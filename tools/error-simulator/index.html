<!DOCTYPE html>
<html lang="en">
<!--
  PTV-TRMNL Error Simulator
  Copyright (c) 2026 Angus Bergman
  Licensed under CC BY-NC 4.0
  
  Simulates documented TRMNL OG errors and crashes from testing logs
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRMNL OG Error Simulator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, monospace;
      background: #0d1117;
      color: #c9d1d9;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      color: #f85149;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #8b949e;
      margin-bottom: 30px;
    }
    .device-frame {
      background: #161b22;
      border: 3px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .device-screen {
      background: #f0f0e8;
      width: 800px;
      height: 480px;
      border: 2px solid #21262d;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
      transform: scale(0.8);
      transform-origin: top center;
    }
    .device-screen.crashed {
      background: #1a1a1a;
    }
    .device-screen.glitched {
      animation: glitch 0.1s infinite;
    }
    @keyframes glitch {
      0% { transform: scale(0.8) translate(0, 0); }
      25% { transform: scale(0.8) translate(-2px, 1px); }
      50% { transform: scale(0.8) translate(2px, -1px); }
      75% { transform: scale(0.8) translate(-1px, 2px); }
      100% { transform: scale(0.8) translate(1px, -2px); }
    }
    .crash-text {
      color: #f85149;
      font-family: monospace;
      font-size: 11px;
      padding: 10px;
      white-space: pre-wrap;
    }
    .rotated-text {
      position: absolute;
      transform: rotate(-90deg);
      transform-origin: left top;
      font-size: 16px;
      font-weight: bold;
      color: #000;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .error-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 12px 16px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    .error-btn:hover {
      background: #30363d;
      border-color: #f85149;
    }
    .error-btn .severity {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      margin-bottom: 5px;
    }
    .severity.critical { background: #f8514922; color: #f85149; }
    .severity.high { background: #d2992222; color: #d29922; }
    .severity.medium { background: #3fb95022; color: #3fb950; }
    .error-btn .title {
      font-weight: bold;
      display: block;
      margin-bottom: 3px;
    }
    .error-btn .desc {
      font-size: 11px;
      color: #8b949e;
    }
    .serial-output {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .serial-output .info { color: #58a6ff; }
    .serial-output .success { color: #3fb950; }
    .serial-output .warn { color: #d29922; }
    .serial-output .error { color: #f85149; }
    .serial-output .panic { color: #ff7b72; font-weight: bold; }
    .status-bar {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #161b22;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 12px;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #3fb950;
    }
    .status-dot.error { background: #f85149; animation: blink 0.5s infinite; }
    @keyframes blink {
      50% { opacity: 0.3; }
    }
    .reset-btn {
      background: #238636;
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .reset-btn:hover {
      background: #2ea043;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üö® TRMNL OG Error Simulator</h1>
    <p class="subtitle">Simulates documented errors and crashes from PTV-TRMNL testing</p>
    
    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Device: Normal Operation</span>
      </div>
      <button class="reset-btn" onclick="resetDevice()">Reset Device</button>
    </div>
    
    <div class="device-frame">
      <div class="device-screen" id="screen">
        <div id="screenContent" style="padding: 20px;">
          <div style="font-size: 24px; font-weight: bold; color: #000;">PTV-TRMNL v5.31</div>
          <div style="color: #666; margin-top: 10px;">Normal Operation</div>
          <div style="margin-top: 30px;">
            <div style="font-size: 48px; color: #000;">09:42</div>
            <div style="color: #666;">Melbourne | 22¬∞C Clear</div>
          </div>
        </div>
      </div>
    </div>
    
    <h3 style="margin-bottom: 10px; color: #8b949e;">Trigger Error Scenario:</h3>
    <div class="controls">
      <button class="error-btn" onclick="triggerError('qr-crash')">
        <span class="severity critical">CRITICAL</span>
        <span class="title">QR Code Memory Crash</span>
        <span class="desc">Guru Meditation - Load Access Fault during QR render</span>
      </button>
      
      <button class="error-btn" onclick="triggerError('font-rotation')">
        <span class="severity high">HIGH</span>
        <span class="title">FONT_12x16 Rotation Bug</span>
        <span class="desc">Text renders 90¬∞ counter-clockwise with larger fonts</span>
      </button>
      
      <button class="error-btn" onclick="triggerError('watchdog-crash')">
        <span class="severity critical">CRITICAL</span>
        <span class="title">Watchdog Timer Crash</span>
        <span class="desc">Task watchdog timeout - device enters boot loop</span>
      </button>
      
      <button class="error-btn" onclick="triggerError('wifi-timeout')">
        <span class="severity medium">MEDIUM</span>
        <span class="title">WiFi Connection Timeout</span>
        <span class="desc">WiFi fails to connect, device stuck on setup</span>
      </button>
      
      <button class="error-btn" onclick="triggerError('api-500')">
        <span class="severity medium">MEDIUM</span>
        <span class="title">Backend API 500 Error</span>
        <span class="desc">Server returns 500, device shows fallback screen</span>
      </button>
      
      <button class="error-btn" onclick="triggerError('memory-exhaustion')">
        <span class="severity critical">CRITICAL</span>
        <span class="title">Memory Exhaustion</span>
        <span class="desc">Heap exhausted during zone decode - alloc fails</span>
      </button>
      
      <button class="error-btn" onclick="triggerError('brick-setup')">
        <span class="severity critical">CRITICAL</span>
        <span class="title">Anti-Brick Violation</span>
        <span class="desc">deepSleep() in setup() - device becomes unflashable</span>
      </button>
      
      <button class="error-btn" onclick="triggerError('ssl-handshake')">
        <span class="severity high">HIGH</span>
        <span class="title">SSL Handshake Failure</span>
        <span class="desc">HTTPS connection fails, can\'t reach Vercel backend</span>
      </button>
    </div>
    
    <h3 style="margin-bottom: 10px; color: #8b949e;">Serial Monitor Output:</h3>
    <div class="serial-output" id="serial"></div>
  </div>
  
  <script>
    const screen = document.getElementById('screen');
    const screenContent = document.getElementById('screenContent');
    const serial = document.getElementById('serial');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    
    let serialLines = [];
    let isInErrorState = false;
    
    function log(text, type = 'info') {
      serialLines.push({ text, type });
      updateSerial();
    }
    
    function updateSerial() {
      serial.innerHTML = serialLines.map(l => 
        `<span class="${l.type}">${l.text}</span>`
      ).join('\n');
      serial.scrollTop = serial.scrollHeight;
    }
    
    function setStatus(text, isError = false) {
      statusText.textContent = text;
      statusDot.classList.toggle('error', isError);
      isInErrorState = isError;
    }
    
    function resetDevice() {
      screen.className = 'device-screen';
      screenContent.innerHTML = `
        <div style="padding: 20px;">
          <div style="font-size: 24px; font-weight: bold; color: #000;">PTV-TRMNL v5.31</div>
          <div style="color: #666; margin-top: 10px;">Normal Operation</div>
          <div style="margin-top: 30px;">
            <div style="font-size: 48px; color: #000;">09:42</div>
            <div style="color: #666;">Melbourne | 22¬∞C Clear</div>
          </div>
        </div>
      `;
      serialLines = [];
      log('==============================', 'info');
      log('PTV-TRMNL v5.31 - Device Reset', 'success');
      log('==============================', 'info');
      log('', 'info');
      log('‚úì Device reset complete', 'success');
      log('‚úì Display initialized', 'success');
      log('‚úì WiFi connected', 'success');
      log('‚Üí Entering loop() - device ready', 'info');
      setStatus('Device: Normal Operation', false);
    }
    
    function triggerError(errorType) {
      serialLines = [];
      
      switch(errorType) {
        case 'qr-crash':
          simulateQRCrash();
          break;
        case 'font-rotation':
          simulateFontRotation();
          break;
        case 'watchdog-crash':
          simulateWatchdogCrash();
          break;
        case 'wifi-timeout':
          simulateWifiTimeout();
          break;
        case 'api-500':
          simulateApi500();
          break;
        case 'memory-exhaustion':
          simulateMemoryExhaustion();
          break;
        case 'brick-setup':
          simulateBrick();
          break;
        case 'ssl-handshake':
          simulateSSLFailure();
          break;
      }
    }
    
    function simulateQRCrash() {
      setStatus('Device: CRASH - Guru Meditation', true);
      log('==============================', 'info');
      log('PTV-TRMNL v5.15 - Unified Setup', 'info');
      log('QR Code + Decision Log + Live Updates', 'info');
      log('==============================', 'info');
      log('', 'info');
      log('‚ö† No credentials - will register', 'warn');
      log('Free heap: 269516', 'info');
      log('‚Üí Init display...', 'info');
      log('‚úì Display init', 'success');
      log('  Panel: EP75 800x480', 'info');
      log('  Rotation: 0 (Landscape)', 'info');
      log('‚Üí Drawing initial setup screen...', 'info');
      log('  Drawing UNIFIED SETUP screen...', 'info');
      log('  ‚Üí FULL REFRESH (Unified Setup)', 'info');
      log('  QR Code URL: ptv-trmnl-new.onrender.com/admin', 'info');
      log('  QR version: 2, size: 25, scale: 6', 'info');
      log('  URL length: 32', 'info');
      log('', 'info');
      log('Guru Meditation Error: Core  0 panic\'ed (Load access fault). Exception was unhandled.', 'panic');
      log('', 'error');
      log('Core  0 register dump:', 'error');
      log('MEPC    : 0x4200337c  RA      : 0x42005b7a  SP      : 0x3fc9fc60', 'error');
      log('MCAUSE  : 0x00000005  MTVAL   : 0x0000232e', 'error');
      log('', 'error');
      log('Backtrace: 0x4200337c:0x3fc9fc60 0x42005b7a:0x3fc9fc80', 'error');
      log('', 'error');
      log('Rebooting...', 'error');
      
      screen.className = 'device-screen crashed glitched';
      screenContent.innerHTML = `
        <div class="crash-text">
Guru Meditation Error: Core  0 panic'ed
(Load access fault)

Exception was unhandled.

MCAUSE  : 0x00000005
MTVAL   : 0x0000232e

Stack memory:
3fc9fc60: 0x3fc98000 0x00000032
3fc9fc80: 0x0000005a 0x00000032
3fc9fca0: 0xc1bfd7fe 0xb66e1056

[BOOT LOOP - Device will reboot]
        </div>
      `;
    }
    
    function simulateFontRotation() {
      setStatus('Device: FONT_12x16 Rotation Bug', true);
      log('==============================', 'info');
      log('PTV-TRMNL v5.14 - Dashboard Display', 'info');
      log('==============================', 'info');
      log('', 'info');
      log('‚úì Display init (EPD_TRMNL_OG)', 'success');
      log('‚úì setRotation(0) - Landscape', 'success');
      log('', 'info');
      log('‚Üí Drawing dashboard...', 'info');
      log('  setFont(FONT_8x8) - OK', 'success');
      log('  setFont(FONT_12x16) - Rendering...', 'warn');
      log('', 'warn');
      log('‚ö† KNOWN BUG: FONT_12x16 renders rotated 90¬∞ CCW', 'warn');
      log('  Text appears sideways on display', 'warn');
      log('  See: KNOWN-ISSUES.md', 'warn');
      
      screen.className = 'device-screen';
      screenContent.innerHTML = `
        <div style="padding: 20px; position: relative; height: 100%;">
          <div style="font-size: 12px; color: #000;">FONT_8x8: Normal text (OK)</div>
          <div class="rotated-text" style="top: 100px; left: 50px;">TRAINS</div>
          <div class="rotated-text" style="top: 100px; left: 150px;">09:42</div>
          <div class="rotated-text" style="top: 100px; left: 250px;">Flinders St</div>
          <div class="rotated-text" style="top: 200px; left: 50px;">TRAMS</div>
          <div class="rotated-text" style="top: 200px; left: 150px;">Route 96</div>
          <div style="position: absolute; bottom: 20px; left: 20px; font-size: 10px; color: #999;">
            ‚ö† FONT_12x16 text is rotated 90¬∞ CCW - use FONT_8x8 only!
          </div>
        </div>
      `;
    }
    
    function simulateWatchdogCrash() {
      setStatus('Device: CRASH - Task Watchdog Timeout', true);
      log('==============================', 'info');
      log('PTV-TRMNL v5.10 - With Watchdog', 'info');
      log('==============================', 'info');
      log('', 'info');
      log('‚úì WiFi connected', 'success');
      log('‚úì Display init', 'success');
      log('‚Üí Fetching dashboard data...', 'info');
      log('  HTTP GET https://ptvtrmnl.vercel.app/api/zones', 'info');
      log('  Waiting for response...', 'info');
      log('', 'info');
      log('E (15234) task_wdt: Task watchdog got triggered.', 'error');
      log('E (15234) task_wdt: The following tasks did not reset the watchdog in time:', 'error');
      log('E (15234) task_wdt:  - loopTask (CPU 0)', 'error');
      log('E (15234) task_wdt: Tasks currently running:', 'error');
      log('E (15234) task_wdt:  - CPU 0: loopTask', 'error');
      log('', 'error');
      log('abort() was called at PC 0x4037e847 on core 0', 'panic');
      log('', 'error');
      log('Backtrace: 0x40375a7d:0x3fcebb20 |<-CORRUPTED', 'error');
      log('', 'error');
      log('Rebooting...', 'error');
      
      screen.className = 'device-screen crashed';
      screenContent.innerHTML = `
        <div class="crash-text">
E (15234) task_wdt: Task watchdog got triggered.
E (15234) task_wdt: The following tasks did not 
reset the watchdog in time:
E (15234) task_wdt:  - loopTask (CPU 0)

abort() was called at PC 0x4037e847

[BOOT LOOP - WDT Timeout]

FIX: Remove esp_task_wdt_init()
See: DEVELOPMENT-RULES.md Section 1.2
        </div>
      `;
    }
    
    function simulateWifiTimeout() {
      setStatus('Device: WiFi Connection Failed', true);
      log('==============================', 'info');
      log('PTV-TRMNL v5.31 - Boot Sequence', 'info');
      log('==============================', 'info');
      log('', 'info');
      log('‚úì Display init', 'success');
      log('‚Üí Connecting WiFi...', 'info');
      log('  SSID: HomeNetwork', 'info');
      log('  Attempt 1/10...', 'warn');
      log('  Attempt 2/10...', 'warn');
      log('  Attempt 3/10...', 'warn');
      log('  ...', 'warn');
      log('  Attempt 10/10...', 'warn');
      log('', 'error');
      log('‚úó WiFi connection failed!', 'error');
      log('  Starting WiFiManager AP...', 'info');
      log('  AP Name: PTV-TRMNL-Setup', 'info');
      log('  Connect to configure WiFi', 'info');
      
      screen.className = 'device-screen';
      screenContent.innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #000;">WiFi Setup Required</div>
          <div style="margin-top: 30px; font-size: 14px; color: #333;">
            <div style="margin-bottom: 20px;">Connect to WiFi network:</div>
            <div style="font-size: 24px; font-weight: bold; padding: 10px; border: 2px solid #000; display: inline-block;">
              PTV-TRMNL-Setup
            </div>
            <div style="margin-top: 20px;">Then visit: 192.168.4.1</div>
          </div>
        </div>
      `;
    }
    
    function simulateApi500() {
      setStatus('Device: Backend Error (HTTP 500)', true);
      log('==============================', 'info');
      log('PTV-TRMNL v5.31 - Fetch Cycle', 'info');
      log('==============================', 'info');
      log('', 'info');
      log('‚úì WiFi OK - IP: 192.168.1.42', 'success');
      log('‚Üí Fetching zones...', 'info');
      log('  GET https://ptvtrmnl.vercel.app/api/zones', 'info');
      log('', 'error');
      log('‚úó HTTP 500: Internal Server Error', 'error');
      log('  Response: {"error":"ODATA_API_KEY not configured"}', 'error');
      log('', 'warn');
      log('‚Üí Showing setup screen (server error)', 'warn');
      log('  Will retry in 20 seconds...', 'info');
      
      screen.className = 'device-screen';
      screenContent.innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #000;">Setup Required</div>
          <div style="margin-top: 20px; font-size: 14px; color: #666;">
            Server returned error. Please check:
          </div>
          <div style="margin-top: 20px; text-align: left; display: inline-block; font-size: 12px;">
            <div>‚òê ODATA_API_KEY configured</div>
            <div>‚òê ODATA_TOKEN configured</div>
            <div>‚òê Backend deployment active</div>
          </div>
          <div style="margin-top: 30px; font-size: 12px; color: #999;">
            Visit: ptvtrmnl.vercel.app/admin
          </div>
        </div>
      `;
    }
    
    function simulateMemoryExhaustion() {
      setStatus('Device: CRASH - Memory Exhaustion', true);
      log('==============================', 'info');
      log('PTV-TRMNL v5.20 - Zone Fetch', 'info');
      log('==============================', 'info');
      log('', 'info');
      log('Free heap before fetch: 45000', 'warn');
      log('‚Üí Fetching zone: trains (370x150)', 'info');
      log('  BMP size: ~28KB', 'info');
      log('  Allocating decode buffer...', 'info');
      log('', 'error');
      log('‚úó malloc() failed! Requested: 28800 bytes', 'error');
      log('  Available heap: 22456 bytes', 'error');
      log('  Largest free block: 18432 bytes', 'error');
      log('', 'panic');
      log('assert failed: heap_caps_malloc heap_caps.c:168', 'panic');
      log('', 'error');
      log('Backtrace: 0x40081234:0x3ffb5f80 |<-CORRUPTED', 'error');
      log('', 'error');
      log('Rebooting...', 'error');
      
      screen.className = 'device-screen crashed';
      screenContent.innerHTML = `
        <div class="crash-text">
MEMORY EXHAUSTION

malloc() failed!
Requested:  28800 bytes
Available:  22456 bytes
Largest:    18432 bytes

assert failed: heap_caps_malloc

[BOOT LOOP]

FIX: Use streaming zone decode
- Fetch ONE zone at a time
- Decode directly to display
- Never hold full payload

See: zones-v12.cpp
        </div>
      `;
    }
    
    function simulateBrick() {
      setStatus('Device: BRICKED - Cannot Reflash', true);
      log('==============================', 'error');
      log('PTV-TRMNL v5.00 - ANTI-BRICK VIOLATION', 'error');
      log('==============================', 'error');
      log('', 'info');
      log('// BAD CODE IN FIRMWARE:', 'error');
      log('void setup() {', 'error');
      log('    WiFi.begin(ssid, pass);  // Blocking!', 'error');
      log('    while (WiFi.status() != WL_CONNECTED) {', 'error');
      log('        delay(500);  // Hangs forever if no WiFi', 'error');
      log('    }', 'error');
      log('    esp_deep_sleep(1000000);  // BRICK!', 'error');
      log('}', 'error');
      log('', 'panic');
      log('üö® DEVICE BRICKED üö®', 'panic');
      log('', 'error');
      log('Device enters deep sleep before USB enumeration', 'error');
      log('Cannot flash new firmware via USB', 'error');
      log('', 'warn');
      log('Recovery options:', 'warn');
      log('1. Hold BOOT button during power-on', 'warn');
      log('2. Connect GPIO0 to GND', 'warn');
      log('3. Use JTAG debugger', 'warn');
      
      screen.className = 'device-screen crashed';
      screenContent.innerHTML = `
        <div class="crash-text" style="color: #ff0000;">
üö®üö®üö® DEVICE BRICKED üö®üö®üö®

CAUSE: deepSleep() in setup()

Device enters sleep before USB
can enumerate. Cannot reflash.

VIOLATED: Development Rules ¬ß1.2
"NO deepSleep() in setup()"
"NO delays > 2 seconds"

---

RECOVERY:
1. Hold BOOT button
2. Apply power
3. Release after 3 seconds
4. Flash via esptool
        </div>
      `;
    }
    
    function simulateSSLFailure() {
      setStatus('Device: SSL Handshake Failed', true);
      log('==============================', 'info');
      log('PTV-TRMNL v5.31 - HTTPS Connection', 'info');
      log('==============================', 'info');
      log('', 'info');
      log('‚úì WiFi OK - IP: 192.168.1.42', 'success');
      log('‚Üí Connecting to ptvtrmnl.vercel.app:443', 'info');
      log('  Using WiFiClientSecure...', 'info');
      log('  setInsecure() for testing', 'warn');
      log('', 'info');
      log('‚Üí SSL handshake...', 'info');
      log('  Sending ClientHello...', 'info');
      log('  Waiting for ServerHello...', 'info');
      log('', 'error');
      log('‚úó SSL handshake failed!', 'error');
      log('  Error: -1 (MBEDTLS_ERR_SSL_WANT_READ)', 'error');
      log('  Possible causes:', 'error');
      log('    - Certificate validation failed', 'error');
      log('    - Server timeout', 'error');
      log('    - Memory insufficient for TLS', 'error');
      log('', 'warn');
      log('‚Üí Retry in 5 seconds...', 'warn');
      
      screen.className = 'device-screen';
      screenContent.innerHTML = `
        <div style="padding: 40px;">
          <div style="font-size: 20px; font-weight: bold; color: #000;">Connection Error</div>
          <div style="margin-top: 20px; font-size: 14px; color: #666;">
            SSL handshake failed
          </div>
          <div style="margin-top: 20px; font-family: monospace; font-size: 11px; color: #333;">
            Host: ptvtrmnl.vercel.app<br>
            Port: 443<br>
            Error: MBEDTLS_ERR_SSL_WANT_READ
          </div>
          <div style="margin-top: 30px; font-size: 12px; color: #999;">
            Retrying in 5 seconds...
          </div>
        </div>
      `;
    }
    
    // Initialize
    resetDevice();
  </script>
</body>
</html>
