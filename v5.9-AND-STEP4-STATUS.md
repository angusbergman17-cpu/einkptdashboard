# v5.9 Firmware + Step 4 Fixes - Status Report

**Date**: 2026-01-27
**Firmware**: v5.9 - Default Dashboard
**Admin Wizard**: Step 4 Simplified
**Status**: âœ… DEPLOYED

---

## âœ… What's Been Done

### 1. Firmware v5.9 - Default Dashboard âœ…

**Problem**: Device showed blank screen or errors while system was being configured.

**Solution**: Created v5.9 with intelligent default dashboard.

**Features**:
- Detects HTTP 500 "System not configured" response
- Shows default dashboard with:
  - Estimated time since boot
  - Device info (ESP32-C3, Friendly ID, WiFi network)
  - Server URL
  - Setup status message
  - Instructions to complete setup
  - Firmware version, refresh count, heap usage
- Partial refresh for time/stats updates
- Full refresh every 10 minutes
- All text renders horizontally (v5.8 orientation fix maintained)

**Your Device Now Shows**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€PTV-TRMNLâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[TIME]â”€â”
â”‚                                            â”‚
â”‚         SETUP IN PROGRESS                  â”‚
â”‚                                            â”‚
â”‚  Device: ESP32-C3 (94A990)                 â”‚
â”‚  WiFi: Connected to [your-wifi]            â”‚
â”‚  Server: https://ptv-trmnl-new.onrender.comâ”‚
â”‚  Status: Waiting for configuration         â”‚
â”‚                                            â”‚
â”‚  Complete setup at:                        â”‚
â”‚  https://ptv-trmnl-new.onrender.com/admin â”‚
â”‚                                            â”‚
â”‚  Firmware: v5.9    Refresh: 5    Heap: 221KBâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Compilation & Flash**:
- âœ… Compiled successfully (9.08 seconds)
- âœ… Memory: RAM 13.3% (43,604 bytes), Flash 55.0% (1,081,146 bytes)
- âœ… Flashed successfully (15.70 seconds)
- âœ… Device: 94:a9:90:8d:28:d0
- âœ… Running and displaying default dashboard

---

### 2. Step 4 Simplified - Automatic Cafe âœ…

**Problem**: Step 4 had redundant cafe input fields and wasn't using the geocoded cafe from Step 2.

**Solution**: Simplified Step 4 to automatically use cafe from Step 2.

**Removed**:
- âŒ "Cafe Business Name" input field
- âŒ "How long do you spend at the cafe?" input field
- âŒ Manual cafe checkbox

**Added**:
- âœ… Auto-detection of cafe from Step 2
- âœ… Info box showing detected cafe address
- âœ… Educational content about journey planning
- âœ… Note when no cafe was entered
- âœ… Better console logging for debugging

**New Step 4 Flow**:
```
Step 4: Smart Journey Planning
â”œâ”€ Work Start Time: [09:00]
â”œâ”€ [If cafe detected in Step 2]
â”‚  â””â”€ â˜• Coffee Stop Detected
â”‚     â””â”€ Cafe: Shop 2/300 Toorak Rd, South Yarra
â”‚     â””â”€ System will automatically optimize timing
â””â”€ Calculate Smart Journey button
```

**Benefits**:
- Simpler user experience
- No redundant inputs
- System handles complexity
- Automatic cafe integration
- Professional appearance

---

## âš ï¸ Known Issue: "No Transit Stops Found"

### The Error

When clicking "Calculate Smart Journey" in Step 4, you get:

```
âš ï¸ Error:
Failed to calculate journey: No transit stops found near your addresses.
Please check the addresses are correct.
```

### Root Cause

The error comes from the **server-side** `SmartJourneyPlanner.findNearbyStops()` function.

**Your addresses ARE correct**:
- âœ… Home: 1008/1 Clara St, South Yarra (-37.8423, 144.9981)
- âœ… Work: 80 Collins St, Melbourne (-37.8140, 144.9709)
- âœ… Cafe: Shop 2/300 Toorak Rd, South Yarra (-37.8399, 144.9970)

**The issue**: The fallback timetables don't have transit stop data for these specific coordinates.

### Why This Happens

**SmartJourneyPlanner workflow**:
```javascript
1. Receive home/work coordinates
2. Call findNearbyStops(homeLocation)
3. Search fallback timetables for stops within radius
4. IF no stops found â†’ ERROR
5. IF stops found â†’ Calculate journey
```

**The fallback data** (`src/data/fallback-timetables.js`) has:
- Basic route information
- Service schedules
- But lacks: Comprehensive stop coordinates for all Melbourne locations

**What's needed**:
1. Wider search radius (currently too narrow)
2. Or: More comprehensive fallback stop data
3. Or: PTV API credentials for real-time stop lookup

---

## ğŸ”§ How to Fix "No Transit Stops Found"

### Option 1: Configure PTV API (Recommended)

The system is designed to use **PTV API** for real-time transit data, including stop locations.

**Steps**:
1. Get PTV API credentials from https://www.ptv.vic.gov.au/footer/data-and-reporting/datasets/ptv-timetable-api/
2. In admin wizard, configure PTV API keys
3. System will use live stop data instead of fallback
4. Journey planning will work with accurate data

### Option 2: Skip Journey Planning for Now

**Workaround**:
1. Skip Step 4 (click "â† Back" then proceed past it)
2. Complete Steps 5-8
3. System will use basic fallback display
4. Add journey planning later when PTV API is configured

### Option 3: Implement Fallback Improvements (Dev Task)

**Server-side changes needed** (for developer):

**File**: `src/core/smart-journey-planner.js`

**Option A: Wider Search Radius**:
```javascript
// Current: searches within 500m
const SEARCH_RADIUS = 500;

// Change to: 2000m (2km)
const SEARCH_RADIUS = 2000;
```

**Option B: Add Melbourne CBD Stops**:
```javascript
// In src/data/fallback-timetables.js
const melbourneStops = [
    {
        id: 'south-yarra-station',
        name: 'South Yarra Station',
        lat: -37.8402,
        lon: -145.0019,
        modes: ['train', 'tram']
    },
    {
        id: 'parliament-station',
        name: 'Parliament Station',
        lat: -37.8113,
        lon: 144.9733,
        modes: ['train']
    },
    // Add more stops...
];
```

**Option C: Return Default Journey**:
```javascript
// If no stops found, return estimated journey
if (nearbyStops.length === 0) {
    return {
        success: true,
        legs: [{
            mode: 'Transit (estimated)',
            from: 'Home',
            to: 'Work',
            duration: 25,
            route: 'Requires PTV API for accurate routing'
        }],
        departureTime: calculateBackwards(workStartTime, 30)
    };
}
```

---

## ğŸ“Š Current System Status

### Device (ESP32-C3)
- âœ… Firmware: v5.9
- âœ… Display: Default dashboard showing
- âœ… Orientation: Horizontal text (fixed)
- âœ… Memory: Stable (~221KB heap)
- âœ… WiFi: Connected
- âœ… Server: Fetching every 20 seconds
- âš ï¸  Response: HTTP 500 (system not configured)

### Server (Render)
- âœ… Running: https://ptv-trmnl-new.onrender.com
- âœ… Step 1: API validation fixed âœ“
- âœ… Step 2: Geocoding working (Google Places) âœ“
- âœ… Step 3: State detection working âœ“
- âš ï¸  Step 4: Journey planning blocked by "no stops found"
- â³ Step 5-8: Not yet reached

### Setup Progress
```
âœ… Step 1: Google Places API configured
âœ… Step 2: Addresses geocoded (home, work, cafe)
âœ… Step 3: State detected (VIC - Transport for Victoria)
âš ï¸  Step 4: Journey planning (blocked)
â³ Step 5: Weather setup
â³ Step 6: Transit data feeds
â³ Step 7: Device selection
â³ Step 8: Complete
```

---

## ğŸ¯ Recommended Next Steps

### Option A: Skip Step 4 for Now

1. **In Step 4**: Click "â† Back"
2. **Proceed manually** to Steps 5-8
3. **Complete setup** without journey planning
4. **Result**: Device will show basic transit info
5. **Later**: Add PTV API and recalculate journey

### Option B: Get PTV API Credentials

1. **Register** at https://www.ptv.vic.gov.au/footer/data-and-reporting/datasets/ptv-timetable-api/
2. **Get API key** and developer ID
3. **Configure in Step 6** of admin wizard
4. **Retry Step 4** - will use real-time stop data
5. **Result**: Full journey planning with live data

### Option C: Developer Fix (If You Have Access)

1. **Edit** `src/core/smart-journey-planner.js`
2. **Increase** SEARCH_RADIUS to 2000
3. **Or add** Melbourne CBD stops to fallback data
4. **Redeploy** server to Render
5. **Retry Step 4** - should find stops

---

## ğŸ“ What the User Sees Now

### On Device (v5.9):
```
PTV-TRMNL v5.9
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SETUP IN PROGRESS

Device: ESP32-C3 (94A990)
WiFi: Connected
Server: ptv-trmnl-new.onrender.com
Status: Waiting for configuration

Complete setup at:
ptv-trmnl-new.onrender.com/admin

[Updates every 20 seconds]
```

### On Admin Page (Step 4):
```
ğŸ§  Step 4: Smart Journey Planning

Work Start Time: [09:00]

â˜• Coffee Stop Detected
Cafe: Shop 2/300 Toorak Rd, South Yarra VIC 3141
Source: Google Places

ğŸ’¡ The system will analyze cafe busyness patterns
    and automatically determine if there's time for
    coffee based on live transit connections.

[Calculate Smart Journey] â† Clicks this

âš ï¸ Error:
Failed to calculate journey: No transit stops found
near your addresses. Please check the addresses are
correct.
```

---

## ğŸ” Technical Details

### V5.9 Firmware

**Memory Management**:
```cpp
unsigned long bootTime = 0;  // Track boot time
bool systemConfigured = false;  // Track config state

String getEstimatedTime() {
    unsigned long elapsedSeconds = (millis() - bootTime) / 1000;
    unsigned long hours = (elapsedSeconds / 3600) % 24;
    unsigned long minutes = (elapsedSeconds / 60) % 60;
    char timeStr[6];
    sprintf(timeStr, "%02lu:%02lu", hours, minutes);
    return String(timeStr);
}

void fetchAndDisplaySafe() {
    // ... fetch from server ...

    if (httpCode != 200) {
        if (httpCode == 500) {
            systemConfigured = false;
            drawDefaultDashboard();  // Show default UI
        }
        return;
    }

    systemConfigured = true;
    // ... draw real dashboard ...
}
```

**Display Layout**:
- Top bar: Title + Time
- Middle: Status message + Device info + Server + Instructions
- Bottom: Version + Refresh count + Heap usage
- Partial refresh: Time + refresh count only
- Full refresh: Every 10 minutes

### Step 4 Changes

**Before**:
```javascript
const includeCafe = document.getElementById('include-cafe').checked;
const cafeDuration = parseInt(document.getElementById('cafe-duration').value);
```

**After**:
```javascript
const includeCafe = !!setupData.cafeLocation;  // Auto-detect from Step 2
const cafeDuration = 10;  // Default 10 minutes
```

**API Call**:
```javascript
POST /admin/smart-journey/calculate
Body: {
    homeLocation: { lat: -37.8423, lon: 144.9981 },
    workLocation: { lat: -37.8140, lon: 144.9709 },
    cafeLocation: { lat: -37.8399, lon: 144.9970 },
    workStartTime: "09:00",
    cafeDuration: 10,
    transitAuthority: "VIC",
    useFallbackData: true  // No PTV API yet
}

Response: {
    success: false,
    error: "No transit stops found near your addresses"
}
```

---

## âœ… Summary

### Completed âœ…
1. **v5.9 Firmware**: Default dashboard during setup
2. **Step 1 Fix**: API validation working
3. **Step 2 Fix**: Geocoding with Google Places
4. **Step 3 Fix**: State detection
5. **Step 4 UI**: Simplified cafe detection

### Blocked âš ï¸
- **Step 4 Journey Calc**: "No transit stops found"
- **Root Cause**: Fallback data lacks stop coordinates
- **Solutions**: Get PTV API, or widen search, or add stops

### Next Actions
- **Option A**: Skip Step 4, complete Steps 5-8
- **Option B**: Get PTV API credentials
- **Option C**: Dev fix to widen search radius

---

**Your device is working perfectly and showing a professional default dashboard while you complete the setup!**

---

**Copyright (c) 2026 Angus Bergman**
**Device**: ESP32-C3 PTV-TRMNL
**Firmware**: v5.9 - Default Dashboard
**Status**: âœ… Running - Waiting for Configuration Complete
