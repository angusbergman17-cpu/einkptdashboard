<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTV-TRMNL Smart Setup & Dashboard</title>
    <style>
        /**
         * PTV-TRMNL Smart Setup Wizard & Live Dashboard
         *
         * Copyright (c) 2026 Angus Bergman
         * Licensed under CC BY-NC 4.0
         * https://creativecommons.org/licenses/by-nc/4.0/
         */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.3);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s ease;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .recommendation-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .recommendation-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .error-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="time"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .actions {
            margin-top: 30px;
            display: flex;
            gap: 10px;
        }

        .geocode-result {
            margin-top: 10px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            display: none;
        }

        .geocode-result.show {
            display: block;
        }

        .device-option {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .device-option:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .device-option.selected {
            border-color: #667eea;
            background: #e8eeff;
        }

        .device-option input[type="radio"] {
            width: 20px;
            height: 20px;
        }

        .device-details h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 5px;
        }

        .badge.compatible {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge.incompatible {
            background: #fff3e0;
            color: #e65100;
        }

        .journey-visualization {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .journey-leg {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        .leg-mode {
            font-weight: 600;
            min-width: 80px;
            color: #667eea;
        }

        .leg-details {
            flex: 1;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .stop-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stop-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stop-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .stop-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .stop-option .stop-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .stop-option .stop-info {
            flex: 1;
        }

        .stop-option .stop-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #1f2937;
        }

        .stop-option .stop-details {
            font-size: 0.85em;
            color: #6b7280;
            margin-top: 2px;
        }

        .stop-option .stop-badge {
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .alternative-route {
            padding: 15px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .alternative-route:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .alternative-route-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .alternative-route-details {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 30px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dashboard-panel h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .api-key-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 10px 0;
        }

        .api-key-item.active {
            background: #e8f5e9;
        }

        .api-icon {
            font-size: 1.5em;
        }

        .api-name {
            flex: 1;
            font-weight: 600;
        }

        .api-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .api-status.active {
            background: #4caf50;
            color: white;
        }

        .api-status.inactive {
            background: #ff9800;
            color: white;
        }

        .log-stream {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 3px 0;
        }

        .log-time {
            color: #808080;
        }

        .log-level {
            font-weight: 600;
            margin: 0 5px;
        }

        .log-info {
            color: #4fc3f7;
        }

        .log-success {
            color: #81c784;
        }

        .log-warning {
            color: #ffb74d;
        }

        .log-error {
            color: #e57373;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.operational {
            background: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }

        .status-indicator.degraded {
            background: #ff9800;
            box-shadow: 0 0 8px rgba(255, 152, 0, 0.5);
        }

        .status-indicator.down {
            background: #f44336;
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
        }

        .qr-code-display {
            text-align: center;
            padding: 20px;
        }

        .qr-code-display img {
            max-width: 250px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .copyright {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .inline-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .inline-group > * {
            flex: 1;
        }

        .detected-state {
            background: #f0f4ff;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .detected-state h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöä PTV-TRMNL</h1>
            <p id="header-subtitle">Smart Transit Display System</p>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>

        <div class="content">
            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loading-text">Loading...</p>
            </div>

            <!-- Error Display -->
            <div class="error-box" id="error-box">
                <strong>‚ö†Ô∏è Error:</strong>
                <p id="error-message"></p>
            </div>

            <!-- Success Notification -->
            <div class="success-box" id="success-notification" style="display:none;">
                <strong>‚úÖ Success!</strong>
                <p id="success-message"></p>
            </div>

            <!-- Step 1: Google Places API -->
            <div class="step active" id="step-1">
                <h2>üó∫Ô∏è Step 1: Enhanced Location Finding</h2>

                <div class="recommendation-box">
                    <h3>Recommended: Google Places API (New)</h3>
                    <p><strong>For best results</strong>, add your Google Places API (new) key now.
                    This ensures accurate address finding for your home, work, and cafe locations.</p>

                    <p style="margin-top: 10px;">üí° The Google Places API (new) has a generous free tier ($200/month credit).
                    Adding it during setup prevents address lookup failures.</p>
                </div>

                <div class="form-group">
                    <label for="google-places-key">Google Places API (New) Key:</label>
                    <input type="password" id="google-places-key" placeholder="AIza...">
                    <small>
                        <a href="https://developers.google.com/maps/documentation/places/web-service/cloud-setup"
                           target="_blank">Get API Key ‚Üí</a>
                    </small>
                </div>

                <div class="success-box" id="google-places-success" style="display:none;">
                    <strong>‚úÖ Success!</strong>
                    <p>Google Places API configured successfully. Enhanced geocoding is now available.</p>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="validateAndSaveGooglePlaces()">
                        Validate & Continue ‚Üí
                    </button>
                    <button class="btn btn-secondary" onclick="skipGooglePlaces()">
                        Skip (Use Free Geocoding)
                    </button>
                </div>

                <div class="recommendation-box" style="margin-top: 20px; background: #fff9c4; border-color: #fbc02d;">
                    <strong>Note:</strong> Skipping will use free Nominatim geocoding, which may be
                    less accurate for specific buildings and businesses.
                </div>
            </div>

            <!-- Step 2: Addresses -->
            <div class="step" id="step-2">
                <h2>üìç Step 2: Your Locations</h2>

                <p style="margin-bottom: 20px;">Enter your addresses. We'll use the best available geocoding service to find exact coordinates.</p>

                <div class="form-group">
                    <label for="home-address">Home Address:</label>
                    <input type="text" id="home-address" placeholder="Enter your home address">
                    <div class="actions" style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="geocodeAddress('home')">Find Location</button>
                    </div>
                    <div class="geocode-result" id="home-result"></div>
                </div>

                <div class="form-group">
                    <label for="work-address">Work Address:</label>
                    <input type="text" id="work-address" placeholder="Enter your work address">
                    <div class="actions" style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="geocodeAddress('work')">Find Location</button>
                    </div>
                    <div class="geocode-result" id="work-result"></div>
                </div>

                <div class="form-group">
                    <label for="cafe-address">Cafe (Optional):</label>
                    <input type="text" id="cafe-address" placeholder="Enter your favorite cafe">
                    <div class="actions" style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="geocodeAddress('cafe')">Find Location</button>
                    </div>
                    <div class="geocode-result" id="cafe-result"></div>
                </div>

                <div class="detected-state" id="detected-state" style="display:none;">
                    <h3>Detected State: <span id="state-name"></span></h3>
                    <p><strong>Transit Authority:</strong> <span id="transit-authority"></span></p>
                    <p><strong>Timezone:</strong> <span id="timezone"></span></p>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="proceedToTransit()" id="continue-transit" disabled>
                        Continue to Transit Setup ‚Üí
                    </button>
                    <button class="btn btn-secondary" onclick="goToStep(1)">
                        ‚Üê Back
                    </button>
                </div>
            </div>

            <!-- Step 3: Transit Authority -->
            <div class="step" id="step-3">
                <h2>üöÇ Step 3: Transit Authority Detected</h2>

                <div class="detected-state">
                    <h3><span id="authority-icon"></span> <span id="authority-name"></span></h3>
                    <p><strong>State:</strong> <span id="state-detected"></span></p>
                    <p><strong>Available modes:</strong> <span id="available-modes"></span></p>
                </div>

                <div class="recommendation-box">
                    <h3>Using Fallback Timetables</h3>
                    <p>The system will use cached static timetables for initial journey planning.
                    You'll be prompted to add a real-time API key later to enable live updates.</p>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="proceedToJourneyPlanning()">
                        Continue to Journey Planning ‚Üí
                    </button>
                    <button class="btn btn-secondary" onclick="goToStep(2)">
                        ‚Üê Back
                    </button>
                </div>
            </div>

            <!-- Step 4: Smart Journey Planning -->
            <div class="step" id="step-4">
                <h2>üß† Step 4: Smart Journey Planning</h2>

                <p style="margin-bottom: 20px;">The system will automatically calculate your optimal journey, including coffee stop timing if you entered a cafe in Step 2.</p>

                <div class="form-group">
                    <label for="work-start-time">Work Start Time:</label>
                    <input type="time" id="work-start-time" value="09:00">
                    <small>When do you need to arrive at work?</small>
                </div>

                <div class="info-box" id="cafe-info" style="display: none; margin-top: 20px;">
                    <h4>‚òï Coffee Stop Detected</h4>
                    <p id="cafe-address-display"></p>
                    <p style="font-size: 13px; margin-top: 10px;">
                        üí° The system will analyze cafe busyness patterns and suggest optimal times to avoid queues.
                        It automatically determines if there's time for coffee based on live transit connections.
                    </p>
                </div>

                <div class="recommendation-box" style="margin-top: 20px;">
                    <h3>How Journey Planning Works</h3>
                    <p><strong>The system automatically:</strong></p>
                    <ul style="margin: 10px 0 0 20px; font-size: 13px;">
                        <li>Finds nearby transit stops for your addresses</li>
                        <li>Calculates walking times</li>
                        <li>Determines optimal departure time working backwards from your arrival time</li>
                        <li>Analyzes cafe busy periods to suggest when to get coffee</li>
                        <li>Factors in transit connections and buffer time</li>
                    </ul>
                </div>

                <div id="journey-no-cafe-note" style="display: none; margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                    <p style="margin: 0; font-size: 13px;">
                        <strong>Note:</strong> No cafe address was entered in Step 2. Journey will be calculated for direct home ‚Üí work route.
                    </p>
                </div>

                <div class="actions" style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="calculateJourney()">
                        Calculate Smart Journey
                    </button>
                    <button class="btn btn-secondary" onclick="goToStep(3)">
                        ‚Üê Back
                    </button>
                </div>

                <div id="journey-result" class="journey-visualization" style="display:none;">
                    <!-- Journey will be rendered here -->
                </div>

                <div id="journey-customize" style="display:none; margin-top: 30px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <h3 style="margin: 0;">Customize Your Preferred Route</h3>
                        <span style="background: rgba(99, 102, 241, 0.1); color: #6366f1; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">OPTIONAL</span>
                    </div>
                    <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                        Select different transit stops or choose an alternative route. Your selection will become your new <strong>preferred route</strong>.
                    </p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h4>üè† Home Stop Options</h4>
                            <div id="home-stop-options" class="stop-options">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>

                        <div>
                            <h4>üè¢ Work Stop Options</h4>
                            <div id="work-stop-options" class="stop-options">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <div id="alternative-routes" style="display:none; margin-top: 20px;">
                        <h4>Alternative Routes</h4>
                        <div id="alternative-routes-list">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <div class="actions" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="recalculateWithSelectedStops()">
                            ‚úì Set as My Preferred Route
                        </button>
                        <button class="btn btn-secondary" onclick="toggleCustomize()">
                            ‚Üê Back to Current Route
                        </button>
                    </div>
                </div>

                <div id="journey-actions" class="actions" style="display:none;">
                    <button class="btn btn-primary" onclick="acceptJourney()">
                        ‚úì Accept Preferred Route ‚Üí
                    </button>
                    <button class="btn btn-secondary" onclick="toggleCustomize()">
                        ‚öôÔ∏è Customize Route Options
                    </button>
                </div>
            </div>

            <!-- Step 5: BOM Weather Data -->
            <div class="step" id="step-5">
                <h2>üå§Ô∏è Step 5: Weather Data</h2>

                <p style="margin-bottom: 20px;">Linking Bureau of Meteorology (BOM) data to your home location...</p>

                <div id="bom-result" style="display:none;">
                    <!-- BOM result will be shown here -->
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="proceedToTransitAPI()">
                        Continue ‚Üí
                    </button>
                    <button class="btn btn-secondary" onclick="goToStep(4)">
                        ‚Üê Back
                    </button>
                </div>
            </div>

            <!-- Step 6: Transit API (Optional) -->
            <div class="step" id="step-6">
                <h2>üîë Step 6: Real-Time Transit Data (Optional)</h2>

                <div class="recommendation-box">
                    <p>Your journey is currently using <strong>fallback static timetables</strong>.
                    To enable <strong>live departure times</strong> and real-time updates, add your
                    <strong><span id="transit-api-name"></span></strong> API key.</p>

                    <p style="margin-top: 10px;">üí° <strong>Free Option:</strong> You can skip this and continue using cached
                    timetables. The system will still work, but won't have live delay/cancellation alerts.</p>
                </div>

                <div class="form-group">
                    <label for="transit-api-key"><span id="transit-api-label"></span> API Key:</label>
                    <input type="password" id="transit-api-key" placeholder="Enter API key">
                    <small>
                        <a href="#" id="transit-api-link" target="_blank">Get API Key ‚Üí</a>
                    </small>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="validateTransitAPI()">
                        Validate & Enable Live Data
                    </button>
                    <button class="btn btn-secondary" onclick="skipTransitAPI()">
                        Skip (Use Fallback Data)
                    </button>
                </div>
            </div>

            <!-- Step 7: Device Selection -->
            <div class="step" id="step-7">
                <h2>üì± Step 7: Select Your E-Ink Device</h2>

                <p style="margin-bottom: 20px;">Choose the e-ink display you'll be using. All outputs will be formatted for your device.</p>

                <div class="device-option" onclick="selectDevice('trmnl-og')">
                    <input type="radio" name="device" value="trmnl-og" id="device-trmnl-og">
                    <div class="device-details">
                        <h4>TRMNL OG (7.5")</h4>
                        <p>800√ó480 pixels, Landscape, ESP32-based</p>
                        <span class="badge compatible">‚úÖ Compatible</span>
                    </div>
                </div>

                <div class="device-option" onclick="selectDevice('kindle-pw5')">
                    <input type="radio" name="device" value="kindle-pw5" id="device-kindle-pw5">
                    <div class="device-details">
                        <h4>Kindle Paperwhite 5 (6.8")</h4>
                        <p>1236√ó1648 pixels, Portrait, 4-bit grayscale</p>
                        <span class="badge compatible">‚úÖ Compatible</span>
                    </div>
                </div>

                <div class="device-option" onclick="selectDevice('kindle-pw3')">
                    <input type="radio" name="device" value="kindle-pw3" id="device-kindle-pw3">
                    <div class="device-details">
                        <h4>Kindle Paperwhite 3/4 (6")</h4>
                        <p>758√ó1024 pixels, Portrait, 4-bit grayscale</p>
                        <span class="badge compatible">‚úÖ Compatible</span>
                    </div>
                </div>

                <div id="device-info" style="display:none; margin-top: 20px;" class="detected-state">
                    <!-- Device info will be shown here -->
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="completeSetup()" id="complete-setup-btn" disabled>
                        Complete Setup ‚Üí
                    </button>
                    <button class="btn btn-secondary" onclick="goToStep(6)">
                        ‚Üê Back
                    </button>
                </div>
            </div>

            <!-- Step 8: Setup Complete -->
            <div class="step" id="step-8">
                <h2>‚úÖ Setup Complete!</h2>

                <div class="success-box">
                    <h3>Your PTV-TRMNL system is configured and ready!</h3>
                </div>

                <div class="detected-state">
                    <h3>Configuration Summary</h3>
                    <div id="setup-summary">
                        <!-- Summary will be filled -->
                    </div>
                </div>

                <div id="qr-code-panel" class="qr-code-display" style="display:none;">
                    <h3>Device Setup QR Code</h3>
                    <img id="device-qr" alt="Device pairing QR code">
                    <p>Scan this QR code with your device to pair it.</p>
                </div>

                <div class="dashboard-panel">
                    <h3>üìú Setup Logs</h3>
                    <div id="setup-logs" class="log-stream">
                        <!-- Setup logs will appear here -->
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="goToDashboard()">
                        View Live Dashboard ‚Üí
                    </button>
                </div>
            </div>

            <!-- Dashboard View -->
            <div class="step" id="dashboard" style="display:none;">
                <h2>üéõÔ∏è Live Dashboard</h2>

                <div class="detected-state">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>System Status</h3>
                        <div>
                            <span class="status-indicator operational" id="system-status-indicator"></span>
                            <span id="system-status-text">Operational</span>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <!-- Journey Panel -->
                    <div class="dashboard-panel" style="grid-column: 1 / -1;">
                        <h3>üöä Your Journey (Live)</h3>
                        <div id="live-journey">
                            <!-- Live journey data -->
                        </div>
                    </div>

                    <!-- Device Panel -->
                    <div class="dashboard-panel">
                        <h3>üì± Paired Device</h3>
                        <div id="device-status">
                            <!-- Device status -->
                        </div>
                    </div>

                    <!-- API Keys Panel -->
                    <div class="dashboard-panel">
                        <h3>üîë Configured APIs</h3>
                        <div id="api-keys-list">
                            <!-- API keys list -->
                        </div>
                    </div>

                    <!-- Logs Panel -->
                    <div class="dashboard-panel" style="grid-column: 1 / -1;">
                        <h3>üìú System Logs (Live)</h3>
                        <div id="technical-logs" class="log-stream">
                            <!-- Live logs -->
                        </div>
                    </div>

                    <!-- Legal Panel -->
                    <div class="dashboard-panel">
                        <h3>‚öñÔ∏è Legal & Compliance</h3>
                        <div id="legal-notices">
                            <h4>Data Sources:</h4>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li>Transport for Victoria - GTFS Realtime (OpenData License)</li>
                                <li>Bureau of Meteorology - Weather Data (CC BY)</li>
                                <li>Google Places API (New) - Terms of Service</li>
                            </ul>

                            <h4 style="margin-top: 15px;">Software License:</h4>
                            <p>PTV-TRMNL ¬© 2026 Angus Bergman</p>
                            <p>Licensed under CC BY-NC 4.0</p>
                            <p><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">
                                License Details ‚Üí</a></p>
                        </div>
                    </div>

                    <!-- Donations Panel -->
                    <div class="dashboard-panel">
                        <h3>üíù Support This Project</h3>
                        <div id="donations">
                            <p>If you find this project useful, consider supporting its development.</p>
                            <p style="margin-top: 15px;">
                                <a href="https://github.com/angusbergman17-cpu/PTV-TRMNL-NEW"
                                   target="_blank"
                                   class="btn btn-secondary"
                                   style="display: inline-block;">
                                    ‚≠ê Star on GitHub
                                </a>
                            </p>
                            <p style="margin-top: 10px;">
                                <small>This project is provided free and open-source under CC BY-NC 4.0.</small>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="actions" style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="window.location.reload()">
                        ‚Üê Return to Setup
                    </button>
                </div>
            </div>
        </div>

        <div class="copyright">
            <p>PTV-TRMNL ¬© 2026 Angus Bergman</p>
            <p>Licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></p>
        </div>
    </div>

    <script>
        /**
         * PTV-TRMNL Smart Setup Wizard Logic
         *
         * Copyright (c) 2026 Angus Bergman
         * Licensed under CC BY-NC 4.0
         */

        // Global state
        let currentStep = 1;
        const totalSteps = 8;
        let setupData = {
            googlePlacesKey: null,
            homeLocation: null,
            workLocation: null,
            cafeLocation: null,
            detectedState: null,
            transitAuthority: null,
            calculatedJourney: null,
            bomStation: null,
            transitAPIKey: null,
            selectedDevice: null
        };

        // Transit authorities configuration
        const TRANSIT_AUTHORITIES = {
            'VIC': {
                name: 'Transport for Victoria',
                icon: 'üöä',
                modes: ['Metro Trains', 'Trams', 'Buses', 'V/Line'],
                apiRequired: 'Transport Victoria OpenData API',
                apiPortal: 'https://opendata.transport.vic.gov.au/',
                timezone: 'Australia/Melbourne'
            },
            'NSW': {
                name: 'Transport for NSW',
                icon: 'üöá',
                modes: ['Trains', 'Light Rail', 'Buses', 'Ferries'],
                apiRequired: 'Transport for NSW Open Data',
                apiPortal: 'https://opendata.transport.nsw.gov.au/',
                timezone: 'Australia/Sydney'
            },
            'QLD': {
                name: 'TransLink (Queensland)',
                icon: 'üöâ',
                modes: ['Trains', 'Buses', 'Ferries', 'Trams'],
                apiRequired: 'TransLink GTFS',
                apiPortal: 'https://www.data.qld.gov.au/',
                timezone: 'Australia/Brisbane'
            },
            'SA': {
                name: 'Adelaide Metro',
                icon: 'üöÜ',
                modes: ['Trains', 'Trams', 'Buses'],
                apiRequired: 'Adelaide Metro API',
                apiPortal: 'https://data.sa.gov.au/',
                timezone: 'Australia/Adelaide'
            },
            'WA': {
                name: 'Transperth',
                icon: 'üöä',
                modes: ['Trains', 'Buses', 'Ferries'],
                apiRequired: 'Transperth API',
                apiPortal: 'https://www.transperth.wa.gov.au/',
                timezone: 'Australia/Perth'
            },
            'TAS': {
                name: 'Metro Tasmania',
                icon: 'üöå',
                modes: ['Buses'],
                apiRequired: 'Metro Tasmania API',
                apiPortal: 'https://www.metrotas.com.au/',
                timezone: 'Australia/Hobart'
            },
            'NT': {
                name: 'Transport NT',
                icon: 'üöç',
                modes: ['Buses'],
                apiRequired: 'Transport NT API',
                apiPortal: 'https://nt.gov.au/',
                timezone: 'Australia/Darwin'
            },
            'ACT': {
                name: 'Transport Canberra',
                icon: 'üöå',
                modes: ['Light Rail', 'Buses'],
                apiRequired: 'Transport Canberra API',
                apiPortal: 'https://www.transport.act.gov.au/',
                timezone: 'Australia/Sydney'
            }
        };

        // Supported devices
        const SUPPORTED_DEVICES = {
            'trmnl-og': {
                name: 'TRMNL OG (7.5")',
                resolution: { width: 800, height: 480 },
                orientation: 'landscape',
                format: 'PNG',
                colorDepth: '1-bit',
                refreshMethod: 'webhook',
                compatible: true
            },
            'kindle-pw5': {
                name: 'Kindle Paperwhite 5 (6.8")',
                resolution: { width: 1236, height: 1648 },
                orientation: 'portrait',
                format: 'HTML/PNG',
                colorDepth: '4-bit grayscale',
                refreshMethod: 'kiosk_browser',
                compatible: true
            },
            'kindle-pw3': {
                name: 'Kindle Paperwhite 3/4 (6")',
                resolution: { width: 758, height: 1024 },
                orientation: 'portrait',
                format: 'HTML/PNG',
                colorDepth: '4-bit grayscale',
                refreshMethod: 'kiosk_browser',
                compatible: true
            }
        };

        // Utility functions
        function showLoading(message) {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-box').style.display = 'block';
            hideLoading();
        }

        function hideError() {
            document.getElementById('error-box').style.display = 'none';
        }

        function showSuccessNotification(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-notification').style.display = 'block';
            document.getElementById('error-box').style.display = 'none'; // Hide any errors
            hideLoading();

            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideSuccessNotification();
            }, 5000);
        }

        function hideSuccessNotification() {
            document.getElementById('success-notification').style.display = 'none';
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                if (message) {
                    const paragraph = element.querySelector('p');
                    if (paragraph) {
                        paragraph.textContent = message;
                    }
                }
            }
        }

        function goToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });

            // Show target step
            const targetStep = stepNumber === 'dashboard' ?
                document.getElementById('dashboard') :
                document.getElementById(`step-${stepNumber}`);
            targetStep.classList.add('active');

            if (stepNumber !== 'dashboard') {
                currentStep = stepNumber;
                updateProgress();
            }

            // Scroll to top
            window.scrollTo(0, 0);

            hideError();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        // Step 1: Google Places API
        async function validateAndSaveGooglePlaces() {
            const apiKey = document.getElementById('google-places-key').value.trim();

            if (!apiKey) {
                showError('Please enter an API key or click Skip');
                return;
            }

            showLoading('Saving and testing Google Places API...');
            hideError();

            try {
                // Save and test using the working force-save endpoint
                const response = await fetch('/admin/apis/force-save-google-places', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Failed to save API key');
                }

                setupData.googlePlacesKey = apiKey;
                hideLoading();

                // Show success message with test results
                let successMsg = 'Google Places API configured successfully. Enhanced geocoding is now available.';
                if (result.testResult) {
                    if (result.testResult.success) {
                        successMsg += '<br><small>Test: ' + result.testResult.testAddress + ' found successfully</small>';
                    } else {
                        successMsg += '<br><small>Key saved (test inconclusive - will be used for address searches)</small>';
                    }
                }

                showSuccess('google-places-success', successMsg);

                setTimeout(() => {
                    goToStep(2);
                }, 1500);

            } catch (error) {
                showError('Failed to validate API key: ' + error.message);
            }
        }

        function skipGooglePlaces() {
            setupData.googlePlacesKey = null;
            goToStep(2);
        }

        // Step 2: Addresses
        async function geocodeAddress(type) {
            const inputId = `${type}-address`;
            const resultId = `${type}-result`;
            const address = document.getElementById(inputId).value.trim();

            if (!address) {
                showError('Please enter an address');
                return;
            }

            showLoading(`Finding ${type} location...`);
            hideError();

            try {
                const response = await fetch('/admin/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Could not find address');
                }

                // Store location
                setupData[`${type}Location`] = result;

                // Display result
                const resultDiv = document.getElementById(resultId);
                resultDiv.innerHTML = `
                    <strong>‚úì Found:</strong> ${result.formattedAddress}<br>
                    <small>Coordinates: ${result.lat.toFixed(4)}, ${result.lon.toFixed(4)}</small><br>
                    <small>Source: ${result.source}</small>
                `;
                resultDiv.classList.add('show');

                hideLoading();

                // Detect state from home address
                if (type === 'home' && !setupData.detectedState) {
                    detectState(result.lat, result.lon);
                }

                // Enable continue button if both home and work are set
                if (setupData.homeLocation && setupData.workLocation) {
                    document.getElementById('continue-transit').disabled = false;
                }

                // Set cafe name if cafe geocoded
                if (type === 'cafe' && result.businessName) {
                    document.getElementById('cafe-name').value = result.businessName;
                }

            } catch (error) {
                showError(`Failed to geocode ${type} address: ` + error.message);
            }
        }

        function detectState(lat, lon) {
            // Detect Australian state from coordinates
            // Simple bounding box detection
            let state = null;

            if (lat >= -39 && lat <= -34 && lon >= 140 && lon <= 150) {
                state = 'VIC';
            } else if (lat >= -38 && lat <= -28 && lon >= 140 && lon <= 154) {
                state = 'NSW';
            } else if (lat >= -29 && lat <= -9 && lon >= 138 && lon <= 154) {
                state = 'QLD';
            } else if (lat >= -39 && lat <= -26 && lon >= 129 && lon <= 141) {
                state = 'SA';
            } else if (lat >= -35 && lat <= -13 && lon >= 112 && lon <= 129) {
                state = 'WA';
            } else if (lat >= -44 && lat <= -39 && lon >= 144 && lon <= 149) {
                state = 'TAS';
            } else if (lat >= -26 && lat <= -10 && lon >= 129 && lon <= 138) {
                state = 'NT';
            } else if (lat >= -36 && lat <= -35 && lon >= 148 && lon <= 150) {
                state = 'ACT';
            }

            if (state && TRANSIT_AUTHORITIES[state]) {
                setupData.detectedState = state;
                setupData.transitAuthority = TRANSIT_AUTHORITIES[state];

                const stateDiv = document.getElementById('detected-state');
                stateDiv.style.display = 'block';
                document.getElementById('state-name').textContent = state;
                document.getElementById('transit-authority').textContent = TRANSIT_AUTHORITIES[state].name;
                document.getElementById('timezone').textContent = TRANSIT_AUTHORITIES[state].timezone;
            }
        }

        function proceedToTransit() {
            if (!setupData.homeLocation || !setupData.workLocation) {
                showError('Please geocode both home and work addresses');
                return;
            }

            if (!setupData.detectedState) {
                showError('Could not detect state from address. Please check your home address.');
                return;
            }

            goToStep(3);

            // Populate transit authority info
            const authority = setupData.transitAuthority;
            document.getElementById('authority-icon').textContent = authority.icon;
            document.getElementById('authority-name').textContent = authority.name;
            document.getElementById('state-detected').textContent = setupData.detectedState;
            document.getElementById('available-modes').textContent = authority.modes.join(', ');
        }

        // Step 3: Transit Authority
        function proceedToJourneyPlanning() {
            goToStep(4);

            // Show cafe info if cafe was geocoded in Step 2
            if (setupData.cafeLocation) {
                document.getElementById('cafe-info').style.display = 'block';
                document.getElementById('cafe-address-display').innerHTML = `
                    <strong>Cafe:</strong> ${setupData.cafeLocation.formattedAddress}<br>
                    <small>Source: ${setupData.cafeLocation.source}</small>
                `;
                document.getElementById('journey-no-cafe-note').style.display = 'none';
            } else {
                document.getElementById('cafe-info').style.display = 'none';
                document.getElementById('journey-no-cafe-note').style.display = 'block';
            }
        }

        // Step 4: Smart Journey Planning
        async function calculateJourney() {
            hideError();
            showLoading('Calculating optimal journey...');

            const workStartTime = document.getElementById('work-start-time').value;
            // Automatically include cafe if it was geocoded in Step 2
            const includeCafe = !!setupData.cafeLocation;
            const cafeDuration = 10; // Default 10 minutes for coffee

            console.log('Calculating journey:', {
                home: setupData.homeLocation,
                work: setupData.workLocation,
                cafe: setupData.cafeLocation,
                workStartTime,
                includeCafe
            });

            try {
                const response = await fetch('/admin/smart-journey/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        homeLocation: {
                            lat: setupData.homeLocation.lat,
                            lon: setupData.homeLocation.lon,
                            formattedAddress: setupData.homeLocation.formattedAddress
                        },
                        workLocation: {
                            lat: setupData.workLocation.lat,
                            lon: setupData.workLocation.lon,
                            formattedAddress: setupData.workLocation.formattedAddress
                        },
                        cafeLocation: includeCafe ? {
                            lat: setupData.cafeLocation.lat,
                            lon: setupData.cafeLocation.lon,
                            formattedAddress: setupData.cafeLocation.formattedAddress
                        } : null,
                        workStartTime,
                        cafeDuration,
                        transitAuthority: setupData.detectedState,
                        useFallbackData: true
                    })
                });

                const journey = await response.json();

                console.log('Journey response:', journey);

                if (!journey.success) {
                    throw new Error(journey.error || 'Failed to calculate journey');
                }

                setupData.calculatedJourney = journey;
                hideLoading();

                // Display journey visualization
                renderJourneyVisualization(journey);
                document.getElementById('journey-result').style.display = 'block';
                document.getElementById('journey-actions').style.display = 'flex';

            } catch (error) {
                hideLoading();
                showError('Failed to calculate journey: ' + error.message);
                console.error('Journey calculation error:', error);
            }
        }

        // Store journey options globally for recalculation
        let journeyOptions = null;

        function renderJourneyVisualization(result) {
            const resultDiv = document.getElementById('journey-result');

            // New format: result.journey contains the journey data
            const journey = result.journey || result;
            const segments = journey.segments || [];

            // Store options for customization
            journeyOptions = result.options || null;

            // Helper function to get icon for segment type
            const getSegmentIcon = (type, icon) => {
                if (icon) return icon;
                const icons = {
                    'walk': 'üö∂',
                    'wait': '‚è≥',
                    'transit': 'üöÜ',
                    'coffee': '‚òï'
                };
                return icons[type] || '‚Ä¢';
            };

            // Helper function to format segment display
            const formatSegment = (seg) => {
                const icon = getSegmentIcon(seg.type, seg.icon);
                let html = `<div class="journey-leg">`;

                if (seg.type === 'walk') {
                    html += `<div class="leg-mode">${icon} Walk</div>`;
                    html += `<div class="leg-details">`;
                    html += `<strong>${seg.from}</strong> ‚Üí <strong>${seg.to}</strong><br>`;
                    html += `${seg.minutes} minutes<br>`;
                    html += `Depart: ${seg.time}`;
                    html += `</div>`;
                } else if (seg.type === 'transit') {
                    html += `<div class="leg-mode">${icon} ${seg.mode}</div>`;
                    html += `<div class="leg-details">`;
                    html += `<strong>${seg.from}</strong> ‚Üí <strong>${seg.to}</strong><br>`;
                    html += `${seg.minutes} minutes<br>`;
                    html += `Depart: ${seg.time}<br>`;
                    if (seg.note) html += `<small style="color: #6366f1;">${seg.note}</small>`;
                    html += `</div>`;
                } else if (seg.type === 'coffee') {
                    html += `<div class="leg-mode">${icon} Coffee Stop</div>`;
                    html += `<div class="leg-details">`;
                    html += `<strong>${seg.location}</strong><br>`;
                    html += `${seg.minutes} minutes<br>`;
                    html += `Time: ${seg.time}`;
                    html += `</div>`;
                } else if (seg.type === 'wait') {
                    html += `<div class="leg-mode">${icon} Buffer</div>`;
                    html += `<div class="leg-details">`;
                    html += `<strong>${seg.location}</strong><br>`;
                    html += `${seg.minutes} minutes buffer`;
                    html += `</div>`;
                }

                html += `</div>`;
                return html;
            };

            const segmentsHTML = segments.map(formatSegment).join('');

            resultDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <h3 style="margin: 0;">‚úì Your Optimized Journey</h3>
                    <span style="background: #4caf50; color: white; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">PREFERRED ROUTE</span>
                </div>
                <div style="margin-top: 20px;">
                    ${segmentsHTML}
                </div>
                <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px; border: 2px solid #4caf50;">
                    <h4>Summary</h4>
                    <p><strong>üè† Leave home:</strong> ${journey.departureTime}</p>
                    <p><strong>üè¢ Arrive at work:</strong> ${journey.arrivalTime}</p>
                    <p><strong>‚è±Ô∏è Total journey time:</strong> ${journey.totalMinutes} minutes</p>
                    ${journey.route ? `<p><strong>üöÜ Transit mode:</strong> ${journey.route.icon} ${journey.route.mode}</p>` : ''}
                    ${journey.route ? `<p><strong>üìç Route:</strong> ${journey.route.from || 'Home Stop'} ‚Üí ${journey.route.to || 'Work Stop'}</p>` : ''}
                    ${journey.cafe?.included ? `<p><strong>‚òï Coffee stop:</strong> ${journey.cafe.durationMinutes} minutes</p>` : ''}
                </div>
                <div style="margin-top: 15px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                    <p style="margin: 0; font-size: 13px;">
                        <strong>üí° Note:</strong> This is your <strong>preferred route</strong> based on optimal timing and convenience.
                        ${journeyOptions && journeyOptions.alternativeRoutes?.length > 0 ?
                            'You can customize stops or view alternative routes below.' :
                            'Journey times are estimated using fallback timetables. Configure Transport Victoria API in Step 6 for live departure times.'}
                    </p>
                </div>
            `;

            // Render customization options if available
            if (journeyOptions) {
                renderStopOptions();
            }
        }

        function renderStopOptions() {
            if (!journeyOptions) return;

            // Render home stop options
            const homeStopsDiv = document.getElementById('home-stop-options');
            homeStopsDiv.innerHTML = journeyOptions.homeStops.map(stop => `
                <div class="stop-option ${stop.selected ? 'selected' : ''}"
                     onclick="selectHomeStop('${stop.id}')"
                     data-stop-id="${stop.id}">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <span class="stop-icon">${stop.icon}</span>
                        <div class="stop-info">
                            <div class="stop-name">${stop.name}</div>
                            <div class="stop-details">${stop.distance}m away ‚Ä¢ ${stop.walkingMinutes} min walk ‚Ä¢ ${stop.mode}</div>
                        </div>
                    </div>
                    ${stop.selected ? '<span class="stop-badge">Selected</span>' : ''}
                </div>
            `).join('');

            // Render work stop options
            const workStopsDiv = document.getElementById('work-stop-options');
            workStopsDiv.innerHTML = journeyOptions.workStops.map(stop => `
                <div class="stop-option ${stop.selected ? 'selected' : ''}"
                     onclick="selectWorkStop('${stop.id}')"
                     data-stop-id="${stop.id}">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <span class="stop-icon">${stop.icon}</span>
                        <div class="stop-info">
                            <div class="stop-name">${stop.name}</div>
                            <div class="stop-details">${stop.distance}m away ‚Ä¢ ${stop.walkingMinutes} min walk ‚Ä¢ ${stop.mode}</div>
                        </div>
                    </div>
                    ${stop.selected ? '<span class="stop-badge">Selected</span>' : ''}
                </div>
            `).join('');

            // Render alternative routes if available
            if (journeyOptions.alternativeRoutes && journeyOptions.alternativeRoutes.length > 0) {
                const altRoutesDiv = document.getElementById('alternative-routes');
                const altRoutesList = document.getElementById('alternative-routes-list');

                altRoutesList.innerHTML = `
                    <div style="margin-bottom: 15px; padding: 12px; background: rgba(99, 102, 241, 0.05); border-left: 3px solid #6366f1; border-radius: 4px;">
                        <p style="margin: 0; font-size: 14px; color: #1e293b;">
                            <strong>‚ÑπÔ∏è Other Available Routes:</strong> These alternatives use different transit modes or stops.
                            Click any route to make it your preferred route.
                        </p>
                    </div>
                    ${journeyOptions.alternativeRoutes.map((alt, index) => `
                        <div class="alternative-route"
                             onclick="selectAlternativeRoute('${alt.originStopId}', '${alt.destinationStopId}')"
                             style="position: relative;">
                            <span style="position: absolute; top: 10px; right: 10px; background: rgba(99, 102, 241, 0.1); color: #6366f1; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">
                                ALTERNATIVE ${index + 1}
                            </span>
                            <div class="alternative-route-header">
                                <span>${alt.icon} ${alt.mode}</span>
                                <span style="color: #667eea;">${alt.totalMinutes} min total</span>
                            </div>
                            <div class="alternative-route-details">
                                <span><strong>From:</strong> ${alt.originStopName}</span>
                                <span>‚Ä¢</span>
                                <span><strong>To:</strong> ${alt.destinationStopName}</span>
                            </div>
                            <div class="alternative-route-details" style="margin-top: 5px;">
                                <span>Transit: ${alt.transitMinutes} min</span>
                                <span>‚Ä¢</span>
                                <span>Walking: ${alt.walkingMinutes} min</span>
                            </div>
                            <div style="margin-top: 8px; font-size: 12px; color: #6366f1; font-weight: 500;">
                                ‚Üí Click to make this your preferred route
                            </div>
                        </div>
                    `).join('')}
                `;

                altRoutesDiv.style.display = 'block';
            } else {
                document.getElementById('alternative-routes').style.display = 'none';
            }
        }

        // Track selected stops
        let selectedHomeStopId = null;
        let selectedWorkStopId = null;

        function selectHomeStop(stopId) {
            selectedHomeStopId = stopId;

            // Update UI to show selection
            document.querySelectorAll('#home-stop-options .stop-option').forEach(el => {
                if (el.dataset.stopId === stopId) {
                    el.classList.add('selected');
                    if (!el.querySelector('.stop-badge')) {
                        el.insertAdjacentHTML('beforeend', '<span class="stop-badge">Selected</span>');
                    }
                } else {
                    el.classList.remove('selected');
                    const badge = el.querySelector('.stop-badge');
                    if (badge) badge.remove();
                }
            });
        }

        function selectWorkStop(stopId) {
            selectedWorkStopId = stopId;

            // Update UI to show selection
            document.querySelectorAll('#work-stop-options .stop-option').forEach(el => {
                if (el.dataset.stopId === stopId) {
                    el.classList.add('selected');
                    if (!el.querySelector('.stop-badge')) {
                        el.insertAdjacentHTML('beforeend', '<span class="stop-badge">Selected</span>');
                    }
                } else {
                    el.classList.remove('selected');
                    const badge = el.querySelector('.stop-badge');
                    if (badge) badge.remove();
                }
            });
        }

        function selectAlternativeRoute(originStopId, destinationStopId) {
            selectedHomeStopId = originStopId;
            selectedWorkStopId = destinationStopId;

            // Update UI
            selectHomeStop(originStopId);
            selectWorkStop(destinationStopId);

            // Auto-recalculate
            recalculateWithSelectedStops();
        }

        function toggleCustomize() {
            const customizeDiv = document.getElementById('journey-customize');
            const isVisible = customizeDiv.style.display !== 'none';

            if (isVisible) {
                customizeDiv.style.display = 'none';
            } else {
                customizeDiv.style.display = 'block';
                // Scroll to customization section
                customizeDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        async function recalculateWithSelectedStops() {
            if (!selectedHomeStopId || !selectedWorkStopId) {
                showError('Please select both a home stop and a work stop');
                return;
            }

            hideError();
            showLoading('Recalculating journey with selected stops...');

            const workStartTime = document.getElementById('work-start-time').value;
            const includeCafe = !!setupData.cafeLocation;
            const cafeDuration = 8;

            try {
                const response = await fetch('/admin/smart-journey/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        homeLocation: {
                            lat: setupData.homeLocation.lat,
                            lon: setupData.homeLocation.lon,
                            formattedAddress: setupData.homeLocation.formattedAddress
                        },
                        workLocation: {
                            lat: setupData.workLocation.lat,
                            lon: setupData.workLocation.lon,
                            formattedAddress: setupData.workLocation.formattedAddress
                        },
                        cafeLocation: includeCafe ? {
                            lat: setupData.cafeLocation.lat,
                            lon: setupData.cafeLocation.lon,
                            formattedAddress: setupData.cafeLocation.formattedAddress
                        } : null,
                        workStartTime,
                        cafeDuration,
                        transitAuthority: setupData.detectedState,
                        useFallbackData: true,
                        selectedStops: {
                            originStopId: selectedHomeStopId,
                            destinationStopId: selectedWorkStopId
                        }
                    })
                });

                const journey = await response.json();

                if (!journey.success) {
                    throw new Error(journey.error || 'Failed to calculate journey');
                }

                setupData.calculatedJourney = journey;
                hideLoading();

                // Display updated journey
                renderJourneyVisualization(journey);
                document.getElementById('journey-result').style.display = 'block';

                // Hide customize panel after recalculation
                document.getElementById('journey-customize').style.display = 'none';

                // Show success message
                showSuccessNotification('Journey recalculated with your selected stops!');

            } catch (error) {
                hideLoading();
                showError('Failed to recalculate journey: ' + error.message);
                console.error('Journey recalculation error:', error);
            }
        }

        function acceptJourney() {
            if (!setupData.calculatedJourney) {
                showError('Please calculate a journey first');
                return;
            }

            goToStep(5);

            // Setup BOM weather data
            setupBOMData();
        }

        // Step 5: BOM Weather Data
        async function setupBOMData() {
            showLoading('Finding closest weather station...');

            try {
                const response = await fetch('/admin/bom/find-station', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: setupData.homeLocation.lat,
                        lon: setupData.homeLocation.lon
                    })
                });

                const result = await response.json();

                setupData.bomStation = result;
                hideLoading();

                const bomDiv = document.getElementById('bom-result');
                bomDiv.style.display = 'block';
                bomDiv.innerHTML = `
                    <div class="success-box">
                        <h4>‚úì Weather Station Found</h4>
                        <p><strong>Station:</strong> ${result.stationName || 'Unknown'}</p>
                        <p><strong>Distance:</strong> ${result.distance ? result.distance.toFixed(1) : 'N/A'} km from your home</p>
                        ${result.current ? `<p><strong>Current conditions:</strong> ${result.current.temp}¬∞C, ${result.current.description}</p>` : ''}
                    </div>
                `;

            } catch (error) {
                console.error('BOM setup error:', error);
                // Non-critical, continue anyway
                const bomDiv = document.getElementById('bom-result');
                bomDiv.style.display = 'block';
                bomDiv.innerHTML = `
                    <div class="warning-box">
                        <p>‚ö†Ô∏è Could not connect to BOM weather service. Weather data will be unavailable.</p>
                    </div>
                `;
            }
        }

        function proceedToTransitAPI() {
            goToStep(6);

            // Populate transit API info
            const authority = setupData.transitAuthority;
            document.getElementById('transit-api-name').textContent = authority.name;
            document.getElementById('transit-api-label').textContent = authority.name;
            document.getElementById('transit-api-link').href = authority.apiPortal;
        }

        // Step 6: Transit API
        async function validateTransitAPI() {
            const apiKey = document.getElementById('transit-api-key').value.trim();

            if (!apiKey) {
                showError('Please enter an API key or click Skip');
                return;
            }

            showLoading('Testing transit API...');
            hideError();

            try {
                const response = await fetch('/admin/transit/validate-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        state: setupData.detectedState,
                        apiKey
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Invalid API key');
                }

                setupData.transitAPIKey = apiKey;
                hideLoading();

                showSuccess('google-places-success', 'Live transit data enabled!');

                setTimeout(() => {
                    goToStep(7);
                }, 1500);

            } catch (error) {
                showError('Failed to validate API key: ' + error.message);
            }
        }

        function skipTransitAPI() {
            setupData.transitAPIKey = null;
            goToStep(7);
        }

        // Step 7: Device Selection
        function selectDevice(deviceId) {
            const device = SUPPORTED_DEVICES[deviceId];

            if (!device.compatible) {
                showError(`${device.name} is not yet compatible. Please select another device.`);
                return;
            }

            setupData.selectedDevice = deviceId;

            // Update radio selection
            document.getElementById(`device-${deviceId}`).checked = true;

            // Show device info
            const infoDiv = document.getElementById('device-info');
            infoDiv.style.display = 'block';
            infoDiv.innerHTML = `
                <h4>Selected: ${device.name}</h4>
                <p><strong>Resolution:</strong> ${device.resolution.width}√ó${device.resolution.height}</p>
                <p><strong>Orientation:</strong> ${device.orientation}</p>
                <p><strong>Format:</strong> ${device.format}</p>
                <p><strong>Refresh Method:</strong> ${device.refreshMethod}</p>
            `;

            // Enable complete button
            document.getElementById('complete-setup-btn').disabled = false;
        }

        // Step 8: Complete Setup
        async function completeSetup() {
            if (!setupData.selectedDevice) {
                showError('Please select a device');
                return;
            }

            showLoading('Saving configuration...');
            hideError();

            try {
                // Save all configuration
                const response = await fetch('/admin/setup/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(setupData)
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to save configuration');
                }

                hideLoading();
                goToStep(8);

                // Show setup summary
                renderSetupSummary();

                // Show QR code if TRMNL device
                if (setupData.selectedDevice.startsWith('trmnl')) {
                    showQRCode();
                }

                // Add setup logs
                addSetupLog('info', 'Configuration saved successfully');
                addSetupLog('success', 'System ready for operation');

                // Redirect to dashboard after 3 seconds
                if (result.redirectTo) {
                    addSetupLog('info', 'Redirecting to dashboard...');
                    setTimeout(() => {
                        window.location.href = result.redirectTo;
                    }, 3000);
                }

            } catch (error) {
                showError('Failed to complete setup: ' + error.message);
            }
        }

        function renderSetupSummary() {
            const summaryDiv = document.getElementById('setup-summary');
            const authority = setupData.transitAuthority;
            const device = SUPPORTED_DEVICES[setupData.selectedDevice];

            summaryDiv.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    <div><span style="font-weight: 600;">üó∫Ô∏è Geocoding:</span> ${setupData.googlePlacesKey ? 'Google Places API (New)' : 'Free Nominatim'}</div>
                    <div><span style="font-weight: 600;">üöÇ Transit Authority:</span> ${authority.name}</div>
                    <div><span style="font-weight: 600;">üîë Real-time Data:</span> ${setupData.transitAPIKey ? 'Enabled' : 'Using Fallback'}</div>
                    <div><span style="font-weight: 600;">üß† Smart Journey:</span> Calculated</div>
                    <div><span style="font-weight: 600;">üå§Ô∏è Weather:</span> ${setupData.bomStation ? 'BOM ' + setupData.bomStation.stationName : 'Not configured'}</div>
                    <div><span style="font-weight: 600;">üì± Device:</span> ${device.name}</div>
                </div>
            `;
        }

        function showQRCode() {
            const qrPanel = document.getElementById('qr-code-panel');
            qrPanel.style.display = 'block';

            // Generate QR code URL
            const serverUrl = window.location.origin;
            const qrUrl = `/api/qr?url=${encodeURIComponent(serverUrl + '/api/screen')}`;

            document.getElementById('device-qr').src = qrUrl;
        }

        function addSetupLog(level, message) {
            const logsDiv = document.getElementById('setup-logs');
            const timestamp = new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.innerHTML = `
                <span class="log-time">${timestamp}</span>
                <span class="log-level">[${level.toUpperCase()}]</span>
                <span class="log-message">${message}</span>
            `;

            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Dashboard
        function goToDashboard() {
            goToStep('dashboard');
            updateDashboard();
            startLiveUpdates();
        }

        function updateDashboard() {
            // Update journey panel
            if (setupData.calculatedJourney) {
                renderLiveJourney(setupData.calculatedJourney);
            }

            // Update device status
            updateDeviceStatus();

            // Update API keys list
            updateAPIKeysList();

            // Add initial logs
            addTechnicalLog('info', 'Dashboard initialized');
        }

        function renderLiveJourney(journey) {
            const journeyDiv = document.getElementById('live-journey');
            const legs = journey.legs || [];

            const legsHTML = legs.map(leg => `
                <div class="journey-leg">
                    <div class="leg-mode">${leg.mode}</div>
                    <div class="leg-details">
                        <strong>${leg.from}</strong> ‚Üí <strong>${leg.to}</strong><br>
                        ${leg.route ? `Route: ${leg.route}<br>` : ''}
                        Duration: ${leg.duration} min
                    </div>
                </div>
            `).join('');

            journeyDiv.innerHTML = legsHTML || '<p>No journey data available</p>';
        }

        function updateDeviceStatus() {
            const statusDiv = document.getElementById('device-status');
            const device = SUPPORTED_DEVICES[setupData.selectedDevice];

            const now = new Date();
            const nextRefresh = new Date(now.getTime() + 15 * 60 * 1000); // 15 min

            statusDiv.innerHTML = `
                <p><strong>Device:</strong> ${device.name}</p>
                <p><strong>Resolution:</strong> ${device.resolution.width}√ó${device.resolution.height}</p>
                <p><strong>Last Refresh:</strong> ${now.toLocaleTimeString()}</p>
                <p><strong>Next Refresh:</strong> ${nextRefresh.toLocaleTimeString()}</p>
                <p><strong>Status:</strong> <span style="color: #4caf50;">‚óè</span> Operational</p>
            `;
        }

        function updateAPIKeysList() {
            const listDiv = document.getElementById('api-keys-list');

            listDiv.innerHTML = `
                <div class="api-key-item ${setupData.googlePlacesKey ? 'active' : ''}">
                    <span class="api-icon">üó∫Ô∏è</span>
                    <span class="api-name">Google Places API</span>
                    <span class="api-status ${setupData.googlePlacesKey ? 'active' : 'inactive'}">
                        ${setupData.googlePlacesKey ? '‚úì Active' : '‚ö†Ô∏è Not Configured'}
                    </span>
                </div>

                <div class="api-key-item ${setupData.transitAPIKey ? 'active' : ''}">
                    <span class="api-icon">üöÇ</span>
                    <span class="api-name">${setupData.transitAuthority.name}</span>
                    <span class="api-status ${setupData.transitAPIKey ? 'active' : 'inactive'}">
                        ${setupData.transitAPIKey ? '‚úì Active' : '‚ö†Ô∏è Using Fallback'}
                    </span>
                </div>

                <div class="api-key-item ${setupData.bomStation ? 'active' : ''}">
                    <span class="api-icon">üå§Ô∏è</span>
                    <span class="api-name">Bureau of Meteorology</span>
                    <span class="api-status ${setupData.bomStation ? 'active' : 'inactive'}">
                        ${setupData.bomStation ? '‚úì Active' : '‚ö†Ô∏è Not Configured'}
                    </span>
                </div>
            `;
        }

        function addTechnicalLog(level, message) {
            const logsDiv = document.getElementById('technical-logs');
            const timestamp = new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.innerHTML = `
                <span class="log-time">${timestamp}</span>
                <span class="log-level">[${level.toUpperCase()}]</span>
                <span class="log-message">${message}</span>
            `;

            logsDiv.appendChild(logEntry);

            // Keep last 50 logs
            while (logsDiv.children.length > 50) {
                logsDiv.removeChild(logsDiv.firstChild);
            }

            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function startLiveUpdates() {
            // Update journey every 30 seconds
            setInterval(() => {
                addTechnicalLog('info', 'Updating journey data...');
                // In production, fetch live data from server
            }, 30000);

            // Update device status every minute
            setInterval(() => {
                updateDeviceStatus();
            }, 60000);
        }

        // Initialize
        updateProgress();
    </script>
</body>
</html>
