<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#1a2744">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commute Compute Firmware Simulator v6.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-size: 24px; margin-bottom: 8px; }
        header p { color: #888; font-size: 14px; }
        .main-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .display-panel { background: #2a2a3e; padding: 20px; border-radius: 12px; }
        .device-frame { background: #333; padding: 15px; border-radius: 8px; display: inline-block; position: relative; }
        .device-label { position: absolute; top: -10px; left: 10px; background: #333; padding: 2px 8px; font-size: 10px; color: #888; }
        #eink-display { width: 800px; height: 480px; background: #f5f5f0; border: 3px solid #1a1a1a; position: relative; overflow: hidden; image-rendering: pixelated; }
        #eink-canvas { width: 100%; height: 100%; image-rendering: pixelated; }
        .controls { background: #2a2a3e; padding: 20px; border-radius: 12px; }
        .controls h2 { font-size: 16px; margin-bottom: 15px; color: #4fb28e; }
        .section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #444; }
        .section h3 { font-size: 12px; color: #888; margin-bottom: 10px; text-transform: uppercase; }
        button { width: 100%; padding: 12px; margin-bottom: 8px; background: #4fb28e; border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; }
        button:hover { background: #4f46e5; }
        button.secondary { background: #444; }
        button.warning { background: #f59e0b; }
        button.success { background: #22c55e; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { padding: 10px; background: #1a1a2e; border-radius: 6px; font-family: monospace; font-size: 11px; margin-bottom: 10px; }
        .status .ok { color: #22c55e; }
        .status .error { color: #ef4444; }
        .status .warn { color: #f59e0b; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .log { max-height: 250px; overflow-y: auto; background: #0a0a15; padding: 10px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.4; }
        .log-entry { margin-bottom: 2px; white-space: pre-wrap; }
        .zones { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 10px; }
        .zone-card { padding: 8px; background: #1a1a2e; border-radius: 6px; font-size: 10px; border: 2px solid #333; }
        .zone-card.dirty { border-color: #f59e0b; }
        .zone-card.loaded { border-color: #22c55e; }
        .zone-card .name { font-weight: bold; margin-bottom: 4px; }
        .zone-card .meta { color: #666; }
        select, input { width: 100%; padding: 8px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #fff; margin-bottom: 8px; font-size: 12px; }
        .firmware-info { background: #0a0a15; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 10px; margin-bottom: 10px; }
        .memory-bar { height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .memory-bar .used { height: 100%; background: #22c55e; transition: width 0.3s; }
        .memory-bar .used.warn { background: #f59e0b; }
        .memory-bar .used.crit { background: #ef4444; }
        .checkbox-row { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 8px; }
        .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 14px; z-index: 10; }
        .overlay.hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÉ Commute Compute Firmware Simulator v6.0</h1>
            <p>Accurate firmware emulation - same zone fetching, BMP rendering, refresh timing & memory constraints</p>
        </header>
        
        <div class="main-layout">
            <div class="display-panel">
                <div class="device-frame">
                    <div class="device-label">TRMNL OG ‚Ä¢ ESP32-C3 ‚Ä¢ 800√ó480</div>
                    <div id="eink-display">
                        <canvas id="eink-canvas" width="800" height="480"></canvas>
                        <div class="overlay" id="overlay">Power off - click Boot Device</div>
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 20px; font-size: 12px; color: #888;">
                    <span>üìê 800√ó480 @ 1-bit BMP</span>
                    <span id="refresh-info">Full: 0 | Partial: 0</span>
                    <span id="last-refresh">Last: --</span>
                </div>
            </div>
            
            <div class="controls">
                <h2>‚öôÔ∏è Firmware Controls</h2>
                
                <div class="firmware-info">
                    <div><strong>=== Commute Compute v6.0 ===</strong></div>
                    <div>ESP32-C3 ‚Ä¢ 320KB RAM ‚Ä¢ 4MB Flash</div>
                    <div>bb_epaper 2.0.6 ‚Ä¢ WiFiManager 2.0.17</div>
                </div>
                
                <div class="section">
                    <h3>üîå Device Control</h3>
                    <button class="warning" onclick="bootDevice()" id="btn-boot">‚ö° Boot Device</button>
                    <button class="secondary" onclick="resetDevice()">üîÑ Factory Reset</button>
                </div>
                
                <div class="section">
                    <h3>üìù Setup Flow</h3>
                    <button class="success" onclick="runFullSetupFlow()">üöÄ Full Setup ‚Üí Dashboard</button>
                    <button class="warning" onclick="randomizeJourney()">üé≤ Randomize Journey</button>
                    <button class="secondary" onclick="showWelcomeScreen()">üëã Welcome Screen</button>
                    <button class="secondary" onclick="showWiFiSetupScreen()">üì∂ WiFi Setup Portal</button>
                    <button class="secondary" onclick="showConfiguredScreen()">‚úÖ Configured Screen</button>
                </div>
                
                <div class="section">
                    <h3>üîÑ Display Refresh</h3>
                    <button onclick="doRefresh(true)" id="btn-full">Full Refresh (5 min cycle)</button>
                    <button class="secondary" onclick="doRefresh(false)" id="btn-partial">Partial Refresh (20s)</button>
                    <div class="checkbox-row">
                        <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()">
                        <label for="auto-refresh">Auto-refresh (20s partial / 5min full)</label>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üåê Server Config</h3>
                    <input type="text" id="server-url" placeholder="Server URL">
                    <select id="demo-mode" onchange="markAllDirty()">
                        <option value="">Live Data</option>
                        <option value="normal">Demo: Normal Commute</option>
                        <option value="random">Demo: Random Journey (Fitzroy‚ÜíCBD)</option>
                        <option value="delay-skip-coffee">Demo: Delay (Skip Coffee)</option>
                        <option value="disruption">Demo: Service Disruption</option>
                        <option value="rain">Demo: Rainy Day</option>
                    </select>
                </div>
                
                <div class="section">
                    <h3>üì¶ Zone Status (like firmware)</h3>
                    <div class="zones" id="zone-cards"></div>
                </div>
                
                <div class="section">
                    <h3>üìä System Status</h3>
                    <div class="status">
                        <div class="info-row"><span>State:</span><span id="state">OFF</span></div>
                        <div class="info-row"><span>WiFi:</span><span id="wifi">Disconnected</span></div>
                        <div class="info-row"><span>Server:</span><span id="server">--</span></div>
                        <div class="info-row"><span>Errors:</span><span id="errors">0</span></div>
                        <div class="info-row"><span>Heap Used:</span><span id="heap">0 / 320 KB</span></div>
                        <div class="memory-bar"><div class="used" id="heap-bar" style="width:0%"></div></div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üìú Serial Monitor (115200 baud)</h3>
                    <div class="log" id="serial-log"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========== FIRMWARE CONSTANTS (match main-v6.cpp) ==========
        const FIRMWARE_VERSION = "6.0";
        const SCREEN_W = 800;
        const SCREEN_H = 480;
        const REFRESH_INTERVAL = 20000;      // 20 seconds
        const FULL_REFRESH_INTERVAL = 300000; // 5 minutes
        const MAX_PARTIAL_BEFORE_FULL = 30;
        const HEAP_TOTAL = 320 * 1024;       // 320KB
        const ZONE_BMP_MAX_SIZE = 40000;     // 40KB per zone
        
        // Zone definitions (match firmware)
        const ZONES = {
            header:  { id: 'header',  x: 0, y: 0,   w: 800, h: 96 },
            summary: { id: 'summary', x: 0, y: 96,  w: 800, h: 36 },
            legs:    { id: 'legs',    x: 0, y: 132, w: 800, h: 316 },
            footer:  { id: 'footer',  x: 0, y: 448, w: 800, h: 32 }
        };
        
        // ========== STATE ==========
        let state = 'OFF';
        let wifiConnected = false;
        let serverConfigured = false;
        let fullRefreshCount = 0;
        let partialRefreshCount = 0;
        let consecutiveErrors = 0;
        let heapUsed = 0;
        let lastFullRefresh = 0;
        let autoRefreshTimer = null;
        let zoneStates = {};
        
        const canvas = document.getElementById('eink-canvas');
        const ctx = canvas.getContext('2d');
        
        // ========== LOGGING ==========
        function log(msg, type = 'info') {
            const logEl = document.getElementById('serial-log');
            const time = new Date().toLocaleTimeString('en-AU', { hour12: false });
            const colors = { ok: '#22c55e', error: '#ef4444', warn: '#f59e0b', info: '#888' };
            logEl.innerHTML = `<div class="log-entry" style="color:${colors[type] || colors.info}">[${time}] ${msg}</div>` + logEl.innerHTML;
            if (logEl.children.length > 100) logEl.lastChild.remove();
        }
        
        function setState(newState) {
            state = newState;
            document.getElementById('state').textContent = newState;
        }
        
        function updateHeap(delta) {
            heapUsed = Math.max(0, Math.min(HEAP_TOTAL, heapUsed + delta));
            const pct = (heapUsed / HEAP_TOTAL * 100).toFixed(1);
            document.getElementById('heap').textContent = `${(heapUsed/1024).toFixed(0)} / 320 KB`;
            const bar = document.getElementById('heap-bar');
            bar.style.width = pct + '%';
            bar.className = 'used' + (pct > 80 ? ' crit' : pct > 60 ? ' warn' : '');
        }
        
        // ========== ZONE MANAGEMENT ==========
        function initZones() {
            Object.keys(ZONES).forEach(id => {
                zoneStates[id] = { loaded: false, dirty: true, data: null, size: 0 };
            });
            renderZoneCards();
        }
        
        function renderZoneCards() {
            const container = document.getElementById('zone-cards');
            container.innerHTML = Object.entries(ZONES).map(([id, z]) => {
                const s = zoneStates[id] || {};
                const cls = s.loaded ? 'loaded' : s.dirty ? 'dirty' : '';
                return `<div class="zone-card ${cls}">
                    <div class="name">${id}</div>
                    <div class="meta">${z.w}√ó${z.h} @ (${z.x},${z.y})</div>
                    <div class="meta">${s.size ? (s.size/1024).toFixed(1) + 'KB' : '--'}</div>
                </div>`;
            }).join('');
        }
        
        function markAllDirty() {
            Object.keys(zoneStates).forEach(id => {
                zoneStates[id].dirty = true;
                zoneStates[id].loaded = false;
            });
            renderZoneCards();
            log('All zones marked dirty');
        }
        
        // ========== BOOT SEQUENCE ==========
        async function bootDevice() {
            document.getElementById('btn-boot').disabled = true;
            document.getElementById('overlay').classList.add('hidden');
            
            // Clear display (like e-ink power on)
            ctx.fillStyle = '#f5f5f0';
            ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
            
            log('');
            log('=== Commute Compute v' + FIRMWARE_VERSION + ' ===', 'ok');
            setState('BOOT');
            
            // Simulate boot sequence
            log('WRITE_PERI_REG(RTC_CNTL_BROWN_OUT_REG, 0)');
            await sleep(100);
            
            log('Serial.begin(115200)');
            await sleep(200);
            
            log('Loading settings from NVS...');
            updateHeap(8192); // Preferences
            await sleep(300);
            
            log('Server URL: ' + document.getElementById('server-url').value);
            serverConfigured = true;
            
            log('Allocating BMP buffer (40KB)...');
            updateHeap(ZONE_BMP_MAX_SIZE);
            await sleep(200);
            
            log('initDisplay() - bb_epaper EP75_800x480');
            updateHeap(4096);
            await sleep(300);
            
            // Show welcome screen
            showWelcomeScreen();
            log('showWelcomeScreen()', 'ok');
            await sleep(2000);
            
            // Connect WiFi
            log('connectWiFi() - Starting WiFiManager...');
            setState('WIFI');
            await sleep(1000);
            log('WiFi connected! IP: 192.168.1.42', 'ok');
            wifiConnected = true;
            document.getElementById('wifi').textContent = 'Connected';
            document.getElementById('wifi').className = 'ok';
            
            log('Setup complete - entering loop()', 'ok');
            setState('RUNNING');
            
            // Initial fetch
            await doRefresh(true);
            
            document.getElementById('btn-boot').disabled = false;
        }
        
        function showWelcomeScreen() {
            ctx.fillStyle = '#f5f5f0';
            ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
            
            // Header bar
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 800, 60);
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('Commute Compute SMART TRANSIT DISPLAY', 400, 25);
            ctx.font = '12px monospace';
            ctx.fillText('v' + FIRMWARE_VERSION, 400, 45);
            
            // Setup box
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(80, 80, 640, 280);
            
            ctx.fillStyle = '#000';
            ctx.font = 'bold 14px monospace';
            ctx.fillText('FIRST TIME SETUP', 400, 110);
            
            ctx.font = '12px monospace';
            ctx.textAlign = 'left';
            ctx.fillText('1. Connect to WiFi: Commute Compute-Setup', 100, 150);
            ctx.fillText('   Password: transport123', 100, 170);
            ctx.fillText('2. Open browser: 192.168.4.1', 100, 200);
            ctx.fillText('3. Select your WiFi and enter password', 100, 230);
            ctx.fillText('4. Server: ' + window.location.host, 100, 260);
            ctx.fillText('5. Save and wait for dashboard', 100, 290);
            
            ctx.textAlign = 'center';
            ctx.font = '10px monospace';
            ctx.fillText('¬© 2026 Angus Bergman ‚Ä¢ CC BY-NC 4.0', 400, 450);
            log('showWelcomeScreen() rendered');
        }
        
        function showWiFiSetupScreen() {
            document.getElementById('overlay').classList.add('hidden');
            ctx.fillStyle = '#f5f5f0';
            ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
            
            // Header bar
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 800, 60);
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('Commute Compute SMART TRANSIT DISPLAY', 400, 25);
            ctx.font = '12px monospace';
            ctx.fillText('WiFi Setup Mode', 400, 45);
            
            ctx.fillStyle = '#000';
            ctx.font = 'bold 18px monospace';
            ctx.fillText('üì∂ WiFi CONFIGURATION', 400, 100);
            
            // AP Info box
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.strokeRect(200, 130, 400, 120);
            
            ctx.font = 'bold 14px monospace';
            ctx.fillText('Connect to this network:', 400, 160);
            
            ctx.font = 'bold 20px monospace';
            ctx.fillText('Commute Compute-Setup', 400, 195);
            
            ctx.font = '14px monospace';
            ctx.fillText('Password: transport123', 400, 230);
            
            // Instructions
            ctx.font = '12px monospace';
            ctx.textAlign = 'left';
            ctx.fillText('Then open your browser to:', 200, 290);
            ctx.font = 'bold 16px monospace';
            ctx.fillText('http://192.168.4.1', 200, 315);
            
            ctx.font = '12px monospace';
            ctx.fillText('‚Ä¢ Select your home WiFi network', 200, 360);
            ctx.fillText('‚Ä¢ Enter your WiFi password', 200, 380);
            ctx.fillText('‚Ä¢ Server URL: ' + window.location.host, 200, 400);
            ctx.fillText('‚Ä¢ Click Save and wait for dashboard', 200, 420);
            
            ctx.textAlign = 'center';
            ctx.font = '10px monospace';
            ctx.fillText('¬© 2026 Angus Bergman ‚Ä¢ CC BY-NC 4.0', 400, 465);
            log('showWiFiSetupScreen() rendered');
        }
        
        function showConfiguredScreen() {
            document.getElementById('overlay').classList.add('hidden');
            ctx.fillStyle = '#f5f5f0';
            ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
            
            // Header bar
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 800, 60);
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('Commute Compute SMART TRANSIT DISPLAY', 400, 25);
            ctx.font = '12px monospace';
            ctx.fillText('v' + FIRMWARE_VERSION + ' ‚Ä¢ Setup Complete', 400, 45);
            
            // Big checkmark
            ctx.fillStyle = '#000';
            ctx.font = 'bold 80px monospace';
            ctx.fillText('‚úì', 400, 180);
            
            ctx.font = 'bold 24px monospace';
            ctx.fillText('SETUP COMPLETE', 400, 230);
            
            // Config details box
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(150, 260, 500, 150);
            
            ctx.font = '14px monospace';
            ctx.textAlign = 'left';
            ctx.fillText('‚úì WiFi: Connected (192.168.1.42)', 170, 290);
            ctx.fillText('‚úì Server: ' + window.location.host, 170, 315);
            ctx.fillText('‚úì Home: 42 Brunswick St, Fitzroy', 170, 340);
            ctx.fillText('‚úì Work: 200 Bourke St, Melbourne', 170, 365);
            ctx.fillText('‚úì Cafe: Industry Beans, Rose St', 170, 390);
            
            ctx.textAlign = 'center';
            ctx.font = 'bold 14px monospace';
            ctx.fillText('Dashboard will appear shortly...', 400, 440);
            
            ctx.font = '10px monospace';
            ctx.fillText('¬© 2026 Angus Bergman ‚Ä¢ CC BY-NC 4.0', 400, 465);
            
            log('showConfiguredScreen() - Valid setup details rendered', 'ok');
            setState('CONFIGURED');
        }
        
        // ========== FULL SETUP FLOW ==========
        async function runFullSetupFlow() {
            document.getElementById('overlay').classList.add('hidden');
            log('');
            log('=== STARTING FULL SETUP FLOW ===', 'ok');
            
            // Step 1: Welcome screen
            log('Step 1: Showing welcome screen...');
            showWelcomeScreen();
            await sleep(2000);
            
            // Step 2: WiFi setup
            log('Step 2: WiFi configuration...');
            showWiFiSetupScreen();
            await sleep(2000);
            
            // Step 3: Connecting animation
            log('Step 3: Connecting to WiFi...');
            ctx.fillStyle = '#f5f5f0';
            ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
            ctx.fillStyle = '#000';
            ctx.font = 'bold 24px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('üì∂ Connecting to WiFi...', 400, 200);
            ctx.font = '14px monospace';
            ctx.fillText('Network: HomeWiFi-5G', 400, 240);
            await sleep(1500);
            
            // Step 4: Validating
            log('Step 4: Validating setup data...', 'ok');
            ctx.fillStyle = '#f5f5f0';
            ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
            ctx.fillStyle = '#000';
            ctx.font = 'bold 24px monospace';
            ctx.fillText('‚öôÔ∏è Validating Configuration...', 400, 200);
            ctx.font = '14px monospace';
            ctx.fillText('Checking server connection...', 400, 240);
            await sleep(1000);
            ctx.fillText('Verifying addresses...', 400, 270);
            await sleep(1000);
            ctx.fillText('Loading journey data...', 400, 300);
            await sleep(1000);
            
            // Step 5: Configured
            log('Step 5: Setup validated!', 'ok');
            showConfiguredScreen();
            await sleep(2000);
            
            // Step 6: Load dashboard
            log('Step 6: Loading dashboard...', 'ok');
            wifiConnected = true;
            serverConfigured = true;
            document.getElementById('wifi').textContent = 'Connected';
            document.getElementById('wifi').className = 'ok';
            setState('RUNNING');
            
            await doRefresh(true);
            log('=== SETUP FLOW COMPLETE ===', 'ok');
        }
        
        // ========== RANDOMIZE JOURNEY ==========
        const RANDOM_HOMES = [
            '42 Brunswick St, Fitzroy',
            '15 Chapel St, Windsor',
            '88 Smith St, Collingwood',
            '120 Acland St, St Kilda',
            '7 Lygon St, Carlton',
            '33 Swan St, Richmond',
            '56 High St, Northcote',
            '21 Glenferrie Rd, Hawthorn'
        ];
        
        const RANDOM_WORKS = [
            '200 Bourke St, Melbourne',
            '80 Collins St, Melbourne',
            '525 Collins St, Melbourne',
            '101 Collins St, Melbourne',
            '385 Bourke St, Melbourne',
            '55 King St, Melbourne',
            '717 Bourke St, Docklands',
            '1 Nicholson St, East Melbourne'
        ];
        
        const RANDOM_CAFES = [
            'Industry Beans, Rose St',
            'Proud Mary, Oxford St',
            'Seven Seeds, Berkeley St',
            'Patricia Coffee, Little William St',
            'Market Lane, Collins St',
            'St Ali, Yarra Place',
            'Axil Coffee, Burwood Rd',
            'Code Black, Weston St'
        ];
        
        const RANDOM_TRAM_ROUTES = ['86', '96', '11', '12', '109', '70', '75', '19'];
        const RANDOM_TRAIN_LINES = ['Sandringham', 'Frankston', 'Craigieburn', 'South Morang', 'Werribee', 'Belgrave'];
        const RANDOM_BUS_ROUTES = ['200', '220', '246', '302', '401', '506', '703', '905'];
        
        async function randomizeJourney() {
            log('');
            log('=== RANDOMIZE JOURNEY (SmartJourney Engine) ===', 'ok');
            log('Calling /api/screen?random=1 ...');
            
            document.getElementById('overlay').classList.add('hidden');
            ctx.fillStyle = '#f5f5f0';
            ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
            ctx.fillStyle = '#000';
            ctx.font = 'bold 24px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('üé≤ Generating Random Journey...', 400, 200);
            ctx.font = '14px monospace';
            ctx.fillText('Using SmartJourney Engine', 400, 240);
            
            const server = document.getElementById('server-url').value;
            
            try {
                const response = await fetch(`${server}/api/screen?random=1`);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                // Log journey metadata from headers
                const origin = response.headers.get('X-Journey-Origin') || 'Unknown';
                const dest = response.headers.get('X-Journey-Dest') || 'Unknown';
                const legs = response.headers.get('X-Journey-Legs') || '?';
                const transit = response.headers.get('X-Journey-Transit') || 'mixed';
                
                log(`Origin: ${origin}`, 'ok');
                log(`Destination: ${dest}`, 'ok');
                log(`Legs: ${legs}, Transit: ${transit}`, 'ok');
                
                const blob = await response.blob();
                const imgUrl = URL.createObjectURL(blob);
                
                // Full refresh animation
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
                await sleep(150);
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
                await sleep(150);
                
                // Draw the dashboard
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, SCREEN_W, SCREEN_H);
                    URL.revokeObjectURL(imgUrl);
                    log('Random journey rendered via V10 Live Render!', 'ok');
                };
                img.src = imgUrl;
                
                fullRefreshCount++;
                document.getElementById('refresh-info').textContent = `Full: ${fullRefreshCount} | Partial: ${partialRefreshCount}`;
                document.getElementById('last-refresh').textContent = `Last: ${new Date().toLocaleTimeString()}`;
                
                wifiConnected = true;
                serverConfigured = true;
                document.getElementById('wifi').textContent = 'Connected';
                document.getElementById('wifi').className = 'ok';
                document.getElementById('server').textContent = 'OK';
                document.getElementById('server').className = 'ok';
                setState('RUNNING');
                
            } catch (err) {
                log(`Error: ${err.message}`, 'error');
                ctx.fillStyle = '#f5f5f0';
                ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
                ctx.fillStyle = '#000';
                ctx.font = 'bold 18px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('‚ùå Failed to generate journey', 400, 220);
                ctx.font = '14px monospace';
                ctx.fillText(err.message, 400, 250);
            }
        }
        
        // ========== REFRESH LOGIC (matches firmware) ==========
        async function doRefresh(full = false) {
            if (state !== 'RUNNING') return;
            
            const now = Date.now();
            
            // Force full refresh if too many partials
            if (!full && partialRefreshCount >= MAX_PARTIAL_BEFORE_FULL) {
                log('MAX_PARTIAL_BEFORE_FULL reached - forcing full refresh', 'warn');
                full = true;
            }
            
            // Force full if interval exceeded
            if (!full && lastFullRefresh && (now - lastFullRefresh > FULL_REFRESH_INTERVAL)) {
                log('FULL_REFRESH_INTERVAL exceeded - forcing full refresh', 'warn');
                full = true;
            }
            
            setState('FETCHING');
            const server = document.getElementById('server-url').value;
            const demo = document.getElementById('demo-mode').value;
            
            log(`fetchZoneUpdates(forceAll=${full})`);
            
            try {
                // Step 1: Fetch zone metadata (lightweight)
                const metaUrl = `${server}/api/zones?metadata=1${demo ? '&demo=' + demo : ''}`;
                log(`GET ${metaUrl}`);
                updateHeap(2048); // HTTP client
                
                const metaResp = await fetch(metaUrl);
                if (!metaResp.ok) throw new Error(`HTTP ${metaResp.status}`);
                
                const metadata = await metaResp.json();
                log(`Zone metadata: ${JSON.stringify(metadata.zones || [])}`, 'ok');
                
                document.getElementById('server').textContent = 'OK';
                document.getElementById('server').className = 'ok';
                
                // Step 2: Fetch each zone BMP
                const zonesToFetch = full ? Object.keys(ZONES) : (metadata.zones || Object.keys(ZONES));
                
                for (const zoneId of zonesToFetch) {
                    if (!ZONES[zoneId]) continue;
                    
                    const zone = ZONES[zoneId];
                    const zoneUrl = `${server}/api/zone/${zoneId}${demo ? '?demo=' + demo : ''}`;
                    
                    log(`Fetching zone: ${zoneId} (${zone.w}x${zone.h})`);
                    
                    const zoneResp = await fetch(zoneUrl);
                    if (!zoneResp.ok) {
                        log(`Zone ${zoneId} failed: HTTP ${zoneResp.status}`, 'error');
                        continue;
                    }
                    
                    const bmpBlob = await zoneResp.blob();
                    const bmpSize = bmpBlob.size;
                    
                    zoneStates[zoneId] = { loaded: true, dirty: false, size: bmpSize };
                    log(`Zone ${zoneId}: ${(bmpSize/1024).toFixed(1)}KB BMP loaded`, 'ok');
                    
                    // Draw zone to canvas
                    await drawZoneBMP(bmpBlob, zone);
                    updateHeap(bmpSize);
                    await sleep(50); // Simulate processing time
                    updateHeap(-bmpSize); // Free after draw
                }
                
                renderZoneCards();
                
                // Step 3: Refresh display
                if (full) {
                    await doFullRefreshAnimation();
                    fullRefreshCount++;
                    partialRefreshCount = 0;
                    lastFullRefresh = now;
                } else {
                    partialRefreshCount++;
                }
                
                document.getElementById('refresh-info').textContent = `Full: ${fullRefreshCount} | Partial: ${partialRefreshCount}`;
                document.getElementById('last-refresh').textContent = `Last: ${new Date().toLocaleTimeString()}`;
                
                consecutiveErrors = 0;
                document.getElementById('errors').textContent = '0';
                
                log(`Display refreshed (${full ? 'FULL' : 'PARTIAL'})`, 'ok');
                
            } catch (err) {
                consecutiveErrors++;
                document.getElementById('errors').textContent = consecutiveErrors;
                document.getElementById('errors').className = 'error';
                log(`ERROR: ${err.message}`, 'error');
                
                // Exponential backoff
                if (consecutiveErrors > 1) {
                    const backoff = Math.min(30000, 1000 * Math.pow(2, consecutiveErrors - 1));
                    log(`Backoff: ${backoff}ms before retry`, 'warn');
                }
            }
            
            updateHeap(-2048); // Free HTTP client
            setState('RUNNING');
        }
        
        async function drawZoneBMP(blob, zone) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, zone.x, zone.y, zone.w, zone.h);
                    URL.revokeObjectURL(img.src);
                    resolve();
                };
                img.onerror = () => {
                    log(`BMP decode error for zone at (${zone.x},${zone.y})`, 'error');
                    resolve();
                };
                img.src = URL.createObjectURL(blob);
            });
        }
        
        async function doFullRefreshAnimation() {
            // Simulate e-ink full refresh (flash black/white/black/white)
            log('bbep.refresh(REFRESH_FULL, true)');
            
            const overlay = document.getElementById('overlay');
            overlay.textContent = 'FULL REFRESH';
            overlay.classList.remove('hidden');
            overlay.style.background = '#000';
            await sleep(150);
            overlay.style.background = '#fff';
            await sleep(150);
            overlay.style.background = '#000';
            await sleep(150);
            overlay.classList.add('hidden');
        }
        
        // ========== AUTO REFRESH ==========
        function toggleAutoRefresh() {
            if (document.getElementById('auto-refresh').checked) {
                if (state !== 'RUNNING') {
                    document.getElementById('auto-refresh').checked = false;
                    log('Cannot enable auto-refresh - device not running', 'warn');
                    return;
                }
                log('Auto-refresh enabled (20s partial, 5min full)', 'ok');
                autoRefreshTimer = setInterval(() => doRefresh(false), REFRESH_INTERVAL);
            } else {
                log('Auto-refresh disabled');
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }
        
        // ========== RESET ==========
        function resetDevice() {
            log('');
            log('=== FACTORY RESET ===', 'error');
            log('preferences.clear()');
            log('WiFi.disconnect(true, true)');
            
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
            document.getElementById('auto-refresh').checked = false;
            
            state = 'OFF';
            wifiConnected = false;
            serverConfigured = false;
            fullRefreshCount = 0;
            partialRefreshCount = 0;
            consecutiveErrors = 0;
            heapUsed = 0;
            lastFullRefresh = 0;
            
            initZones();
            
            ctx.fillStyle = '#888';
            ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);
            
            document.getElementById('overlay').textContent = 'Power off - click Boot Device';
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('overlay').style.background = 'rgba(0,0,0,0.9)';
            
            document.getElementById('state').textContent = 'OFF';
            document.getElementById('wifi').textContent = 'Disconnected';
            document.getElementById('wifi').className = '';
            document.getElementById('server').textContent = '--';
            document.getElementById('server').className = '';
            document.getElementById('errors').textContent = '0';
            document.getElementById('errors').className = '';
            document.getElementById('heap').textContent = '0 / 320 KB';
            document.getElementById('heap-bar').style.width = '0%';
            document.getElementById('refresh-info').textContent = 'Full: 0 | Partial: 0';
            document.getElementById('last-refresh').textContent = 'Last: --';
        }
        
        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }
        
        // ========== INIT ==========
        // Set server URL to current origin (turnkey deployment support)
        document.getElementById('server-url').value = window.location.origin;
        
        initZones();
        log('Simulator ready');
        log('Server: ' + window.location.origin);
        log('Firmware emulation: v' + FIRMWARE_VERSION);
        log('Click "Boot Device" to start');
    </script>
</body>
</html>
