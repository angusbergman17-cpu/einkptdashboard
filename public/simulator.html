<!DOCTYPE html>
<html lang="en">
<!--
    Commute Compute - Intelligent Transit Display System
    Multi-Device Simulator with SmartCommute Engine Integration
    
    Copyright (c) 2026 Angus Bergman
    Licensed under CC BY-NC 4.0
    https://creativecommons.org/licenses/by-nc/4.0/
-->
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#1a2744">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commute Compute Simulator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #1a2744; 
            color: #f1f5f9; 
            min-height: 100vh; 
            padding: 20px;
            padding-top: 76px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Global Navigation */
        .global-nav {
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        .global-nav .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: #f8fafc;
            text-decoration: none;
        }
        .global-nav .nav-links { display: flex; gap: 8px; }
        .global-nav .nav-link {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        .global-nav .nav-link:hover { background: rgba(30, 41, 59, 0.8); color: #f8fafc; border-color: #4fb28e; }
        .global-nav .nav-link.active { background: #4fb28e; color: white; border-color: #4fb28e; }
        
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-size: 24px; margin-bottom: 8px; }
        header p { color: #94a3b8; font-size: 14px; }
        
        .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        @media (max-width: 1000px) { .main-layout { grid-template-columns: 1fr; } }
        
        .display-wrapper {
            background: #2a3d5f;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3d5278;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .display-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
            font-size: 12px;
            color: #64748b;
            flex-wrap: wrap;
            gap: 8px;
        }
        .display-info span {
            background: #334155;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .display-info .live { background: #166534; color: #dcfce7; }
        
        #eink-display {
            background: #f5f5f0;
            border: 4px solid #1a1a1a;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.08), 0 8px 32px rgba(0,0,0,0.3);
        }
        #eink-display img {
            display: block;
            width: 100%;
            height: auto;
        }
        
        .controls {
            background: #2a3d5f;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3d5278;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        .controls h2 { font-size: 16px; margin-bottom: 15px; color: #4fb28e; }
        .control-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }
        .control-section:last-child { border-bottom: none; }
        .control-section h3 {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .control-group { margin-bottom: 12px; }
        .control-group label {
            display: block;
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
        }
        .control-group input, .control-group select {
            width: 100%;
            padding: 10px 12px;
            background: #1a2744;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #f8fafc;
            font-size: 13px;
            font-family: 'Space Grotesk', sans-serif;
        }
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #4fb28e;
        }
        
        .button-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        button {
            flex: 1;
            padding: 12px;
            background: #4fb28e;
            border: none;
            border-radius: 6px;
            color: #1a2744;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }
        button:hover { background: #5fcca0; transform: translateY(-1px); }
        button.secondary { background: #3d5278; color: #f1f5f9; }
        button.secondary:hover { background: #4a6291; }
        button.warning { background: #f59e0b; color: #1a2744; }
        button.danger { background: #ef4444; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .scenario-btn {
            padding: 10px 8px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #f1f5f9;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .scenario-btn:hover { background: #475569; border-color: #4fb28e; }
        .scenario-btn.active { background: #4fb28e; color: #1a2744; border-color: #4fb28e; }
        
        .status-bar {
            margin-top: 20px;
            background: #1e293b;
            padding: 12px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status-item { display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; }
        .status-dot.loading { background: #f59e0b; animation: pulse 0.8s infinite; }
        .status-dot.error { background: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        .log-output {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-output .log-line { margin-bottom: 4px; }
        .log-output .log-time { color: #64748b; }
        .log-output .log-info { color: #4fb28e; }
        .log-output .log-warn { color: #f59e0b; }
        .log-output .log-error { color: #ef4444; }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #334155;
            color: #64748b;
            font-size: 12px;
        }
        footer a { color: #4fb28e; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <!-- Global Navigation -->
    <nav class="global-nav">
        <a href="/" class="nav-brand">
            <img src="/assets/brand/cc-logo-128.png" alt="CC" style="height: 48px; width: auto;">
            <span>Commute Compute</span>
        </a>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/admin.html" class="nav-link">Settings</a>
            <a href="/simulator.html" class="nav-link active">Simulator</a>
        </div>
    </nav>

    <main class="container">
        <header>
            <h1>üß™ CCDash V10 Simulator</h1>
            <p>Test SmartCommute engine with random journeys ‚Ä¢ Firmware behavior verification</p>
        </header>

        <div class="main-layout">
            <!-- Display Panel -->
            <div class="display-wrapper">
                <div class="display-info">
                    <span id="device-name">TRMNL OG</span>
                    <span id="device-res">800√ó480</span>
                    <span id="render-mode">V10 Renderer</span>
                    <span id="refresh-count">Refresh #0</span>
                    <span id="data-mode" class="live">Live API</span>
                </div>
                <div id="eink-display" style="width: 800px; max-width: 100%;">
                    <img id="display-image" src="" alt="E-Ink Display Preview" style="background: #f5f5f0;">
                    <div id="loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; color: white;">
                        <div style="text-align: center;">
                            <div class="status-dot loading" style="width: 20px; height: 20px; margin: 0 auto 10px;"></div>
                            <div>Loading dashboard...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Log Output -->
                <div class="log-output" id="log-output">
                    <div class="log-line"><span class="log-time">[--:--:--]</span> <span class="log-info">Simulator ready</span></div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="controls">
                <h2>‚öôÔ∏è Simulator Controls</h2>

                <!-- Random Journey Generator -->
                <div class="control-section">
                    <h3>üé≤ Random Journey Generator</h3>
                    <p style="font-size: 11px; color: #94a3b8; margin-bottom: 10px;">
                        Generate random scenarios to test SmartCommute engine
                    </p>
                    <div class="button-row">
                        <button onclick="generateRandomJourney()">üé≤ Random Journey</button>
                    </div>
                    <div class="scenario-grid">
                        <button class="scenario-btn" onclick="generateScenario('early')">‚è∞ Early Arrival</button>
                        <button class="scenario-btn" onclick="generateScenario('late')">‚ö†Ô∏è Running Late</button>
                        <button class="scenario-btn" onclick="generateScenario('ontime')">‚úì On Time</button>
                        <button class="scenario-btn" onclick="generateScenario('disruption')">üö® Disruption</button>
                        <button class="scenario-btn" onclick="generateScenario('delay')">‚è±Ô∏è Delayed Service</button>
                        <button class="scenario-btn" onclick="generateScenario('coffee')">‚òï Coffee Time</button>
                        <button class="scenario-btn" onclick="generateScenario('nocoffee')">üö´ Skip Coffee</button>
                        <button class="scenario-btn" onclick="generateScenario('multimodal')">üöÉüöä Multi-Modal</button>
                    </div>
                </div>

                <!-- Journey Parameters -->
                <div class="control-section">
                    <h3>üìç Journey Parameters</h3>
                    <div class="control-group">
                        <label>Home Address</label>
                        <input type="text" id="input-home" value="1 Clara St, South Yarra VIC">
                    </div>
                    <div class="control-group">
                        <label>Work Address</label>
                        <input type="text" id="input-work" value="Bunnings Collingwood, Victoria Parade VIC">
                    </div>
                    <div class="control-group">
                        <label>Coffee Stop</label>
                        <input type="text" id="input-cafe" value="Au79 Richmond Trader, Church St VIC">
                    </div>
                    <div class="control-group">
                        <label>Target Arrival Time</label>
                        <input type="time" id="input-arrival" value="09:00">
                    </div>
                    <div class="control-group">
                        <label>Simulated Current Time (leave blank for now)</label>
                        <input type="time" id="input-current-time" value="">
                    </div>
                    <div class="control-group">
                        <label>Number of Legs</label>
                        <select id="input-legs">
                            <option value="auto">Auto (SmartCommute decides)</option>
                            <option value="3">3 legs</option>
                            <option value="4">4 legs</option>
                            <option value="5" selected>5 legs</option>
                        </select>
                    </div>
                </div>

                <!-- Service Status Override -->
                <div class="control-section">
                    <h3>üö¶ Service Status</h3>
                    <div class="control-group">
                        <label>Transit Status</label>
                        <select id="input-status">
                            <option value="normal">Normal Service</option>
                            <option value="delayed">Delayed (+5 min)</option>
                            <option value="disruption">Major Disruption</option>
                            <option value="suspended">Service Suspended</option>
                            <option value="diversion">Tram Diversion</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Weather Override</label>
                        <select id="input-weather">
                            <option value="auto">Auto (Live Weather)</option>
                            <option value="sunny">‚òÄÔ∏è Sunny 28¬∞</option>
                            <option value="cloudy">‚òÅÔ∏è Cloudy 18¬∞</option>
                            <option value="rain">üåßÔ∏è Rain 15¬∞</option>
                            <option value="storm">‚õàÔ∏è Storm 14¬∞</option>
                        </select>
                    </div>
                </div>

                <!-- Refresh Controls -->
                <div class="control-section">
                    <h3>üîÑ Display Refresh</h3>
                    <div class="button-row">
                        <button onclick="refreshDisplay()">Full Refresh</button>
                        <button class="secondary" onclick="refreshDisplay(true)">Partial</button>
                    </div>
                    <div class="button-row">
                        <button class="secondary" onclick="startAutoRefresh()">‚ñ∂Ô∏è Auto (60s)</button>
                        <button class="secondary" onclick="stopAutoRefresh()">‚èπÔ∏è Stop</button>
                    </div>
                </div>

                <!-- Firmware Simulation -->
                <div class="control-section">
                    <h3>üîß Firmware Simulation</h3>
                    <div class="button-row">
                        <button class="warning" onclick="simulateBoot()">üîÑ Boot Sequence</button>
                    </div>
                    <div style="font-size: 10px; color: #64748b; margin-top: 8px;">
                        Firmware: CC-FW-6.1-60s ‚Ä¢ 60s refresh interval
                    </div>
                </div>

                <!-- Export -->
                <div class="control-section">
                    <h3>üì§ Export</h3>
                    <div class="button-row">
                        <button class="secondary" onclick="downloadImage()">üíæ Download PNG</button>
                        <button class="secondary" onclick="copyApiUrl()">üìã Copy API URL</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Ready</span>
            </div>
            <div class="status-item">
                <span id="last-update">Last update: --</span>
            </div>
            <div class="status-item">
                <span>SmartCommute v3.0 ‚Ä¢ CCDash Renderer v2.1</span>
            </div>
        </div>

        <footer>
            ¬© 2026 Angus Bergman ‚Ä¢ 
            <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a> ‚Ä¢ 
            Transit data: <a href="https://opendata.transport.vic.gov.au">Transport Victoria OpenData API</a> (CC BY 4.0)
        </footer>
    </main>

    <script>
        // =========================================================================
        // SIMULATOR STATE
        // =========================================================================
        let refreshCount = 0;
        let autoRefreshInterval = null;
        const BASE_URL = window.location.origin;

        // Random data pools for journey generation
        const MELBOURNE_ADDRESSES = [
            '1 Clara St, South Yarra VIC',
            '68 Cambridge St, Collingwood VIC',
            '42 Smith St, Fitzroy VIC',
            '155 Brunswick St, Fitzroy VIC',
            '300 Chapel St, Prahran VIC',
            '89 Acland St, St Kilda VIC',
            '12 Lygon St, Carlton VIC',
            '200 Sydney Rd, Brunswick VIC'
        ];

        const WORK_ADDRESSES = [
            'Bunnings Collingwood, Victoria Parade VIC',
            '80 Collins St, Melbourne VIC',
            '101 Collins St, Melbourne VIC',
            '360 Elizabeth St, Melbourne VIC',
            'Melbourne Central, Swanston St VIC',
            'Federation Square, Melbourne VIC',
            'Flinders St Station, Melbourne VIC',
            'Southern Cross Station, Melbourne VIC'
        ];

        const CAFES = [
            'Au79 Richmond Trader, Church St VIC',
            'Proud Mary, 172 Oxford St, Collingwood',
            'Industry Beans, 3/62 Rose St, Fitzroy',
            'Market Lane Coffee, Queen Victoria Market',
            'Patricia Coffee, 493 Little Bourke St',
            'Brother Baba Budan, 359 Little Bourke St',
            'Seven Seeds, 114 Berkeley St, Carlton',
            'St Ali, 12 Yarra Pl, South Melbourne'
        ];

        const STATIONS = [
            'South Yarra', 'Richmond', 'Flinders Street', 'Melbourne Central',
            'Parliament', 'Collingwood', 'Clifton Hill', 'Jolimont',
            'North Melbourne', 'Footscray', 'Prahran', 'Windsor'
        ];

        const TRAM_ROUTES = ['1', '3', '5', '6', '11', '12', '16', '19', '48', '57', '58', '59', '64', '67', '70', '72', '75', '78', '86', '96'];

        // =========================================================================
        // LOGGING
        // =========================================================================
        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString('en-AU', { hour12: false });
            const line = document.createElement('div');
            line.className = 'log-line';
            line.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logOutput.appendChild(line);
            logOutput.scrollTop = logOutput.scrollHeight;
            
            // Keep only last 50 lines
            while (logOutput.children.length > 50) {
                logOutput.removeChild(logOutput.firstChild);
            }
        }

        // =========================================================================
        // RANDOM JOURNEY GENERATION
        // =========================================================================
        function generateRandomJourney() {
            log('Generating random journey...', 'info');
            
            // Random addresses
            document.getElementById('input-home').value = MELBOURNE_ADDRESSES[Math.floor(Math.random() * MELBOURNE_ADDRESSES.length)];
            document.getElementById('input-work').value = WORK_ADDRESSES[Math.floor(Math.random() * WORK_ADDRESSES.length)];
            document.getElementById('input-cafe').value = Math.random() > 0.3 ? CAFES[Math.floor(Math.random() * CAFES.length)] : '';
            
            // Random arrival time (7am - 10am)
            const hour = 7 + Math.floor(Math.random() * 3);
            const minute = Math.floor(Math.random() * 4) * 15;
            document.getElementById('input-arrival').value = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            // Random status (mostly normal)
            const statusRoll = Math.random();
            let status = 'normal';
            if (statusRoll > 0.9) status = 'disruption';
            else if (statusRoll > 0.8) status = 'delayed';
            else if (statusRoll > 0.7) status = 'diversion';
            document.getElementById('input-status').value = status;
            
            // Random weather
            const weatherRoll = Math.random();
            let weather = 'auto';
            if (weatherRoll > 0.8) weather = 'rain';
            else if (weatherRoll > 0.6) weather = 'cloudy';
            else if (weatherRoll > 0.4) weather = 'sunny';
            document.getElementById('input-weather').value = weather;
            
            refreshDisplay();
        }

        function generateScenario(scenario) {
            log(`Loading scenario: ${scenario}`, 'info');
            
            // Reset to defaults
            document.getElementById('input-status').value = 'normal';
            document.getElementById('input-weather').value = 'auto';
            document.getElementById('input-current-time').value = '';
            
            switch (scenario) {
                case 'early':
                    // Set current time to give plenty of buffer
                    document.getElementById('input-arrival').value = '09:00';
                    document.getElementById('input-current-time').value = '07:30';
                    break;
                    
                case 'late':
                    // Set current time close to arrival
                    document.getElementById('input-arrival').value = '09:00';
                    document.getElementById('input-current-time').value = '08:50';
                    break;
                    
                case 'ontime':
                    document.getElementById('input-arrival').value = '09:00';
                    document.getElementById('input-current-time').value = '08:20';
                    break;
                    
                case 'disruption':
                    document.getElementById('input-status').value = 'disruption';
                    break;
                    
                case 'delay':
                    document.getElementById('input-status').value = 'delayed';
                    break;
                    
                case 'coffee':
                    document.getElementById('input-cafe').value = CAFES[Math.floor(Math.random() * CAFES.length)];
                    document.getElementById('input-arrival').value = '09:30';
                    document.getElementById('input-current-time').value = '08:00';
                    break;
                    
                case 'nocoffee':
                    document.getElementById('input-cafe').value = CAFES[Math.floor(Math.random() * CAFES.length)];
                    document.getElementById('input-arrival').value = '09:00';
                    document.getElementById('input-current-time').value = '08:45';
                    break;
                    
                case 'multimodal':
                    // Pick addresses that require multiple transit modes
                    document.getElementById('input-home').value = '89 Acland St, St Kilda VIC';
                    document.getElementById('input-work').value = 'Melbourne Central, Swanston St VIC';
                    break;
            }
            
            refreshDisplay();
        }

        // =========================================================================
        // DISPLAY REFRESH
        // =========================================================================
        async function refreshDisplay(partial = false) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const loadingOverlay = document.getElementById('loading-overlay');
            const displayImage = document.getElementById('display-image');
            
            statusDot.className = 'status-dot loading';
            statusText.textContent = partial ? 'Partial refresh...' : 'Full refresh...';
            loadingOverlay.style.display = 'flex';
            
            try {
                // Build API URL with parameters
                const params = new URLSearchParams({
                    device: 'trmnl-og',
                    format: 'png',
                    t: Date.now() // Cache bust
                });
                
                // Add journey parameters if set
                const home = document.getElementById('input-home').value;
                const work = document.getElementById('input-work').value;
                const cafe = document.getElementById('input-cafe').value;
                const arrival = document.getElementById('input-arrival').value;
                const currentTime = document.getElementById('input-current-time').value;
                const status = document.getElementById('input-status').value;
                const weather = document.getElementById('input-weather').value;
                
                if (home) params.set('home', home);
                if (work) params.set('work', work);
                if (cafe) params.set('cafe', cafe);
                if (arrival) params.set('arrivalTime', arrival);
                if (currentTime) params.set('simulatedTime', currentTime);
                if (status !== 'normal') params.set('status', status);
                if (weather !== 'auto') params.set('weather', weather);
                
                const apiUrl = `${BASE_URL}/api/screen?${params.toString()}`;
                
                log(`Fetching: /api/screen?...`, 'info');
                
                // Simulate e-ink flash for full refresh
                if (!partial) {
                    displayImage.style.filter = 'invert(1)';
                    await new Promise(r => setTimeout(r, 150));
                    displayImage.style.filter = 'none';
                }
                
                // Load the image
                displayImage.src = apiUrl;
                
                await new Promise((resolve, reject) => {
                    displayImage.onload = resolve;
                    displayImage.onerror = reject;
                });
                
                refreshCount++;
                document.getElementById('refresh-count').textContent = `Refresh #${refreshCount}`;
                document.getElementById('last-update').textContent = `Last update: ${new Date().toLocaleTimeString('en-AU', { hour12: true })}`;
                
                statusDot.className = 'status-dot';
                statusText.textContent = 'Ready';
                loadingOverlay.style.display = 'none';
                
                log(`Display updated (${partial ? 'partial' : 'full'} refresh #${refreshCount})`, 'info');
                
            } catch (error) {
                statusDot.className = 'status-dot error';
                statusText.textContent = 'Error';
                loadingOverlay.innerHTML = `<div style="text-align:center;color:#ef4444;"><div style="font-size:24px;margin-bottom:10px;">‚ö†Ô∏è</div><div>Failed to load</div><div style="font-size:11px;margin-top:5px;">${error.message}</div></div>`;
                log(`Error: ${error.message}`, 'error');
            }
        }

        // =========================================================================
        // AUTO REFRESH
        // =========================================================================
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                log('Auto-refresh already running', 'warn');
                return;
            }
            log('Starting auto-refresh (60s interval per firmware spec)', 'info');
            autoRefreshInterval = setInterval(() => refreshDisplay(true), 60000);
            refreshDisplay();
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                log('Auto-refresh stopped', 'info');
            }
        }

        // =========================================================================
        // FIRMWARE SIMULATION
        // =========================================================================
        async function simulateBoot() {
            const displayImage = document.getElementById('display-image');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            log('Starting boot sequence (CC-FW-6.1-60s)...', 'info');
            
            // Show boot screen
            loadingOverlay.style.display = 'flex';
            loadingOverlay.innerHTML = `
                <div style="text-align:center;">
                    <div style="font-size:48px;margin-bottom:15px;">üöÉ</div>
                    <div style="font-size:24px;font-weight:700;margin-bottom:8px;">Commute Compute</div>
                    <div style="font-size:12px;color:#888;margin-bottom:20px;">Smart Transit Display</div>
                    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:15px;">
                        <div class="status-dot loading"></div>
                        <div class="status-dot loading" style="animation-delay:0.2s;"></div>
                        <div class="status-dot loading" style="animation-delay:0.4s;"></div>
                    </div>
                    <div id="boot-status" style="font-size:11px;color:#666;">Initializing...</div>
                    <div style="font-size:10px;color:#444;margin-top:20px;">CC-FW-6.1-60s</div>
                </div>
            `;
            
            const bootSteps = [
                { text: 'Initializing hardware...', delay: 400 },
                { text: 'Connecting to WiFi...', delay: 600 },
                { text: 'WiFi connected ‚úì', delay: 300 },
                { text: 'Syncing with dashboard...', delay: 500 },
                { text: 'Loading SmartCommute engine...', delay: 400 },
                { text: 'Fetching transit data...', delay: 600 },
                { text: 'Rendering display...', delay: 400 },
                { text: 'Boot complete!', delay: 300 }
            ];
            
            for (const step of bootSteps) {
                document.getElementById('boot-status').textContent = step.text;
                log(step.text, 'info');
                await new Promise(r => setTimeout(r, step.delay));
            }
            
            await new Promise(r => setTimeout(r, 500));
            refreshDisplay();
        }

        // =========================================================================
        // EXPORT FUNCTIONS
        // =========================================================================
        function downloadImage() {
            const img = document.getElementById('display-image');
            if (!img.src || img.src.includes('data:')) {
                log('No image to download', 'warn');
                return;
            }
            
            const link = document.createElement('a');
            link.href = img.src;
            link.download = `ccdash-${Date.now()}.png`;
            link.click();
            log('Image downloaded', 'info');
        }

        function copyApiUrl() {
            const params = new URLSearchParams({
                device: 'trmnl-og',
                format: 'png'
            });
            
            const home = document.getElementById('input-home').value;
            const work = document.getElementById('input-work').value;
            if (home) params.set('home', home);
            if (work) params.set('work', work);
            
            const url = `${BASE_URL}/api/screen?${params.toString()}`;
            navigator.clipboard.writeText(url).then(() => {
                log('API URL copied to clipboard', 'info');
            });
        }

        // =========================================================================
        // INITIALIZATION
        // =========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            log('Simulator initialized', 'info');
            log('Firmware: CC-FW-6.1-60s (60s refresh)', 'info');
            log('Renderer: CCDash v2.1 (V10 Spec)', 'info');
            
            // Initial load
            refreshDisplay();
        });
    </script>
</body>
</html>
