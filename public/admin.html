<!DOCTYPE html>
<html lang="en">
<!--
    Commute Compute Admin Dashboard
    Copyright (c) 2026 Angus Bergman
    Licensed under CC BY-NC 4.0
    https://creativecommons.org/licenses/by-nc/4.0/

    Architecture: Setup Wizard -> Admin Dashboard -> Live Dashboard -> Device
    CSS naming: cc-* prefix per DEVELOPMENT-RULES.md Section 0.2
    Time format: 12-hour only per DEVELOPMENT-RULES.md Section 12.2
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commute Compute - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="/favicon-32.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#1a2744">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cc-bg-primary: #1a2744;
            --cc-bg-secondary: #2a3d5f;
            --cc-bg-card: #243350;
            --cc-accent: #4fb28e;
            --cc-accent-blue: #0ea5e9;
            --cc-text-primary: #f1f5f9;
            --cc-text-secondary: #94a3b8;
            --cc-text-muted: #64748b;
            --cc-success: #22c55e;
            --cc-error: #ef4444;
            --cc-warning: #f59e0b;
            --cc-border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: var(--cc-bg-primary);
            color: var(--cc-text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .cc-header {
            background: var(--cc-bg-secondary);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--cc-border);
        }

        .cc-logo { font-size: 20px; font-weight: 700; color: var(--cc-accent); }

        .cc-header-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            color: var(--cc-text-secondary);
        }

        .cc-time { font-weight: 600; color: var(--cc-text-primary); }

        .cc-nav {
            background: var(--cc-bg-secondary);
            padding: 0 20px;
            display: flex;
            gap: 5px;
            border-bottom: 1px solid var(--cc-border);
            overflow-x: auto;
        }

        .cc-nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--cc-text-secondary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .cc-nav-tab:hover { color: var(--cc-text-primary); background: rgba(255,255,255,0.05); }
        .cc-nav-tab.cc-active { color: var(--cc-accent); border-bottom-color: var(--cc-accent); }

        .cc-main { max-width: 1200px; margin: 0 auto; padding: 20px; }

        .cc-tab-content { display: none; }
        .cc-tab-content.cc-active { display: block; }

        .cc-card {
            background: var(--cc-bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--cc-border);
        }

        .cc-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--cc-border);
        }

        .cc-card-title { font-size: 16px; font-weight: 600; }

        .cc-card-icon {
            width: 32px;
            height: 32px;
            background: var(--cc-accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .cc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }

        .cc-journey-summary {
            background: linear-gradient(135deg, var(--cc-bg-secondary), var(--cc-bg-card));
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .cc-journey-route {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .cc-journey-leg {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background: var(--cc-bg-secondary);
            border-radius: 8px;
            min-width: 70px;
        }

        .cc-leg-icon { font-size: 24px; margin-bottom: 5px; }
        .cc-leg-label { font-size: 11px; color: var(--cc-text-secondary); }
        .cc-leg-time { font-size: 13px; font-weight: 600; color: var(--cc-accent); }
        .cc-arrow { color: var(--cc-text-muted); font-size: 18px; }

        .cc-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .cc-status-success { background: rgba(34, 197, 94, 0.2); color: var(--cc-success); }
        .cc-status-warning { background: rgba(245, 158, 11, 0.2); color: var(--cc-warning); }
        .cc-status-error { background: rgba(239, 68, 68, 0.2); color: var(--cc-error); }

        .cc-form-group { margin-bottom: 15px; }
        .cc-label { display: block; font-size: 13px; color: var(--cc-text-secondary); margin-bottom: 5px; }

        .cc-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--cc-bg-secondary);
            border: 1px solid var(--cc-border);
            border-radius: 6px;
            color: var(--cc-text-primary);
            font-family: inherit;
            font-size: 14px;
        }

        .cc-input:focus { outline: none; border-color: var(--cc-accent); }

        .cc-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cc-btn-primary { background: var(--cc-accent); color: #000; }
        .cc-btn-primary:hover { background: #3d9a7a; }
        .cc-btn-secondary { background: var(--cc-bg-secondary); color: var(--cc-text-primary); border: 1px solid var(--cc-border); }
        .cc-btn-secondary:hover { background: var(--cc-bg-card); }
        .cc-btn-danger { background: var(--cc-error); color: white; }

        .cc-dashboard-preview {
            background: #f5f5f0;
            border-radius: 8px;
            padding: 10px;
            aspect-ratio: 800/480;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
        }

        .cc-dashboard-preview img { max-width: 100%; max-height: 100%; border-radius: 4px; }

        .cc-webhook-box {
            background: rgba(79, 178, 142, 0.1);
            border: 1px solid rgba(79, 178, 142, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .cc-webhook-url {
            font-family: monospace;
            font-size: 11px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            cursor: pointer;
        }

        .cc-info { padding: 12px 15px; border-radius: 8px; font-size: 13px; margin: 10px 0; }
        .cc-info-success { background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--cc-success); }
        .cc-info-warning { background: rgba(245, 158, 11, 0.1); border-left: 3px solid var(--cc-warning); }

        .cc-toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }

        .cc-toast {
            background: var(--cc-bg-card);
            border: 1px solid var(--cc-border);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: cc-slide-in 0.3s ease;
        }

        @keyframes cc-slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .cc-attribution { font-size: 12px; color: var(--cc-text-muted); line-height: 2; }
        .cc-attribution a { color: var(--cc-accent-blue); text-decoration: none; }
        .cc-attribution a:hover { text-decoration: underline; }

        .cc-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--cc-border);
            border-top-color: var(--cc-accent);
            border-radius: 50%;
            animation: cc-spin 0.8s linear infinite;
        }

        @keyframes cc-spin { to { transform: rotate(360deg); } }

        .cc-empty-state { text-align: center; padding: 40px 20px; color: var(--cc-text-secondary); }
        .cc-empty-state h3 { margin-bottom: 10px; color: var(--cc-text-primary); }

        .cc-footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--cc-text-muted);
            font-size: 12px;
            border-top: 1px solid var(--cc-border);
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .cc-header { flex-direction: column; gap: 10px; text-align: center; }
            .cc-nav-tab { padding: 10px 15px; font-size: 13px; }
            .cc-grid { grid-template-columns: 1fr; }
            .cc-journey-route { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="cc-toast-container" id="cc-toast-container"></div>

    <header class="cc-header">
        <div class="cc-logo">Commute Compute</div>
        <div class="cc-header-info">
            <span id="cc-state-badge" class="cc-status cc-status-success">VIC</span>
            <span class="cc-time" id="cc-current-time">--:-- --</span>
            <span id="cc-date">--</span>
        </div>
    </header>

    <nav class="cc-nav">
        <button class="cc-nav-tab cc-active" data-tab="journey" onclick="ccShowTab('journey')">Journey</button>
        <button class="cc-nav-tab" data-tab="dashboard" onclick="ccShowTab('dashboard')">Live Dashboard</button>
        <button class="cc-nav-tab" data-tab="config" onclick="ccShowTab('config')">Configuration</button>
        <button class="cc-nav-tab" data-tab="api" onclick="ccShowTab('api')">API Keys</button>
        <button class="cc-nav-tab" data-tab="system" onclick="ccShowTab('system')">System</button>
    </nav>

    <main class="cc-main">
        <!-- JOURNEY TAB -->
        <section id="cc-tab-journey" class="cc-tab-content cc-active">
            <div id="cc-journey-loading" class="cc-card">
                <div style="text-align: center; padding: 40px;">
                    <div class="cc-loading"></div>
                    <p style="margin-top: 15px; color: var(--cc-text-secondary);">Loading journey data...</p>
                </div>
            </div>

            <div id="cc-journey-content" style="display: none;">
                <div class="cc-journey-summary">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h2 style="font-size: 24px; margin-bottom: 5px;">Your Journey</h2>
                            <p style="color: var(--cc-text-secondary);" id="cc-journey-route-text">Home to Work</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--cc-accent);" id="cc-leave-time">--:-- --</div>
                            <div style="color: var(--cc-text-secondary); font-size: 14px;">Leave by</div>
                        </div>
                    </div>

                    <div class="cc-journey-route" id="cc-journey-legs"></div>

                    <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--cc-border); flex-wrap: wrap; gap: 10px;">
                        <div><span style="color: var(--cc-text-secondary);">Total:</span> <strong id="cc-total-duration">-- min</strong></div>
                        <div><span style="color: var(--cc-text-secondary);">Arrive:</span> <strong id="cc-arrival-time">--:-- --</strong></div>
                    </div>
                </div>

                <div class="cc-grid">
                    <div class="cc-card">
                        <div class="cc-card-header">
                            <div class="cc-card-icon">üöÜ</div>
                            <span class="cc-card-title">Next Departures</span>
                        </div>
                        <div id="cc-departures"><p style="color: var(--cc-text-secondary);">Loading...</p></div>
                    </div>
                    <div class="cc-card">
                        <div class="cc-card-header">
                            <div class="cc-card-icon">‚òÄÔ∏è</div>
                            <span class="cc-card-title">Weather</span>
                        </div>
                        <div id="cc-weather"><p style="color: var(--cc-text-secondary);">Loading...</p></div>
                    </div>
                </div>

                <div class="cc-card" id="cc-coffee-card" style="display: none;">
                    <div class="cc-card-header">
                        <div class="cc-card-icon">‚òï</div>
                        <span class="cc-card-title">Coffee Decision</span>
                    </div>
                    <div id="cc-coffee-decision"></div>
                </div>

                <div class="cc-card">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="cc-btn cc-btn-primary" onclick="ccRecalculateJourney()">Recalculate Journey</button>
                        <button class="cc-btn cc-btn-secondary" onclick="ccShowTab('config')">Edit Configuration</button>
                    </div>
                </div>
            </div>

            <div id="cc-journey-empty" class="cc-card" style="display: none;">
                <div class="cc-empty-state">
                    <h3>No Journey Configured</h3>
                    <p>Complete the setup wizard to configure your commute.</p>
                    <button class="cc-btn cc-btn-primary" onclick="window.location.href='/setup-wizard.html'" style="margin-top: 15px;">Start Setup Wizard</button>
                </div>
            </div>
        </section>

        <!-- DASHBOARD TAB -->
        <section id="cc-tab-dashboard" class="cc-tab-content">
            <div class="cc-card">
                <div class="cc-card-header">
                    <div class="cc-card-icon">üì∫</div>
                    <span class="cc-card-title">Live Dashboard Preview</span>
                    <span class="cc-status cc-status-success" id="cc-dashboard-status">Live</span>
                </div>
                <p style="color: var(--cc-text-secondary); margin-bottom: 15px; font-size: 13px;">This is what your e-ink device displays.</p>
                <div class="cc-dashboard-preview" id="cc-dashboard-preview">
                    <img id="cc-dashboard-image" src="" alt="Dashboard" style="display: none;">
                    <span id="cc-dashboard-loading">Loading dashboard...</span>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="cc-btn cc-btn-secondary" onclick="ccRefreshDashboard()">Refresh</button>
                    <button class="cc-btn cc-btn-secondary" onclick="ccOpenFullscreen()">Fullscreen</button>
                </div>
            </div>

            <div class="cc-card">
                <div class="cc-card-header">
                    <div class="cc-card-icon">üîó</div>
                    <span class="cc-card-title">Device Webhook URL</span>
                </div>
                <p style="color: var(--cc-text-secondary); font-size: 13px; margin-bottom: 10px;">Configure your e-ink device with this URL.</p>
                <div class="cc-webhook-box">
                    <div class="cc-webhook-url" id="cc-webhook-url" onclick="ccCopyWebhook()">Loading...</div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="cc-btn cc-btn-primary" onclick="ccCopyWebhook()">Copy URL</button>
                        <button class="cc-btn cc-btn-secondary" onclick="ccRegenerateWebhook()">Regenerate</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- CONFIGURATION TAB -->
        <section id="cc-tab-config" class="cc-tab-content">
            <div class="cc-grid">
                <div class="cc-card">
                    <div class="cc-card-header">
                        <div class="cc-card-icon">üìç</div>
                        <span class="cc-card-title">Addresses</span>
                    </div>
                    <div class="cc-form-group">
                        <label class="cc-label">Home Address</label>
                        <input type="text" class="cc-input" id="cc-config-home" placeholder="Enter home address">
                    </div>
                    <div class="cc-form-group">
                        <label class="cc-label">Work Address</label>
                        <input type="text" class="cc-input" id="cc-config-work" placeholder="Enter work address">
                    </div>
                    <div class="cc-form-group">
                        <label class="cc-label">Cafe (Optional)</label>
                        <input type="text" class="cc-input" id="cc-config-cafe" placeholder="Enter cafe address">
                    </div>
                </div>

                <div class="cc-card">
                    <div class="cc-card-header">
                        <div class="cc-card-icon">‚è∞</div>
                        <span class="cc-card-title">Journey Settings</span>
                    </div>
                    <div class="cc-form-group">
                        <label class="cc-label">Target Arrival Time</label>
                        <input type="time" class="cc-input" id="cc-config-arrival" value="09:00">
                    </div>
                    <div class="cc-form-group">
                        <label class="cc-label"><input type="checkbox" id="cc-config-coffee" checked> Include coffee stop</label>
                    </div>
                </div>
            </div>

            <div class="cc-card">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="cc-btn cc-btn-primary" onclick="ccSaveConfiguration()">Save Configuration</button>
                    <button class="cc-btn cc-btn-secondary" onclick="ccResetConfiguration()">Reset to Defaults</button>
                </div>
            </div>
        </section>

        <!-- API KEYS TAB -->
        <section id="cc-tab-api" class="cc-tab-content">
            <div class="cc-card">
                <div class="cc-card-header">
                    <div class="cc-card-icon">üöÜ</div>
                    <span class="cc-card-title">Transport API Key</span>
                    <span class="cc-status" id="cc-transport-status">Not Set</span>
                </div>
                <p style="color: var(--cc-text-secondary); font-size: 13px; margin-bottom: 15px;">Required for real-time data. Get a free key from <a href="https://opendata.transport.vic.gov.au/" target="_blank" style="color: var(--cc-accent-blue);">Transport Victoria OpenData</a>.</p>
                <div class="cc-form-group">
                    <label class="cc-label">API Key (UUID format)</label>
                    <input type="text" class="cc-input" id="cc-api-transport" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                </div>
                <button class="cc-btn cc-btn-primary" onclick="ccSaveTransportKey()">Save & Validate</button>
            </div>

            <div class="cc-card">
                <div class="cc-card-header">
                    <div class="cc-card-icon">üó∫Ô∏è</div>
                    <span class="cc-card-title">Google Places API Key</span>
                    <span class="cc-status" id="cc-google-status">Optional</span>
                </div>
                <p style="color: var(--cc-text-secondary); font-size: 13px; margin-bottom: 15px;">Optional - enables enhanced address autocomplete. This is a paid API.</p>
                <div class="cc-form-group">
                    <label class="cc-label">API Key</label>
                    <input type="text" class="cc-input" id="cc-api-google" placeholder="AIza...">
                </div>
                <button class="cc-btn cc-btn-secondary" onclick="ccSaveGoogleKey()">Save Key</button>
            </div>

            <div class="cc-info cc-info-success">
                <strong>Free Tier:</strong> The system works completely free. Transport API is free, Google API is optional.
            </div>
        </section>

        <!-- SYSTEM TAB -->
        <section id="cc-tab-system" class="cc-tab-content">
            <div class="cc-grid">
                <div class="cc-card">
                    <div class="cc-card-header">
                        <div class="cc-card-icon">‚ÑπÔ∏è</div>
                        <span class="cc-card-title">System Information</span>
                    </div>
                    <div style="font-size: 13px;">
                        <p><strong>Version:</strong> <span id="cc-version">3.0.0</span></p>
                        <p><strong>State:</strong> <span id="cc-sys-state">VIC</span></p>
                        <p><strong>Data Source:</strong> <span id="cc-data-source">--</span></p>
                        <p><strong>Last Updated:</strong> <span id="cc-last-updated">--</span></p>
                    </div>
                </div>

                <div class="cc-card">
                    <div class="cc-card-header">
                        <div class="cc-card-icon">‚ù§Ô∏è</div>
                        <span class="cc-card-title">Support the Project</span>
                    </div>
                    <p style="font-size: 13px; color: var(--cc-text-secondary); margin-bottom: 15px;">Commute Compute is free and open source.</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <a href="https://github.com/angusbergman/commutecompute" target="_blank" class="cc-btn cc-btn-secondary">Star on GitHub</a>
                        <a href="https://ko-fi.com/angusbergman" target="_blank" class="cc-btn cc-btn-primary">Buy Me a Coffee</a>
                    </div>
                </div>
            </div>

            <div class="cc-card">
                <div class="cc-card-header">
                    <div class="cc-card-icon">üìú</div>
                    <span class="cc-card-title">Licensing & Attribution</span>
                </div>
                <div class="cc-attribution">
                    <p><strong>Commute Compute</strong> &copy; 2026 Angus Bergman</p>
                    <p>Licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></p>

                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--cc-text-primary);">Data Sources</h4>
                    <ul style="list-style: none;">
                        <li>üöÜ <strong>Transport Data:</strong> <a href="https://opendata.transport.vic.gov.au/" target="_blank">Transport Victoria OpenData</a> (CC BY 4.0)</li>
                        <li>üå§Ô∏è <strong>Weather:</strong> <a href="http://www.bom.gov.au/" target="_blank">Bureau of Meteorology</a> (CC BY 3.0 AU)</li>
                        <li>üó∫Ô∏è <strong>Geocoding:</strong> <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> (ODbL)</li>
                    </ul>

                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--cc-text-primary);">Trademarks</h4>
                    <p style="font-size: 11px;">Commute Compute, SmartCommute, CCDash, CC LiveDash, and CCFirm are trademarks of Angus Bergman.</p>
                </div>
            </div>

            <div class="cc-card">
                <div class="cc-card-header">
                    <div class="cc-card-icon">üõ†Ô∏è</div>
                    <span class="cc-card-title">Technical Details</span>
                </div>
                <div style="font-size: 13px; color: var(--cc-text-secondary);">
                    <p><strong>Architecture:</strong> Zero-config serverless (Vercel)</p>
                    <p><strong>Display:</strong> CCDash V10 specification</p>
                    <p><strong>Devices:</strong> TRMNL OG (800x480), Kindle PW3/4/5</p>
                    <p><strong>Refresh:</strong> 20s partial / 10min full</p>
                </div>
            </div>

            <div class="cc-card">
                <div class="cc-card-header">
                    <div class="cc-card-icon">‚ö†Ô∏è</div>
                    <span class="cc-card-title">Danger Zone</span>
                </div>
                <p style="color: var(--cc-text-secondary); font-size: 13px; margin-bottom: 15px;">These actions cannot be undone.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="cc-btn cc-btn-secondary" onclick="ccClearCache()">Clear Cache</button>
                    <button class="cc-btn cc-btn-danger" onclick="ccResetAll()">Reset All Data</button>
                </div>
            </div>
        </section>
    </main>

    <footer class="cc-footer">
        <p>Commute Compute &copy; 2026 Angus Bergman - CC BY-NC 4.0</p>
        <p style="margin-top: 5px;">
            <a href="/attribution.html" style="color: var(--cc-accent-blue);">Attribution</a> |
            <a href="/help.html" style="color: var(--cc-accent-blue);">Help</a> |
            <a href="https://github.com/angusbergman/commutecompute" target="_blank" style="color: var(--cc-accent-blue);">GitHub</a>
        </p>
    </footer>

    <script>
        /**
         * Commute Compute Admin Dashboard
         * Copyright (c) 2026 Angus Bergman - CC BY-NC 4.0
         * 12-hour time format per DEVELOPMENT-RULES.md Section 12.2
         */

        const CC_BASE = window.location.origin;
        let ccConfig = null;
        let ccWebhookUrl = null;

        // XSS sanitization - MANDATORY per DEVELOPMENT-RULES.md Section 17.1
        function ccSanitize(str) {
            if (str === null || str === undefined) return '';
            if (typeof str !== 'string') str = String(str);
            const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'};
            return str.replace(/[&<>"'`=/]/g, c => map[c]);
        }

        // 12-hour time format - MANDATORY per DEVELOPMENT-RULES.md Section 12.2
        function ccFormatTime12h(time24) {
            if (!time24) return '--:-- --';
            let hours, minutes;
            if (time24 instanceof Date) {
                hours = time24.getHours();
                minutes = time24.getMinutes();
            } else if (typeof time24 === 'string' && time24.includes(':')) {
                [hours, minutes] = time24.split(':').map(Number);
            } else {
                return '--:-- --';
            }
            const ampm = hours >= 12 ? 'pm' : 'am';
            const hours12 = hours % 12 || 12;
            return `${hours12}:${String(minutes).padStart(2, '0')} ${ampm}`;
        }

        function ccToast(message, type = 'info') {
            const container = document.getElementById('cc-toast-container');
            const toast = document.createElement('div');
            toast.className = 'cc-toast';
            toast.style.borderLeftColor = type === 'success' ? 'var(--cc-success)' : type === 'error' ? 'var(--cc-error)' : 'var(--cc-accent)';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function ccShowTab(tabId) {
            document.querySelectorAll('.cc-nav-tab').forEach(t => t.classList.toggle('cc-active', t.dataset.tab === tabId));
            document.querySelectorAll('.cc-tab-content').forEach(c => c.classList.toggle('cc-active', c.id === `cc-tab-${tabId}`));
            if (tabId === 'dashboard') ccLoadDashboard();
            else if (tabId === 'config') ccLoadConfiguration();
            else if (tabId === 'api') ccLoadApiStatus();
            else if (tabId === 'system') ccLoadSystemInfo();
        }

        function ccUpdateClock() {
            const now = new Date();
            document.getElementById('cc-current-time').textContent = ccFormatTime12h(now);
            document.getElementById('cc-date').textContent = now.toLocaleDateString('en-AU', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        async function ccLoadConfig() {
            const stored = localStorage.getItem('cc-config');
            if (stored) {
                try { ccConfig = JSON.parse(stored); } catch (e) { console.error('Config parse error'); }
            }
            ccWebhookUrl = localStorage.getItem('cc-webhook-url');
            return ccConfig;
        }

        async function ccLoadJourney() {
            const loadingEl = document.getElementById('cc-journey-loading');
            const contentEl = document.getElementById('cc-journey-content');
            const emptyEl = document.getElementById('cc-journey-empty');

            await ccLoadConfig();

            if (!ccConfig || !ccConfig.addresses?.home || !ccConfig.addresses?.work) {
                loadingEl.style.display = 'none';
                contentEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            if (ccConfig.state) document.getElementById('cc-state-badge').textContent = ccConfig.state;

            try {
                const response = await fetch(`${CC_BASE}/api/status`);
                const data = await response.json();
                if (data) ccRenderJourney(data);
            } catch (e) {
                console.error('Journey load error:', e);
                ccRenderJourneyFromConfig();
            }

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
            emptyEl.style.display = 'none';
        }

        function ccRenderJourney(data) {
            document.getElementById('cc-journey-route-text').textContent = `${ccSanitize(ccConfig?.addresses?.home || 'Home')} ‚Üí ${ccSanitize(ccConfig?.addresses?.work || 'Work')}`;
            if (data.leaveTime) document.getElementById('cc-leave-time').textContent = ccFormatTime12h(data.leaveTime);
            document.getElementById('cc-arrival-time').textContent = ccFormatTime12h(data.arrivalTime || ccConfig?.journey?.arrivalTime);
            if (data.totalDuration) document.getElementById('cc-total-duration').textContent = `${data.totalDuration} min`;

            const legs = document.getElementById('cc-journey-legs');
            let html = `<div class="cc-journey-leg"><div class="cc-leg-icon">üö∂</div><div class="cc-leg-label">Walk</div><div class="cc-leg-time">${data.walkToStation || '5'} min</div></div><div class="cc-arrow">‚Üí</div>`;

            if (ccConfig?.journey?.coffeeEnabled && ccConfig?.addresses?.cafe) {
                html += `<div class="cc-journey-leg"><div class="cc-leg-icon">‚òï</div><div class="cc-leg-label">Coffee</div><div class="cc-leg-time">${data.coffeeTime || '5'} min</div></div><div class="cc-arrow">‚Üí</div>`;
                document.getElementById('cc-coffee-card').style.display = 'block';
                document.getElementById('cc-coffee-decision').innerHTML = `<p style="color: var(--cc-accent);">Time for coffee at ${ccSanitize(ccConfig.cafe?.name || ccConfig.addresses.cafe)}</p>`;
            }

            const icon = data.mode === 1 ? 'üöä' : data.mode === 2 ? 'üöå' : 'üöÜ';
            html += `<div class="cc-journey-leg"><div class="cc-leg-icon">${icon}</div><div class="cc-leg-label">${ccSanitize(data.modeName || 'Transit')}</div><div class="cc-leg-time">${data.transitDuration || '20'} min</div></div><div class="cc-arrow">‚Üí</div>`;
            html += `<div class="cc-journey-leg"><div class="cc-leg-icon">üè¢</div><div class="cc-leg-label">Work</div></div>`;
            legs.innerHTML = html;

            if (data.weather) {
                document.getElementById('cc-weather').innerHTML = `<div style="display: flex; align-items: center; gap: 15px;"><span style="font-size: 32px;">${data.weather.icon || '‚òÄÔ∏è'}</span><div><div style="font-size: 24px; font-weight: 600;">${data.weather.temp || '--'}¬∞C</div><div style="color: var(--cc-text-secondary);">${ccSanitize(data.weather.condition || '')}</div></div></div>`;
            }

            if (data.departures?.length) {
                let dhtml = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                data.departures.slice(0, 3).forEach(d => {
                    dhtml += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;"><span>${ccSanitize(d.destination || d.route)}</span><strong style="color: var(--cc-accent);">${ccFormatTime12h(d.time)}</strong></div>`;
                });
                dhtml += '</div>';
                document.getElementById('cc-departures').innerHTML = dhtml;
            }
        }

        function ccRenderJourneyFromConfig() {
            document.getElementById('cc-journey-route-text').textContent = `${ccSanitize(ccConfig?.addresses?.home || 'Home')} ‚Üí ${ccSanitize(ccConfig?.addresses?.work || 'Work')}`;
            document.getElementById('cc-arrival-time').textContent = ccFormatTime12h(ccConfig?.journey?.arrivalTime);
            const legs = document.getElementById('cc-journey-legs');
            let html = `<div class="cc-journey-leg"><div class="cc-leg-icon">üö∂</div><div class="cc-leg-label">Walk</div></div><div class="cc-arrow">‚Üí</div>`;
            if (ccConfig?.journey?.coffeeEnabled) html += `<div class="cc-journey-leg"><div class="cc-leg-icon">‚òï</div><div class="cc-leg-label">Coffee</div></div><div class="cc-arrow">‚Üí</div>`;
            html += `<div class="cc-journey-leg"><div class="cc-leg-icon">üöÜ</div><div class="cc-leg-label">Transit</div></div><div class="cc-arrow">‚Üí</div>`;
            html += `<div class="cc-journey-leg"><div class="cc-leg-icon">üè¢</div><div class="cc-leg-label">Work</div></div>`;
            legs.innerHTML = html;
        }

        async function ccLoadDashboard() {
            const img = document.getElementById('cc-dashboard-image');
            const loading = document.getElementById('cc-dashboard-loading');
            let url = `${CC_BASE}/api/screen?t=${Date.now()}`;
            if (ccWebhookUrl) {
                const m = ccWebhookUrl.match(/\/api\/device\/(.+)$/);
                if (m) url = `${CC_BASE}/api/screen?token=${m[1]}&t=${Date.now()}`;
            }
            img.onload = () => { img.style.display = 'block'; loading.style.display = 'none'; };
            img.onerror = () => { loading.textContent = 'Failed to load preview'; };
            img.src = url;
            document.getElementById('cc-webhook-url').textContent = ccWebhookUrl || 'Not configured - complete setup wizard first';
        }

        function ccRefreshDashboard() { ccLoadDashboard(); ccToast('Refreshed', 'success'); }
        function ccOpenFullscreen() { window.open(`${CC_BASE}/api/screen?t=${Date.now()}`, '_blank'); }

        function ccCopyWebhook() {
            if (!ccWebhookUrl) { ccToast('No webhook configured', 'error'); return; }
            navigator.clipboard.writeText(ccWebhookUrl).then(() => ccToast('Copied!', 'success')).catch(() => ccToast('Copy manually', 'info'));
        }

        async function ccRegenerateWebhook() {
            if (!ccConfig) { ccToast('No configuration', 'error'); return; }
            try {
                const r = await fetch(`${CC_BASE}/api/admin/generate-webhook`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config: ccConfig }) });
                const d = await r.json();
                if (d.success) {
                    ccWebhookUrl = d.webhookUrl;
                    localStorage.setItem('cc-webhook-url', ccWebhookUrl);
                    document.getElementById('cc-webhook-url').textContent = ccWebhookUrl;
                    ccToast('Webhook regenerated!', 'success');
                } else { ccToast('Failed', 'error'); }
            } catch (e) { ccToast('Error', 'error'); }
        }

        function ccLoadConfiguration() {
            if (!ccConfig) return;
            document.getElementById('cc-config-home').value = ccConfig.addresses?.home || '';
            document.getElementById('cc-config-work').value = ccConfig.addresses?.work || '';
            document.getElementById('cc-config-cafe').value = ccConfig.addresses?.cafe || '';
            document.getElementById('cc-config-arrival').value = ccConfig.journey?.arrivalTime || '09:00';
            document.getElementById('cc-config-coffee').checked = ccConfig.journey?.coffeeEnabled !== false;
        }

        async function ccSaveConfiguration() {
            ccConfig = ccConfig || {};
            ccConfig.addresses = ccConfig.addresses || {};
            ccConfig.journey = ccConfig.journey || {};
            ccConfig.addresses.home = document.getElementById('cc-config-home').value;
            ccConfig.addresses.work = document.getElementById('cc-config-work').value;
            ccConfig.addresses.cafe = document.getElementById('cc-config-cafe').value;
            ccConfig.journey.arrivalTime = document.getElementById('cc-config-arrival').value;
            ccConfig.journey.coffeeEnabled = document.getElementById('cc-config-coffee').checked;
            localStorage.setItem('cc-config', JSON.stringify(ccConfig));
            await ccRegenerateWebhook();
            ccToast('Configuration saved!', 'success');
        }

        function ccResetConfiguration() {
            if (!confirm('Reset all configuration?')) return;
            localStorage.clear();
            window.location.href = '/setup-wizard.html';
        }

        function ccLoadApiStatus() {
            const tk = ccConfig?.api?.key || localStorage.getItem('cc-transport-key');
            if (tk) {
                document.getElementById('cc-api-transport').value = tk;
                document.getElementById('cc-transport-status').textContent = 'Set';
                document.getElementById('cc-transport-status').className = 'cc-status cc-status-success';
            }
            const gk = localStorage.getItem('cc-google-key');
            if (gk) {
                document.getElementById('cc-api-google').value = gk;
                document.getElementById('cc-google-status').textContent = 'Set';
                document.getElementById('cc-google-status').className = 'cc-status cc-status-success';
            }
        }

        async function ccSaveTransportKey() {
            const key = document.getElementById('cc-api-transport').value.trim();
            if (!key) { ccToast('Enter API key', 'error'); return; }
            if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(key)) { ccToast('Invalid UUID format', 'error'); return; }
            try {
                const r = await fetch(`${CC_BASE}/api/save-transit-key`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiKey: key, state: ccConfig?.state || 'VIC' }) });
                const d = await r.json();
                if (d.success) {
                    localStorage.setItem('cc-transport-key', key);
                    if (ccConfig) { ccConfig.api = ccConfig.api || {}; ccConfig.api.key = key; localStorage.setItem('cc-config', JSON.stringify(ccConfig)); }
                    document.getElementById('cc-transport-status').textContent = 'Validated';
                    document.getElementById('cc-transport-status').className = 'cc-status cc-status-success';
                    ccToast('Saved & validated!', 'success');
                } else { ccToast(d.message || 'Failed', 'error'); }
            } catch (e) { ccToast('Error', 'error'); }
        }

        async function ccSaveGoogleKey() {
            const key = document.getElementById('cc-api-google').value.trim();
            if (!key) { ccToast('Enter API key', 'error'); return; }
            try {
                const r = await fetch(`${CC_BASE}/api/save-google-key`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiKey: key }) });
                const d = await r.json();
                if (d.success) {
                    localStorage.setItem('cc-google-key', key);
                    document.getElementById('cc-google-status').textContent = 'Saved';
                    document.getElementById('cc-google-status').className = 'cc-status cc-status-success';
                    ccToast('Saved!', 'success');
                } else { ccToast(d.message || 'Failed', 'error'); }
            } catch (e) { ccToast('Error', 'error'); }
        }

        async function ccLoadSystemInfo() {
            try {
                const r = await fetch(`${CC_BASE}/api/version`);
                const d = await r.json();
                document.getElementById('cc-version').textContent = d.version || '3.0.0';
            } catch (e) {}
            document.getElementById('cc-sys-state').textContent = ccConfig?.state || 'VIC';
            document.getElementById('cc-data-source').textContent = ccConfig?.api?.key ? 'Live GTFS-RT' : 'Fallback Timetables';
            document.getElementById('cc-last-updated').textContent = new Date().toLocaleString('en-AU');
        }

        async function ccClearCache() {
            if (!confirm('Clear cache?')) return;
            try { await fetch(`${CC_BASE}/admin/cache/clear`, { method: 'POST' }); } catch (e) {}
            ccToast('Cache cleared', 'success');
        }

        function ccResetAll() {
            if (!confirm('Delete ALL data?')) return;
            if (!confirm('Are you sure?')) return;
            localStorage.clear();
            ccToast('Cleared. Redirecting...', 'success');
            setTimeout(() => window.location.href = '/setup-wizard.html', 1500);
        }

        async function ccRecalculateJourney() {
            ccToast('Recalculating...', 'info');
            try { await fetch(`${CC_BASE}/api/journey-recalculate`, { method: 'POST' }); } catch (e) {}
            await ccLoadJourney();
            ccToast('Done!', 'success');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            ccUpdateClock();
            setInterval(ccUpdateClock, 1000);
            await ccLoadJourney();
        });
    </script>
</body>
</html>
