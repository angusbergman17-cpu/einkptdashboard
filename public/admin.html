<!DOCTYPE html>
<html lang="en">
<!--
    PTV-TRMNL - Intelligent Transit Display System
    Copyright (c) 2026 Angus Bergman
    All rights reserved.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTV-TRMNL Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(34, 197, 94, 0.2);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .time-display {
            font-size: 48px;
            font-weight: 700;
            margin: 15px 0 5px;
            font-variant-numeric: tabular-nums;
        }

        .date-display {
            font-size: 16px;
            opacity: 0.8;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .nav-tab.active {
            background: rgba(99, 102, 241, 0.8);
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Grid layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Cards */
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .card-icon {
            font-size: 24px;
        }

        /* Departure rows */
        .departure-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .departure-row:last-child {
            border-bottom: none;
        }

        .departure-dest {
            font-weight: 500;
            font-size: 15px;
        }

        .departure-status {
            font-size: 12px;
            opacity: 0.7;
        }

        .departure-time {
            font-size: 28px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .departure-time span {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.7;
        }

        /* Weather */
        .weather-display {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .weather-temp {
            font-size: 48px;
            font-weight: 700;
        }

        .weather-condition {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .weather-extra {
            font-size: 13px;
            opacity: 0.7;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            opacity: 0.9;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.8);
            background: rgba(255,255,255,0.15);
        }

        .form-input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Buttons */
        .btn {
            background: rgba(99, 102, 241, 0.8);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(99, 102, 241, 1);
            transform: translateY(-1px);
        }

        .btn-success {
            background: rgba(34, 197, 94, 0.8);
        }

        .btn-success:hover {
            background: rgba(34, 197, 94, 1);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #6366f1;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .message-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .message-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        /* Coffee decision */
        .coffee-decision {
            text-align: center;
            padding: 20px;
        }

        .coffee-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .coffee-text {
            font-size: 22px;
            font-weight: 700;
        }

        .coffee-subtext {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-live {
            background: rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .status-fallback {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Route summary */
        .route-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .route-time {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }

        .route-time-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .route-time-value {
            font-size: 28px;
            font-weight: 700;
        }

        /* Transit mode selector */
        .transit-mode {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .transit-mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .add-mode-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 15px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            background: transparent;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .add-mode-btn:hover {
            border-color: rgba(99, 102, 241, 0.8);
            color: white;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            opacity: 0.6;
            font-size: 13px;
        }

        .footer a {
            color: white;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* No data */
        .no-data {
            text-align: center;
            padding: 30px;
            opacity: 0.6;
        }

        /* Address Autocomplete */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2d3748;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .form-group {
            position: relative;
        }

        /* System Architecture Viz */
        .arch-node {
            background: rgba(99, 102, 241, 0.2);
            border: 2px solid #6366f1;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .arch-node-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #c7d2fe;
        }

        .arch-node-desc {
            font-size: 13px;
            opacity: 0.85;
            line-height: 1.5;
        }

        .arch-arrow {
            text-align: center;
            font-size: 24px;
            margin: 5px 0;
            opacity: 0.6;
        }

        /* Version control footer */
        .version-footer {
            margin-top: 30px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-size: 11px;
            color: #718096;
            font-family: 'Courier New', monospace;
        }

        .version-footer .version-label {
            font-weight: 600;
            color: #4a5568;
            margin-right: 8px;
        }

        .version-footer .version-value {
            color: #2d3748;
        }

        .version-footer .separator {
            margin: 0 10px;
            color: #cbd5e0;
        }

        /* Autocomplete dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 10px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .autocomplete-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* Onboarding Overlay & Tutorial Styles */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .onboarding-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(102, 126, 234, 0.3);
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .onboarding-modal h2 {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .onboarding-modal p {
            font-size: 16px;
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .onboarding-step-content {
            min-height: 180px;
        }

        .onboarding-features {
            list-style: none;
            margin: 20px 0;
        }

        .onboarding-features li {
            padding: 10px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
        }

        .onboarding-features li:before {
            content: "‚úì";
            display: inline-block;
            width: 24px;
            height: 24px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            color: #667eea;
            flex-shrink: 0;
        }

        .onboarding-progress {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 25px 0 20px;
        }

        .onboarding-progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .onboarding-progress-dot.active {
            width: 30px;
            border-radius: 5px;
            background: #667eea;
        }

        .onboarding-buttons {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            margin-top: 25px;
        }

        .btn-onboarding {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-onboarding-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-onboarding-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-onboarding-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-onboarding-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-onboarding-skip {
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            padding: 12px 20px;
        }

        .btn-onboarding-skip:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Tutorial Highlight */
        .tutorial-highlight {
            position: relative;
            z-index: 10000;
            box-shadow: 0 0 0 4px #667eea, 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 12px;
        }

        .tutorial-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            z-index: 10001;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: tooltipPulse 0.4s ease-out;
        }

        @keyframes tooltipPulse {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .tutorial-tooltip:after {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .tutorial-tooltip.top:after {
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0 10px;
            border-color: #764ba2 transparent transparent transparent;
        }

        .tutorial-tooltip.bottom:after {
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent #667eea transparent;
        }

        /* Show Tutorial Again Button */
        .show-tutorial-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 1000;
        }

        .show-tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Progressive UI Disclosure - Mode Toggle */
        .mode-toggle-container {
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .mode-toggle {
            position: relative;
            width: 56px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .mode-toggle.advanced {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .mode-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .mode-toggle.advanced .mode-toggle-slider {
            transform: translateX(28px);
        }

        .mode-label {
            font-size: 13px;
            font-weight: 500;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .mode-label.active {
            opacity: 1;
            color: #667eea;
        }

        /* Advanced-only elements (hidden in simple mode) */
        .advanced-only {
            display: none !important;
        }

        body.advanced-mode .advanced-only {
            display: block !important;
        }

        body.advanced-mode .nav-tab.advanced-only {
            display: inline-block !important;
        }

        body.advanced-mode .advanced-only.inline {
            display: inline !important;
        }

        body.advanced-mode .advanced-only.flex {
            display: flex !important;
        }

        /* Visual Enhancements - Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-operational {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }

        .status-degraded {
            background: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
        }

        .status-down {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.05) 25%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0.05) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
            height: 20px;
            margin: 8px 0;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton.skeleton-card {
            height: 120px;
            border-radius: 12px;
        }

        .skeleton.skeleton-text {
            height: 16px;
            width: 100%;
        }

        .skeleton.skeleton-text-short {
            height: 16px;
            width: 60%;
        }

        /* Success Animation */
        @keyframes success-pulse {
            0%, 100% {
                background: rgba(34, 197, 94, 0.1);
                border-color: rgba(34, 197, 94, 0.3);
            }
            50% {
                background: rgba(34, 197, 94, 0.2);
                border-color: rgba(34, 197, 94, 0.5);
            }
        }

        .success-flash {
            animation: success-pulse 1s ease-in-out;
        }

        /* Color-coded confidence indicators */
        .confidence-high {
            color: #22c55e;
            font-weight: 600;
        }

        .confidence-medium {
            color: #f59e0b;
            font-weight: 600;
        }

        .confidence-low {
            color: #ef4444;
            font-weight: 600;
        }

        .confidence-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .confidence-badge.high {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .confidence-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .confidence-badge.low {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastSlideIn 0.3s ease-out;
            min-width: 300px;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.toast-success {
            border-color: #22c55e;
        }

        .toast.toast-error {
            border-color: #ef4444;
        }

        .toast.toast-warning {
            border-color: #f59e0b;
        }

        .toast.toast-info {
            border-color: #667eea;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            opacity: 0.9;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Confirmation Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(102, 126, 234, 0.3);
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .confirm-modal h3 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #667eea;
        }

        .confirm-modal p {
            font-size: 15px;
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 24px;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .confirm-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .confirm-btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .confirm-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .confirm-btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .confirm-btn-danger:hover {
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        /* Inline Validation */
        .form-field {
            margin-bottom: 16px;
        }

        .form-field.error input,
        .form-field.error select,
        .form-field.error textarea {
            border-color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.05);
        }

        .form-field.success input,
        .form-field.success select {
            border-color: #22c55e !important;
            background: rgba(34, 197, 94, 0.05);
        }

        .field-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .field-error:before {
            content: "‚ö†";
        }

        .field-success {
            color: #22c55e;
            font-size: 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .field-success:before {
            content: "‚úì";
        }

        /* Responsive Design - Mobile Friendly */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 24px;
            }

            .time-display {
                font-size: 36px;
            }

            .nav-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .nav-tab {
                width: 100%;
                text-align: center;
            }

            .card {
                padding: 16px;
            }

            .toast-container {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .toast {
                min-width: auto;
            }

            .confirm-modal {
                padding: 20px;
                width: 95%;
            }

            .mode-toggle-container {
                flex-direction: row;
                gap: 8px;
            }
        }

        /* 8px Grid System */
        * {
            /* Base spacing units: 8px, 16px, 24px, 32px */
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --spacing-xl: 40px;
        }

        /* Enhanced Card Shadows */
        .card {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2),
                        0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3),
                        0 8px 32px rgba(0, 0, 0, 0.2);
        }

        /* Accessibility Improvements - WCAG AAA */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        a:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        .btn:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 3px;
        }

        /* Skip to content link for screen readers */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: #667eea;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-to-content:focus {
            top: 0;
        }

        /* High contrast text for accessibility */
        p, span, div {
            color: rgba(255, 255, 255, 0.95);
        }

        label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        /* Smooth animations with 200ms timing */
        button, .card, .nav-tab, .toast {
            transition: all 200ms ease-out;
        }

        input, select, textarea {
            transition: border-color 200ms ease-out,
                        background 200ms ease-out,
                        transform 200ms ease-out;
        }
    </style>
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Onboarding Overlay (shown on first visit) -->
    <div id="onboarding-overlay" class="onboarding-overlay" style="display: none;">
        <div class="onboarding-modal">
            <div class="onboarding-step-content" id="onboarding-content">
                <!-- Content will be dynamically inserted -->
            </div>
            <div class="onboarding-progress" id="onboarding-progress">
                <div class="onboarding-progress-dot active"></div>
                <div class="onboarding-progress-dot"></div>
                <div class="onboarding-progress-dot"></div>
                <div class="onboarding-progress-dot"></div>
            </div>
            <div class="onboarding-buttons">
                <button class="btn-onboarding btn-onboarding-skip" id="onboarding-skip" onclick="skipOnboarding()">
                    Skip Tutorial
                </button>
                <div style="display: flex; gap: 12px; flex: 1;">
                    <button class="btn-onboarding btn-onboarding-secondary" id="onboarding-prev" onclick="prevOnboardingStep()" style="display: none;">
                        ‚Üê Previous
                    </button>
                    <button class="btn-onboarding btn-onboarding-primary" id="onboarding-next" onclick="nextOnboardingStep()">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Show Tutorial Again Button (hidden by default) -->
    <button id="show-tutorial-btn" class="show-tutorial-btn" onclick="restartTutorial()" style="display: none;">
        ? Show Tutorial
    </button>

    <div class="container" id="main-content">
        <!-- Header -->
        <div class="header">
            <h1>PTV-TRMNL Admin</h1>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span id="data-mode">Loading...</span>
            </div>
            <div class="time-display" id="current-time">--:--:--</div>
            <div class="date-display" id="current-date">Loading...</div>

            <!-- Mode Toggle -->
            <div class="mode-toggle-container">
                <span class="mode-label active" id="mode-label-simple">Simple</span>
                <div class="mode-toggle" id="mode-toggle" onclick="toggleUIMode()">
                    <div class="mode-toggle-slider"></div>
                </div>
                <span class="mode-label" id="mode-label-advanced">Advanced</span>
            </div>
        </div>


        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab" onclick="showTab('setup')">üöÄ Setup & Journey</button>
            <button class="nav-tab" onclick="showTab('api')">üîë API Settings</button>
            <button class="nav-tab active" onclick="showTab('live')">üöä Live Data</button>
            <button class="nav-tab advanced-only" onclick="showTab('config')">‚öôÔ∏è Configuration</button>
            <button class="nav-tab advanced-only" onclick="showTab('system')">üß† System & Support</button>
        </div>

        <!-- Setup & Journey Tab -->
        <div id="tab-setup" class="tab-content">
            <!-- Auto-Calculation Status (shown when configured) -->
            <div id="auto-calc-card" class="card" style="display: none; margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #667eea;">
                <div class="card-header">
                    <span class="card-icon">üîÑ</span>
                    <h2>Automatic Journey Updates</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9; font-size: 14px;">
                    Your journey is automatically recalculated every 2 minutes with live transit data.
                </p>
                <div id="auto-calc-status" style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 13px; opacity: 0.8;">Loading status...</div>
                </div>
                <button class="btn btn-secondary" onclick="forceRecalculation()" id="recalc-btn">
                    üîÑ Recalculate Now
                </button>
            </div>

            <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #667eea;">
                <div class="card-header">
                    <span class="card-icon">üöÄ</span>
                    <h2 id="setup-title">Journey Setup</h2>
                </div>
                <p id="setup-description" style="margin-bottom: 25px; opacity: 0.9; font-size: 14px;">
                    Enter your addresses and arrival time. We'll automatically detect nearby transit stops, select the best route, and start journey planning.
                </p>

                <!-- Single-Step Form -->
                <div style="max-width: 600px; margin: 0 auto;">
                    <div class="form-group" style="position: relative;">
                        <label class="form-label">üè† Home Address *</label>
                        <input type="text" id="setup-home-address" class="form-input" placeholder="Start typing your home address..." autocomplete="off" required>
                        <div id="setup-home-suggestions" class="autocomplete-dropdown"></div>
                        <small style="color: rgba(255,255,255,0.6); font-size: 11px; display: block; margin-top: 5px;">
                            We'll detect your state and find nearby transit stops automatically
                        </small>
                    </div>

                    <div class="form-group" style="position: relative;">
                        <label class="form-label">üíº Work Address *</label>
                        <input type="text" id="setup-work-address" class="form-input" placeholder="Start typing your work address..." autocomplete="off" required>
                        <div id="setup-work-suggestions" class="autocomplete-dropdown"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‚è∞ Arrival Time at Work *</label>
                        <input type="time" id="setup-arrival-time" class="form-input" value="09:00" required>
                    </div>

                    <div class="form-group" style="position: relative;">
                        <label class="form-label">‚òï Favorite Cafe (Optional)</label>
                        <input type="text" id="setup-cafe-address" class="form-input" placeholder="Start typing cafe name or address..." autocomplete="off">
                        <div id="setup-cafe-suggestions" class="autocomplete-dropdown"></div>
                        <small style="color: rgba(255,255,255,0.6); font-size: 11px; display: block; margin-top: 5px;">
                            Include a coffee stop in your morning routine
                        </small>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="setup-include-coffee" checked>
                        <label for="setup-include-coffee">Factor coffee time into journey planning (5 minutes)</label>
                    </div>

                    <!-- Google Places API Key Section -->
                    <div style="margin-top: 30px; padding: 20px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; border: 2px dashed rgba(99, 102, 241, 0.3);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 24px;">üîë</span>
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Optional: Google Places API Key</h3>
                        </div>
                        <p style="font-size: 13px; opacity: 0.85; margin-bottom: 15px; line-height: 1.6;">
                            The smart journey planner works with free Nominatim geocoding, but adding a Google Places API key provides enhanced address search and cafe discovery.
                        </p>

                        <div class="checkbox-group" style="margin-bottom: 15px;">
                            <input type="checkbox" id="setup-has-google-api" onchange="toggleGoogleApiInput()">
                            <label for="setup-has-google-api">I have a Google Places API key</label>
                        </div>

                        <div id="setup-google-api-input" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Google Places API Key</label>
                                <input type="password" id="setup-google-api-key" class="form-input" placeholder="Enter your Google Places API key">
                                <small style="color: rgba(255,255,255,0.6); font-size: 11px; display: block; margin-top: 5px;">
                                    Don't have one? <a href="https://console.cloud.google.com/apis/library/places-backend.googleapis.com" target="_blank" style="color: #60a5fa; text-decoration: none;">Get it here (free tier available)</a>
                                </small>
                            </div>
                            <button class="btn btn-secondary" onclick="saveGoogleApiKey()" style="width: 100%; margin-top: 10px;">
                                üíæ Save API Key & Restart System
                            </button>
                            <div id="google-api-save-message" style="display: none; margin-top: 10px; padding: 10px; border-radius: 6px; font-size: 13px;"></div>
                        </div>

                        <div style="margin-top: 12px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 6px; border-left: 3px solid #fbbf24;">
                            <div style="font-size: 12px; opacity: 0.9;">
                                <strong>üí° Note:</strong> Google Places free tier includes $200/month credit. The system has quota protection built-in to never exceed free limits.
                            </div>
                        </div>
                    </div>

                    <div id="setup-message" class="message" style="display: none; margin-top: 20px;"></div>
                    <div id="setup-progress" style="display: none; margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.2); border-radius: 8px; border-left: 3px solid #667eea;">
                        <div style="font-weight: 600; margin-bottom: 10px;">üîÑ Setting up your journey...</div>
                        <div id="setup-progress-text" style="font-size: 13px; opacity: 0.9;"></div>
                    </div>

                    <button class="btn btn-block btn-success" onclick="startJourneyPlanning()" style="margin-top: 25px; font-size: 16px; padding: 15px;">
                        ‚ú® Start Journey Planning
                    </button>

                    <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <p style="font-size: 13px; opacity: 0.7; margin-bottom: 10px;">
                            <strong>What happens next?</strong>
                        </p>
                        <ul style="text-align: left; font-size: 12px; opacity: 0.8; line-height: 1.8; max-width: 450px; margin: 0 auto;">
                            <li>‚úÖ Your state will be auto-detected from your address</li>
                            <li>‚úÖ Nearby transit stops will be identified automatically</li>
                            <li>‚úÖ Best route mode (train/tram/bus) will be selected</li>
                            <li>‚úÖ Journey calculation will start immediately</li>
                            <li>‚úÖ Live updates will begin (every 2 minutes)</li>
                        </ul>
                        <p style="font-size: 12px; opacity: 0.7; margin-top: 15px;">
                            Need API credentials? Add them in the <strong>Configuration</strong> tab for live transit data.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Data Tab -->
        <div id="tab-live" class="tab-content active">
            <!-- Unconfigured Placeholder (shown until setup complete) -->
            <div id="live-data-unconfigured" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;">üöÜ</div>
                <h2 style="margin-bottom: 15px; opacity: 0.9;">Live Data Not Available Yet</h2>
                <p style="opacity: 0.7; margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                    Complete the journey setup first to see live transit data, departure times, and journey recommendations.
                </p>
                <button class="btn btn-primary" onclick="showTab('setup')" style="padding: 12px 30px; font-size: 16px;">
                    ‚Üí Go to Setup
                </button>
            </div>

            <!-- Live Data Content (shown after configuration) -->
            <div id="live-data-configured">
                <!-- Data Source Indicator Banner -->
                <div id="data-source-indicator" style="margin-bottom: 20px; padding: 18px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="data-source-icon" style="font-size: 28px;">üî¥</span>
                        <div>
                            <div id="data-source-title" style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">Using Fallback Timetable Data</div>
                            <div id="data-source-subtitle" style="font-size: 13px; opacity: 0.85;">Configure API keys in API Settings to enable real-time updates</div>
                        </div>
                    </div>
                    <button id="data-source-action-btn" class="btn btn-secondary" onclick="showTab('api')" style="padding: 10px 20px; font-size: 14px; white-space: nowrap;">
                        ‚Üí API Settings
                    </button>
                </div>

                <!-- Configuration Status Banner -->
                <div id="config-status-banner" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 12px; border-left: 4px solid #667eea;">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px;">üì° Live Data Configuration</div>
                    <div id="config-summary" style="font-size: 13px; opacity: 0.9; line-height: 1.6;">Loading configuration...</div>
                </div>

                <div class="grid">
                <!-- Train Departures -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üöÜ</span>
                        <h2 id="train-station-name">Train Departures</h2>
                        <span class="status-badge" id="train-status">‚óè</span>
                    </div>
                    <div id="train-departures">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>

                <!-- Tram Departures -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üöä</span>
                        <h2 id="tram-station-name">Tram Departures</h2>
                        <span class="status-badge" id="tram-status">‚óè</span>
                    </div>
                    <div id="tram-departures">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>

                <!-- Weather -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üå§Ô∏è</span>
                        <h2 id="weather-location-name">Weather</h2>
                        <span class="status-badge status-live" id="weather-source">BOM</span>
                    </div>
                    <div id="weather-display">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>

                <!-- Coffee Decision -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">‚òï</span>
                        <h2>Coffee Decision</h2>
                        <span class="status-badge" id="coffee-status">‚óè</span>
                    </div>
                    <div id="coffee-decision" class="coffee-decision">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>

            <!-- API Status Dashboard -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <span class="card-icon">üîå</span>
                    <h2>API Status & Configuration</h2>
                </div>
                <div id="api-status-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div class="loading"><div class="spinner"></div>Loading API status...</div>
                </div>
            </div>

            <!-- Journey Summary -->
            <div class="card" id="journey-summary-card" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">üó∫Ô∏è</span>
                    <h2>Today's Journey</h2>
                </div>
                <div id="journey-summary"></div>
            </div>
            </div><!-- end live-data-configured -->
        </div>

        <!-- API Settings Tab (NEW) -->
        <div id="tab-api" class="tab-content">
            <!-- Introduction Banner -->
            <div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border-radius: 12px; border-left: 4px solid #667eea;">
                <div style="font-size: 24px; margin-bottom: 12px;">üîë API Settings</div>
                <p style="opacity: 0.9; line-height: 1.6; margin-bottom: 12px;">
                    Configure API credentials to enable <strong>real-time transit data</strong> and enhanced features.
                </p>
                <p style="opacity: 0.8; font-size: 14px; line-height: 1.5; margin: 0;">
                    <strong>All fields are optional.</strong> The system works with fallback timetable data if you don't configure APIs.
                    Real-time updates enhance accuracy but aren't required.
                </p>
            </div>

            <!-- Current Data Mode Indicator -->
            <div id="data-mode-indicator" style="margin-bottom: 25px; padding: 16px; background: rgba(251, 191, 36, 0.1); border-radius: 10px; border-left: 4px solid #fbbf24;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="font-size: 24px;">üî¥</span>
                    <div>
                        <div style="font-weight: 600; font-size: 15px;">Using Fallback Timetable Data</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Configure API keys below to enable live real-time updates</div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <!-- Transit Authority API Credentials -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üîë</span>
                        <h2 id="transit-api-title">Transit Authority API</h2>
                    </div>
                    <div id="transit-api-description" style="margin-bottom: 15px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; display: none;">
                        <p style="margin: 0; opacity: 0.9; font-size: 13px;">
                            <strong>Victoria:</strong> For Transport Victoria OpenData API credentials, visit
                            <a href="https://opendata.transport.vic.gov.au/" target="_blank" style="color: #667eea;">OpenData Transport Victoria</a>
                        </p>
                        <p style="margin: 8px 0 0 0; opacity: 0.8; font-size: 12px;">
                            See <strong>VICTORIA-GTFS-REALTIME-PROTOCOL.md</strong> for GTFS Realtime API instructions
                        </p>
                    </div>
                    <div id="transit-api-description-generic" style="margin-bottom: 15px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 13px;">
                            Enter your transit authority API credentials below. Configuration details will appear after detecting your location in Setup tab.
                        </p>
                    </div>
                    <div id="api-message"></div>
                    <div class="form-group">
                        <label class="form-label">API Key (Optional)</label>
                        <input type="text" id="ptv-dev-id" class="form-input" placeholder="Your API Key">
                        <small style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 5px;">
                            VIC: Previously called "Developer ID" | Other states: Check your transit authority portal
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Token / Secret (Optional)</label>
                        <input type="password" id="ptv-api-key" class="form-input" placeholder="Your API Token">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="savePtvConfig()">Save</button>
                        <button class="btn btn-secondary" onclick="testPtvApi()">Test</button>
                    </div>
                </div>

                <!-- Victorian GTFS Realtime API (Victoria only) -->
                <div id="victoria-gtfs-config" class="card" style="display: none;">
                    <div class="card-header">
                        <span class="card-icon">üöÇ</span>
                        <h2>GTFS Realtime API (Victoria)</h2>
                    </div>
                    <p style="margin-bottom: 15px; opacity: 0.9; font-size: 13px;">
                        Optional: Enable real-time metro train updates via Transport for Victoria's OpenData portal
                    </p>
                    <div class="form-group">
                        <label class="form-label">GTFS Realtime Subscription Key (Optional)</label>
                        <input type="password" id="gtfs-realtime-key" class="form-input" placeholder="Your subscription key from opendata.transport.vic.gov.au">
                        <small style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 5px;">
                            Get your key at <a href="https://opendata.transport.vic.gov.au/" target="_blank" style="color: #667eea;">opendata.transport.vic.gov.au</a>
                        </small>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="saveGtfsRealtimeConfig()">Save</button>
                        <button class="btn btn-secondary" onclick="testGtfsRealtimeApi()">Test</button>
                    </div>
                </div>

                <!-- Additional API Keys -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üåê</span>
                        <h2>Enhanced Features</h2>
                    </div>
                    <p style="margin-bottom: 15px; opacity: 0.9; font-size: 13px;">
                        Optional: Add Google Places, Mapbox, or custom RSS feeds for enhanced functionality
                    </p>

                    <div class="form-group">
                        <label class="form-label">Google Places API Key (Optional)</label>
                        <input type="password" id="google-places-key" class="form-input" placeholder="For enhanced geocoding and cafe busy-ness detection">
                        <small style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 5px;">
                            Get from <a href="https://console.cloud.google.com/" target="_blank" style="color: #667eea;">Google Cloud Console</a>
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Mapbox Access Token (Optional)</label>
                        <input type="password" id="mapbox-token" class="form-input" placeholder="For additional geocoding coverage">
                        <small style="color: rgba(255,255,255,0.6); font-size: 12px; display: block; margin-top: 5px;">
                            Get from <a href="https://account.mapbox.com/" target="_blank" style="color: #667eea;">Mapbox Account</a>
                        </small>
                    </div>

                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; font-size: 14px; font-weight: 600;">Custom RSS Feeds</h3>
                            <button class="btn btn-secondary" onclick="addRssFeed()" style="padding: 6px 12px; font-size: 12px;">+ Add Feed</button>
                        </div>
                        <div id="rss-feeds-list" style="display: grid; gap: 10px;">
                            <!-- RSS feeds will be populated here -->
                            <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6; font-size: 13px;">
                                No custom RSS feeds added yet
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="saveAdditionalAPIs()">Save All</button>
                    </div>
                </div>
            </div>

            <!-- API Status Overview -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <span class="card-icon">üìä</span>
                    <h2>API Status Overview</h2>
                </div>
                <div id="api-health-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        Configure APIs above to see status
                    </div>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%); border-left: 4px solid #3b82f6;">
                <div class="card-header">
                    <span class="card-icon">üí°</span>
                    <h2>Getting API Keys</h2>
                </div>
                <div style="font-size: 14px; line-height: 1.7; opacity: 0.9;">
                    <p><strong>Victoria (Melbourne)</strong>:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Visit <a href="https://opendata.transport.vic.gov.au/" target="_blank" style="color: #667eea;">OpenData Transport Victoria</a></li>
                        <li>Sign up for a free developer account</li>
                        <li>Subscribe to GTFS Realtime feeds (Metro Trains, Trams)</li>
                        <li>Copy your subscription key and paste above</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Other States</strong>:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Check your state's transit authority developer portal</li>
                        <li>Most states offer free API access for personal use</li>
                        <li>Look for "Developer", "API", or "Open Data" sections</li>
                    </ul>
                </div>
            </div>
        </div>


        <!-- Configuration Tab -->
        <div id="tab-config" class="tab-content">
            <!-- Journey Profiles Management (Task #6) -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #667eea;">
                <div class="card-header">
                    <span class="card-icon">üìã</span>
                    <h2>Journey Profiles</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px;">
                    Create multiple journey profiles for different routes, schedules, or scenarios.
                </p>

                <!-- Active Profile Display -->
                <div id="active-profile-display" style="padding: 16px; background: rgba(34, 197, 94, 0.1); border-radius: 10px; border-left: 3px solid #22c55e; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">‚úì</span>
                        <span>Active: <span id="active-profile-name">Default Journey</span></span>
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        <span id="active-profile-schedule">Active all days</span>
                    </div>
                </div>

                <!-- Profile List -->
                <div id="profiles-list" style="display: grid; gap: 12px; margin-bottom: 20px;">
                    <!-- Profiles will be populated here -->
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        Loading profiles...
                    </div>
                </div>

                <button class="btn btn-primary" onclick="showCreateProfileModal()">
                    + Create New Profile
                </button>
            </div>

            <!-- Data Sources Overview -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #667eea;">
                <div class="card-header">
                    <span class="card-icon">üåê</span>
                    <h2>Active Data Sources</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px;">
                    All external APIs and data sources currently used by the system
                </p>
                <div id="data-sources-list" style="display: grid; gap: 12px;">
                    <!-- Will be populated dynamically -->
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        Loading data sources...
                    </div>
                </div>
            </div>

            <!-- User Configuration -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <span class="card-icon">üë§</span>
                    <h2>Your Journey Configuration</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px;">
                    Addresses, stops, and preferences you've entered
                </p>
                <div id="user-config-display" style="display: grid; gap: 15px;">
                    <!-- Will be populated dynamically -->
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        No configuration yet. Complete setup first.
                    </div>
                </div>
            </div>

            <!-- Note: API settings moved to API Settings tab -->
            <div style="margin-bottom: 20px; padding: 16px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                <div style="font-weight: 600; margin-bottom: 6px;">üîë Looking for API Settings?</div>
                <div style="font-size: 14px; opacity: 0.9;">
                    API credentials have been moved to the <strong>API Settings</strong> tab for easier configuration.
                    <button class="btn btn-secondary" onclick="showTab('api')" style="margin-left: 10px; padding: 6px 16px; font-size: 13px;">
                        ‚Üí Go to API Settings
                    </button>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">‚öôÔ∏è</span>
                        <h2>Display Settings</h2>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="use-24-hour" checked>
                        <label for="use-24-hour">24-hour time</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-walking-times" checked>
                        <label for="show-walking-times">Show walking times</label>
                    </div>
                    <button class="btn" onclick="saveDisplaySettings()">Save Settings</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üõ†Ô∏è</span>
                        <h2>Actions</h2>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn" onclick="refreshData()">Refresh Data</button>
                        <button class="btn btn-secondary" onclick="clearCache()">Clear Cache</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System & Support Tab -->
        <div id="tab-system" class="tab-content">
            <!-- System Architecture -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-left: 4px solid #667eea;">
                <div class="card-header">
                    <span class="card-icon">üß†</span>
                    <h2>Complete System Architecture Map</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9; font-size: 14px;">
                    Visual mind map showing data flow from setup wizard through server to TRMNL device
                </p>
                <button class="btn btn-primary btn-block" onclick="toggleSystemArchitecture()" id="arch-toggle-btn" style="margin-bottom: 15px; font-size: 16px; font-weight: 600;">
                    <span style="font-size: 20px;">üîç</span> Show Full Architecture Map
                </button>
                <div id="architecture-viz" style="display: none; margin-top: 20px;"></div>
            </div>

            <!-- Victorian GTFS Realtime Data Viewer (Victoria only) -->
            <div id="victoria-gtfs-viewer" class="card" style="display: none; margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-left: 4px solid #667eea;">
                <div class="card-header">
                    <span class="card-icon">üöÇ</span>
                    <h2>Live GTFS Realtime Data Viewer (Victoria)</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9; font-size: 14px;">
                    Real-time trip updates from Transport Victoria's OpenData portal - Metro trains only
                </p>
                <iframe
                    title="Data viewer"
                    width="100%"
                    height="400"
                    src="https://opendata.transport.vic.gov.au/dataset/gtfs-realtime/resource/0010d606-47bf-4abb-a04f-63add63a4d23/view/07d75c4f-db6f-444d-97d8-22082ab0a0ca"
                    frameBorder="0"
                    style="border-radius: 8px; background: white; border: 1px solid rgba(255,255,255,0.1);">
                </iframe>
                <div style="margin-top: 15px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                    <p style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; opacity: 0.9;">üìö Resources:</p>
                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; opacity: 0.8; line-height: 1.8;">
                        <li><a href="https://opendata.transport.vic.gov.au/dataset/gtfs-realtime" target="_blank" style="color: #667eea;">OpenData Portal - GTFS Realtime Dataset</a></li>
                        <li><a href="https://opendata.transport.vic.gov.au/dataset/2d9a7228-5b81-40d3-8075-ae7a3da42198/resource/0010d606-47bf-4abb-a04f-63add63a4d23/download/gtfsr_metro_train_trip_updates.openapi.json" target="_blank" style="color: #667eea;">OpenAPI Specification (JSON)</a></li>
                        <li>See <strong>VICTORIA-GTFS-REALTIME-PROTOCOL.md</strong> for complete implementation guide</li>
                    </ul>
                </div>
            </div>

            <!-- Algorithm Intelligence -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);">
                <div class="card-header">
                    <span class="card-icon">ü§ñ</span>
                    <h2>Algorithm Intelligence</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px;">
                    What makes this system smart? Here's how our algorithms work together to optimize your journey.
                </p>

                <!-- Coffee Decision Algorithm -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #40DCA5;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px;">
                        ‚òï Coffee Decision Algorithm
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Intelligence:</strong> Dynamically calculates if there's time for coffee based on real-time transit data</p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Inputs:</strong></div>
                            ‚Ä¢ Walking time from home to station (calculated via geocoding)<br>
                            ‚Ä¢ Next available train departure (live GTFS data)<br>
                            ‚Ä¢ Cafe busy-ness indicator (Google Places API)<br>
                            ‚Ä¢ Estimated coffee preparation time (2-5 min based on busy-ness)<br>
                            ‚Ä¢ Walking time from cafe to station<br>
                            ‚Ä¢ Safety buffer (2 min to avoid missing train)
                        </div>
                        <div style="padding: 12px; background: rgba(64, 220, 165, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Decision Logic:</strong></div>
                            If (home_to_station_walk + coffee_prep + cafe_to_station_walk + buffer) < time_until_next_train:<br>
                            <span style="margin-left: 20px; color: #40DCA5;">‚úì <strong>Go for coffee!</strong></span><br>
                            Else:<br>
                            <span style="margin-left: 20px; color: #fc8181;">‚úó <strong>Go direct</strong></span>
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Communication:</strong> Sends decision to Smart Journey Planner ‚Üí Updates display module
                        </p>
                    </div>
                </details>

                <!-- Multi-Tier Geocoding -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #667eea;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px;">
                        üìç Multi-Tier Geocoding Intelligence
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Intelligence:</strong> 6-service fallback chain ensures address resolution always succeeds</p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Priority Chain:</strong></div>
                            1. <strong>Google Places</strong> - Highest accuracy, business data<br>
                            2. <strong>Mapbox</strong> - Global coverage, address-focused<br>
                            3. <strong>HERE</strong> - Optimized for Australian addresses<br>
                            4. <strong>Foursquare</strong> - Venue and business locations<br>
                            5. <strong>LocationIQ</strong> - Free tier geocoding<br>
                            6. <strong>Nominatim (OpenStreetMap)</strong> - Always available fallback
                        </div>
                        <div style="padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Smart Features:</strong></div>
                            ‚Ä¢ <strong>Bias coordinates</strong>: Searches near your configured city<br>
                            ‚Ä¢ <strong>Decision logging</strong>: Records which service was used<br>
                            ‚Ä¢ <strong>24-hour cache</strong>: Faster responses for repeated addresses<br>
                            ‚Ä¢ <strong>Automatic retry</strong>: If one service fails, tries next immediately
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Communication:</strong> Used by Route Planner ‚Üí Provides coordinates to Walking Time Calculator
                        </p>
                    </div>
                </details>

                <!-- Real-Time Delay Detection -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #f6ad55;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px;">
                        ‚ö° Real-Time Delay Detection & Adjustment
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Intelligence:</strong> Monitors live transit data and automatically recalculates journey when delays are detected</p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Detection Process:</strong></div>
                            ‚Ä¢ Fetches GTFS-Realtime data every 30 seconds<br>
                            ‚Ä¢ Compares scheduled departure vs actual departure<br>
                            ‚Ä¢ Calculates delay in minutes<br>
                            ‚Ä¢ Categorizes severity: on-time (0 min), delayed (1-10 min), disrupted (>10 min)
                        </div>
                        <div style="padding: 12px; background: rgba(246, 173, 85, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Automatic Actions:</strong></div>
                            1. <strong>Updates journey display</strong> with revised times<br>
                            2. <strong>Recalculates coffee decision</strong> based on new timing<br>
                            3. <strong>Adjusts connection buffers</strong> for multi-leg journeys<br>
                            4. <strong>Logs decision</strong> for transparency
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Communication:</strong> GTFS data ‚Üí Delay Detector ‚Üí Journey Status API ‚Üí Display Updates
                        </p>
                    </div>
                </details>

                <!-- Journey Optimization -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #8b5cf6;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px;">
                        üéØ Journey Optimization Engine
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Intelligence:</strong> Plans optimal route considering walking speed, connection buffers, and service patterns</p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Optimization Factors:</strong></div>
                            ‚Ä¢ <strong>Walking speed</strong>: 4.5 km/h average human walking pace<br>
                            ‚Ä¢ <strong>Connection buffer</strong>: 3-5 minutes between services<br>
                            ‚Ä¢ <strong>Station access time</strong>: Platform walking time included<br>
                            ‚Ä¢ <strong>Service frequency</strong>: Considers headways between trains
                        </div>
                        <div style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Route Selection:</strong></div>
                            1. Calculate all possible routes to destination<br>
                            2. Score each route: (earliest_arrival √ó 0.6) + (fewest_changes √ó 0.3) + (least_walking √ó 0.1)<br>
                            3. Select highest-scoring route<br>
                            4. Validate against live service data
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Communication:</strong> User Preferences ‚Üí Route Planner ‚Üí Multi-Modal Router ‚Üí Journey Display
                        </p>
                    </div>
                </details>

                <!-- Module Communication Map -->
                <details style="margin-bottom: 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #ec4899;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px;">
                        üîÑ Inter-Module Communication Flow
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>How the algorithms talk to each other:</strong></p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 11px; line-height: 1.6;">
                            User Preferences<br>
                            ‚Üì<br>
                            Setup Wizard ‚Üí Preferences Manager<br>
                            ‚Üì<br>
                            Geocoding Service (addresses ‚Üí coordinates)<br>
                            ‚Üì<br>
                            Route Planner + Walking Time Calculator<br>
                            ‚Üì<br>
                            Transit Authority API (GTFS Realtime)<br>
                            ‚Üì<br>
                            Multi-Modal Router<br>
                            ‚Üì<br>
                            Coffee Decision Engine + Busy Detector<br>
                            ‚Üì<br>
                            Smart Journey Planner (combines all data)<br>
                            ‚Üì<br>
                            Automatic Background Calculation (every 2 min)<br>
                            ‚Üì<br>
                            Journey Status API + Delay Detection<br>
                            ‚Üì<br>
                            Display Module ‚Üí Your TRMNL Device
                        </div>
                        <div style="padding: 12px; background: rgba(236, 72, 153, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Key Communication Methods:</strong></div>
                            ‚Ä¢ <strong>Shared Cache</strong>: Modules read/write to cachedJourney<br>
                            ‚Ä¢ <strong>Decision Logger</strong>: All modules log decisions to global logger<br>
                            ‚Ä¢ <strong>Preferences Object</strong>: Centralized configuration accessed by all<br>
                            ‚Ä¢ <strong>Event-Driven Updates</strong>: API endpoints trigger recalculations<br>
                            ‚Ä¢ <strong>Real-Time Sync</strong>: 30-second refresh cycle keeps data current
                        </div>
                    </div>
                </details>
            </div>

            <!-- Decision Log -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <span class="card-icon">üìã</span>
                    <h2>Decision Log</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9;">
                    View all decisions made by the system for full transparency and troubleshooting
                </p>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="loadDecisionLog()" style="flex: 1;">
                        <span style="font-size: 18px;">üìä</span> View Decision Log
                    </button>
                    <button class="btn btn-success" onclick="exportDecisionLog()" style="flex: 1;">
                        <span style="font-size: 18px;">üíæ</span> Export Logs
                    </button>
                </div>
                <div id="decision-log-content" style="display: none; margin-top: 20px; max-height: 500px; overflow-y: auto;">
                    <div id="decision-log-stats" style="margin-bottom: 15px;"></div>
                    <div id="decision-log-entries"></div>
                </div>
            </div>

            <!-- Feedback Form -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <span class="card-icon">üí¨</span>
                    <h2>Send Feedback & Ideas</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9;">
                    Have ideas for improvements or experiencing issues? Send feedback directly to the developer.
                </p>
                <div id="feedback-form">
                    <div class="form-group">
                        <label class="form-label">Your Name (Optional)</label>
                        <input type="text" id="feedback-name" class="form-input" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Email (Optional)</label>
                        <input type="email" id="feedback-email" class="form-input" placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Feedback Type</label>
                        <select id="feedback-type" class="form-input">
                            <option value="idea">üí° Feature Idea</option>
                            <option value="bug">üêõ Bug Report</option>
                            <option value="question">‚ùì Question</option>
                            <option value="praise">üéâ Praise</option>
                            <option value="other">üìù Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea id="feedback-message" class="form-input" rows="5" placeholder="Describe your feedback, idea, or issue..." required></textarea>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="submitFeedback()">
                        <span style="font-size: 18px;">üì®</span> Send Feedback
                    </button>
                    <div id="feedback-status" style="margin-top: 15px; text-align: center; display: none;"></div>
                </div>
            </div>

            <!-- Data Source Compliance -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <span class="card-icon">‚öñÔ∏è</span>
                    <h2>Data Source Compliance & Licensing</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9;">
                    This system uses multiple external data sources. <strong>You are responsible for complying with their terms of service and obtaining necessary API keys.</strong>
                </p>

                <!-- Transport APIs -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 4px solid #667eea;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none;">
                        üöÜ Transport Victoria OpenData API
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Real-time train, tram, and bus data in Victoria</p>
                        <p><strong>Registration:</strong> <a href="https://opendata.transport.vic.gov.au/" target="_blank" style="color: #667eea;">https://opendata.transport.vic.gov.au/</a></p>
                        <p><strong>License:</strong> Creative Commons Attribution 4.0 International</p>
                        <p><strong>Compliance:</strong> Must attribute "Transport Victoria" in any public-facing implementation</p>
                    </div>
                </details>

                <!-- Weather API -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(72, 187, 120, 0.1); border-radius: 8px; border-left: 4px solid #48bb78;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none;">
                        üå§Ô∏è Bureau of Meteorology (BOM) Data
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Weather data and forecasts</p>
                        <p><strong>Access:</strong> <a href="http://www.bom.gov.au/catalogue/data-feeds.shtml" target="_blank" style="color: #48bb78;">http://www.bom.gov.au/catalogue/data-feeds.shtml</a></p>
                        <p><strong>License:</strong> Creative Commons Attribution 3.0 Australia</p>
                        <p><strong>Compliance:</strong> Must attribute "Bureau of Meteorology" and include copyright notice</p>
                        <p style="font-size: 12px; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 4px;">
                            Example: "Weather data ¬© Commonwealth of Australia, Bureau of Meteorology"
                        </p>
                    </div>
                </details>

                <!-- Google Places API -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 4px solid #fbbf24;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none;">
                        üìç Google Places API (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Enhanced cafe/business geocoding and busy-ness detection</p>
                        <p><strong>Registration:</strong> <a href="https://developers.google.com/maps/documentation/places" target="_blank" style="color: #fbbf24;">Google Cloud Console</a></p>
                        <p><strong>License:</strong> Google Maps Platform Terms of Service</p>
                        <p><strong>Compliance:</strong> Must display "Powered by Google" logo and attribution</p>
                        <p><strong>Pricing:</strong> Check current pricing at <a href="https://cloud.google.com/maps-platform/pricing" target="_blank" style="color: #fbbf24;">Google Cloud Pricing</a></p>
                    </div>
                </details>

                <!-- Mapbox -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none;">
                        üó∫Ô∏è Mapbox Geocoding API (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> High-accuracy address geocoding</p>
                        <p><strong>Registration:</strong> <a href="https://www.mapbox.com/pricing" target="_blank" style="color: #3b82f6;">Mapbox Pricing</a></p>
                        <p><strong>License:</strong> Mapbox Terms of Service</p>
                        <p><strong>Compliance:</strong> Must include Mapbox attribution in any maps displayed</p>
                    </div>
                </details>

                <!-- HERE -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 4px solid #8b5cf6;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none;">
                        üåè HERE Geocoding API (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Australian address optimization</p>
                        <p><strong>Registration:</strong> <a href="https://developer.here.com/" target="_blank" style="color: #8b5cf6;">HERE Developer Portal</a></p>
                        <p><strong>License:</strong> HERE Platform Terms and Conditions</p>
                        <p><strong>Compliance:</strong> Freemium tier available; check usage limits</p>
                    </div>
                </details>

                <!-- OpenStreetMap -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none;">
                        üåç OpenStreetMap Nominatim (Free, Always Available)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Fallback geocoding (no API key needed)</p>
                        <p><strong>Documentation:</strong> <a href="https://nominatim.org/release-docs/latest/" target="_blank" style="color: #10b981;">Nominatim Documentation</a></p>
                        <p><strong>License:</strong> Open Database License (ODbL)</p>
                        <p><strong>Compliance:</strong> Must include "¬© OpenStreetMap contributors" attribution</p>
                        <p><strong>Usage Policy:</strong> Must include valid User-Agent header (already implemented)</p>
                    </div>
                </details>

                <!-- Foursquare -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(236, 72, 153, 0.1); border-radius: 8px; border-left: 4px solid #ec4899;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none;">
                        üìå Foursquare Places API (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Venue and business location data</p>
                        <p><strong>Registration:</strong> <a href="https://foursquare.com/developers/" target="_blank" style="color: #ec4899;">Foursquare Developers</a></p>
                        <p><strong>License:</strong> Foursquare Developer Terms</p>
                        <p><strong>Compliance:</strong> Must attribute Foursquare in any displayed data</p>
                    </div>
                </details>

                <!-- LocationIQ -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(156, 163, 175, 0.1); border-radius: 8px; border-left: 4px solid #9ca3af;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none;">
                        üîç LocationIQ (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Free tier geocoding</p>
                        <p><strong>Registration:</strong> <a href="https://locationiq.com/" target="_blank" style="color: #9ca3af;">LocationIQ</a></p>
                        <p><strong>License:</strong> Free tier: 5,000 requests/day</p>
                        <p><strong>Compliance:</strong> Must include attribution per terms of service</p>
                    </div>
                </details>

                <!-- Important Notice -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(252, 129, 129, 0.15); border: 2px solid rgba(252, 129, 129, 0.5); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px; color: #fc8181;">‚ö†Ô∏è YOUR RESPONSIBILITY</div>
                    <p style="font-size: 13px; line-height: 1.6; margin: 0;">
                        <strong>As a user of this software, you are responsible for:</strong><br>
                        ‚Ä¢ Registering for and maintaining your own API keys<br>
                        ‚Ä¢ Complying with all terms of service for external APIs<br>
                        ‚Ä¢ Properly attributing all data sources as required<br>
                        ‚Ä¢ Staying within usage limits and quotas<br>
                        ‚Ä¢ Paying for any commercial API usage<br>
                        <br>
                        <strong>The software creator (Angus Bergman) is not responsible for your use of external APIs.</strong>
                    </p>
                </div>
            </div>

            <!-- System Reset & Cache Management (Collapsible) -->
            <details class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(252, 129, 129, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%); border-left: 4px solid #fc8181;">
                <summary style="cursor: pointer; user-select: none; list-style: none; padding: 20px;">
                    <div class="card-header" style="margin: -20px; padding: 20px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span class="card-icon">‚ö†Ô∏è</span>
                            <h2 style="margin: 0;">System Reset & Cache Management</h2>
                        </div>
                        <span style="font-size: 20px; transition: transform 0.3s;">‚ñº</span>
                    </div>
                </summary>
                <div style="padding: 0 20px 20px 20px;">
                    <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px; line-height: 1.6;">
                        Advanced system controls for managing data and restarting the server. Use these tools carefully.
                    </p>

                <!-- Cache Clear -->
                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;">üóëÔ∏è</span>
                        <div>
                            <div style="font-weight: 600; font-size: 15px;">Clear All Caches</div>
                            <div style="font-size: 12px; opacity: 0.8;">Clears geocoding, weather, and journey calculation caches</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-block" onclick="clearAllCaches()" id="clear-cache-btn">
                        üóëÔ∏è Clear Caches Only
                    </button>
                </div>

                <!-- Full System Reset -->
                <div style="background: linear-gradient(135deg, rgba(252, 129, 129, 0.15) 0%, rgba(239, 68, 68, 0.15) 100%); border-radius: 8px; padding: 20px; border: 2px solid #fc8181;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <span style="font-size: 28px;">üîÑ</span>
                        <div>
                            <div style="font-weight: 700; font-size: 16px; color: #e53e3e;">Complete System Reset</div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">‚ö†Ô∏è This will delete ALL user data and restart the server</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 12px; margin-bottom: 15px; font-size: 13px; line-height: 1.6;">
                        <strong>What gets deleted:</strong><br>
                        ‚Ä¢ All addresses (home, cafe, work)<br>
                        ‚Ä¢ Journey preferences and transit routes<br>
                        ‚Ä¢ API credentials<br>
                        ‚Ä¢ All cached data (geocoding, weather, journey)<br>
                        ‚Ä¢ Location and state configuration<br>
                        <br>
                        <strong>What happens after:</strong><br>
                        ‚Ä¢ Server restarts automatically (10 second delay)<br>
                        ‚Ä¢ You'll need to run Setup Wizard again<br>
                        ‚Ä¢ All data will be fresh and empty
                    </div>

                    <button class="btn btn-block" onclick="confirmFullSystemReset()" id="full-reset-btn"
                            style="background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
                                   color: white;
                                   font-weight: 700;
                                   font-size: 16px;
                                   padding: 15px;
                                   border: none;
                                   box-shadow: 0 4px 12px rgba(252, 129, 129, 0.3);">
                        ‚ö†Ô∏è WIPE ALL DATA & RESTART SERVER
                    </button>
                </div>
                </div>
            </details>

            <!-- Support Section -->
            <div class="card" style="background: linear-gradient(135deg, #40DCA5 0%, #2ecc71 100%); color: white; border: none;">
                <div class="card-header" style="border: none;">
                    <span class="card-icon">‚òï</span>
                    <h2 style="color: white;">Support This Project</h2>
                </div>
                <p style="margin-bottom: 20px; line-height: 1.6; opacity: 0.95;">
                    From conception to execution, many weeks, hours, and all-nighters went into creating this intelligent transit system.
                    Your support helps keep the project alive and improving.
                </p>
                <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 12px; font-size: 15px;">What your support enables:</div>
                    <div style="display: grid; gap: 10px; font-size: 14px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">üöÄ</span>
                            <span>Continued development and new features</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">üêõ</span>
                            <span>Bug fixes and performance improvements</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">üìö</span>
                            <span>Better documentation and guides</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">üíª</span>
                            <span>Server hosting and API costs</span>
                        </div>
                    </div>
                </div>
                <a href="https://buymeacoffee.com/angusbergman" target="_blank"
                   class="btn btn-block"
                   style="background: white; color: #40DCA5; font-weight: 600; font-size: 16px; text-decoration: none; display: block; text-align: center; padding: 15px;">
                    ‚òï Buy Me a Coffee
                </a>
                <div style="text-align: center; margin-top: 15px; font-size: 13px; opacity: 0.85;">
                    Every contribution, big or small, is deeply appreciated üíö
                </div>
            </div>

            <!-- About -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">‚ÑπÔ∏è</span>
                    <h2>About PTV-TRMNL</h2>
                </div>
                <p style="line-height: 1.6; margin-bottom: 15px;">
                    An intelligent real-time Melbourne transit display system that learns your commute patterns
                    and helps you decide: <strong>Can I get coffee, or should I go direct?</strong>
                </p>
                <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; line-height: 1.6; font-size: 14px;">
                    <div><strong>Data Sources:</strong></div>
                    <div style="opacity: 0.9; margin-top: 5px;">
                        ‚Ä¢ Bureau of Meteorology (Official JSON Feeds)<br>
                        ‚Ä¢ Transport Victoria GTFS-Realtime API<br>
                        ‚Ä¢ OpenStreetMap Nominatim<br>
                        ‚Ä¢ Google Places API (Optional)
                    </div>
                </div>
            </div>
        </div>

        <!-- Version Control Footer -->
        <div class="version-footer">
            <span class="version-label">Version:</span>
            <span class="version-value" id="versionHash">Loading...</span>
            <span class="separator">‚Ä¢</span>
            <span class="version-label">Build:</span>
            <span class="version-value" id="buildDate">Loading...</span>
            <span class="separator">‚Ä¢</span>
            <span class="version-value">¬© 2026 Angus Bergman</span>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><a href="/admin/live-display" target="_blank">Live Display</a> ¬∑ <a href="/preview" target="_blank">E-Ink Preview</a> ¬∑ <a href="/api/dashboard" target="_blank">HTML Dashboard</a> ¬∑ <a href="/journey" target="_blank">Journey Visualizer</a></p>
            <p style="margin-top: 15px; font-size: 12px; opacity: 0.7;">
                ¬© 2026 Angus Bergman. All rights reserved.<br>
                PTV-TRMNL - Intelligent Transit Display System
            </p>

            <!-- Data Source Attributions (Dynamic based on configuration) -->
            <div id="attributions-footer" style="margin-top: 15px; padding: 10px 12px; background: rgba(255, 255, 255, 0.03); border-left: 2px solid rgba(237, 137, 54, 0.3); font-size: 10px; opacity: 0.7; line-height: 1.6;">
                <div style="font-weight: 600; margin-bottom: 6px; font-size: 11px; opacity: 0.9;">Data Source Attributions</div>
                <div id="attributions-content" style="font-size: 10px;">Loading...</div>
            </div>

            <!-- License Information (Collapsible) -->
            <details style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 12px; line-height: 1.7; cursor: pointer;">
                <summary style="font-weight: 600; font-size: 13px; cursor: pointer; user-select: none;">
                    üìÑ License Information (Click to expand)
                </summary>
                <div style="margin-top: 15px;">
                    <p style="margin-bottom: 10px;">
                        This software, including all code, architecture, and documentation, is created by <strong>Angus Bergman</strong> and is licensed under:
                    </p>
                    <p style="margin-bottom: 10px;">
                        <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 600;">
                            Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)
                        </a>
                    </p>
                    <div style="padding: 10px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                        <div style="font-weight: 600; margin-bottom: 6px;">‚úÖ You ARE free to:</div>
                        <ul style="margin-left: 20px; margin-bottom: 10px;">
                            <li>Use this software for personal, non-commercial purposes</li>
                            <li>Modify and adapt the code for your own use</li>
                            <li>Share the software with proper attribution to Angus Bergman</li>
                            <li>Study how it works and learn from it</li>
                        </ul>
                        <div style="font-weight: 600; margin-bottom: 6px;">‚ùå You are NOT allowed to:</div>
                        <ul style="margin-left: 20px;">
                            <li>Use this software for commercial purposes without written permission</li>
                            <li>Sell or profit from this software or derivatives</li>
                            <li><strong style="color: #fc8181;">Remove or obscure attribution to Angus Bergman</strong></li>
                            <li>Claim this work as your own</li>
                        </ul>
                    </div>
                    <p style="margin-top: 10px; font-size: 11px; opacity: 0.8;">
                        For commercial licensing inquiries, contact: angusbergman17@gmail.com
                    </p>
                </div>
            </details>
        </div>
    </div>

    <script>
        /**
         * ========================================================================
         * CRITICAL: DEVELOPMENT RULES COMPLIANCE REQUIRED
         * ========================================================================
         *
         * ALL CODE IN THIS FILE MUST COMPLY WITH:
         * docs/development/DEVELOPMENT-RULES.md (v1.0.12)
         *
         * TOP PRIORITY REQUIREMENTS:
         *
         * 1. LOCATION AGNOSTIC (Section K):
         *    - NO hardcoded locations (Melbourne, Victoria, etc.)
         *    - NO hardcoded timezones (Australia/Melbourne)
         *    - MUST detect state from user input
         *    - MUST use dynamic timezone based on detected state
         *    - MUST support all 8 Australian states/territories equally
         *
         * 2. USER-FIRST API KEY FLOW (Section R):
         *    - Setup MUST work WITHOUT API keys (fallback data)
         *    - API keys are OPTIONAL enhancements
         *    - Clear indicators: fallback vs live data
         *
         * 3. TERMINOLOGY (Section 3):
         *    - Use "Transport for Victoria" or "Transport Victoria"
         *    - NEVER use "PTV" or "Public Transport Victoria"
         *    - Use "ODATA_API_KEY" for environment variables
         *
         * 4. ROBUST ERROR HANDLING (Section N):
         *    - Timeout protection on all external calls
         *    - Circuit breakers for APIs
         *    - Graceful degradation
         *
         * 5. TRMNL BYOS COMPLIANCE (Section P):
         *    - 7.5" e-ink display (800x480 or 480x800)
         *    - BYOS webhook format required
         *    - Respect e-ink refresh limits
         *
         * 6. RENDER COMPATIBILITY (Section Q):
         *    - Use process.cwd() for file paths
         *    - Correct relative imports
         *    - Memory optimization for free tier
         *
         * BEFORE MAKING CHANGES:
         * - Read DEVELOPMENT-RULES.md sections 1-4
         * - Check for forbidden terms (Section 1)
         * - Verify location agnostic principles (Section K)
         * - Test with fallback data (no API keys)
         * - Run compliance self-check (Section 15)
         *
         * VIOLATIONS OF THESE RULES ARE NOT PERMITTED.
         * ========================================================================
         */

        const BASE_URL = window.location.origin;
        let refreshInterval;

        // ==================== ONBOARDING SYSTEM ====================

        const ONBOARDING_STEPS = [
            {
                title: "Welcome to PTV-TRMNL! üöä",
                content: `
                    <p>Your intelligent transit display system for smart commute decisions.</p>
                    <ul class="onboarding-features">
                        <li>Real-time transit data from Transport Victoria</li>
                        <li>Intelligent journey planning with live delays</li>
                        <li>Coffee stop optimization based on transit times</li>
                        <li>Weather-aware departure recommendations</li>
                    </ul>
                    <p style="margin-top: 15px; font-size: 14px; opacity: 0.8;">This quick tutorial will show you how to get started.</p>
                `
            },
            {
                title: "Step 1: Configure Your Journey üè†",
                content: `
                    <p>Start by setting up your daily journey locations:</p>
                    <ul class="onboarding-features">
                        <li><strong>Home Address:</strong> Your starting point</li>
                        <li><strong>Coffee Stop:</strong> Your favorite cafe (optional)</li>
                        <li><strong>Work Address:</strong> Your destination</li>
                    </ul>
                    <p style="margin-top: 15px;">The system will auto-detect your state and find nearby transit stops.</p>
                `,
                highlightElement: "tab-setup",
                scrollTo: "tab-setup"
            },
            {
                title: "Step 2: Select Transit Stops üöâ",
                content: `
                    <p>After entering addresses, you'll choose your preferred transit stops:</p>
                    <ul class="onboarding-features">
                        <li>System finds stops near your locations</li>
                        <li>Select departure and arrival stations</li>
                        <li>Data validation ensures accuracy</li>
                    </ul>
                    <p style="margin-top: 15px;">PTV-TRMNL will then calculate smart departure times automatically.</p>
                `
            },
            {
                title: "Step 3: View Live Departures üî¥",
                content: `
                    <p>Once configured, enjoy real-time transit information:</p>
                    <ul class="onboarding-features">
                        <li>Auto-updates every 2 minutes</li>
                        <li>Live delay and cancellation alerts</li>
                        <li>Smart coffee stop recommendations</li>
                        <li>Weather-aware departure times</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Ready to get started?</strong> Let's configure your journey!</p>
                `
            }
        ];

        let currentOnboardingStep = 0;

        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('ptv-trmnl-onboarding-completed');
            if (!hasVisited) {
                setTimeout(() => {
                    startOnboarding();
                }, 500);
            } else {
                // Show "Show Tutorial Again" button for returning users
                document.getElementById('show-tutorial-btn').style.display = 'block';
            }
        }

        function startOnboarding() {
            currentOnboardingStep = 0;
            document.getElementById('onboarding-overlay').style.display = 'flex';
            updateOnboardingStep();
        }

        function updateOnboardingStep() {
            const step = ONBOARDING_STEPS[currentOnboardingStep];
            const content = document.getElementById('onboarding-content');
            const prevBtn = document.getElementById('onboarding-prev');
            const nextBtn = document.getElementById('onboarding-next');
            const skipBtn = document.getElementById('onboarding-skip');

            // Clear any previous highlights
            removeAllHighlights();

            // Update content
            content.innerHTML = `
                <h2>${step.title}</h2>
                ${step.content}
            `;

            // Update progress dots
            const dots = document.querySelectorAll('.onboarding-progress-dot');
            dots.forEach((dot, index) => {
                if (index === currentOnboardingStep) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });

            // Update buttons
            if (currentOnboardingStep === 0) {
                prevBtn.style.display = 'none';
                nextBtn.textContent = 'Next ‚Üí';
                skipBtn.style.display = 'block';
            } else if (currentOnboardingStep === ONBOARDING_STEPS.length - 1) {
                prevBtn.style.display = 'block';
                nextBtn.textContent = 'Get Started! üöÄ';
                skipBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'block';
                nextBtn.textContent = 'Next ‚Üí';
                skipBtn.style.display = 'block';
            }

            // Apply highlight if specified
            if (step.highlightElement) {
                setTimeout(() => {
                    highlightElement(step.highlightElement);
                }, 300);
            }

            // Scroll to element if specified
            if (step.scrollTo) {
                setTimeout(() => {
                    const element = document.getElementById(step.scrollTo);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
            }
        }

        function nextOnboardingStep() {
            if (currentOnboardingStep < ONBOARDING_STEPS.length - 1) {
                currentOnboardingStep++;
                updateOnboardingStep();
            } else {
                completeOnboarding();
            }
        }

        function prevOnboardingStep() {
            if (currentOnboardingStep > 0) {
                currentOnboardingStep--;
                updateOnboardingStep();
            }
        }

        function skipOnboarding() {
            if (confirm('Are you sure you want to skip the tutorial? You can always restart it later from the "Show Tutorial" button.')) {
                completeOnboarding();
            }
        }

        function completeOnboarding() {
            localStorage.setItem('ptv-trmnl-onboarding-completed', 'true');
            document.getElementById('onboarding-overlay').style.display = 'none';
            document.getElementById('show-tutorial-btn').style.display = 'block';
            removeAllHighlights();

            // Navigate to setup tab
            showTab('setup');
        }

        function restartTutorial() {
            localStorage.removeItem('ptv-trmnl-onboarding-completed');
            startOnboarding();
            document.getElementById('show-tutorial-btn').style.display = 'none';
        }

        function highlightElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('tutorial-highlight');
            }
        }

        function removeAllHighlights() {
            const highlighted = document.querySelectorAll('.tutorial-highlight');
            highlighted.forEach(el => el.classList.remove('tutorial-highlight'));
        }

        // ==================== END ONBOARDING SYSTEM ====================

        // ==================== PROGRESSIVE UI DISCLOSURE ====================

        function toggleUIMode() {
            const body = document.body;
            const toggle = document.getElementById('mode-toggle');
            const simpleLabel = document.getElementById('mode-label-simple');
            const advancedLabel = document.getElementById('mode-label-advanced');

            const isAdvanced = body.classList.toggle('advanced-mode');

            // Update toggle appearance
            if (isAdvanced) {
                toggle.classList.add('advanced');
                simpleLabel.classList.remove('active');
                advancedLabel.classList.add('active');
            } else {
                toggle.classList.remove('advanced');
                simpleLabel.classList.add('active');
                advancedLabel.classList.remove('active');
            }

            // Save preference
            localStorage.setItem('ptv-trmnl-ui-mode', isAdvanced ? 'advanced' : 'simple');
        }

        function loadUIMode() {
            const savedMode = localStorage.getItem('ptv-trmnl-ui-mode') || 'simple';
            if (savedMode === 'advanced') {
                const body = document.body;
                const toggle = document.getElementById('mode-toggle');
                const simpleLabel = document.getElementById('mode-label-simple');
                const advancedLabel = document.getElementById('mode-label-advanced');

                body.classList.add('advanced-mode');
                toggle.classList.add('advanced');
                simpleLabel.classList.remove('active');
                advancedLabel.classList.add('active');
            }
        }

        // ==================== END PROGRESSIVE UI DISCLOSURE ====================

        // ==================== TOAST NOTIFICATION SYSTEM ====================

        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úó',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Convenience functions
        function showSuccess(title, message) {
            showToast('success', title, message);
        }

        function showError(title, message) {
            showToast('error', title, message);
        }

        function showWarning(title, message) {
            showToast('warning', title, message);
        }

        function showInfo(title, message) {
            showToast('info', title, message);
        }

        // ==================== END TOAST NOTIFICATION SYSTEM ====================

        // ==================== CONFIRMATION MODAL SYSTEM ====================

        function showConfirm(title, message, onConfirm, options = {}) {
            const overlay = document.createElement('div');
            overlay.className = 'confirm-modal-overlay';

            const isDangerous = options.danger || false;
            const confirmText = options.confirmText || 'Confirm';
            const cancelText = options.cancelText || 'Cancel';

            overlay.innerHTML = `
                <div class="confirm-modal">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div class="confirm-modal-buttons">
                        <button class="confirm-btn confirm-btn-cancel" id="confirm-cancel">
                            ${cancelText}
                        </button>
                        <button class="confirm-btn ${isDangerous ? 'confirm-btn-danger' : 'confirm-btn-confirm'}" id="confirm-ok">
                            ${confirmText}
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Handle button clicks
            document.getElementById('confirm-ok').addEventListener('click', () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            });

            document.getElementById('confirm-cancel').addEventListener('click', () => {
                overlay.remove();
            });

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });

            // Close on Escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // ==================== END CONFIRMATION MODAL SYSTEM ====================

        // ==================== INLINE VALIDATION HELPERS ====================

        function validateField(inputId, validator, errorMessage) {
            const input = document.getElementById(inputId);
            const field = input.closest('.form-field') || input.parentElement;

            if (!validator(input.value)) {
                field.classList.add('error');
                field.classList.remove('success');

                let errorEl = field.querySelector('.field-error');
                if (!errorEl) {
                    errorEl = document.createElement('div');
                    errorEl.className = 'field-error';
                    field.appendChild(errorEl);
                }
                errorEl.textContent = errorMessage;
                return false;
            } else {
                field.classList.remove('error');
                field.classList.add('success');

                const errorEl = field.querySelector('.field-error');
                if (errorEl) errorEl.remove();

                let successEl = field.querySelector('.field-success');
                if (!successEl) {
                    successEl = document.createElement('div');
                    successEl.className = 'field-success';
                    field.appendChild(successEl);
                }
                successEl.textContent = 'Looks good!';
                return true;
            }
        }

        function clearFieldValidation(inputId) {
            const input = document.getElementById(inputId);
            const field = input.closest('.form-field') || input.parentElement;

            field.classList.remove('error', 'success');
            const errorEl = field.querySelector('.field-error');
            const successEl = field.querySelector('.field-success');
            if (errorEl) errorEl.remove();
            if (successEl) successEl.remove();
        }

        // ==================== END INLINE VALIDATION HELPERS ====================

        // ==================== JOURNEY PROFILES MANAGEMENT (Task #6) ====================

        let profiles = [];

        // Load all profiles
        async function loadProfiles() {
            try {
                const response = await fetch(BASE_URL + '/api/profiles');
                const data = await response.json();

                if (data.success) {
                    profiles = data.profiles;
                    renderProfiles();
                    updateActiveProfileDisplay();
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        // Render profiles list
        function renderProfiles() {
            const container = document.getElementById('profiles-list');
            if (!container) return;

            if (profiles.length === 0) {
                container.innerHTML = `
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        No profiles yet. Create your first journey profile!
                    </div>
                `;
                return;
            }

            container.innerHTML = profiles.map(profile => {
                const isActive = profile.isActive;
                const scheduleText = getScheduleText(profile.schedule);

                return `
                    <div class="profile-card" style="padding: 16px; background: ${isActive ? 'rgba(102, 126, 234, 0.15)' : 'rgba(255,255,255,0.05)'}; border-radius: 10px; border-left: 3px solid ${isActive ? '#667eea' : 'rgba(255,255,255,0.2)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-weight: 600; font-size: 15px;">${profile.name}</span>
                                    ${isActive ? '<span style="background: rgba(102, 126, 234, 0.3); color: #667eea; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">ACTIVE</span>' : ''}
                                </div>
                                <div style="font-size: 13px; opacity: 0.8;">
                                    üìÖ ${scheduleText}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${!isActive ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="activateProfile('${profile.id}')">Activate</button>` : ''}
                                ${profile.id !== 'default' ? `
                                    <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteProfileConfirm('${profile.id}')">Delete</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update active profile display
        function updateActiveProfileDisplay() {
            const activeProfile = profiles.find(p => p.isActive);
            if (!activeProfile) return;

            const nameEl = document.getElementById('active-profile-name');
            const scheduleEl = document.getElementById('active-profile-schedule');

            if (nameEl) nameEl.textContent = activeProfile.name;
            if (scheduleEl) scheduleEl.textContent = getScheduleText(activeProfile.schedule);
        }

        // Get schedule text description
        function getScheduleText(schedule) {
            if (schedule.type === 'all') return 'Active all days';
            if (schedule.type === 'weekdays') return 'Weekdays only';
            if (schedule.type === 'weekends') return 'Weekends only';
            if (schedule.type === 'custom') {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const days = schedule.days.map(d => dayNames[d]).join(', ');
                return `Custom: ${days}`;
            }
            return 'Custom schedule';
        }

        // Show create profile modal
        function showCreateProfileModal() {
            const modal = document.createElement('div');
            modal.className = 'confirm-modal-overlay';
            modal.innerHTML = `
                <div class="confirm-modal" style="max-width: 600px;">
                    <h3>Create Journey Profile</h3>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Profile Name</label>
                        <input type="text" id="profile-name" placeholder="e.g., Home to Gym" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Schedule</label>
                        <select id="profile-schedule-type" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                            <option value="all">All days</option>
                            <option value="weekdays">Weekdays only</option>
                            <option value="weekends">Weekends only</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Effective Until (Optional)</label>
                        <input type="date" id="profile-until" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 4px;">Leave empty for permanent profile</div>
                    </div>
                    <div class="confirm-modal-buttons">
                        <button class="confirm-btn confirm-btn-cancel" onclick="this.closest('.confirm-modal-overlay').remove()">
                            Cancel
                        </button>
                        <button class="confirm-btn confirm-btn-confirm" onclick="createProfile()">
                            Create Profile
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Create profile
        async function createProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const scheduleType = document.getElementById('profile-schedule-type').value;
            const effectiveUntil = document.getElementById('profile-until').value || null;

            if (!name) {
                showError('Validation Error', 'Please enter a profile name');
                return;
            }

            let days = [0, 1, 2, 3, 4, 5, 6];
            if (scheduleType === 'weekdays') {
                days = [1, 2, 3, 4, 5];
            } else if (scheduleType === 'weekends') {
                days = [0, 6];
            }

            try {
                const response = await fetch(BASE_URL + '/api/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        schedule: {
                            type: scheduleType,
                            days,
                            effectiveUntil
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Profile Created', data.message);
                    document.querySelector('.confirm-modal-overlay').remove();
                    loadProfiles();
                } else {
                    showError('Create Failed', data.error);
                }
            } catch (error) {
                showError('Network Error', error.message);
            }
        }

        // Activate profile
        async function activateProfile(profileId) {
            try {
                const response = await fetch(BASE_URL + `/api/profiles/${profileId}/activate`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Profile Activated', data.message);
                    loadProfiles();
                    loadAllData();
                } else {
                    showError('Activation Failed', data.error);
                }
            } catch (error) {
                showError('Network Error', error.message);
            }
        }

        // Delete profile with confirmation
        function deleteProfileConfirm(profileId) {
            const profile = profiles.find(p => p.id === profileId);
            if (!profile) return;

            showConfirm(
                'Delete Profile?',
                `Are you sure you want to delete "${profile.name}"? This action cannot be undone.`,
                () => deleteProfile(profileId),
                { danger: true, confirmText: 'Delete' }
            );
        }

        // Delete profile
        async function deleteProfile(profileId) {
            try {
                const response = await fetch(BASE_URL + `/api/profiles/${profileId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Profile Deleted', data.message);
                    loadProfiles();
                } else {
                    showError('Delete Failed', data.error);
                }
            } catch (error) {
                showError('Network Error', error.message);
            }
        }

        // ==================== END JOURNEY PROFILES MANAGEMENT ====================

        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);
            loadAllData();
            loadSavedPreferences();
            loadVersionInfo();
            loadAttributions();
            refreshInterval = setInterval(loadAllData, 30000);

            // Load UI mode preference (simple/advanced)
            loadUIMode();

            // Check if this is first visit and show onboarding
            checkFirstVisit();

            // Load profiles when on Config tab
            loadProfiles();
        });

        // Load version control info
        function loadVersionInfo() {
            fetch('/api/version')
                .then(r => r.json())
                .then(v => {
                    document.getElementById('versionHash').textContent = v.version || 'v2.5.0';
                    document.getElementById('buildDate').textContent = v.date || new Date().toISOString().split('T')[0];
                })
                .catch(() => {
                    document.getElementById('versionHash').textContent = 'v2.5.0';
                    document.getElementById('buildDate').textContent = new Date().toISOString().split('T')[0];
                });
        }

        // Load required attributions based on configuration
        function loadAttributions() {
            fetch('/api/attributions')
                .then(r => r.json())
                .then(data => {
                    const content = document.getElementById('attributions-content');
                    if (data.attributions && data.attributions.length > 0) {
                        content.innerHTML = data.attributions.map(attr => {
                            const required = attr.required ? ' (Required)' : ' (Optional)';
                            return `<div style="margin-bottom: 4px;">‚Ä¢ ${attr.text} ‚Ä¢ ${attr.license}${attr.required ? '' : required}</div>`;
                        }).join('');
                    } else {
                        content.innerHTML = '<div>No attributions loaded</div>';
                    }
                })
                .catch(() => {
                    document.getElementById('attributions-content').innerHTML = 'Created by <strong>Angus Bergman</strong> ‚Ä¢ Licensed under CC BY-NC 4.0';
                });
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Location-agnostic timezone detection
        let detectedTimezone = null;

        function getTimezoneForState(state) {
            const timezones = {
                'VIC': 'Australia/Melbourne',
                'NSW': 'Australia/Sydney',
                'ACT': 'Australia/Sydney',
                'QLD': 'Australia/Brisbane',
                'SA': 'Australia/Adelaide',
                'WA': 'Australia/Perth',
                'TAS': 'Australia/Hobart',
                'NT': 'Australia/Darwin'
            };
            return timezones[state] || Intl.DateTimeFormat().resolvedOptions().timeZone;
        }

        function updateClock() {
            const now = new Date();
            // Use detected timezone or fallback to browser timezone
            const timezone = detectedTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-AU', {
                timeZone: timezone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-AU', {
                timeZone: timezone, weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
        }

        async function loadAllData() {
            try {
                const [status, weather, regions, systemStatus] = await Promise.all([
                    fetch(BASE_URL + '/api/status').then(r => r.json()).catch(() => null),
                    fetch(BASE_URL + '/admin/weather').then(r => r.json()).catch(() => null),
                    fetch(BASE_URL + '/api/region-updates').then(r => r.json()).catch(() => null),
                    fetch(BASE_URL + '/api/system-status').then(r => r.json()).catch(() => null)
                ]);

                if (status) {
                    updateDepartures(status);
                    document.getElementById('data-mode').textContent = status.dataMode === 'Live' ? 'Live Data' : 'Fallback';
                }
                if (weather) updateWeather(weather);
                if (systemStatus) updateSystemStatus(systemStatus);
                loadJourneySummary();
                loadCoffeeDecision();
                loadAutoCalcStatus();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateSystemStatus(status) {
            const isConfigured = status.configured;

            // Set timezone based on detected state (location agnostic)
            if (status.location && status.location.state) {
                detectedTimezone = getTimezoneForState(status.location.state);
                console.log(`Timezone set to ${detectedTimezone} for state ${status.location.state}`);
            }

            // Control Live Data tab visibility based on configuration status
            const liveDataUnconfigured = document.getElementById('live-data-unconfigured');
            const liveDataConfigured = document.getElementById('live-data-configured');

            if (liveDataUnconfigured && liveDataConfigured) {
                if (isConfigured) {
                    liveDataUnconfigured.style.display = 'none';
                    liveDataConfigured.style.display = 'block';
                } else {
                    liveDataUnconfigured.style.display = 'block';
                    liveDataConfigured.style.display = 'none';
                }
            }

            // Update configuration banner
            const configSummary = document.getElementById('config-summary');
            if (configSummary) {
                configSummary.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 12px;">
                        <div><strong>Location:</strong> ${status.location.city}, ${status.location.state}</div>
                        <div><strong>Transit Authority:</strong> ${status.location.transitAuthority}</div>
                        <div><strong>Status:</strong> <span style="color: ${isConfigured ? '#48bb78' : '#fc8181'}; font-weight: 600;">${isConfigured ? '‚úì Configured' : '‚úó Not Configured'}</span></div>
                        <div><strong>Auto-Calc:</strong> ${status.journey.autoCalculation.active ? '‚úì Active' : '‚úó Inactive'}</div>
                    </div>
                `;
            }

            // Update data source indicator in Live Data tab
            updateDataSourceIndicator(status.apis);

            // Update data sources list in Configuration tab
            updateDataSourcesList(status.apis, status.location.state);

            // Update user configuration display
            updateUserConfigDisplay(status);

            // Show/hide Victorian GTFS viewer based on state
            updateVictorianGTFSViewer(status.location.state);

            // Update station names in live data widgets
            if (status.transitStations.mode1.origin !== 'Not configured') {
                const trainHeader = document.getElementById('train-station-name');
                if (trainHeader) {
                    trainHeader.textContent = `${status.transitStations.mode1.origin}`;
                }
            }

            if (status.transitStations.mode2 && status.transitStations.mode2.origin !== 'Not configured') {
                const tramHeader = document.getElementById('tram-station-name');
                if (tramHeader) {
                    tramHeader.textContent = `${status.transitStations.mode2.origin}`;
                }
            }

            // Update weather location
            const weatherHeader = document.getElementById('weather-location-name');
            if (weatherHeader && status.location.city !== 'Not configured') {
                weatherHeader.textContent = `Weather - ${status.location.city}`;
            }

            // Update API status grid
            updateApiStatusGrid(status.apis);

            // Update status badges
            updateStatusBadges(status);
        }

        function updateDataSourcesList(apis, state) {
            const dataSourcesList = document.getElementById('data-sources-list');
            if (!dataSourcesList) return;

            const sources = [];

            // Transit Authority API
            sources.push(`
                <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 3px solid ${apis.transitAuthority.configured ? '#48bb78' : '#fc8181'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 14px;">üöÜ ${apis.transitAuthority.name}</div>
                        <span style="padding: 4px 10px; background: ${apis.transitAuthority.configured ? 'rgba(72, 187, 120, 0.2)' : 'rgba(252, 129, 129, 0.2)'}; border-radius: 12px; font-size: 11px; font-weight: 600; color: ${apis.transitAuthority.configured ? '#48bb78' : '#fc8181'};">
                            ${apis.transitAuthority.configured ? '‚úì Active' : '‚úó Not Configured'}
                        </span>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                        <strong>Purpose:</strong> Real-time transit departures & route planning
                    </div>
                    <div style="font-size: 11px; opacity: 0.6;">${apis.transitAuthority.baseUrl || 'Configure in API Credentials section'}</div>
                </div>
            `);

            // Nominatim/OpenStreetMap (always active)
            sources.push(`
                <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 14px;">üó∫Ô∏è OpenStreetMap / Nominatim</div>
                        <span style="padding: 4px 10px; background: rgba(72, 187, 120, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #48bb78;">
                            ‚úì Always Active
                        </span>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                        <strong>Purpose:</strong> Address geocoding & location search
                    </div>
                    <div style="font-size: 11px; opacity: 0.6;">https://nominatim.openstreetmap.org</div>
                </div>
            `);

            // Google Places (if configured)
            if (apis.googlePlaces && apis.googlePlaces.configured) {
                sources.push(`
                    <div style="padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 3px solid #fbbf24;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px;">üìç Google Places API</div>
                            <span style="padding: 4px 10px; background: rgba(72, 187, 120, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #48bb78;">
                                ‚úì Active
                            </span>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                            <strong>Purpose:</strong> Enhanced geocoding, cafe busy-ness detection
                        </div>
                        <div style="font-size: 11px; opacity: 0.6;">Google Maps Platform</div>
                    </div>
                `);
            }

            // BOM Weather
            if (apis.bom) {
                sources.push(`
                    <div style="padding: 15px; background: rgba(72, 187, 120, 0.1); border-radius: 8px; border-left: 3px solid #48bb78;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px;">üå§Ô∏è Bureau of Meteorology</div>
                            <span style="padding: 4px 10px; background: rgba(72, 187, 120, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #48bb78;">
                                ‚úì Active
                            </span>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                            <strong>Purpose:</strong> Local weather forecasts & conditions
                        </div>
                        <div style="font-size: 11px; opacity: 0.6;">http://www.bom.gov.au</div>
                    </div>
                `);
            }

            // Victorian GTFS Realtime API (Victoria only)
            if (state === 'VIC') {
                sources.push(`
                    <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 3px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px;">üöÇ Transport for Victoria - GTFS Realtime</div>
                            <span style="padding: 4px 10px; background: rgba(251, 191, 36, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #fbbf24;">
                                Configure in API section
                            </span>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                            <strong>Purpose:</strong> Real-time metro train trip updates (delays, cancellations)
                        </div>
                        <div style="font-size: 11px; opacity: 0.6;">
                            https://api.opendata.transport.vic.gov.au ‚Ä¢ See <strong>VICTORIA-GTFS-REALTIME-PROTOCOL.md</strong>
                        </div>
                    </div>
                `);
            }

            // Fallback Timetables
            sources.push(`
                <div style="padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #8b5cf6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 14px;">üóÉÔ∏è Fallback Timetables</div>
                        <span style="padding: 4px 10px; background: rgba(72, 187, 120, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #48bb78;">
                            ‚úì Ready
                        </span>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                        <strong>Purpose:</strong> Offline transit stop data for all Australian states
                    </div>
                    <div style="font-size: 11px; opacity: 0.6;">
                        Current state: <strong>${state || 'Not detected'}</strong> ‚Ä¢ 80+ stops across VIC, NSW, QLD, SA, WA, TAS, ACT, NT
                    </div>
                </div>
            `);

            dataSourcesList.innerHTML = sources.join('');
        }

        function updateDataSourceIndicator(apis) {
            const indicator = document.getElementById('data-source-indicator');
            const icon = document.getElementById('data-source-icon');
            const title = document.getElementById('data-source-title');
            const subtitle = document.getElementById('data-source-subtitle');
            const actionBtn = document.getElementById('data-source-action-btn');

            if (!indicator) return;

            // Check if any real-time APIs are configured
            const hasLiveData = apis.transitAuthority && apis.transitAuthority.configured;

            if (hasLiveData) {
                // Live data mode
                indicator.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%)';
                indicator.style.borderLeft = '4px solid #10b981';
                icon.textContent = 'üü¢';
                title.textContent = 'Live Data Active';
                subtitle.textContent = 'Real-time transit updates enabled ‚Ä¢ Refreshing automatically';
                actionBtn.textContent = 'üîÑ Refresh Now';
                actionBtn.onclick = () => loadAllData();
            } else {
                // Fallback data mode
                indicator.style.background = 'linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%)';
                indicator.style.borderLeft = '4px solid #fbbf24';
                icon.textContent = 'üî¥';
                title.textContent = 'Using Fallback Timetable Data';
                subtitle.textContent = 'Configure API keys in API Settings to enable real-time updates';
                actionBtn.textContent = '‚Üí API Settings';
                actionBtn.onclick = () => showTab('api');
            }
        }

        function updateUserConfigDisplay(status) {
            const userConfigDisplay = document.getElementById('user-config-display');
            if (!userConfigDisplay) return;

            if (!status.configured) {
                userConfigDisplay.innerHTML = `
                    <div style="padding: 30px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                        <div style="font-size: 40px; opacity: 0.3; margin-bottom: 15px;">‚öôÔ∏è</div>
                        <div style="opacity: 0.7; margin-bottom: 15px;">No configuration yet</div>
                        <button class="btn btn-primary" onclick="showTab('setup')">‚Üí Go to Setup</button>
                    </div>
                `;
                return;
            }

            const config = [];

            // Addresses
            config.push(`
                <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">üìç Addresses</div>
                    <div style="font-size: 13px; line-height: 1.8;">
                        <div><strong>Home:</strong> ${status.addresses.home || 'Not set'}</div>
                        <div><strong>Work:</strong> ${status.addresses.work || 'Not set'}</div>
                        ${status.addresses.cafe ? `<div><strong>Cafe:</strong> ${status.addresses.cafe}</div>` : ''}
                    </div>
                </div>
            `);

            // Transit Stops
            config.push(`
                <div style="padding: 15px; background: rgba(64, 220, 165, 0.1); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">üöâ Transit Stops</div>
                    <div style="font-size: 13px; line-height: 1.8;">
                        <div><strong>From:</strong> ${status.transitStations.mode1.origin || 'Not set'}</div>
                        <div><strong>To:</strong> ${status.transitStations.mode1.destination || 'Not set'}</div>
                        <div><strong>Mode:</strong> ${status.transitStations.mode1.type || 'Not set'}</div>
                        ${status.transitStations.mode2 && status.transitStations.mode2.origin !== 'Not configured' ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <strong>Transfer:</strong> ${status.transitStations.mode2.origin} ‚Üí ${status.transitStations.mode2.destination} (${status.transitStations.mode2.type})
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);

            // Journey Preferences
            config.push(`
                <div style="padding: 15px; background: rgba(246, 173, 85, 0.1); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">‚è∞ Journey Preferences</div>
                    <div style="font-size: 13px; line-height: 1.8;">
                        <div><strong>Arrival Time:</strong> ${status.journey.arrivalTime || 'Not set'}</div>
                        <div><strong>Coffee Stops:</strong> ${status.journey.coffeeEnabled ? '‚úì Enabled' : '‚úó Disabled'}</div>
                        ${status.journey.walkingTimes ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <strong>Walking Times:</strong><br>
                                Home ‚Üí Station: ${status.journey.walkingTimes.homeToStation || 'Calculating...'}<br>
                                ${status.addresses.cafe ? `Home ‚Üí Cafe: ${status.journey.walkingTimes.homeToCafe || 'Calculating...'}<br>` : ''}
                                ${status.addresses.cafe ? `Cafe ‚Üí Station: ${status.journey.walkingTimes.cafeToStation || 'Calculating...'}<br>` : ''}
                                Station ‚Üí Work: ${status.journey.walkingTimes.stationToWork || 'Calculating...'}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);

            userConfigDisplay.innerHTML = config.join('');
        }

        function updateVictorianGTFSViewer(state) {
            const viewer = document.getElementById('victoria-gtfs-viewer');
            const gtfsConfig = document.getElementById('victoria-gtfs-config');
            const transitApiTitle = document.getElementById('transit-api-title');
            const transitApiDesc = document.getElementById('transit-api-description');
            const transitApiDescGeneric = document.getElementById('transit-api-description-generic');

            // Show/hide Victorian-specific elements
            if (state === 'VIC') {
                if (viewer) viewer.style.display = 'block';
                if (gtfsConfig) gtfsConfig.style.display = 'block';
                if (transitApiDesc) transitApiDesc.style.display = 'block';
                if (transitApiDescGeneric) transitApiDescGeneric.style.display = 'none';

                // Update transit API title for Victorian users
                if (transitApiTitle) transitApiTitle.textContent = 'Transport for Victoria - OpenData API';

                console.log('‚úÖ Victorian features enabled');
            } else {
                if (viewer) viewer.style.display = 'none';
                if (gtfsConfig) gtfsConfig.style.display = 'none';
                if (transitApiDesc) transitApiDesc.style.display = 'none';
                if (transitApiDescGeneric) transitApiDescGeneric.style.display = 'block';

                // Generic title for non-Victorian users
                if (transitApiTitle) transitApiTitle.textContent = 'Transit Authority API';

                console.log(`‚ÑπÔ∏è  State-specific features hidden (state: ${state || 'unknown'})`);
            }
        }

        function updateApiStatusGrid(apis) {
            const grid = document.getElementById('api-status-grid');
            if (!grid) return;

            const apiCards = [];

            // Transit Authority API
            apiCards.push(createApiCard(
                'üöÜ',
                apis.transitAuthority.name,
                apis.transitAuthority.configured ? 'Configured' : 'Not Configured',
                apis.transitAuthority.status,
                apis.transitAuthority.baseUrl
            ));

            // Weather API
            apiCards.push(createApiCard(
                'üå§Ô∏è',
                apis.weather.name,
                apis.weather.service,
                apis.weather.status,
                'Always Active'
            ));

            // Geocoding
            apiCards.push(createApiCard(
                'üìç',
                apis.geocoding.name,
                `${apis.geocoding.services.length} Services Available`,
                apis.geocoding.status,
                apis.geocoding.services.join(', ')
            ));

            // Google Places (if configured)
            if (apis.googlePlaces.configured) {
                apiCards.push(createApiCard(
                    'üó∫Ô∏è',
                    apis.googlePlaces.name,
                    'Enhanced Geocoding',
                    apis.googlePlaces.status,
                    'Active'
                ));
            }

            // Mapbox (if configured)
            if (apis.mapbox.configured) {
                apiCards.push(createApiCard(
                    'üåê',
                    apis.mapbox.name,
                    'Address Geocoding',
                    apis.mapbox.status,
                    'Active'
                ));
            }

            // HERE (if configured)
            if (apis.here.configured) {
                apiCards.push(createApiCard(
                    'üåè',
                    apis.here.name,
                    'Australian Address Optimization',
                    apis.here.status,
                    'Active'
                ));
            }

            grid.innerHTML = apiCards.join('');
        }

        function createApiCard(icon, name, description, status, details) {
            const statusColor = status === 'active' ? '#48bb78' : status === 'optional' ? '#f6ad55' : '#fc8181';
            const statusText = status === 'active' ? 'Active' : status === 'optional' ? 'Optional' : 'Inactive';

            return `
                <div style="padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 4px solid ${statusColor};">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="font-size: 24px;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 13px;">${name}</div>
                            <div style="font-size: 11px; opacity: 0.7;">${description}</div>
                        </div>
                        <div style="padding: 4px 8px; background: ${statusColor}33; color: ${statusColor}; border-radius: 4px; font-size: 10px; font-weight: 600;">
                            ${statusText}
                        </div>
                    </div>
                    <div style="font-size: 10px; opacity: 0.6; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                        ${details}
                    </div>
                </div>
            `;
        }

        function updateStatusBadges(status) {
            // Update train status
            const trainStatus = document.getElementById('train-status');
            if (trainStatus) {
                trainStatus.style.color = status.apis.transitAuthority.configured ? '#48bb78' : '#fc8181';
                trainStatus.textContent = status.apis.transitAuthority.configured ? '‚óè Live' : '‚óè Offline';
            }

            // Update tram status
            const tramStatus = document.getElementById('tram-status');
            if (tramStatus) {
                tramStatus.style.color = status.apis.transitAuthority.configured ? '#48bb78' : '#fc8181';
                tramStatus.textContent = status.apis.transitAuthority.configured ? '‚óè Live' : '‚óè Offline';
            }

            // Update coffee status
            const coffeeStatus = document.getElementById('coffee-status');
            if (coffeeStatus) {
                coffeeStatus.style.color = status.journey.configured ? '#48bb78' : '#fc8181';
                coffeeStatus.textContent = status.journey.configured ? '‚óè Active' : '‚óè Inactive';
            }
        }

        async function loadAutoCalcStatus() {
            try {
                const response = await fetch(BASE_URL + '/api/journey-cache');
                const data = await response.json();
                const statusDiv = document.getElementById('auto-calc-status');

                if (data.cached) {
                    const calcTime = new Date(data.calculatedAt);
                    const timeAgo = getTimeAgo(calcTime);

                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 8px; height: 8px; background: #48bb78; border-radius: 50%; box-shadow: 0 0 8px rgba(72, 187, 120, 0.6);"></div>
                            <span style="font-weight: 600; color: #48bb78;">Active</span>
                        </div>
                        <div style="font-size: 13px; opacity: 0.8; line-height: 1.6;">
                            <strong>Last Calculated:</strong> ${calcTime.toLocaleTimeString()}<br>
                            <strong>Time Ago:</strong> ${timeAgo}<br>
                            <strong>Arrival Time:</strong> ${data.journey?.arrivalTime || 'N/A'}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 8px; height: 8px; background: #f6ad55; border-radius: 50%;"></div>
                            <span style="font-weight: 600; color: #f6ad55;">Pending</span>
                        </div>
                        <div style="font-size: 13px; opacity: 0.8;">
                            No journey calculated yet. Configure your addresses and API credentials.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading auto-calc status:', error);
            }
        }

        async function forceRecalculation() {
            const btn = document.getElementById('recalc-btn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Calculating...';

            try {
                const response = await fetch(BASE_URL + '/api/journey-recalculate', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Journey recalculated successfully!');
                    loadAutoCalcStatus();
                    loadJourneySummary();
                } else {
                    alert('‚ùå ' + (data.message || 'Calculation failed. Check your configuration.'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Recalculate Now';
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds} seconds ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
        }

        function updateDepartures(data) {
            const trains = data.data?.trains || [];
            const trams = data.data?.trams || [];

            document.getElementById('train-departures').innerHTML = trains.length ?
                trains.slice(0, 4).map(d => `
                    <div class="departure-row">
                        <div><div class="departure-dest">${d.destination || d.direction || 'Unknown'}</div></div>
                        <div class="departure-time">${d.minutes || d.minutesToDeparture || '--'}<span> min</span></div>
                    </div>
                `).join('') : '<div class="no-data">No departures</div>';

            document.getElementById('tram-departures').innerHTML = trams.length ?
                trams.slice(0, 4).map(d => `
                    <div class="departure-row">
                        <div><div class="departure-dest">${d.destination || d.direction || 'Unknown'}</div></div>
                        <div class="departure-time">${d.minutes || d.minutesToDeparture || '--'}<span> min</span></div>
                    </div>
                `).join('') : '<div class="no-data">No departures</div>';
        }

        function updateWeather(data) {
            const temp = data.current?.temperature || data.temperature || '--';
            const condition = data.current?.condition?.full || data.condition || 'Unknown';
            const humidity = data.current?.humidity || data.humidity || '--';
            document.getElementById('weather-source').textContent = data.source || 'BOM';
            document.getElementById('weather-display').innerHTML = `
                <div class="weather-display">
                    <div class="weather-temp">${temp}¬∞</div>
                    <div><div class="weather-condition">${condition}</div><div class="weather-extra">Humidity ${humidity}%</div></div>
                </div>
            `;
        }

        async function loadCoffeeDecision() {
            try {
                const route = await fetch(BASE_URL + '/admin/route').then(r => r.json());
                if (route?.coffee_decision) {
                    document.getElementById('coffee-decision').innerHTML = `
                        <div class="coffee-icon">${route.coffee_decision.can_get_coffee ? '‚òï' : '‚è∞'}</div>
                        <div class="coffee-text">${route.coffee_decision.can_get_coffee ? 'Time for Coffee!' : 'Skip Coffee'}</div>
                        <div class="coffee-subtext">${route.coffee_decision.message || ''}</div>
                    `;
                } else {
                    document.getElementById('coffee-decision').innerHTML = `
                        <div class="coffee-icon">‚òï</div>
                        <div class="coffee-text">Plan a Journey</div>
                        <div class="coffee-subtext">Configure your route first</div>
                    `;
                }
            } catch (e) {
                document.getElementById('coffee-decision').innerHTML = `
                    <div class="coffee-icon">‚òï</div><div class="coffee-text">Plan a Journey</div>
                `;
            }
        }

        async function loadJourneySummary() {
            try {
                const journey = await fetch(BASE_URL + '/admin/route/auto').then(r => r.json());
                if (journey?.success && journey?.route) {
                    document.getElementById('journey-summary-card').style.display = 'block';

                    let legsHTML = '';
                    const route = journey.route;

                    // Display all journey legs
                    if (route.legs && route.legs.length > 0) {
                        legsHTML = route.legs.map((leg, idx) => {
                            const icon = {
                                'train': 'üöÜ',
                                'tram': 'üöä',
                                'bus': 'üöå',
                                'walk': 'üö∂',
                                'walking': 'üö∂',
                                'coffee': '‚òï'
                            }[leg.type?.toLowerCase()] || 'üö∂';

                            return `
                                <div style="display: flex; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                                    <div style="font-size: 28px; margin-right: 15px;">${icon}</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">${leg.route || leg.description || 'Walking'}</div>
                                        <div style="font-size: 13px; opacity: 0.8;">
                                            ${leg.from || ''} ${leg.to ? '‚Üí ' + leg.to : ''}
                                        </div>
                                        ${leg.departureTime ? `<div style="font-size: 12px; margin-top: 4px;">Depart: ${leg.departureTime}</div>` : ''}
                                    </div>
                                    <div style="text-align: right; font-size: 13px;">
                                        ${leg.duration ? `<div>${leg.duration} min</div>` : ''}
                                        ${leg.delay ? `<div style="color: #fc8181; font-weight: 600;">+${leg.delay} min delay</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }

                    document.getElementById('journey-summary').innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="padding: 15px; background: rgba(102, 126, 234, 0.15); border-radius: 8px;">
                                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">üè† Leave Home</div>
                                    <div style="font-size: 24px; font-weight: 700;">${journey.summary?.must_leave_home || route.startTime || '--:--'}</div>
                                </div>
                                <div style="padding: 15px; background: rgba(72, 187, 120, 0.15); border-radius: 8px;">
                                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">üè¢ Arrive Work</div>
                                    <div style="font-size: 24px; font-weight: 700;">${journey.arrivalTime || journey.summary?.arrival_at_work || '--:--'}</div>
                                </div>
                            </div>

                            ${route.includedCoffee ? `
                                <div style="padding: 12px; background: rgba(237, 137, 54, 0.15); border-radius: 8px; margin-bottom: 15px; text-align: center;">
                                    ‚òï Coffee stop included at ${route.cafeName || 'selected cafe'}
                                    ${route.coffeeWaitTime ? ` (${route.coffeeWaitTime} min wait)` : ''}
                                </div>
                            ` : ''}

                            <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">üìç Journey Breakdown:</div>
                            ${legsHTML || '<div style="opacity: 0.6;">No journey legs available</div>'}

                            ${journey.warnings && journey.warnings.length > 0 ? `
                                <div style="margin-top: 15px; padding: 12px; background: rgba(252, 129, 129, 0.15); border-radius: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Warnings:</div>
                                    ${journey.warnings.map(w => `<div style="font-size: 13px; margin-bottom: 4px;">‚Ä¢ ${w}</div>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else if (journey?.summary) {
                    // Fallback for old format
                    document.getElementById('journey-summary-card').style.display = 'block';
                    document.getElementById('journey-summary').innerHTML = `
                        <div class="route-summary">
                            <div class="route-time"><div class="route-time-label">Leave Home</div><div class="route-time-value">${journey.summary.must_leave_home || '--:--'}</div></div>
                            <div class="route-time"><div class="route-time-label">Arrive Work</div><div class="route-time-value">${journey.summary.arrival_at_work || '--:--'}</div></div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Journey summary error:', e);
                document.getElementById('journey-summary-card').style.display = 'none';
            }
        }

        function addTransitLeg() {
            document.getElementById('transit-mode-2').style.display = 'block';
            document.getElementById('add-mode-btn').style.display = 'none';
        }

        function removeTransitLeg() {
            document.getElementById('transit-mode-2').style.display = 'none';
            document.getElementById('add-mode-btn').style.display = 'flex';
            document.getElementById('mode2-origin').value = '';
            document.getElementById('mode2-destination').value = '';
        }

        async function planJourney() {
            document.getElementById('plan-btn-text').textContent = 'Planning...';
            const hasMode2 = document.getElementById('transit-mode-2').style.display !== 'none';

            const data = {
                homeAddress: document.getElementById('home-address').value,
                workAddress: document.getElementById('work-address').value,
                cafeAddress: document.getElementById('cafe-address').value,
                arrivalTime: document.getElementById('arrival-time').value,
                includeCoffee: document.getElementById('include-coffee').checked,
                coffeeTime: parseInt(document.getElementById('coffee-time').value) || 5,
                transitRoute: {
                    numberOfModes: hasMode2 ? 2 : 1,
                    mode1: { type: parseInt(document.getElementById('mode1-type').value), originStation: { name: document.getElementById('mode1-origin').value }, destinationStation: { name: document.getElementById('mode1-destination').value } },
                    mode2: hasMode2 ? { type: parseInt(document.getElementById('mode2-type').value), originStation: { name: document.getElementById('mode2-origin').value }, destinationStation: { name: document.getElementById('mode2-destination').value } } : null
                }
            };

            try {
                const result = await fetch(BASE_URL + '/admin/route/auto-plan', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
                }).then(r => r.json());

                if (result.success) {
                    showMessage('planner-message', 'Journey planned!', 'success');
                    document.getElementById('journey-result').style.display = 'block';
                    document.getElementById('journey-result-content').innerHTML = `
                        <div class="route-summary">
                            <div class="route-time"><div class="route-time-label">Leave Home</div><div class="route-time-value">${result.journey?.summary?.must_leave_home || '--:--'}</div></div>
                            <div class="route-time"><div class="route-time-label">Arrive Work</div><div class="route-time-value">${result.journey?.summary?.arrival_at_work || '--:--'}</div></div>
                        </div>
                    `;
                    localStorage.setItem('ptv-journey-prefs', JSON.stringify(data));
                    loadJourneySummary();
                    loadCoffeeDecision();
                } else {
                    showMessage('planner-message', result.error || 'Failed', 'error');
                }
            } catch (e) {
                showMessage('planner-message', 'Error: ' + e.message, 'error');
            }
            document.getElementById('plan-btn-text').textContent = 'Plan My Journey';
        }

        async function loadSavedPreferences() {
            try {
                // Load from server preferences
                const response = await fetch(BASE_URL + '/admin/preferences');
                if (response.ok) {
                    const data = await response.json();
                    const prefs = data.preferences || data;

                    // Load addresses
                    if (prefs.addresses) {
                        if (document.getElementById('home-address')) {
                            document.getElementById('home-address').value = prefs.addresses.home || '';
                        }
                        if (document.getElementById('cafe-address')) {
                            document.getElementById('cafe-address').value = prefs.addresses.cafe || '';
                        }
                        if (document.getElementById('cafe-name')) {
                            document.getElementById('cafe-name').value = prefs.addresses.cafeName || '';
                        }
                        if (document.getElementById('work-address')) {
                            document.getElementById('work-address').value = prefs.addresses.work || '';
                        }
                    }

                    // Load journey preferences
                    if (prefs.journey) {
                        if (document.getElementById('arrival-time')) {
                            document.getElementById('arrival-time').value = prefs.journey.arrivalTime || '09:00';
                        }

                        // Load transit route if configured
                        if (prefs.journey.transitRoute?.mode1) {
                            if (document.getElementById('mode1-type')) {
                                document.getElementById('mode1-type').value = prefs.journey.transitRoute.mode1.type || 0;
                            }
                            if (document.getElementById('mode1-origin')) {
                                document.getElementById('mode1-origin').value = prefs.journey.transitRoute.mode1.originStation?.name || '';
                            }
                            if (document.getElementById('mode1-destination')) {
                                document.getElementById('mode1-destination').value = prefs.journey.transitRoute.mode1.destinationStation?.name || '';
                            }
                        }
                    }

                    // Load API credentials
                    if (prefs.api) {
                        if (document.getElementById('ptv-dev-id')) {
                            document.getElementById('ptv-dev-id').value = prefs.api.key || '';
                        }
                        if (document.getElementById('ptv-api-key')) {
                            document.getElementById('ptv-api-key').value = prefs.api.token || '';
                        }
                    }

                    console.log('‚úÖ Preferences loaded from server');
                }
            } catch (error) {
                console.error('Failed to load preferences from server:', error);

                // Fallback to localStorage
                const saved = localStorage.getItem('ptv-journey-prefs');
                if (saved) {
                    const p = JSON.parse(saved);
                    if (document.getElementById('home-address')) document.getElementById('home-address').value = p.homeAddress || '';
                    if (document.getElementById('work-address')) document.getElementById('work-address').value = p.workAddress || '';
                    if (document.getElementById('cafe-address')) document.getElementById('cafe-address').value = p.cafeAddress || '';
                    if (document.getElementById('arrival-time')) document.getElementById('arrival-time').value = p.arrivalTime || '09:00';
                }
            }
        }

        async function savePtvConfig() {
            try {
                await fetch(BASE_URL + '/admin/apis', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ptv_opendata: { api_key: document.getElementById('ptv-dev-id').value, token: document.getElementById('ptv-api-key').value } })
                });
                showMessage('api-message', 'Saved!', 'success');
            } catch (e) {
                showMessage('api-message', 'Error', 'error');
            }
        }

        async function testPtvApi() {
            const data = await fetch(BASE_URL + '/api/status').then(r => r.json());
            showMessage('api-message', data.dataMode === 'Live' ? 'Connected!' : 'Not connected', data.dataMode === 'Live' ? 'success' : 'error');
        }

        async function saveGtfsRealtimeConfig() {
            try {
                const key = document.getElementById('gtfs-realtime-key').value;
                await fetch(BASE_URL + '/admin/apis/gtfs-realtime', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscription_key: key })
                });
                showMessage('api-message', '‚úÖ GTFS Realtime key saved!', 'success');
            } catch (e) {
                showMessage('api-message', '‚ùå Error saving key', 'error');
                console.error('GTFS Realtime save error:', e);
            }
        }

        async function testGtfsRealtimeApi() {
            try {
                const key = document.getElementById('gtfs-realtime-key').value;
                if (!key) {
                    showMessage('api-message', '‚ö†Ô∏è Please enter a subscription key first', 'error');
                    return;
                }

                showMessage('api-message', 'üîÑ Testing connection...', 'info');

                const response = await fetch(BASE_URL + '/admin/apis/gtfs-realtime/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscription_key: key })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('api-message', `‚úÖ Connected! Received ${result.tripCount || 0} trip updates`, 'success');
                } else {
                    showMessage('api-message', `‚ùå ${result.message || 'Connection failed'}`, 'error');
                }
            } catch (e) {
                showMessage('api-message', '‚ùå Test failed: ' + e.message, 'error');
                console.error('GTFS Realtime test error:', e);
            }
        }

        async function saveAdditionalAPIs() {
            try {
                const googleKey = document.getElementById('google-places-key').value;
                const mapboxToken = document.getElementById('mapbox-token').value;

                await fetch(BASE_URL + '/admin/apis/additional', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        google_places: googleKey || null,
                        mapbox: mapboxToken || null,
                        rss_feeds: window.customRssFeeds || []
                    })
                });

                showMessage('api-message', '‚úÖ Additional APIs saved!', 'success');
            } catch (e) {
                showMessage('api-message', '‚ùå Error saving', 'error');
                console.error('Additional APIs save error:', e);
            }
        }

        // Initialize global RSS feeds array
        window.customRssFeeds = window.customRssFeeds || [];

        function addRssFeed() {
            const feedUrl = prompt('Enter RSS feed URL:');
            if (!feedUrl) return;

            const feedName = prompt('Enter a name for this feed (optional):');

            const feed = {
                url: feedUrl,
                name: feedName || feedUrl,
                enabled: true,
                id: Date.now().toString()
            };

            window.customRssFeeds.push(feed);
            renderRssFeeds();
        }

        function removeRssFeed(feedId) {
            window.customRssFeeds = window.customRssFeeds.filter(f => f.id !== feedId);
            renderRssFeeds();
        }

        function toggleRssFeed(feedId) {
            const feed = window.customRssFeeds.find(f => f.id === feedId);
            if (feed) {
                feed.enabled = !feed.enabled;
                renderRssFeeds();
            }
        }

        function renderRssFeeds() {
            const container = document.getElementById('rss-feeds-list');
            if (!container) return;

            if (window.customRssFeeds.length === 0) {
                container.innerHTML = `
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6; font-size: 13px;">
                        No custom RSS feeds added yet
                    </div>
                `;
                return;
            }

            container.innerHTML = window.customRssFeeds.map(feed => `
                <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" ${feed.enabled ? 'checked' : ''} onchange="toggleRssFeed('${feed.id}')" style="cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 13px;">${feed.name}</div>
                        <div style="font-size: 11px; opacity: 0.7; word-break: break-all;">${feed.url}</div>
                    </div>
                    <button onclick="removeRssFeed('${feed.id}')" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </div>
            `).join('');
        }

        function saveDisplaySettings() {
            localStorage.setItem('ptv-display-settings', JSON.stringify({
                use24Hour: document.getElementById('use-24-hour').checked,
                showWalkingTimes: document.getElementById('show-walking-times').checked
            }));
            showMessage('api-message', 'Saved!', 'success');
        }

        function refreshData() { loadAllData(); }
        async function clearCache() { await fetch(BASE_URL + '/admin/cache/clear', { method: 'POST' }); loadAllData(); }

        function showMessage(id, msg, type) {
            document.getElementById(id).innerHTML = `<div class="message message-${type}">${msg}</div>`;
            setTimeout(() => document.getElementById(id).innerHTML = '', 3000);
        }

        // ============= ADDRESS AUTOCOMPLETE =============
        let autocompleteDebounce = null;

        function setupAddressAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);

            input.addEventListener('input', function() {
                clearTimeout(autocompleteDebounce);
                const query = this.value.trim();

                if (query.length < 3) {
                    suggestions.style.display = 'none';
                    return;
                }

                autocompleteDebounce = setTimeout(async () => {
                    try {
                        // Use Nominatim for geocoding (free, no API key)
                        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, Melbourne, Australia&limit=5`;
                        const response = await fetch(url);
                        const results = await response.json();

                        if (results.length > 0) {
                            suggestions.innerHTML = results.map(r => `
                                <div class="autocomplete-item" onclick="selectAddress('${inputId}', '${suggestionsId}', '${r.display_name.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                                    ${r.display_name}
                                </div>
                            `).join('');
                            suggestions.style.display = 'block';
                        } else {
                            suggestions.style.display = 'none';
                        }
                    } catch (e) {
                        console.error('Autocomplete error:', e);
                    }
                }, 500);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }

        function selectAddress(inputId, suggestionsId, address, lat, lon) {
            document.getElementById(inputId).value = address;
            document.getElementById(inputId).dataset.lat = lat;
            document.getElementById(inputId).dataset.lon = lon;
            document.getElementById(suggestionsId).style.display = 'none';
        }

        // Auto-save mechanism for fields
        let autoSaveTimeout = null;
        let saveIndicator = null;

        function createSaveIndicator() {
            if (!saveIndicator) {
                saveIndicator = document.createElement('div');
                saveIndicator.id = 'save-indicator';
                saveIndicator.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #48bb78; color: white; border-radius: 8px; font-size: 13px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s; z-index: 10000;';
                document.body.appendChild(saveIndicator);
            }
            return saveIndicator;
        }

        function showSaveIndicator(message, success = true) {
            const indicator = createSaveIndicator();
            indicator.textContent = message;
            indicator.style.background = success ? '#48bb78' : '#fc8181';
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 2000);
        }

        async function autoSaveField(fieldId, section, fieldName) {
            const value = document.getElementById(fieldId)?.value || '';

            try {
                // Get current preferences
                const prefsResponse = await fetch(BASE_URL + '/admin/preferences');
                const prefsData = await prefsResponse.json();
                const prefs = prefsData.preferences || prefsData;

                // Update the specific field
                if (!prefs[section]) prefs[section] = {};
                prefs[section][fieldName] = value;

                // Save back to server using PUT method
                const saveResponse = await fetch(BASE_URL + '/admin/preferences', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(prefs)
                });

                if (saveResponse.ok) {
                    showSaveIndicator('‚úì Saved', true);
                    console.log(`Auto-saved ${fieldName}:`, value);
                } else {
                    console.error('Failed to auto-save:', await saveResponse.text());
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        function setupAutoSave(fieldId, section, fieldName) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            field.addEventListener('input', () => {
                // Clear existing timeout
                if (autoSaveTimeout) {
                    clearTimeout(autoSaveTimeout);
                }

                // Set new timeout (debounce)
                autoSaveTimeout = setTimeout(() => {
                    autoSaveField(fieldId, section, fieldName);
                }, 1500); // Save 1.5 seconds after user stops typing
            });

            // Also save on blur (when field loses focus)
            field.addEventListener('blur', () => {
                if (autoSaveTimeout) {
                    clearTimeout(autoSaveTimeout);
                }
                autoSaveField(fieldId, section, fieldName);
            });
        }

        // Initialize autocomplete on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);
            loadAllData();
            loadSavedPreferences();
            refreshInterval = setInterval(loadAllData, 30000);

            // Setup address autocomplete
            setupAddressAutocomplete('home-address', 'home-suggestions');
            setupAddressAutocomplete('cafe-address', 'cafe-suggestions');
            setupAddressAutocomplete('work-address', 'work-suggestions');

            // Setup auto-save for address fields
            setupAutoSave('home-address', 'addresses', 'home');
            setupAutoSave('cafe-name', 'addresses', 'cafeName');
            setupAutoSave('cafe-address', 'addresses', 'cafe');
            setupAutoSave('work-address', 'addresses', 'work');
            setupAutoSave('arrival-time', 'journey', 'arrivalTime');
        });

        // ============= SIMPLIFIED JOURNEY PLANNER =============
        async function calculateSimpleRoute() {
            const btn = document.getElementById('calc-btn-text');
            btn.textContent = '‚è≥ Calculating...';

            const homeAddr = document.getElementById('home-address').value;
            const cafeAddr = document.getElementById('cafe-address').value;
            const workAddr = document.getElementById('work-address').value;
            const arrivalTime = document.getElementById('arrival-time').value;

            if (!homeAddr || !workAddr) {
                showMessage('planner-message', 'Please enter home and work addresses', 'error');
                btn.textContent = 'üó∫Ô∏è Calculate Route';
                return;
            }

            try {
                // Save preferences
                localStorage.setItem('ptv-journey-addresses', JSON.stringify({
                    homeAddress: homeAddr,
                    cafeAddress: cafeAddr,
                    workAddress: workAddr,
                    arrivalTime: arrivalTime
                }));

                // Call simplified route planning endpoint
                const response = await fetch(BASE_URL + '/admin/route/quick-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        homeAddress: homeAddr,
                        cafeAddress: cafeAddr,
                        workAddress: workAddr,
                        arrivalTime: arrivalTime
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('planner-message', '‚úÖ Route calculated!', 'success');
                    displayRouteResult(result);
                } else {
                    showMessage('planner-message', result.error || 'Failed to calculate route', 'error');
                }
            } catch (e) {
                showMessage('planner-message', 'Error: ' + e.message, 'error');
            }

            btn.textContent = 'üó∫Ô∏è Calculate Route';
        }

        function displayRouteResult(result) {
            const journey = result.journey;

            if (!journey) {
                return;
            }

            // Show journey details
            document.getElementById('journey-result').style.display = 'block';
            document.getElementById('address-card').style.display = 'none';

            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(34, 197, 94, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">LEAVE HOME</div>
                        <div style="font-size: 32px; font-weight: 700;">${journey.summary?.must_leave_home || '--:--'}</div>
                    </div>
                    <div style="background: rgba(99, 102, 241, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">ARRIVE WORK</div>
                        <div style="font-size: 32px; font-weight: 700;">${journey.summary?.arrival_at_work || '--:--'}</div>
                    </div>
                </div>
            `;

            // Coffee decision
            if (journey.coffee_decision) {
                const canGetCoffee = journey.coffee_decision.can_get_coffee;
                html += `
                    <div style="background: ${canGetCoffee ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">
                            ${canGetCoffee ? '‚òï YES - YOU HAVE TIME FOR COFFEE!' : '‚ö° NO - GO DIRECT TO WORK'}
                        </div>
                        <div style="opacity: 0.9;">${journey.coffee_decision.message || ''}</div>
                    </div>
                `;
            }

            // Journey segments
            if (journey.segments && journey.segments.length > 0) {
                html += '<div style="margin-top: 20px;"><div style="font-weight: 600; margin-bottom: 15px; font-size: 16px;">Journey Timeline:</div>';
                journey.segments.forEach(seg => {
                    const icon = seg.type === 'walk' ? 'üö∂' : seg.type === 'coffee' ? '‚òï' : seg.type === 'train' ? 'üöÜ' : seg.type === 'tram' ? 'üöä' : seg.type === 'bus' ? 'üöå' : '‚è±Ô∏è';
                    html += `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 24px;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${seg.from || seg.location || ''} ${seg.to ? '‚Üí ' + seg.to : ''}</div>
                                <div style="font-size: 13px; opacity: 0.7;">${seg.type} ¬∑ ${seg.duration} min ${seg.departure ? '¬∑ ' + seg.departure : ''}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            document.getElementById('journey-result-content').innerHTML = html;
            window.scrollTo({ top: document.getElementById('journey-result').offsetTop - 20, behavior: 'smooth' });
        }

        function showAddressEditor() {
            document.getElementById('address-card').style.display = 'block';
            document.getElementById('journey-result').style.display = 'none';
            window.scrollTo({ top: document.getElementById('address-card').offsetTop - 20, behavior: 'smooth' });
        }

        // ============= SYSTEM ARCHITECTURE VISUALIZATION =============
        function showSystemArchitecture() {
            const viz = document.getElementById('architecture-viz');

            if (viz.style.display === 'block') {
                viz.style.display = 'none';
                return;
            }

            viz.style.display = 'block';
            viz.innerHTML = `
                <div style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                    <h3 style="text-align: center; margin-bottom: 25px; font-size: 20px;">üß† Intelligent Data Flow</h3>

                    <div class="arch-node">
                        <div class="arch-node-title">1Ô∏è‚É£ User Input</div>
                        <div class="arch-node-desc">You configure your home, cafe, and work addresses along with your desired arrival time</div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">2Ô∏è‚É£ Multi-Tier Address Geocoding</div>
                        <div class="arch-node-desc">
                            <strong>6-Tier Fallback System</strong> finds addresses with maximum accuracy:<br>
                            1Ô∏è‚É£ <strong>Google Places</strong> (best for cafes/businesses)<br>
                            2Ô∏è‚É£ <strong>Mapbox</strong> (excellent accuracy)<br>
                            3Ô∏è‚É£ <strong>HERE</strong> (optimized for Australia)<br>
                            4Ô∏è‚É£ <strong>Foursquare</strong> (venues/locations)<br>
                            5Ô∏è‚É£ <strong>LocationIQ</strong> (free tier)<br>
                            6Ô∏è‚É£ <strong>Nominatim</strong> (always available)<br>
                            <em>Cached in memory for 24 hours</em>
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">3Ô∏è‚É£ Walking Distance Calculation</div>
                        <div class="arch-node-desc">
                            <strong>Haversine Formula</strong> calculates walking distances and times<br>
                            Standard walking speed: 80m/min (4.8 km/h)
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">4Ô∏è‚É£ Cafe Busy-ness Detection</div>
                        <div class="arch-node-desc">
                            <strong>Google Places API</strong> (if configured) provides real-time busy-ness<br>
                            <strong>Fallback:</strong> Time-based inference (7-9am = 2√ó wait time, etc.)
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">5Ô∏è‚É£ Transit Data Fetching</div>
                        <div class="arch-node-desc">
                            <strong>Transport Victoria GTFS-Realtime API</strong> provides live departures<br>
                            OpenData Platform ¬∑ Metro Trains, Yarra Trams, Metro Bus, V/Line<br>
                            API Key authentication ¬∑ 30-second cache TTL
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">6Ô∏è‚É£ Backward Time Calculation</div>
                        <div class="arch-node-desc">
                            System works <strong>backwards</strong> from your arrival time:<br>
                            Arrival ‚Üí subtract work walk ‚Üí subtract transit ‚Üí subtract cafe time ‚Üí subtract walks ‚Üí <strong>LEAVE HOME TIME</strong>
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">7Ô∏è‚É£ Multi-Modal Route Optimization</div>
                        <div class="arch-node-desc">
                            <strong>Multi-Modal Router</strong> searches trains, trams, buses<br>
                            Filters by ¬±10 min window ¬∑ Returns best 2 options
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">8Ô∏è‚É£ Real-Time Delay Detection</div>
                        <div class="arch-node-desc">
                            <strong>Live GTFS-RT Monitoring</strong> detects service disruptions<br>
                            Automatically recalculates connections when delays occur<br>
                            Updates every 30 seconds ¬∑ Shows revised departure times
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">9Ô∏è‚É£ Coffee Decision</div>
                        <div class="arch-node-desc">
                            Compares available time vs required time (walk + coffee purchase + walk)<br>
                            <strong>Result:</strong> ‚òï YES or ‚ö° NO
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">üîü Weather Integration</div>
                        <div class="arch-node-desc">
                            <strong>Bureau of Meteorology</strong> official JSON feeds<br>
                            Updates every 30 min ¬∑ 10-minute cache
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">1Ô∏è‚É£1Ô∏è‚É£ Decision Logging</div>
                        <div class="arch-node-desc">
                            <strong>Transparent Decision Trail</strong> records all system decisions:<br>
                            ‚Ä¢ Geocoding service used<br>
                            ‚Ä¢ Route calculations<br>
                            ‚Ä¢ Delay detections<br>
                            ‚Ä¢ Connection adjustments<br>
                            <em>Available for troubleshooting and transparency</em>
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node" style="border-color: #22c55e;">
                        <div class="arch-node-title">üéØ Live Display</div>
                        <div class="arch-node-desc">
                            E-ink display shows:<br>
                            ‚Ä¢ Current time & weather<br>
                            ‚Ä¢ Coffee decision<br>
                            ‚Ä¢ Next departures<br>
                            ‚Ä¢ Service alerts<br>
                            <br>
                            <strong>Updates every 30 seconds</strong>
                        </div>
                    </div>

                    <div style="margin-top: 25px; padding: 15px; background: rgba(99, 102, 241, 0.2); border-radius: 8px; text-align: center;">
                        <strong>All data points work together intelligently to answer:</strong><br>
                        <span style="font-size: 18px; display: block; margin-top: 10px;">
                            ‚òï "Can I get coffee, or should I go direct?"
                        </span>
                    </div>
                </div>
            `;
        }

        // Decision Log Functions
        async function loadDecisionLog() {
            const content = document.getElementById('decision-log-content');
            const stats = document.getElementById('decision-log-stats');
            const entries = document.getElementById('decision-log-entries');

            try {
                const response = await fetch(BASE_URL + '/api/decisions?limit=50');
                const data = await response.json();

                if (data.success) {
                    // Show content
                    content.style.display = 'block';

                    // Display stats
                    stats.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700;">${data.stats.totalDecisions}</div>
                                <div style="font-size: 12px; opacity: 0.8;">Total Decisions</div>
                            </div>
                            ${Object.entries(data.stats.categories).map(([cat, count]) => `
                                <div>
                                    <div style="font-size: 20px; font-weight: 600;">${count}</div>
                                    <div style="font-size: 11px; opacity: 0.8;">${cat}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    // Display log entries
                    if (data.logs.length > 0) {
                        entries.innerHTML = `
                            <div style="font-weight: 600; margin: 15px 0 10px 0; font-size: 14px;">Recent Decisions (Last 50):</div>
                            ${data.logs.reverse().map(log => {
                                const categoryColors = {
                                    'Geocoding': 'rgba(102, 126, 234, 0.15)',
                                    'Route Calculation': 'rgba(72, 187, 120, 0.15)',
                                    'Delay Detection': 'rgba(252, 129, 129, 0.15)',
                                    'Connection Adjustment': 'rgba(237, 137, 54, 0.15)',
                                    'Coffee Decision': 'rgba(139, 92, 246, 0.15)',
                                    'API Fallback': 'rgba(251, 191, 36, 0.15)',
                                    'Transit Mode Selection': 'rgba(59, 130, 246, 0.15)',
                                    'Cache': 'rgba(156, 163, 175, 0.15)'
                                };

                                const bgColor = categoryColors[log.category] || 'rgba(255,255,255,0.05)';

                                return `
                                    <div style="padding: 12px; background: ${bgColor}; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid rgba(255,255,255,0.3);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="font-weight: 600; font-size: 13px;">${log.category}</div>
                                            <div style="font-size: 11px; opacity: 0.7; font-family: 'Courier New', monospace;">
                                                ${new Date(log.timestamp).toLocaleTimeString()}
                                            </div>
                                        </div>
                                        <div style="font-size: 13px; margin-bottom: 4px;">${log.decision}</div>
                                        ${log.details ? `
                                            <details style="margin-top: 6px; font-size: 12px; opacity: 0.8;">
                                                <summary style="cursor: pointer; font-size: 11px;">Details</summary>
                                                <pre style="margin-top: 6px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; overflow-x: auto; font-size: 11px;">${JSON.stringify(log.details, null, 2)}</pre>
                                            </details>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        `;
                    } else {
                        entries.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">No decisions logged yet</div>';
                    }
                }
            } catch (error) {
                content.style.display = 'block';
                entries.innerHTML = `<div style="padding: 20px; text-align: center; color: #fc8181;">Error loading decision log: ${error.message}</div>`;
            }
        }

        async function exportDecisionLog() {
            try {
                const response = await fetch(BASE_URL + '/api/decisions/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `decisions-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                alert('‚úÖ Decision log exported successfully!');
            } catch (error) {
                alert('‚ùå Error exporting decision log: ' + error.message);
            }
        }

        // Feedback Form
        async function submitFeedback() {
            const name = document.getElementById('feedback-name').value;
            const email = document.getElementById('feedback-email').value;
            const type = document.getElementById('feedback-type').value;
            const message = document.getElementById('feedback-message').value;
            const status = document.getElementById('feedback-status');

            if (!message.trim()) {
                status.style.display = 'block';
                status.style.color = '#fc8181';
                status.textContent = '‚ùå Please enter a message';
                return;
            }

            status.style.display = 'block';
            status.style.color = '#4a5568';
            status.textContent = 'üì§ Sending...';

            try {
                const response = await fetch(BASE_URL + '/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name || 'Anonymous',
                        email: email || 'No email provided',
                        type,
                        message,
                        timestamp: new Date().toISOString()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    status.style.color = '#48bb78';
                    status.textContent = '‚úÖ Feedback sent successfully! Thank you for your input.';
                    // Clear form
                    document.getElementById('feedback-name').value = '';
                    document.getElementById('feedback-email').value = '';
                    document.getElementById('feedback-message').value = '';
                } else {
                    throw new Error(result.message || 'Failed to send feedback');
                }
            } catch (error) {
                status.style.color = '#fc8181';
                status.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // ============= SYSTEM RESET & CACHE MANAGEMENT =============

        /**
         * Clear all caches without resetting user data
         */
        async function clearAllCaches() {
            const btn = document.getElementById('clear-cache-btn');
            const originalText = btn.innerHTML;

            if (!confirm('Clear all caches? This will remove cached geocoding, weather, and journey data.\n\nYour preferences and configuration will NOT be deleted.\n\nClick OK to proceed.')) {
                return;
            }

            btn.innerHTML = '‚è≥ Clearing caches...';
            btn.disabled = true;

            try {
                const response = await fetch(BASE_URL + '/admin/cache/clear', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    btn.innerHTML = '‚úÖ Caches Cleared!';
                    btn.style.background = '#48bb78';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 3000);

                    showMessage('system-reset-message', 'All caches cleared successfully. Data will refresh on next request.', 'success');
                } else {
                    throw new Error(result.error || 'Failed to clear caches');
                }
            } catch (error) {
                btn.innerHTML = '‚ùå Error';
                btn.style.background = '#fc8181';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 3000);

                alert('Error clearing caches: ' + error.message);
            }
        }

        /**
         * Complete system reset - confirmation step
         */
        function confirmFullSystemReset() {
            const confirmed = confirm(
                '‚ö†Ô∏è COMPLETE SYSTEM RESET ‚ö†Ô∏è\n\n' +
                'This action will:\n' +
                '‚Ä¢ DELETE ALL user data (addresses, preferences, API keys)\n' +
                '‚Ä¢ CLEAR ALL caches\n' +
                '‚Ä¢ RESTART the server\n\n' +
                'You will need to run the Setup Wizard again.\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Are you ABSOLUTELY SURE you want to proceed?'
            );

            if (!confirmed) {
                return;
            }

            // Second confirmation for safety
            const finalConfirm = confirm(
                '‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è\n\n' +
                'This is your last chance to cancel.\n\n' +
                'All your data will be permanently deleted.\n\n' +
                'Type exactly "DELETE" in the next prompt to proceed, or click Cancel to abort.'
            );

            if (!finalConfirm) {
                return;
            }

            // Require typing DELETE
            const userInput = prompt('Type "DELETE" in capital letters to confirm system reset:');

            if (userInput !== 'DELETE') {
                alert('System reset cancelled. You must type "DELETE" exactly to proceed.');
                return;
            }

            // Proceed with reset
            performFullSystemReset();
        }

        /**
         * Execute the full system reset
         */
        async function performFullSystemReset() {
            const btn = document.getElementById('full-reset-btn');
            btn.innerHTML = '‚è≥ Wiping data and restarting server...';
            btn.disabled = true;
            btn.style.opacity = '0.6';

            try {
                const response = await fetch(BASE_URL + '/admin/system/reset-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    // Show success message
                    btn.innerHTML = '‚úÖ Reset Complete! Server Restarting...';
                    btn.style.background = '#48bb78';

                    // Show countdown and redirect
                    let countdown = 10;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            btn.innerHTML = `‚úÖ Server restarting... Redirecting to Setup in ${countdown}s`;
                        } else {
                            clearInterval(countdownInterval);
                            window.location.href = '/setup';
                        }
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Reset failed');
                }
            } catch (error) {
                btn.innerHTML = '‚ùå Error: ' + error.message;
                btn.style.background = '#fc8181';

                setTimeout(() => {
                    btn.innerHTML = '‚ö†Ô∏è WIPE ALL DATA & RESTART SERVER';
                    btn.style.background = '';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }, 5000);

                alert('System reset failed: ' + error.message + '\n\nPlease try again or contact support.');
            }
        }

        // System Architecture Visualization
        async function toggleSystemArchitecture() {
            const vizDiv = document.getElementById('architecture-viz');
            const toggleBtn = document.getElementById('arch-toggle-btn');

            if (vizDiv.style.display === 'block') {
                vizDiv.style.display = 'none';
                toggleBtn.innerHTML = '<span style="font-size: 20px;">üîç</span> Show Full Architecture Map';
                return;
            }

            // Fetch current configuration to show active services (or defaults if not configured)
            const attributions = await fetch(BASE_URL + '/api/attributions').then(r => r.json()).catch(() => ({
                attributions: [
                    { name: 'PTV-TRMNL', license: 'CC BY-NC 4.0', required: true },
                    { name: 'Transport Authority', license: 'Varies by state', required: true },
                    { name: 'Bureau of Meteorology', license: 'CC BY 3.0 AU', required: true },
                    { name: 'OpenStreetMap', license: 'ODbL', required: true }
                ]
            }));
            const preferences = await fetch(BASE_URL + '/admin/preferences').then(r => r.json()).catch(() => null);

            // Use defaults if not configured to show full architecture BEFORE user configuration
            const transitAuthority = preferences?.location?.transitAuthority || 'Auto-detected based on your state';
            const location = preferences?.location?.city ? `${preferences.location.city}, ${preferences.location.state}` : 'To be configured';

            vizDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; color: white;">
                    <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 20px;">System Architecture Map</h3>
                    <div style="font-size: 13px; opacity: 0.9; text-align: center; margin-bottom: 25px;">
                        <strong>Location:</strong> ${location} ‚Ä¢ <strong>Transit Authority:</strong> ${transitAuthority}
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <!-- Layer 1: User Input -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">üìù USER INPUT LAYER</div>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                <div style="padding: 8px 15px; background: rgba(255,255,255,0.15); border-radius: 6px;">Setup Wizard</div>
                                <div style="padding: 8px 15px; background: rgba(255,255,255,0.15); border-radius: 6px;">Preferences</div>
                                <div style="padding: 8px 15px; background: rgba(255,255,255,0.15); border-radius: 6px;">Addresses</div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 2: Data Processing -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">‚öôÔ∏è DATA PROCESSING LAYER</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                <div style="padding: 8px; background: rgba(64, 220, 165, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Geocoding</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">6-Tier Fallback</div>
                                </div>
                                <div style="padding: 8px; background: rgba(102, 126, 234, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Route Planning</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Multi-Modal</div>
                                </div>
                                <div style="padding: 8px; background: rgba(246, 173, 85, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Walking Times</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Calculated</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 3: External Data Sources (Active Only) -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">üåê ACTIVE DATA SOURCES</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                ${attributions.attributions?.filter(a => a.required || a.name !== 'PTV-TRMNL').map(attr => `
                                    <div style="padding: 8px; background: rgba(255,255,255,0.15); border-radius: 6px; border-left: 3px solid ${attr.name.includes('Transport') ? '#667eea' : attr.name.includes('BOM') || attr.name.includes('Meteorology') ? '#48bb78' : attr.name.includes('OpenStreetMap') ? '#10b981' : '#fbbf24'};">
                                        <div style="font-weight: 600; font-size: 11px;">${attr.name}</div>
                                        <div style="font-size: 9px; opacity: 0.8; margin-top: 2px;">${attr.license}</div>
                                    </div>
                                `).join('') || '<div style="text-align: center; opacity: 0.7;">No services configured</div>'}
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 4: Intelligence Engine -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">ü§ñ INTELLIGENCE ENGINE</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                <div style="padding: 8px; background: rgba(139, 92, 246, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Coffee Decision</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Time Calculator</div>
                                </div>
                                <div style="padding: 8px; background: rgba(236, 72, 153, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Delay Detection</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Real-Time</div>
                                </div>
                                <div style="padding: 8px; background: rgba(251, 191, 36, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Journey Optimizer</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Multi-Factor</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 5: Auto Calculation -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">üîÑ AUTO-CALCULATION LAYER</div>
                            <div style="text-align: center;">
                                <div style="padding: 10px; background: rgba(102, 126, 234, 0.3); border-radius: 6px; display: inline-block;">
                                    <div style="font-weight: 600; font-size: 12px;">Background Process</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Runs every 2 minutes</div>
                                    <div style="font-size: 10px; opacity: 0.9;">Keeps data always current</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 6: Output -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">üì± OUTPUT LAYER</div>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                <div style="padding: 10px 15px; background: rgba(64, 220, 165, 0.3); border-radius: 6px; font-weight: 600;">
                                    TRMNL Display
                                </div>
                                <div style="padding: 10px 15px; background: rgba(72, 187, 120, 0.3); border-radius: 6px; font-weight: 600;">
                                    Journey Visualizer
                                </div>
                                <div style="padding: 10px 15px; background: rgba(102, 126, 234, 0.3); border-radius: 6px; font-weight: 600;">
                                    Admin Dashboard
                                </div>
                            </div>
                        </div>

                        <!-- Data Flow Indicators -->
                        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 10px; text-align: center; font-size: 13px;">üîÑ Live Data Flow</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 11px;">
                                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Transit Data:</strong> Refreshes every 30 seconds
                                </div>
                                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Weather Data:</strong> Cached for 10 minutes
                                </div>
                                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Journey Calc:</strong> Auto-updates every 2 minutes
                                </div>
                                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Geocoding:</strong> Cached for 24 hours
                                </div>
                            </div>
                        </div>

                        <!-- Decision Logging -->
                        <div style="margin-top: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 11px; text-align: center;">
                            <strong>üîç Transparency:</strong> All decisions logged to Decision Log for full system transparency
                        </div>
                    </div>
                </div>
            `;

            vizDiv.style.display = 'block';
            toggleBtn.innerHTML = '<span style="font-size: 20px;">üîº</span> Hide Architecture Map';
        }

        // ===== SETUP WIZARD FUNCTIONS =====

        // Setup wizard step navigation
        function setupNextStep(step) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`setup-content-${i}`).style.display = 'none';
                document.getElementById(`setup-step-${i}`).style.background = '#e2e8f0';
                document.getElementById(`setup-step-${i}`).style.color = '#2d3748';
            }

            // Show current step
            document.getElementById(`setup-content-${step}`).style.display = 'block';
            document.getElementById(`setup-step-${step}`).style.background = '#667eea';
            document.getElementById(`setup-step-${step}`).style.color = 'white';

            // Mark previous steps as complete
            for (let i = 1; i < step; i++) {
                document.getElementById(`setup-step-${i}`).style.background = '#48bb78';
                document.getElementById(`setup-step-${i}`).style.color = 'white';
            }
        }

        function setupPrevStep(step) {
            setupNextStep(step);
        }

        function toggleSetupMode2() {
            const section = document.getElementById('setup-mode2-section');
            const checkbox = document.getElementById('setup-add-mode2');
            section.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleSetupCoffeeTime() {
            const section = document.getElementById('setup-coffee-time-section');
            const checkbox = document.getElementById('setup-include-coffee');
            section.style.display = checkbox.checked ? 'block' : 'none';
        }

        // Toggle Google API key input visibility
        function toggleGoogleApiInput() {
            const checkbox = document.getElementById('setup-has-google-api');
            const inputSection = document.getElementById('setup-google-api-input');
            inputSection.style.display = checkbox.checked ? 'block' : 'none';
        }

        // Save Google API key and restart system
        async function saveGoogleApiKey() {
            const apiKey = document.getElementById('setup-google-api-key').value.trim();
            const messageDiv = document.getElementById('google-api-save-message');

            if (!apiKey) {
                messageDiv.style.display = 'block';
                messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                messageDiv.style.color = '#fca5a5';
                messageDiv.innerHTML = '‚ùå Please enter your Google Places API key';
                return;
            }

            try {
                // Show saving message
                messageDiv.style.display = 'block';
                messageDiv.style.background = 'rgba(251, 191, 36, 0.2)';
                messageDiv.style.color = '#fbbf24';
                messageDiv.innerHTML = '‚è≥ Saving API key...';

                // Save to additional APIs endpoint
                const response = await fetch('/admin/apis/additional', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiId: 'googlePlaces',
                        apiKey: apiKey,
                        enabled: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                    messageDiv.style.color = '#6ee7b7';
                    messageDiv.innerHTML = `
                        ‚úÖ Google Places API key saved successfully!
                        <br><small>Reloading system in 3 seconds...</small>
                    `;

                    // Reload the page after 3 seconds to restart with new API key
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    messageDiv.style.color = '#fca5a5';
                    messageDiv.innerHTML = `‚ùå Failed to save: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                console.error('Error saving Google API key:', error);
                messageDiv.style.display = 'block';
                messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                messageDiv.style.color = '#fca5a5';
                messageDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        async function startJourneyPlanning() {
            console.log('üöÄ startJourneyPlanning() called');

            // Validate required fields
            const homeAddress = document.getElementById('setup-home-address').value.trim();
            const workAddress = document.getElementById('setup-work-address').value.trim();
            const arrivalTime = document.getElementById('setup-arrival-time').value;
            const cafeAddress = document.getElementById('setup-cafe-address').value.trim();
            const coffeeEnabled = document.getElementById('setup-include-coffee').checked;

            console.log('üìù Input values:', { homeAddress, workAddress, arrivalTime, cafeAddress, coffeeEnabled });

            if (!homeAddress) {
                showMessage('setup-message', '‚ùå Please enter your home address', 'error');
                return;
            }
            if (!workAddress) {
                showMessage('setup-message', '‚ùå Please enter your work address', 'error');
                return;
            }
            if (!arrivalTime) {
                showMessage('setup-message', '‚ùå Please enter your arrival time', 'error');
                return;
            }

            // Hide any previous messages
            document.getElementById('setup-message').style.display = 'none';

            // Show progress indicator
            const progressDiv = document.getElementById('setup-progress');
            const progressText = document.getElementById('setup-progress-text');
            progressDiv.style.display = 'block';
            progressText.textContent = 'Validating addresses...';

            try {
                // Prepare data for smart setup
                const setupData = {
                    addresses: {
                        home: homeAddress,
                        work: workAddress,
                        cafe: cafeAddress || null
                    },
                    arrivalTime: arrivalTime,
                    coffeeEnabled: coffeeEnabled
                };

                console.log('üì§ Sending request to /admin/smart-setup:', setupData);
                progressText.textContent = 'Detecting your state and nearby transit stops...';

                // Call smart setup endpoint that will:
                // 1. Geocode addresses
                // 2. Detect state
                // 3. Find nearby transit stops automatically
                // 4. Select best route mode
                // 5. Save configuration
                // 6. Start auto-calculation
                const response = await fetch(BASE_URL + '/admin/smart-setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(setupData)
                });

                console.log('üì• Response status:', response.status, response.statusText);

                const result = await response.json();
                console.log('üì• Response data:', result);

                if (result.success) {
                    progressText.textContent = '‚úÖ Journey configured! Loading Live Data...';

                    // Hide progress after brief display
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 300);

                    // Show comprehensive success message
                    const setupMessage = document.getElementById('setup-message');
                    setupMessage.className = 'message success';
                    setupMessage.style.display = 'block';
                    setupMessage.innerHTML = `
                        <div style="padding: 20px;">
                            <div style="font-size: 24px; margin-bottom: 15px;">‚úÖ Journey Configured for ${result.state || 'Your Location'}!</div>

                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; margin-bottom: 10px;">üìç Your Journey:</div>
                                <div style="font-size: 14px; line-height: 1.8;">
                                    <div>üè† <strong>Home:</strong> ${result.homeStop || 'Not available'}</div>
                                    <div>üíº <strong>Work:</strong> ${result.workStop || 'Not available'}</div>
                                    <div>üöÜ <strong>Transit Mode:</strong> ${result.routeMode || 'Auto-detected'}</div>
                                    <div>üìä <strong>Stops Found:</strong> ${result.stopsFound || 0} stops in your area</div>
                                </div>
                            </div>

                            <div style="background: rgba(251, 191, 36, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #fbbf24;">
                                <div style="font-weight: 600; margin-bottom: 8px;">üî¥ Using Fallback Timetable Data</div>
                                <div style="font-size: 13px; opacity: 0.9; line-height: 1.6;">
                                    Your journey is configured and working! Currently using static timetable data.
                                    For real-time updates, add your API keys in the next step.
                                </div>
                            </div>

                            <div style="font-weight: 600; margin-bottom: 10px;">What's Next?</div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="showTab('api')" style="flex: 1; min-width: 200px;">
                                    üîë Configure API Keys for Live Data
                                </button>
                                <button class="btn btn-secondary" onclick="showTab('live')" style="flex: 1; min-width: 200px;">
                                    üëÄ View Journey with Fallback Data
                                </button>
                            </div>

                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px; opacity: 0.7;">
                                <strong>üí° Tip:</strong> The system works great with fallback data! API keys are optional and just add real-time arrival updates.
                            </div>
                        </div>
                    `;

                    // Scroll to message
                    setupMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    console.error('‚ùå Setup failed:', result.message);
                    progressDiv.style.display = 'none';
                    showToast('error', 'Setup Failed', result.message || 'Setup failed. Please try again.');
                    showMessage('setup-message', '‚ùå ' + (result.message || 'Setup failed. Please try again.'), 'error');
                }
            } catch (error) {
                console.error('‚ùå Setup error:', error);
                progressDiv.style.display = 'none';
                showToast('error', 'Setup Error', error.message || 'An unexpected error occurred. Check console for details.');
                showMessage('setup-message', '‚ùå Error: ' + error.message + '<br>Check browser console for details.', 'error');
            }
        }

        // Legacy function for backward compatibility (no longer used in UI)
        async function completeSetup() {
            console.warn('completeSetup() is deprecated, use startJourneyPlanning() instead');
            await startJourneyPlanning();
        }

        // ===== ADDRESS AUTOCOMPLETE FUNCTIONS =====

        let addressSearchTimeout = null;

        function setupAddressAutocomplete(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) return;

            input.addEventListener('input', function() {
                const query = this.value.trim();

                clearTimeout(addressSearchTimeout);

                if (query.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }

                addressSearchTimeout = setTimeout(async () => {
                    try {
                        console.log(`üîç Searching for: "${query}"`);
                        const response = await fetch(`${BASE_URL}/admin/address/search?query=${encodeURIComponent(query)}`);
                        console.log(`üì° Search response status: ${response.status}`);

                        const data = await response.json();
                        console.log(`üì• Search results:`, data);

                        if (data.success && data.results && data.results.length > 0) {
                            console.log(`‚úÖ Found ${data.results.length} results from sources:`, data.sources);

                            // Log validation information if available
                            if (data.validation) {
                                console.log(`üéØ Geocoding confidence: ${data.validation.confidence.score}% (${data.validation.confidence.level})`);
                                console.log(`üîç Cross-validation: ${data.validation.crossValidation.agreement}`);
                            }

                            // Show confidence indicator at top if available
                            let confidenceHeader = '';
                            if (data.validation && data.validation.confidence) {
                                const conf = data.validation.confidence;
                                const emoji = conf.level === 'high' ? 'üü¢' : conf.level === 'medium' ? 'üü°' : 'üî¥';
                                confidenceHeader = `
                                    <div style="padding: 8px 12px; background: rgba(102, 126, 234, 0.1); border-bottom: 1px solid rgba(102, 126, 234, 0.2); font-size: 11px;">
                                        ${emoji} <strong>${conf.message}</strong> (${conf.score}% confidence)<br>
                                        <span style="opacity: 0.7;">Sources: ${conf.sources}</span>
                                    </div>
                                `;
                            }

                            dropdown.innerHTML = confidenceHeader + data.results.map(result => `
                                <div class="autocomplete-item" onclick='selectAddress("${inputId}", "${dropdownId}", ${JSON.stringify(result).replace(/'/g, "\\'")})'>
                                    <div style="font-weight: 600; margin-bottom: 3px;">${result.display_name || result.address}</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${result.full_address || ''}</div>
                                    <div style="font-size: 10px; opacity: 0.5; margin-top: 2px;">Source: ${result.source || 'Unknown'}</div>
                                </div>
                            `).join('');
                            dropdown.style.display = 'block';
                        } else {
                            console.warn(`‚ö†Ô∏è No results found for: "${query}"`);
                            dropdown.innerHTML = `
                                <div class="autocomplete-item" style="opacity: 0.6;">
                                    No results found for "${query}"<br>
                                    <small style="font-size: 11px;">Try: full address with suburb and state</small>
                                </div>
                            `;
                            dropdown.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('‚ùå Address search error:', error);
                        dropdown.innerHTML = `
                            <div class="autocomplete-item" style="color: #fc8181;">
                                Search error: ${error.message}<br>
                                <small style="font-size: 11px;">Check browser console for details</small>
                            </div>
                        `;
                        dropdown.style.display = 'block';
                    }
                }, 300);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== input) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function selectAddress(inputId, dropdownId, result) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (input) {
                input.value = result.display_name || result.address;
                input.setAttribute('data-lat', result.lat);
                input.setAttribute('data-lon', result.lon);
            }

            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        // Initialize autocomplete on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Setup autocomplete for Setup tab
            setupAddressAutocomplete('setup-home-address', 'setup-home-suggestions');
            setupAddressAutocomplete('setup-work-address', 'setup-work-suggestions');
            setupAddressAutocomplete('setup-cafe-address', 'setup-cafe-suggestions');

            // Setup autocomplete for Journey Planner tab (if fields exist)
            setupAddressAutocomplete('home-address', 'home-suggestions');
            setupAddressAutocomplete('work-address', 'work-suggestions');
            setupAddressAutocomplete('cafe-address', 'cafe-suggestions');
        });
    </script>
</body>
</html>
