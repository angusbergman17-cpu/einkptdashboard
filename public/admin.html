<!DOCTYPE html>
<html lang="en">
<!--
    Commute Compute - Intelligent Transit Display System
    Copyright (c) 2026 Angus Bergman
    Licensed under CC BY-NC 4.0
    https://creativecommons.org/licenses/by-nc/4.0/
-->
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#1a2744">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commute Compute Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a2744;
            min-height: 100vh;
            color: #f1f5f9;
            padding: 20px;
            font-size: 15px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px;
            background: #2a3d5f;
            border: 1px solid #3d5278;
            border-radius: 4px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #166534;
            padding: 4px 12px;
            font-size: 13px;
            color: #dcfce7;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .time-display {
            font-size: 48px;
            font-weight: 700;
            margin: 15px 0 5px;
            font-variant-numeric: tabular-nums;
        }

        .date-display {
            font-size: 16px;
            opacity: 0.8;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #94a3b8;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.15s, border-color 0.15s;
        }

        .nav-tab:hover {
            color: #f1f5f9;
            border-bottom-color: #64748b;
        }

        .nav-tab.active {
            color: #4fb28e;
            border-bottom-color: #4fb28e;
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Grid layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Cards */
        .card {
            background: #2a3d5f;
            padding: 24px;
            border: 1px solid #3d5278;
            border-radius: 4px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3d5278;
        }

        .card-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .card-icon {
            font-size: 20px;
        }

        /* Departure rows */
        .departure-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .departure-row:last-child {
            border-bottom: none;
        }

        .departure-dest {
            font-weight: 500;
            font-size: 15px;
        }

        .departure-status {
            font-size: 12px;
            opacity: 0.7;
        }

        .departure-time {
            font-size: 28px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .departure-time span {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.7;
        }

        /* Weather */
        .weather-display {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .weather-temp {
            font-size: 48px;
            font-weight: 700;
        }

        .weather-condition {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .weather-extra {
            font-size: 13px;
            opacity: 0.7;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #cbd5e1;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #3d5278;
            border-radius: 4px;
            background: #1a2744;
            color: #f1f5f9;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            transition: border-color 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4fb28e;
        }

        .form-input::placeholder {
            color: #7a8fa8;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Buttons */
        .btn {
            background: #4fb28e;
            color: #f1f5f9;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #818cf8;
            transform: scale(1.02);
        }

        .btn-success {
            background: rgba(34, 197, 94, 0.8);
        }

        .btn-success:hover {
            background: rgba(34, 197, 94, 1);
        }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.8);
        }

        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.9);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4fb28e;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .message-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .message-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .message-warning {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        /* Coffee decision */
        .coffee-decision {
            text-align: center;
            padding: 20px;
        }

        .coffee-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .coffee-text {
            font-size: 22px;
            font-weight: 700;
        }

        .coffee-subtext {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-live {
            background: rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .status-fallback {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Route summary */
        .route-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .route-time {
            text-align: center;
            padding: 15px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
        }

        .route-time-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .route-time-value {
            font-size: 28px;
            font-weight: 700;
        }

        /* Transit mode selector */
        .transit-mode {
            background: rgba(15, 23, 42, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .transit-mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .add-mode-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 15px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            background: transparent;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .add-mode-btn:hover {
            border-color: #4fb28e;
            color: #f1f5f9;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            opacity: 0.6;
            font-size: 13px;
        }

        .footer a {
            color: white;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* No data */
        .no-data {
            text-align: center;
            padding: 30px;
            opacity: 0.6;
        }

        /* Address Autocomplete */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .form-group {
            position: relative;
        }

        /* System Architecture Viz */
        .arch-node {
            background: rgba(79, 178, 142, 0.1);
            border: 2px solid rgba(79, 178, 142, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .arch-node-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #f1f5f9;
        }

        .arch-node-desc {
            font-size: 13px;
            opacity: 0.85;
            line-height: 1.5;
        }

        .arch-arrow {
            text-align: center;
            font-size: 24px;
            margin: 5px 0;
            opacity: 0.6;
        }

        /* Version control footer */
        .version-footer {
            margin-top: 30px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-size: 11px;
            color: #718096;
            font-family: 'Courier New', monospace;
        }

        .version-footer .version-label {
            font-weight: 600;
            color: #334155;
            margin-right: 8px;
        }

        .version-footer .version-value {
            color: #1e293b;
        }

        .version-footer .separator {
            margin: 0 10px;
            color: #cbd5e1;
        }

        /* Autocomplete dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 10px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .autocomplete-item:hover {
            background: rgba(79, 178, 142, 0.15);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* Onboarding Overlay & Tutorial Styles */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .onboarding-modal {
            background: #1a2744;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(79, 178, 142, 0.3);
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .onboarding-modal h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #f1f5f9;
            font-weight: 600;
        }

        .onboarding-modal p {
            font-size: 16px;
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .onboarding-step-content {
            min-height: 180px;
        }

        .onboarding-features {
            list-style: none;
            margin: 20px 0;
        }

        .onboarding-features li {
            padding: 10px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
        }

        .onboarding-features li:before {
            content: "‚úì";
            display: inline-block;
            width: 24px;
            height: 24px;
            background: rgba(79, 178, 142, 0.2);
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            color: #4fb28e;
            flex-shrink: 0;
        }

        .onboarding-progress {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 25px 0 20px;
        }

        .onboarding-progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .onboarding-progress-dot.active {
            width: 30px;
            border-radius: 5px;
            background: #4fb28e;
        }

        .onboarding-buttons {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            margin-top: 25px;
        }

        .btn-onboarding {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-onboarding-primary {
            background: #4fb28e;
            color: #f1f5f9;
            flex: 1;
        }

        .btn-onboarding-primary:hover {
            background: #818cf8;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(79, 178, 142, 0.3);
        }

        .btn-onboarding-secondary {
            background: rgba(51, 65, 85, 0.8);
            color: #f1f5f9;
        }

        .btn-onboarding-secondary:hover {
            background: rgba(71, 85, 105, 0.9);
        }

        .btn-onboarding-skip {
            background: transparent;
            color: #94a3b8;
            padding: 12px 20px;
        }

        .btn-onboarding-skip:hover {
            color: #cbd5e1;
        }

        /* Tutorial Highlight */
        .tutorial-highlight {
            position: relative;
            z-index: 10000;
            box-shadow: 0 0 0 4px #4fb28e, 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 12px;
        }

        .tutorial-tooltip {
            position: absolute;
            background: #4fb28e;
            color: #f1f5f9;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.7;
            max-width: 300px;
            z-index: 10001;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            animation: tooltipPulse 0.4s ease-out;
        }

        @keyframes tooltipPulse {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .tutorial-tooltip:after {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .tutorial-tooltip.top:after {
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0 10px;
            border-color: #4fb28e transparent transparent transparent;
        }

        .tutorial-tooltip.bottom:after {
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent #4fb28e transparent;
        }

        /* Show Tutorial Again Button */
        .show-tutorial-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4fb28e;
            color: #f1f5f9;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(79, 178, 142, 0.3);
            transition: all 200ms;
            z-index: 1000;
        }

        .show-tutorial-btn:hover {
            background: #818cf8;
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(79, 178, 142, 0.4);
        }

        /* All tabs always visible (no simple/advanced toggle) */

        /* Visual Enhancements - Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-operational {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }

        .status-degraded {
            background: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
        }

        .status-down {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.05) 25%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0.05) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
            height: 20px;
            margin: 8px 0;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton.skeleton-card {
            height: 120px;
            border-radius: 12px;
        }

        .skeleton.skeleton-text {
            height: 16px;
            width: 100%;
        }

        .skeleton.skeleton-text-short {
            height: 16px;
            width: 60%;
        }

        /* Success Animation */
        @keyframes success-pulse {
            0%, 100% {
                background: rgba(34, 197, 94, 0.1);
                border-color: rgba(34, 197, 94, 0.3);
            }
            50% {
                background: rgba(34, 197, 94, 0.2);
                border-color: rgba(34, 197, 94, 0.5);
            }
        }

        .success-flash {
            animation: success-pulse 1s ease-in-out;
        }

        /* Color-coded confidence indicators */
        .confidence-high {
            color: #22c55e;
            font-weight: 600;
        }

        .confidence-medium {
            color: #f59e0b;
            font-weight: 600;
        }

        .confidence-low {
            color: #ef4444;
            font-weight: 600;
        }

        .confidence-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .confidence-badge.high {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .confidence-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .confidence-badge.low {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: #1a2744;
            border: 2px solid;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastSlideIn 0.3s ease-out;
            min-width: 300px;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.toast-success {
            border-color: #22c55e;
        }

        .toast.toast-error {
            border-color: #ef4444;
        }

        .toast.toast-warning {
            border-color: #f59e0b;
        }

        .toast.toast-info {
            border-color: #4fb28e;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            opacity: 0.9;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Confirmation Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal {
            background: #1a2744;
            border-radius: 12px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(79, 178, 142, 0.3);
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .confirm-modal h3 {
            font-size: 20px;
            margin-bottom: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .confirm-modal p {
            font-size: 15px;
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 24px;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn-cancel {
            background: rgba(51, 65, 85, 0.8);
            color: #f1f5f9;
        }

        .confirm-btn-cancel:hover {
            background: rgba(71, 85, 105, 0.9);
        }

        .confirm-btn-confirm {
            background: #4fb28e;
            color: #f1f5f9;
        }

        .confirm-btn-confirm:hover {
            background: #818cf8;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(79, 178, 142, 0.3);
        }

        .confirm-btn-danger {
            background: #ef4444;
        }

        .confirm-btn-danger:hover {
            background: #f87171;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Inline Validation */
        .form-field {
            margin-bottom: 16px;
        }

        .form-field.error input,
        .form-field.error select,
        .form-field.error textarea {
            border-color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.05);
        }

        .form-field.success input,
        .form-field.success select {
            border-color: #22c55e !important;
            background: rgba(34, 197, 94, 0.05);
        }

        .field-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .field-error:before {
            content: "‚ö†";
        }

        .field-success {
            color: #22c55e;
            font-size: 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .field-success:before {
            content: "‚úì";
        }

        /* Responsive Design - Mobile Friendly */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 24px;
            }

            .time-display {
                font-size: 36px;
            }

            .nav-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .nav-tab {
                width: 100%;
                text-align: center;
            }

            .card {
                padding: 16px;
            }

            .toast-container {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .toast {
                min-width: auto;
            }

            .confirm-modal {
                padding: 20px;
                width: 95%;
            }

            .mode-toggle-container {
                flex-direction: row;
                gap: 8px;
            }
        }

        /* 8px Grid System */
        * {
            /* Base spacing units: 8px, 16px, 24px, 32px */
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --spacing-xl: 40px;
        }

        /* Enhanced Card Shadows */
        .card {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3),
                        0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35),
                        0 4px 16px rgba(0, 0, 0, 0.2);
        }

        /* Accessibility Improvements - WCAG AAA */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 3px solid #4fb28e;
            outline-offset: 2px;
        }

        a:focus {
            outline: 3px solid #4fb28e;
            outline-offset: 2px;
        }

        .btn:focus-visible {
            outline: 3px solid #4fb28e;
            outline-offset: 3px;
        }

        /* Skip to content link for screen readers */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: #4fb28e;
            color: #f1f5f9;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-to-content:focus {
            top: 0;
        }

        /* High contrast text for accessibility */
        p, span, div {
            color: #cbd5e1;
        }

        label {
            color: #cbd5e1;
            font-weight: 500;
        }

        h1, h2, h3, h4, h5, h6 {
            color: #f1f5f9;
        }

        /* Smooth animations with 200ms timing */
        button, .card, .nav-tab, .toast {
            transition: all 200ms ease-out;
        }

        input, select, textarea {
            transition: border-color 200ms ease-out,
                        background 200ms ease-out,
                        transform 200ms ease-out;
        }

        /* Architecture visualization styles */
        .arch-viz-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .arch-viz-container {
                grid-template-columns: 1fr;
            }
        }

        .arch-viz-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .arch-viz-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 1rem;
        }

        .arch-viz-card svg,
        .arch-viz-card img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            background: #ffffff;
            padding: 1rem;
        }

        /* Global Navigation */
        .global-nav {
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10001;
            backdrop-filter: blur(10px);
        }
        
        .global-nav .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: #f1f5f9;
            text-decoration: none;
        }
        
        .global-nav .nav-brand span:first-child { font-size: 24px; }
        
        .global-nav .nav-links-global {
            display: flex;
            gap: 8px;
        }
        
        .global-nav .nav-link-global {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .global-nav .nav-link-global:hover {
            background: rgba(30, 41, 59, 0.8);
            color: #f1f5f9;
            border-color: #4fb28e;
        }
        
        .global-nav .nav-link-global.active {
            background: #4fb28e;
            color: white;
            border-color: #4fb28e;
        }
        
        body { padding-top: 56px; }
        
        @media (max-width: 600px) {
            .global-nav .nav-links-global { display: none; }
        }
    </style>
</head>
<body>
    <!-- Global Navigation -->
    <nav class="global-nav">
        <a href="/" class="nav-brand">
            <img src="/assets/brand/cc-logo-128.png" alt="CC" style="height: 56px; width: auto; margin-right: 10px;">
            <span>Commute Compute</span>
        </a>
        <div class="nav-links-global">
            <a href="/" class="nav-link-global">Dashboard</a>
            <a href="/admin.html" class="nav-link-global active">Settings</a>
            <a href="/simulator.html" class="nav-link-global">Simulator</a>
        </div>
    </nav>

    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Onboarding Overlay (shown on first visit) -->
    <div id="onboarding-overlay" class="onboarding-overlay" style="display: none;">
        <div class="onboarding-modal">
            <div class="onboarding-step-content" id="onboarding-content">
                <!-- Content will be dynamically inserted -->
            </div>
            <div class="onboarding-progress" id="onboarding-progress">
                <div class="onboarding-progress-dot active"></div>
                <div class="onboarding-progress-dot"></div>
                <div class="onboarding-progress-dot"></div>
                <div class="onboarding-progress-dot"></div>
            </div>
            <div class="onboarding-buttons">
                <button class="btn-onboarding btn-onboarding-skip" id="onboarding-skip" onclick="skipOnboarding()">
                    Skip Tutorial
                </button>
                <div style="display: flex; gap: 12px; flex: 1;">
                    <button class="btn-onboarding btn-onboarding-secondary" id="onboarding-prev" onclick="prevOnboardingStep()" style="display: none;">
                        ‚Üê Previous
                    </button>
                    <button class="btn-onboarding btn-onboarding-primary" id="onboarding-next" onclick="nextOnboardingStep()">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Show Tutorial Again Button (hidden by default) -->
    <button id="show-tutorial-btn" class="show-tutorial-btn" onclick="restartTutorial()" style="display: none;">
        ? Show Tutorial
    </button>

    <div class="container" id="main-content">
        <!-- Header -->
        <div class="header">
            <h1>Commute Compute Admin</h1>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span id="data-mode">Loading...</span>
            </div>
            <div class="time-display" id="current-time">--:--:--</div>
            <div class="date-display" id="current-date">Loading...</div>

        </div>


        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab" onclick="showTab('setup', this)">Setup & Journey</button>
            <button class="nav-tab" onclick="showTab('api', this)">API Settings</button>
            <button class="nav-tab active" onclick="showTab('live', this)">Live Data</button>
            <button class="nav-tab" onclick="showTab('config', this)">Configuration</button>
            <button class="nav-tab" onclick="showTab('architecture', this)">Architecture</button>
            <button class="nav-tab" onclick="showTab('system', this)">System & Support</button>
        </div>

        <!-- Setup & Journey Tab - Rebuilt for localStorage config -->
        <div id="tab-setup" class="tab-content">
            <!-- Not Configured State -->
            <div id="setup-not-configured" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 80px; margin-bottom: 20px;">üöÄ</div>
                <h2 style="margin-bottom: 15px; font-size: 24px;">Welcome to Commute Compute</h2>
                <p style="opacity: 0.8; margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.7; font-size: 15px;">
                    Set up your commute in just a few steps. We'll find the best route and keep your e-ink display updated with live transit data.
                </p>
                <a href="/setup-wizard.html" class="btn btn-primary" style="padding: 15px 40px; font-size: 18px; text-decoration: none; display: inline-block;">
                    ‚ú® Start Setup Wizard
                </a>
            </div>

            <!-- Configured State - Summary View -->
            <div id="setup-configured" style="display: none;">
                <!-- Journey Configuration Card -->
                <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(79, 178, 142, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%); border-left: 4px solid #4fb28e;">
                    <div class="card-header" style="margin-bottom: 20px;">
                        <span class="card-icon">üó∫Ô∏è</span>
                        <h2>Your Commute</h2>
                        <a href="/setup-wizard.html" class="btn btn-secondary" style="margin-left: auto; padding: 8px 16px; font-size: 13px;">
                            ‚úèÔ∏è Edit
                        </a>
                    </div>

                    <div style="display: grid; gap: 15px;">
                        <!-- Route Summary -->
                        <div id="journey-route-summary" style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; align-items: flex-start; gap: 12px;">
                                    <span style="font-size: 20px; width: 28px; text-align: center;">üè†</span>
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; opacity: 0.6; margin-bottom: 2px;">HOME</div>
                                        <div id="summary-home" style="font-size: 14px; font-weight: 500;">Not configured</div>
                                    </div>
                                </div>
                                
                                <div style="border-left: 2px dashed rgba(255,255,255,0.2); margin-left: 13px; height: 8px;"></div>
                                
                                <div id="summary-cafe-row" style="display: none;">
                                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                                        <span style="font-size: 20px; width: 28px; text-align: center;">‚òï</span>
                                        <div style="flex: 1;">
                                            <div style="font-size: 11px; opacity: 0.6; margin-bottom: 2px;">COFFEE STOP</div>
                                            <div id="summary-cafe" style="font-size: 14px; font-weight: 500;">Not configured</div>
                                        </div>
                                    </div>
                                    <div style="border-left: 2px dashed rgba(255,255,255,0.2); margin-left: 13px; height: 8px;"></div>
                                </div>
                                
                                <div style="display: flex; align-items: flex-start; gap: 12px;">
                                    <span style="font-size: 20px; width: 28px; text-align: center;">üíº</span>
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; opacity: 0.6; margin-bottom: 2px;">WORK</div>
                                        <div id="summary-work" style="font-size: 14px; font-weight: 500;">Not configured</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                            <div style="padding: 15px; background: rgba(79, 178, 142, 0.15); border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">‚è∞</div>
                                <div style="font-size: 11px; opacity: 0.6; margin-bottom: 3px;">ARRIVE BY</div>
                                <div id="summary-arrival" style="font-size: 18px; font-weight: 700;">9:00am</div>
                            </div>
                            <div style="padding: 15px; background: rgba(102, 126, 234, 0.15); border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">üìç</div>
                                <div style="font-size: 11px; opacity: 0.6; margin-bottom: 3px;">STATE</div>
                                <div id="summary-state" style="font-size: 18px; font-weight: 700;">VIC</div>
                            </div>
                            <div style="padding: 15px; background: rgba(251, 191, 36, 0.15); border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 5px;">‚òÅÔ∏è</div>
                                <div style="font-size: 11px; opacity: 0.6; margin-bottom: 3px;">MODE</div>
                                <div id="summary-mode" style="font-size: 14px; font-weight: 700;">Free</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Configuration Card -->
                <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #818cf8;">
                    <div class="card-header" style="margin-bottom: 20px;">
                        <span class="card-icon">üì∫</span>
                        <h2>Display Device</h2>
                    </div>

                    <div id="device-status-content">
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 15px;">
                            <div style="font-size: 40px;">üìü</div>
                            <div style="flex: 1;">
                                <div id="device-name" style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">TRMNL Display (OG)</div>
                                <div id="device-specs" style="font-size: 12px; opacity: 0.7;">800√ó480 ‚Ä¢ Landscape ‚Ä¢ ESP32</div>
                            </div>
                            <span id="device-status-badge" style="background: rgba(34, 197, 94, 0.9); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                ‚úì Ready
                            </span>
                        </div>

                        <!-- Firmware Disclaimer -->
                        <div id="firmware-disclaimer" style="padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 3px solid #fbbf24; margin-bottom: 15px;">
                            <div style="font-size: 12px; line-height: 1.5; color: rgba(255,255,255,0.85);">
                                <strong>‚ö†Ô∏è Custom Firmware Required:</strong> Your device must be flashed with 
                                <a href="/flasher/" target="_blank" style="color: #fbbf24;">Commute Compute firmware</a> 
                                to connect to this dashboard. Stock firmware will not work.
                            </div>
                        </div>

                        <!-- Webhook URL -->
                        <div id="webhook-section" style="display: none; padding: 15px; background: rgba(79, 178, 142, 0.1); border-radius: 10px; border: 1px solid rgba(79, 178, 142, 0.3);">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 10px;">üîó Device Webhook URL</div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="webhook-url-display" readonly 
                                    style="flex: 1; padding: 10px 12px; font-family: monospace; font-size: 11px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #f1f5f9;">
                                <button onclick="copyWebhookUrl()" class="btn btn-secondary" style="padding: 10px 15px; font-size: 12px;">
                                    üìã Copy
                                </button>
                            </div>
                            <div style="font-size: 11px; opacity: 0.6; margin-top: 8px;">
                                Configure your device to fetch from this URL for live dashboard updates
                            </div>
                        </div>

                        <!-- No Device Selected -->
                        <div id="no-device-section" style="display: none; padding: 20px; background: rgba(251, 191, 36, 0.1); border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 12px;">
                                No e-ink device configured yet
                            </div>
                            <a href="/setup-wizard.html" class="btn btn-secondary" style="padding: 10px 20px; font-size: 13px; text-decoration: none;">
                                üì± Add Device
                            </a>
                        </div>
                    </div>
                </div>

                <!-- SmartCommute Settings Card -->
                <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(79, 178, 142, 0.08) 0%, rgba(102, 126, 234, 0.08) 100%); border-radius: 12px; border: 1px solid rgba(79, 178, 142, 0.2);">
                    <div class="card-header" style="margin-bottom: 20px;">
                        <span class="card-icon">
                            <svg width="20" height="20" style="color: #4fb28e;"><use href="#icon-cpu"/></svg>
                        </span>
                        <h2>SmartCommute Settings</h2>
                    </div>
                    <p style="margin-bottom: 20px; font-size: 13px; opacity: 0.8; line-height: 1.6;">
                        Fine-tune how the SmartCommute engine calculates your optimal journey. These settings affect departure time recommendations and coffee feasibility.
                    </p>

                    <!-- Walking Times Section -->
                    <div style="padding: 16px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px; display: flex; align-items: center; gap: 8px; color: #f1f5f9;">
                            <svg width="16" height="16" style="color: #4fb28e;"><use href="#icon-route"/></svg>
                            Walking Times
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 12px;">Home to Transit Stop</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="sc-home-to-stop" class="form-input" min="1" max="30" value="5" style="flex: 1;">
                                    <span style="font-size: 12px; opacity: 0.7;">min</span>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 12px;">Home to Coffee Shop</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="sc-home-to-cafe" class="form-input" min="1" max="30" value="5" style="flex: 1;">
                                    <span style="font-size: 12px; opacity: 0.7;">min</span>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 12px;">Coffee Shop to Transit</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="sc-cafe-to-stop" class="form-input" min="1" max="30" value="2" style="flex: 1;">
                                    <span style="font-size: 12px; opacity: 0.7;">min</span>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 12px;">Final Stop to Work</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="sc-stop-to-work" class="form-input" min="1" max="30" value="5" style="flex: 1;">
                                    <span style="font-size: 12px; opacity: 0.7;">min</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coffee Settings Section -->
                    <div style="padding: 16px; background: rgba(167, 139, 250, 0.1); border-radius: 10px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px; display: flex; align-items: center; gap: 8px; color: #f1f5f9;">
                            <svg width="16" height="16" style="color: #a78bfa;"><use href="#icon-coffee"/></svg>
                            Coffee Settings
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 12px;">Coffee Duration (ordering + making)</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="sc-coffee-duration" class="form-input" min="3" max="20" value="5" style="flex: 1;">
                                    <span style="font-size: 12px; opacity: 0.7;">min</span>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 12px;">Minimum Buffer Time</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="sc-buffer-time" class="form-input" min="1" max="15" value="3" style="flex: 1;">
                                    <span style="font-size: 12px; opacity: 0.7;">min</span>
                                </div>
                                <small style="font-size: 10px; opacity: 0.6; display: block; margin-top: 4px;">Safety margin before departure</small>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 12px;">Coffee Position in Route</label>
                                <select id="sc-coffee-position" class="form-input">
                                    <option value="auto">Auto (SmartCommute decides)</option>
                                    <option value="before">Before transit (on way to station)</option>
                                    <option value="after">After transit (near work)</option>
                                    <option value="never">Never include coffee</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Transit Mode Preferences -->
                    <div style="padding: 16px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px; display: flex; align-items: center; gap: 8px; color: #f1f5f9;">
                            <svg width="16" height="16" style="color: #667eea;"><use href="#icon-train"/></svg>
                            Transit Mode Preferences
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="sc-prefer-train" checked style="width: 18px; height: 18px; accent-color: #4fb28e;">
                                <span style="font-size: 13px;">üöÉ Train</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="sc-prefer-tram" checked style="width: 18px; height: 18px; accent-color: #4fb28e;">
                                <span style="font-size: 13px;">üöä Tram</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="sc-prefer-bus" style="width: 18px; height: 18px; accent-color: #4fb28e;">
                                <span style="font-size: 13px;">üöå Bus</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="sc-minimize-walking" checked style="width: 18px; height: 18px; accent-color: #4fb28e;">
                                <span style="font-size: 13px;">üö∂ Min Walking</span>
                            </label>
                        </div>
                    </div>

                    <!-- Advanced Options (collapsed) -->
                    <details style="margin-bottom: 16px;">
                        <summary style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 13px; font-weight: 500; color: #94a3b8;">
                            <svg width="14" height="14" style="vertical-align: middle; margin-right: 6px;"><use href="#icon-sliders"/></svg>
                            Advanced Options
                        </summary>
                        <div style="padding: 16px; margin-top: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 12px;">Walking Speed</label>
                                    <select id="sc-walking-speed" class="form-input">
                                        <option value="60">Slow (60m/min)</option>
                                        <option value="80" selected>Normal (80m/min)</option>
                                        <option value="100">Fast (100m/min)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 12px;">Max Walking Distance</label>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="number" id="sc-max-walk" class="form-input" min="100" max="2000" value="600" step="100" style="flex: 1;">
                                        <span style="font-size: 12px; opacity: 0.7;">m</span>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 12px;">Multi-Modal Journeys</label>
                                    <select id="sc-multi-modal" class="form-input">
                                        <option value="allow">Allow (tram + train)</option>
                                        <option value="prefer">Prefer single mode</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- Save Button -->
                    <button onclick="saveSmartCommuteSettings()" class="btn btn-primary btn-block" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="16" height="16"><use href="#icon-save"/></svg>
                        Save SmartCommute Settings
                    </button>
                    <div id="sc-settings-message" style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 13px;"></div>
                </div>

                <!-- Quick Actions Card -->
                <div class="card" style="background: rgba(255,255,255,0.03);">
                    <div class="card-header" style="margin-bottom: 15px;">
                        <span class="card-icon">‚ö°</span>
                        <h2>Quick Actions</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <button onclick="forceRecalculation()" class="btn btn-secondary" style="padding: 15px; font-size: 14px;">
                            üîÑ Recalculate Journey
                        </button>
                        <button onclick="showTab('live', this)" class="btn btn-secondary" style="padding: 15px; font-size: 14px;">
                            üìä View Live Data
                        </button>
                        <a href="/preview.html" target="_blank" class="btn btn-secondary" style="padding: 15px; font-size: 14px; text-decoration: none; text-align: center;">
                            üñºÔ∏è E-Ink Preview
                        </a>
                        <button onclick="clearConfig()" class="btn btn-secondary" style="padding: 15px; font-size: 14px; opacity: 0.7;">
                            üóëÔ∏è Reset Config
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Live Data Tab - Rebuilt per Section 22 Branding Rules -->
        <div id="tab-live" class="tab-content active">
            <!-- SVG Icon Definitions -->
            <svg style="display: none;">
                <defs>
                    <symbol id="icon-train" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 11V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4M4 11v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4M4 11h16M8 19v2M16 19v2M9 7h6M9 11h.01M15 11h.01"/>
                    </symbol>
                    <symbol id="icon-tram" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 9V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v4M5 9v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9M5 9h14M8 17v2M16 17v2M12 3v2M8 13h.01M16 13h.01"/>
                    </symbol>
                    <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
                    </symbol>
                    <symbol id="icon-coffee" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 8h1a4 4 0 1 1 0 8h-1M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8zM6 2v2M10 2v2M14 2v2"/>
                    </symbol>
                    <symbol id="icon-route" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="6" cy="19" r="3"/><path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15"/><circle cx="18" cy="5" r="3"/>
                    </symbol>
                    <symbol id="icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                    </symbol>
                    <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 6L9 17l-5-5"/>
                    </symbol>
                    <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01"/>
                    </symbol>
                    <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </symbol>
                    <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </symbol>
                    <!-- Additional icons for Configuration tab -->
                    <symbol id="icon-list" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
                    </symbol>
                    <symbol id="icon-globe" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </symbol>
                    <symbol id="icon-user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                    </symbol>
                    <symbol id="icon-key" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                    </symbol>
                    <symbol id="icon-timer" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M5 3L2 6"/><path d="M22 6l-3-3"/><path d="M6 19l-2 2"/><path d="M18 19l2 2"/><path d="M12 3V1"/>
                    </symbol>
                    <symbol id="icon-smartphone" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>
                    </symbol>
                    <symbol id="icon-radio" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/>
                    </symbol>
                    <symbol id="icon-save" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                    </symbol>
                    <symbol id="icon-lightbulb" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/>
                    </symbol>
                    <symbol id="icon-wrench" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                    </symbol>
                    <symbol id="icon-database" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </symbol>
                    <symbol id="icon-sliders" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/>
                    </symbol>
                    <symbol id="icon-zap" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                    </symbol>
                    <symbol id="icon-layers" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>
                    </symbol>
                    <symbol id="icon-cpu" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/>
                    </symbol>
                    <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </symbol>
                    <symbol id="icon-book" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </symbol>
                    <symbol id="icon-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </symbol>
                    <symbol id="icon-mail" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                    </symbol>
                    <symbol id="icon-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </symbol>
                    <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                    </symbol>
                    <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </symbol>
                    <symbol id="icon-target" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
                    </symbol>
                    <symbol id="icon-map-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                    </symbol>
                    <symbol id="icon-git-branch" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/>
                    </symbol>
                    <symbol id="icon-external-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                    </symbol>
                </defs>
            </svg>

            <!-- Unconfigured State -->
            <div id="live-data-unconfigured" style="display: none; text-align: center; padding: 60px 20px;">
                <svg width="80" height="80" style="opacity: 0.3; margin-bottom: 20px; color: #4fb28e;"><use href="#icon-route"/></svg>
                <h2 style="margin-bottom: 15px; font-size: 24px; font-weight: 600; color: #f1f5f9;">Journey Not Configured</h2>
                <p style="opacity: 0.7; margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.6; font-size: 15px; color: #94a3b8;">
                    Complete the setup wizard to configure your commute. The SmartCommute engine will calculate optimal routes and departure times.
                </p>
                <button class="btn btn-primary" onclick="showTab('setup', this)" style="padding: 12px 30px; font-size: 16px;">
                    Configure Journey
                </button>
            </div>

            <!-- Configured State -->
            <div id="live-data-configured">
                <!-- SmartCommute Status Banner -->
                <div id="smartcommute-status-banner" style="margin-bottom: 20px; padding: 18px 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px; background: linear-gradient(135deg, rgba(79, 178, 142, 0.15) 0%, rgba(34, 197, 94, 0.15) 100%); border-left: 4px solid #4fb28e;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="smartcommute-status-icon" style="width: 32px; height: 32px; border-radius: 50%; background: #22c55e; display: flex; align-items: center; justify-content: center;">
                            <svg width="18" height="18" style="color: white;"><use href="#icon-check"/></svg>
                        </div>
                        <div>
                            <div id="smartcommute-status-title" style="font-weight: 700; font-size: 16px; margin-bottom: 4px; color: #f1f5f9;">SmartCommute Active</div>
                            <div id="smartcommute-status-subtitle" style="font-size: 13px; color: #94a3b8;">Real-time journey calculation enabled</div>
                        </div>
                    </div>
                    <button id="refresh-data-btn" class="btn btn-secondary" onclick="refreshLiveData()" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16"><use href="#icon-refresh"/></svg>
                        Refresh
                    </button>
                </div>

                <!-- Journey Configuration Summary -->
                <div id="journey-config-banner" style="margin-bottom: 20px; padding: 16px 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #667eea;">
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" style="color: #667eea;"><use href="#icon-route"/></svg>
                            Journey Configuration
                        </div>
                        <button onclick="showTab('setup', this)" class="btn btn-secondary" style="padding: 6px 14px; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14"><use href="#icon-settings"/></svg>
                            Edit Preferences
                        </button>
                    </div>
                    <div id="journey-config-summary" style="font-size: 13px; color: #94a3b8; line-height: 1.6;">Loading configuration...</div>
                </div>

                <!-- E-Ink Display Preview - Actual CCDash Rendered Output -->
                <div id="eink-preview-panel" class="card" style="margin-bottom: 20px; background: #2a3d5f; border-radius: 12px; padding: 20px; border: 1px solid #3d5278;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: #1a1a1a; display: flex; align-items: center; justify-content: center;">
                                <svg width="22" height="22" style="color: white;"><use href="#icon-smartphone"/></svg>
                            </div>
                            <div>
                                <h3 style="font-size: 16px; font-weight: 600; color: #f1f5f9; margin: 0;">E-Ink Display Preview</h3>
                                <span style="font-size: 12px; color: #94a3b8;">
                                    <span id="eink-device-name">TRMNL OG</span> ‚Ä¢ 
                                    <span id="eink-dimensions">800√ó480</span> ‚Ä¢ 
                                    <span id="eink-last-update">--</span>
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div id="eink-live-indicator" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(34, 197, 94, 0.15); border-radius: 20px; font-size: 11px; color: #22c55e;">
                                <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                                Live
                            </div>
                            <button onclick="refreshEinkPreview()" class="btn btn-secondary" style="padding: 8px 14px; font-size: 12px;">
                                <svg width="14" height="14"><use href="#icon-refresh"/></svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Actual E-Ink Display Image from CCDash Renderer -->
                    <div id="eink-display-container" style="background: #1a1a1a; border-radius: 8px; padding: 16px; display: flex; justify-content: center; align-items: center; min-height: 300px;">
                        <div id="eink-image-wrapper" style="position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden;">
                            <img id="eink-preview-image" 
                                 src="" 
                                 alt="E-Ink Display Preview" 
                                 style="display: block; max-width: 100%; height: auto; background: #f5f5f0;">
                            <div id="eink-loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26,26,26,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8;">
                                <div class="spinner" style="margin-bottom: 12px;"></div>
                                <span style="font-size: 13px;">Loading display...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Device & Firmware Info -->
                    <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 4px;">Device</div>
                            <div id="eink-device-info" style="font-size: 14px; font-weight: 600; color: #f1f5f9;">TRMNL Display (OG)</div>
                        </div>
                        <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 4px;">Resolution</div>
                            <div id="eink-resolution-info" style="font-size: 14px; font-weight: 600; color: #f1f5f9;">800 √ó 480 px</div>
                        </div>
                        <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 4px;">Color Depth</div>
                            <div style="font-size: 14px; font-weight: 600; color: #f1f5f9;">1-bit (B&W)</div>
                        </div>
                        <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.6; margin-bottom: 4px;">Firmware</div>
                            <div style="font-size: 14px; font-weight: 600; color: #f1f5f9;">CC-FW-6.1-60s</div>
                        </div>
                    </div>

                    <!-- API Endpoint Info -->
                    <details style="margin-top: 16px;">
                        <summary style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 13px; font-weight: 500; color: #94a3b8;">
                            <svg width="14" height="14" style="vertical-align: middle; margin-right: 6px;"><use href="#icon-database"/></svg>
                            API Endpoint & Raw Data
                        </summary>
                        <div style="margin-top: 12px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 11px; opacity: 0.6; margin-bottom: 4px;">Image Source (what firmware fetches)</div>
                                <code id="eink-api-url" style="font-size: 12px; color: #4fb28e; word-break: break-all;"></code>
                            </div>
                            <div style="font-family: 'Courier New', monospace; font-size: 11px; overflow-x: auto; max-height: 300px; overflow-y: auto;">
                                <pre id="sc-raw-output" style="margin: 0; color: #94a3b8; white-space: pre-wrap; word-break: break-word;">Loading...</pre>
                            </div>
                        </div>
                    </details>

                    <!-- Edit Settings Link -->
                    <div style="margin-top: 16px; padding: 12px 16px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; border: 1px dashed rgba(102, 126, 234, 0.3);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <svg width="18" height="18" style="color: #667eea;"><use href="#icon-sliders"/></svg>
                            <span style="font-size: 13px; color: #94a3b8;">Adjust journey settings to see changes on display</span>
                        </div>
                        <button onclick="showTab('setup', this)" class="btn" style="padding: 8px 16px; font-size: 13px; background: #667eea;">
                            Edit SmartCommute Settings
                        </button>
                    </div>
                </div>

                <!-- Main Data Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    
                    <!-- Train Departures Card -->
                    <div class="card" style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 20px; border-left: 4px solid #4fb28e;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(79, 178, 142, 0.2); display: flex; align-items: center; justify-content: center;">
                                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-train"/></svg>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; color: #f1f5f9; margin: 0;" id="train-station-name">Train Departures</h3>
                                    <span style="font-size: 12px; color: #94a3b8;" id="train-station-subtitle">Loading...</span>
                                </div>
                            </div>
                            <span id="train-status-badge" style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(79, 178, 142, 0.2); color: #4fb28e;">Live</span>
                        </div>
                        <div id="train-departures" style="min-height: 100px;">
                            <div class="loading" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 30px; color: #94a3b8;">
                                <div class="spinner"></div>
                                <span>Loading departures...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tram Departures Card -->
                    <div class="card" style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 20px; border-left: 4px solid #667eea;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(102, 126, 234, 0.2); display: flex; align-items: center; justify-content: center;">
                                    <svg width="22" height="22" style="color: #667eea;"><use href="#icon-tram"/></svg>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; color: #f1f5f9; margin: 0;" id="tram-station-name">Tram Departures</h3>
                                    <span style="font-size: 12px; color: #94a3b8;" id="tram-station-subtitle">Loading...</span>
                                </div>
                            </div>
                            <span id="tram-status-badge" style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(102, 126, 234, 0.2); color: #667eea;">Live</span>
                        </div>
                        <div id="tram-departures" style="min-height: 100px;">
                            <div class="loading" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 30px; color: #94a3b8;">
                                <div class="spinner"></div>
                                <span>Loading departures...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Weather Card -->
                    <div class="card" style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 20px; border-left: 4px solid #fbbf24;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(251, 191, 36, 0.2); display: flex; align-items: center; justify-content: center;">
                                    <svg width="22" height="22" style="color: #fbbf24;"><use href="#icon-sun"/></svg>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; color: #f1f5f9; margin: 0;" id="weather-location-name">Weather</h3>
                                    <span style="font-size: 12px; color: #94a3b8;" id="weather-source">Bureau of Meteorology</span>
                                </div>
                            </div>
                            <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(251, 191, 36, 0.2); color: #fbbf24;">BOM</span>
                        </div>
                        <div id="weather-display" style="min-height: 80px;">
                            <div class="loading" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 30px; color: #94a3b8;">
                                <div class="spinner"></div>
                                <span>Loading weather...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Coffee Decision Card -->
                    <div class="card" style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 20px; border-left: 4px solid #a78bfa;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(167, 139, 250, 0.2); display: flex; align-items: center; justify-content: center;">
                                    <svg width="22" height="22" style="color: #a78bfa;"><use href="#icon-coffee"/></svg>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; color: #f1f5f9; margin: 0;">Coffee Decision</h3>
                                    <span style="font-size: 12px; color: #94a3b8;">SmartCommute recommendation</span>
                                </div>
                            </div>
                            <span id="coffee-status-badge" style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(167, 139, 250, 0.2); color: #a78bfa;">Auto</span>
                        </div>
                        <div id="coffee-decision" style="min-height: 80px;">
                            <div class="loading" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 30px; color: #94a3b8;">
                                <div class="spinner"></div>
                                <span>Calculating...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SmartCommute Journey Summary -->
                <div class="card" style="margin-top: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 20px; border-left: 4px solid #4fb28e;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(79, 178, 142, 0.2); display: flex; align-items: center; justify-content: center;">
                                <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-clock"/></svg>
                            </div>
                            <div>
                                <h3 style="font-size: 16px; font-weight: 600; color: #f1f5f9; margin: 0;">Today's Journey</h3>
                                <span style="font-size: 12px; color: #94a3b8;">SmartCommute calculated route</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="recalculateJourney()" style="padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14"><use href="#icon-refresh"/></svg>
                            Recalculate
                        </button>
                    </div>
                    <div id="journey-summary" style="min-height: 60px;">
                        <div style="padding: 20px; text-align: center; color: #94a3b8; font-size: 14px;">
                            Journey summary will appear here after calculation
                        </div>
                    </div>
                </div>

                <!-- Data Sources Footer -->
                <div style="margin-top: 20px; padding: 16px 20px; background: rgba(15, 23, 42, 0.5); border-radius: 12px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #94a3b8;">
                            <svg width="14" height="14" style="color: #4fb28e;"><use href="#icon-check"/></svg>
                            <span>SmartCommute Engine v3.0</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #94a3b8;">
                            <svg width="14" height="14" style="color: #4fb28e;"><use href="#icon-check"/></svg>
                            <span>CCDash Renderer v13</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #94a3b8;">
                            <svg width="14" height="14" style="color: #667eea;"><use href="#icon-settings"/></svg>
                            <span id="data-last-updated">Last updated: --</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="showTab('api', this)" style="padding: 8px 16px; font-size: 12px;">
                        API Settings
                    </button>
                </div>
            </div>
        </div>


                <!-- API Settings Tab - Rebuilt to use Setup Wizard data -->
        <div id="tab-api" class="tab-content">
            <!-- Not Configured State -->
            <div id="api-not-configured" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 80px; margin-bottom: 20px;">üîë</div>
                <h2 style="margin-bottom: 15px; font-size: 24px;">API Keys Not Configured</h2>
                <p style="opacity: 0.8; margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.7; font-size: 15px;">
                    Complete the setup wizard to configure your API keys. The wizard will guide you through obtaining and validating your credentials.
                </p>
                <a href="/setup-wizard.html" class="btn btn-primary" style="padding: 15px 40px; font-size: 18px; text-decoration: none; display: inline-block;">
                    ‚ú® Go to Setup Wizard
                </a>
            </div>

            <!-- Configured State -->
            <div id="api-configured" style="display: none;">
                <!-- Data Mode Banner -->
                <div id="api-data-mode-banner" style="margin-bottom: 25px; padding: 18px 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="api-mode-icon" style="font-size: 32px;">üü¢</span>
                        <div>
                            <div id="api-mode-title" style="font-weight: 700; font-size: 17px; margin-bottom: 4px;">Real-Time Data Enabled</div>
                            <div id="api-mode-subtitle" style="font-size: 13px; opacity: 0.85;">Transit API validated and active</div>
                        </div>
                    </div>
                </div>

                <!-- Transit API Card -->
                <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(79, 178, 142, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); border-left: 4px solid #4fb28e;">
                    <div class="card-header" style="margin-bottom: 15px;">
                        <span class="card-icon">üöÜ</span>
                        <h2>Transport Victoria OpenData API</h2>
                    </div>

                    <div id="transit-api-status-card" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span id="transit-status-icon" style="font-size: 24px;">‚úÖ</span>
                                <div>
                                    <div id="transit-status-text" style="font-weight: 600; font-size: 14px;">Configured & Validated</div>
                                    <div id="transit-key-preview" style="font-size: 12px; opacity: 0.7; font-family: monospace; margin-top: 4px;">ce606b90-****-****-****-************</div>
                                </div>
                            </div>
                            <span id="transit-status-badge" style="background: rgba(34, 197, 94, 0.9); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                ‚úì Active
                            </span>
                        </div>
                    </div>

                    <!-- Edit Transit API (collapsed by default) -->
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 14px; font-weight: 500;">
                            ‚úèÔ∏è Edit Transit API Key
                        </summary>
                        <div style="padding: 15px; margin-top: 10px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label class="form-label">Transport Victoria API Key</label>
                                <input type="password" id="edit-transit-key" class="form-input" placeholder="Enter new API key">
                                <small style="color: rgba(255,255,255,0.6); font-size: 11px; display: block; margin-top: 5px;">
                                    Get your free key at <a href="https://opendata.transport.vic.gov.au/" target="_blank" style="color: #4fb28e;">opendata.transport.vic.gov.au</a>
                                </small>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="updateTransitKey()">üíæ Save & Validate</button>
                                <button class="btn btn-secondary" onclick="testTransitKey()">üîÑ Test Current</button>
                            </div>
                            <div id="transit-edit-message" style="display: none; margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 13px;"></div>
                        </div>
                    </details>
                </div>

                <!-- Google Places API Card -->
                <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #818cf8;">
                    <div class="card-header" style="margin-bottom: 15px;">
                        <span class="card-icon">üìç</span>
                        <h2>Google Places API</h2>
                    </div>

                    <div id="google-api-status-card" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span id="google-status-icon" style="font-size: 24px;">‚úÖ</span>
                                <div>
                                    <div id="google-status-text" style="font-weight: 600; font-size: 14px;">Configured & Validated</div>
                                    <div id="google-key-preview" style="font-size: 12px; opacity: 0.7; font-family: monospace; margin-top: 4px;">AIza****************************</div>
                                </div>
                            </div>
                            <span id="google-status-badge" style="background: rgba(34, 197, 94, 0.9); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                ‚úì Active
                            </span>
                        </div>
                    </div>

                    <div style="padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; font-size: 13px; line-height: 1.5;">
                        <strong>üí° Usage:</strong> Google Places enhances address search accuracy and enables real-time cafe busy-ness detection in Live Mode.
                    </div>

                    <!-- Edit Google API (collapsed by default) -->
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 14px; font-weight: 500;">
                            ‚úèÔ∏è Edit Google Places API Key
                        </summary>
                        <div style="padding: 15px; margin-top: 10px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label class="form-label">Google Places API Key</label>
                                <input type="password" id="edit-google-key" class="form-input" placeholder="Enter new API key">
                                <small style="color: rgba(255,255,255,0.6); font-size: 11px; display: block; margin-top: 5px;">
                                    Get from <a href="https://console.cloud.google.com/apis/library/places-backend.googleapis.com" target="_blank" style="color: #4fb28e;">Google Cloud Console - Places API (new)</a>
                                </small>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="updateGoogleKey()">üíæ Save & Validate</button>
                                <button class="btn btn-secondary" onclick="testGoogleKey()">üîÑ Test Current</button>
                            </div>
                            <div id="google-edit-message" style="display: none; margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 13px;"></div>
                        </div>
                    </details>
                </div>

                <!-- API Mode Selection -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="margin-bottom: 15px;">
                        <span class="card-icon">‚òÅÔ∏è</span>
                        <h2>Data Mode</h2>
                    </div>

                    <div style="display: grid; gap: 12px;">
                        <label id="mode-free-option" style="display: flex; align-items: center; padding: 15px; background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 10px; cursor: pointer;">
                            <input type="radio" name="api-mode-select" value="cached" style="margin-right: 12px; width: 18px; height: 18px;" onchange="updateApiMode('cached')">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">üÜì Free Mode</div>
                                <div style="font-size: 12px; opacity: 0.8;">Uses cached timetable data. No runtime API calls. Best for most users.</div>
                            </div>
                        </label>

                        <label id="mode-live-option" style="display: flex; align-items: center; padding: 15px; background: rgba(102, 126, 234, 0.1); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; cursor: pointer;">
                            <input type="radio" name="api-mode-select" value="live" style="margin-right: 12px; width: 18px; height: 18px;" onchange="updateApiMode('live')">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">‚ö° Live Mode</div>
                                <div style="font-size: 12px; opacity: 0.8;">Real-time transit data + cafe busy-ness. Requires valid API keys.</div>
                            </div>
                        </label>
                    </div>

                    <div id="mode-change-message" style="display: none; margin-top: 15px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; font-size: 13px;"></div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header" style="margin-bottom: 15px;">
                        <span class="card-icon">‚ö°</span>
                        <h2>Quick Actions</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <button onclick="testAllApis()" class="btn btn-secondary" style="padding: 15px; font-size: 14px;">
                            üîÑ Test All APIs
                        </button>
                        <button onclick="refreshApiStatus()" class="btn btn-secondary" style="padding: 15px; font-size: 14px;">
                            üìä Refresh Status
                        </button>
                        <a href="/setup-wizard.html" class="btn btn-secondary" style="padding: 15px; font-size: 14px; text-decoration: none; text-align: center;">
                            ‚ú® Re-run Setup Wizard
                        </a>
                    </div>
                </div>
            </div>
        </div>


                <!-- Configuration Tab -->
        <div id="tab-config" class="tab-content">
            <!-- Journey Profiles Management -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-list"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Journey Profiles</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px; line-height: 1.5;">
                    Create multiple journey profiles for different routes, schedules, or scenarios.
                </p>

                <!-- Active Profile Display -->
                <div id="active-profile-display" style="padding: 16px; background: rgba(34, 197, 94, 0.1); border-radius: 12px; border-left: 4px solid #22c55e; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" style="color: #22c55e;"><use href="#icon-check"/></svg>
                        <span>Active: <span id="active-profile-name">Default Journey</span></span>
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        <span id="active-profile-schedule">Active all days</span>
                    </div>
                </div>

                <!-- Profile List -->
                <div id="profiles-list" style="display: grid; gap: 12px; margin-bottom: 20px;">
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        Loading profiles...
                    </div>
                </div>

                <button class="btn btn-primary" onclick="showCreateProfileModal()" style="display: flex; align-items: center; gap: 8px;">
                    <svg width="16" height="16"><use href="#icon-route"/></svg>
                    Create New Profile
                </button>
            </div>

            <!-- Data Sources Overview -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #667eea;"><use href="#icon-globe"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Active Data Sources</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px; line-height: 1.5;">
                    All external APIs and data sources currently used by the system
                </p>
                <div id="data-sources-list" style="display: grid; gap: 12px;">
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        Loading data sources...
                    </div>
                </div>
            </div>

            <!-- User Configuration -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-user"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Your Journey Configuration</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px; line-height: 1.5;">
                    Addresses, stops, and preferences you've entered
                </p>
                <div id="user-config-display" style="display: grid; gap: 15px;">
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        No configuration yet. Complete setup first.
                    </div>
                </div>
            </div>

            <!-- Note: API settings moved to API Settings tab -->
            <div style="margin-bottom: 20px; padding: 16px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; border-left: 4px solid #667eea;">
                <div style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                    <svg width="18" height="18" style="color: #667eea;"><use href="#icon-key"/></svg>
                    <span>Looking for API Settings?</span>
                </div>
                <div style="font-size: 14px; opacity: 0.9; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                    API credentials have been moved to the <strong>API Settings</strong> tab for easier configuration.
                    <button class="btn btn-secondary" onclick="showTab('api', this)" style="padding: 6px 16px; font-size: 13px;">
                        Go to API Settings
                    </button>
                </div>
            </div>

            <!-- Refresh Rate Settings -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%); border-radius: 12px; border-left: 4px solid #fbbf24;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #fbbf24;"><use href="#icon-timer"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Refresh Rate Settings</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px; line-height: 1.5;">
                    Configure how often your device refreshes and the server recalculates your journey. Lower intervals increase accuracy but may reduce e-ink display lifespan.
                </p>

                <div id="refresh-settings-message" style="display: none; margin-bottom: 15px;"></div>

                <div style="display: grid; gap: 20px;">
                    <!-- Display Refresh -->
                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" style="color: #94a3b8;"><use href="#icon-smartphone"/></svg>
                            <span>Display Refresh Interval</span>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <input type="number" id="display-refresh-value" class="form-input" style="flex: 1; max-width: 100px;" min="5" value="15">
                            <select id="display-refresh-unit" class="form-input" style="flex: 1; max-width: 120px;">
                                <option value="minutes">minutes</option>
                            </select>
                        </div>
                        <small style="color: rgba(255,255,255,0.6); font-size: 12px; display: block;">
                            <span id="display-refresh-note">Minimum: 15 minutes for CC E-Ink (e-ink protection)</span>
                        </small>
                        <div id="display-refresh-estimate" style="margin-top: 8px; padding: 8px; background: rgba(251, 191, 36, 0.1); border-radius: 4px; font-size: 11px; display: none;">
                            <svg width="14" height="14" style="color: #fbbf24; vertical-align: middle; margin-right: 4px;"><use href="#icon-zap"/></svg>
                            Estimated e-ink lifespan: <span id="eink-lifespan"></span> years
                        </div>
                    </div>

                    <!-- Journey Recalculation -->
                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" style="color: #94a3b8;"><use href="#icon-refresh"/></svg>
                            <span>Journey Recalculation</span>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <input type="number" id="journey-recalc-value" class="form-input" style="flex: 1; max-width: 100px;" min="1" value="2">
                            <select id="journey-recalc-unit" class="form-input" style="flex: 1; max-width: 120px;">
                                <option value="minutes">minutes</option>
                            </select>
                        </div>
                        <small style="color: rgba(255,255,255,0.6); font-size: 12px;">
                            How often the server recalculates your journey (minimum: 1 minute)
                        </small>
                    </div>

                    <!-- Transit Data Fetch -->
                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" style="color: #94a3b8;"><use href="#icon-train"/></svg>
                            <span>Transit Data Fetch</span>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <input type="number" id="data-fetch-value" class="form-input" style="flex: 1; max-width: 100px;" min="10" value="30">
                            <select id="data-fetch-unit" class="form-input" style="flex: 1; max-width: 120px;">
                                <option value="seconds">seconds</option>
                            </select>
                        </div>
                        <small style="color: rgba(255,255,255,0.6); font-size: 12px;">
                            How often server checks for new departures (minimum: 10 seconds)
                        </small>
                    </div>

                    <!-- Webhook (Fixed) -->
                    <div style="padding: 15px; background: rgba(79, 178, 142, 0.1); border-radius: 8px; border-left: 4px solid #4fb28e;">
                        <div style="font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" style="color: #4fb28e;"><use href="#icon-radio"/></svg>
                            <span>Webhook Interval</span>
                        </div>
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">
                            <strong>Fixed:</strong> 15 minutes
                        </div>
                        <small style="color: rgba(255,255,255,0.6); font-size: 12px;">
                            CC E-Ink platform enforces 15-minute minimum (cannot be changed)
                        </small>
                    </div>
                </div>

                <button class="btn btn-primary btn-block" onclick="saveRefreshSettings()" style="margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg width="16" height="16"><use href="#icon-save"/></svg>
                    Save Refresh Settings
                </button>

                <div style="margin-top: 15px; padding: 12px; background: rgba(79, 178, 142, 0.1); border-radius: 8px; border-left: 4px solid #4fb28e; font-size: 12px; display: flex; align-items: flex-start; gap: 8px;">
                    <svg width="16" height="16" style="color: #4fb28e; flex-shrink: 0; margin-top: 1px;"><use href="#icon-lightbulb"/></svg>
                    <span><strong>Tip:</strong> Lower refresh intervals provide more up-to-date information but increase e-ink display wear. For daily commuting, 15-minute display refresh is recommended.</span>
                </div>
            </div>

            <div class="grid" style="gap: 20px;">
                <div class="card" style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #4fb28e;">
                    <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                        <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-sliders"/></svg>
                        <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Display Settings</h2>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="use-24-hour">
                        <label for="use-24-hour">24-hour time (default: 12-hour)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-walking-times" checked>
                        <label for="show-walking-times">Show walking times</label>
                    </div>
                    <button class="btn" onclick="saveDisplaySettings()" style="display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16"><use href="#icon-save"/></svg>
                        Save Settings
                    </button>
                </div>

                <div class="card" style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #667eea;">
                    <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                        <svg width="22" height="22" style="color: #667eea;"><use href="#icon-wrench"/></svg>
                        <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Actions</h2>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn" onclick="refreshData()" style="display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16"><use href="#icon-refresh"/></svg>
                            Refresh Data
                        </button>
                        <button class="btn btn-secondary" onclick="clearCache()" style="display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16"><use href="#icon-database"/></svg>
                            Clear Cache
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Architecture Tab -->
        <div id="tab-architecture" class="tab-content">
            <!-- Architecture Overview -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-layers"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Commute Compute System Architecture</h2>
                </div>
                <p style="margin-bottom: 20px; color: #cbd5e1; line-height: 1.7; font-size: 14px;">
                    A fully self-hosted smart transit display system for Australian public transport. Each user deploys their own complete stack with zero external dependencies.
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <span style="padding: 6px 14px; background: rgba(79, 178, 142, 0.2); border-radius: 20px; font-size: 12px; font-weight: 600; color: #4fb28e;">v4.0</span>
                    <span style="padding: 6px 14px; background: rgba(102, 126, 234, 0.2); border-radius: 20px; font-size: 12px; font-weight: 600; color: #667eea;">CCDash V10 LOCKED</span>
                    <span style="padding: 6px 14px; background: rgba(251, 191, 36, 0.2); border-radius: 20px; font-size: 12px; font-weight: 600; color: #fbbf24;">CC-FW-6.1-60s</span>
                </div>
            </div>

            <!-- Core Principles -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-check"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Core Principles</h2>
                </div>
                <div style="display: grid; gap: 12px; margin-top: 15px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <svg width="20" height="20" style="color: #4fb28e; flex-shrink: 0; margin-top: 2px;"><use href="#icon-user"/></svg>
                        <div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">Self-Hosted</div>
                            <div style="font-size: 13px; color: #94a3b8;">User owns server, device, and API keys. Complete data isolation.</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <svg width="20" height="20" style="color: #667eea; flex-shrink: 0; margin-top: 2px;"><use href="#icon-settings"/></svg>
                        <div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">Zero-Config</div>
                            <div style="font-size: 13px; color: #94a3b8;">No environment variables. All configuration via Setup Wizard and URL tokens.</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <svg width="20" height="20" style="color: #fbbf24; flex-shrink: 0; margin-top: 2px;"><use href="#icon-cpu"/></svg>
                        <div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">Server-Side Rendering</div>
                            <div style="font-size: 13px; color: #94a3b8;">All computation on server. Device receives pre-rendered 1-bit BMP images.</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <svg width="20" height="20" style="color: #22c55e; flex-shrink: 0; margin-top: 2px;"><use href="#icon-globe"/></svg>
                        <div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">Multi-State Support</div>
                            <div style="font-size: 13px; color: #94a3b8;">Victoria (PTV), NSW (TfNSW), Queensland (TransLink) with more states planned.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technology Stack -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #667eea;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #667eea;"><use href="#icon-database"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Technology Stack</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 15px;">
                    <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Server</div>
                        <div style="font-size: 14px; font-weight: 500;">Node.js 18+, Vercel Serverless</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Rendering</div>
                        <div style="font-size: 14px; font-weight: 500;">@napi-rs/canvas, 1-bit BMP</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Transit Data</div>
                        <div style="font-size: 14px; font-weight: 500;">GTFS-RT (VIC/NSW/QLD)</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Firmware</div>
                        <div style="font-size: 14px; font-weight: 500;">ESP32-C3, PlatformIO, C++</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Display</div>
                        <div style="font-size: 14px; font-weight: 500;">E-ink 800√ó480 (TRMNL/Kindle)</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Typography</div>
                        <div style="font-size: 14px; font-weight: 500;">Inter (bundled TTF)</div>
                    </div>
                </div>
            </div>

            <!-- Layer Architecture -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-layers"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Layer Architecture</h2>
                </div>
                <div style="margin-top: 15px; font-family: 'JetBrains Mono', monospace; font-size: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 16px; overflow-x: auto;">
                    <div style="color: #94a3b8; margin-bottom: 8px;">/* Presentation ‚Üí API ‚Üí Service ‚Üí Core ‚Üí Data */</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="padding: 10px 14px; background: linear-gradient(90deg, rgba(79, 178, 142, 0.3) 0%, rgba(79, 178, 142, 0.1) 100%); border-radius: 6px; border-left: 3px solid #4fb28e;">
                            <span style="color: #4fb28e; font-weight: 600;">PRESENTATION</span>
                            <span style="color: #94a3b8; margin-left: 12px;">admin.html, setup-wizard.html, simulator</span>
                        </div>
                        <div style="padding: 10px 14px; background: linear-gradient(90deg, rgba(102, 126, 234, 0.3) 0%, rgba(102, 126, 234, 0.1) 100%); border-radius: 6px; border-left: 3px solid #667eea;">
                            <span style="color: #667eea; font-weight: 600;">API LAYER</span>
                            <span style="color: #94a3b8; margin-left: 12px;">/api/zones, /api/livedash, /api/screen, /api/admin/*</span>
                        </div>
                        <div style="padding: 10px 14px; background: linear-gradient(90deg, rgba(251, 191, 36, 0.3) 0%, rgba(251, 191, 36, 0.1) 100%); border-radius: 6px; border-left: 3px solid #fbbf24;">
                            <span style="color: #fbbf24; font-weight: 600;">SERVICE LAYER</span>
                            <span style="color: #94a3b8; margin-left: 12px;">SmartCommute, CC LiveDash, Zone Renderer, Weather</span>
                        </div>
                        <div style="padding: 10px 14px; background: linear-gradient(90deg, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.1) 100%); border-radius: 6px; border-left: 3px solid #ef4444;">
                            <span style="color: #ef4444; font-weight: 600;">CORE LAYER</span>
                            <span style="color: #94a3b8; margin-left: 12px;">CoffeeDecision, Route Planner, Journey Engine</span>
                        </div>
                        <div style="padding: 10px 14px; background: linear-gradient(90deg, rgba(168, 85, 247, 0.3) 0%, rgba(168, 85, 247, 0.1) 100%); border-radius: 6px; border-left: 3px solid #a855f7;">
                            <span style="color: #a855f7; font-weight: 600;">DATA LAYER</span>
                            <span style="color: #94a3b8; margin-left: 12px;">OpenData Client, GTFS Static, Preferences, Fallback Timetables</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Flow -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #667eea;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #667eea;"><use href="#icon-route"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Data Flow</h2>
                </div>
                <p style="margin: 15px 0; font-size: 14px; color: #94a3b8; line-height: 1.6;">
                    Real-time transit data flows from external APIs through the processing pipeline to your e-ink display.
                </p>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="width: 32px; height: 32px; background: #4fb28e; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">1</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px;">External APIs</div>
                            <div style="font-size: 12px; color: #94a3b8;">Transport Victoria OpenData, BOM Weather, Google Places</div>
                        </div>
                        <div style="font-size: 11px; color: #4fb28e; padding: 4px 8px; background: rgba(79, 178, 142, 0.1); border-radius: 4px;">30s cache</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="width: 32px; height: 32px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">2</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px;">SmartCommute Engine</div>
                            <div style="font-size: 12px; color: #94a3b8;">Route calculation, CoffeeDecision, journey optimization</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="width: 32px; height: 32px; background: #fbbf24; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">3</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px;">CCDash Renderer V13</div>
                            <div style="font-size: 12px; color: #94a3b8;">1-bit BMP generation, zone diffing, partial refresh</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="width: 32px; height: 32px; background: #a855f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">4</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px;">E-ink Device</div>
                            <div style="font-size: 12px; color: #94a3b8;">CCFirm fetches zones, applies partial refresh every 60s</div>
                        </div>
                        <div style="font-size: 11px; color: #a855f7; padding: 4px 8px; background: rgba(168, 85, 247, 0.1); border-radius: 4px;">60s refresh</div>
                    </div>
                </div>
            </div>

            <!-- Zone Layout (V10 LOCKED) -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #fbbf24;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #fbbf24;"><use href="#icon-sliders"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Zone Layout (CCDash V10)</h2>
                    <span style="padding: 4px 10px; background: rgba(239, 68, 68, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #ef4444;">LOCKED</span>
                </div>
                <p style="margin: 15px 0; font-size: 14px; color: #94a3b8;">
                    800√ó480 display divided into 5 zones for efficient partial refresh.
                </p>
                <div style="display: grid; gap: 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(79, 178, 142, 0.15); border-radius: 6px; border: 1px solid rgba(79, 178, 142, 0.3);">
                        <span style="color: #4fb28e; font-weight: 600; min-width: 70px;">HEADER</span>
                        <span style="color: #94a3b8;">y: 0-94 (94px)</span>
                        <span style="color: #f1f5f9; margin-left: auto;">Time, weather, location</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(102, 126, 234, 0.15); border-radius: 6px; border: 1px solid rgba(102, 126, 234, 0.3);">
                        <span style="color: #667eea; font-weight: 600; min-width: 70px;">SUMMARY</span>
                        <span style="color: #94a3b8;">y: 96-124 (28px)</span>
                        <span style="color: #f1f5f9; margin-left: auto;">Leave time, arrival estimate</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(251, 191, 36, 0.15); border-radius: 6px; border: 1px solid rgba(251, 191, 36, 0.3);">
                        <span style="color: #fbbf24; font-weight: 600; min-width: 70px;">LEGS</span>
                        <span style="color: #94a3b8;">y: 132-448 (316px)</span>
                        <span style="color: #f1f5f9; margin-left: auto;">Journey leg cards (~31.7 KB)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(168, 85, 247, 0.15); border-radius: 6px; border: 1px solid rgba(168, 85, 247, 0.3);">
                        <span style="color: #a855f7; font-weight: 600; min-width: 70px;">FOOTER</span>
                        <span style="color: #94a3b8;">y: 448-480 (32px)</span>
                        <span style="color: #f1f5f9; margin-left: auto;">Destination, arrival time</span>
                    </div>
                </div>
            </div>

            <!-- API Endpoints -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-globe"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">API Endpoints</h2>
                </div>
                <div style="display: grid; gap: 8px; margin-top: 15px; font-family: 'JetBrains Mono', monospace; font-size: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                        <span style="padding: 2px 8px; background: #22c55e; border-radius: 4px; font-size: 10px; font-weight: 700;">GET</span>
                        <span style="color: #4fb28e;">/api/zones</span>
                        <span style="color: #94a3b8; margin-left: auto;">Zone refresh for TRMNL</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                        <span style="padding: 2px 8px; background: #22c55e; border-radius: 4px; font-size: 10px; font-weight: 700;">GET</span>
                        <span style="color: #4fb28e;">/api/livedash</span>
                        <span style="color: #94a3b8; margin-left: auto;">Multi-device renderer</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                        <span style="padding: 2px 8px; background: #22c55e; border-radius: 4px; font-size: 10px; font-weight: 700;">GET</span>
                        <span style="color: #4fb28e;">/api/screen</span>
                        <span style="color: #94a3b8; margin-left: auto;">Full screen PNG</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                        <span style="padding: 2px 8px; background: #22c55e; border-radius: 4px; font-size: 10px; font-weight: 700;">GET</span>
                        <span style="color: #4fb28e;">/api/health</span>
                        <span style="color: #94a3b8; margin-left: auto;">Health check</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                        <span style="padding: 2px 8px; background: #3b82f6; border-radius: 4px; font-size: 10px; font-weight: 700;">POST</span>
                        <span style="color: #667eea;">/api/admin/*</span>
                        <span style="color: #94a3b8; margin-left: auto;">Setup & configuration</span>
                    </div>
                </div>
            </div>

            <!-- Hardware Support -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #667eea;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #667eea;"><use href="#icon-smartphone"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Supported Hardware</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 15px;">
                    <div style="padding: 14px; background: rgba(79, 178, 142, 0.1); border-radius: 8px; border: 1px solid rgba(79, 178, 142, 0.2);">
                        <div style="font-weight: 600; font-size: 14px; color: #4fb28e; margin-bottom: 8px;">TRMNL OG</div>
                        <div style="font-size: 12px; color: #94a3b8; line-height: 1.6;">
                            800√ó480 ‚Ä¢ ESP32-C3<br>
                            7.5" E-ink ‚Ä¢ 60s partial refresh
                        </div>
                    </div>
                    <div style="padding: 14px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2);">
                        <div style="font-weight: 600; font-size: 14px; color: #667eea; margin-bottom: 8px;">TRMNL Mini</div>
                        <div style="font-size: 12px; color: #94a3b8; line-height: 1.6;">
                            400√ó300 ‚Ä¢ ESP32-C3<br>
                            Compact form factor
                        </div>
                    </div>
                    <div style="padding: 14px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.2);">
                        <div style="font-weight: 600; font-size: 14px; color: #fbbf24; margin-bottom: 8px;">Kindle (Jailbroken)</div>
                        <div style="font-size: 12px; color: #94a3b8; line-height: 1.6;">
                            PW2-5, Voyage, Basic<br>
                            kindle-dash package required
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visual Diagrams -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #a855f7;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #a855f7;"><use href="#icon-search"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Visual Diagrams</h2>
                </div>
                <div class="arch-viz-container" style="margin-top: 15px;">
                    <div class="arch-viz-card" style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px;">
                        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" style="color: #4fb28e;"><use href="#icon-route"/></svg>
                            Data Flow Diagram
                        </h3>
                        <img src="/assets/data-flow-diagram.svg" alt="Data Flow Diagram showing how data moves through the system" style="border-radius: 6px;" />
                    </div>
                    <div class="arch-viz-card" style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px;">
                        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" style="color: #667eea;"><use href="#icon-cpu"/></svg>
                            System Mind Map
                        </h3>
                        <img src="/assets/system-mind-map.svg" alt="System Mind Map showing all components and their relationships" style="border-radius: 6px;" />
                    </div>
                </div>
            </div>

            <!-- Documentation Links -->
            <div style="padding: 16px; background: rgba(79, 178, 142, 0.1); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                    <svg width="18" height="18" style="color: #4fb28e;"><use href="#icon-book"/></svg>
                    <span>Full Documentation</span>
                </div>
                <div style="font-size: 13px; color: #94a3b8; line-height: 1.6;">
                    For complete architecture details, see <strong>docs/ARCHITECTURE.md</strong> (v4.0, 20 sections).
                    Development rules in <strong>DEVELOPMENT-RULES.md</strong> (v1.12, 22 sections).
                </div>
            </div>
        </div>

        <!-- System & Support Tab -->
        <div id="tab-system" class="tab-content">
            <!-- System Architecture -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-cpu"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Complete System Architecture Map</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9; font-size: 14px;">
                    Visual mind map showing data flow from setup wizard through server to e-ink device
                </p>
                <button class="btn btn-primary btn-block" onclick="toggleSystemArchitecture()" id="arch-toggle-btn" style="margin-bottom: 15px; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg width="20" height="20"><use href="#icon-search"/></svg>
                    Show Full Architecture Map
                </button>
                <div id="architecture-viz" style="display: none; margin-top: 20px;"></div>
            </div>

            <!-- Victorian GTFS Realtime Data Viewer (Victoria only) -->
            <div id="victoria-gtfs-viewer" class="card" style="display: none; margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-train"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Live GTFS Realtime Data Viewer (Victoria)</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9; font-size: 14px;">
                    Real-time trip updates from Transport Victoria's OpenData portal - Metro trains only
                </p>
                <iframe
                    title="Data viewer"
                    width="100%"
                    height="400"
                    src="https://opendata.transport.vic.gov.au/dataset/gtfs-realtime/resource/0010d606-47bf-4abb-a04f-63add63a4d23/view/07d75c4f-db6f-444d-97d8-22082ab0a0ca"
                    frameBorder="0"
                    style="border-radius: 8px; background: white; border: 1px solid rgba(255,255,255,0.1);">
                </iframe>
                <div style="margin-top: 15px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                    <p style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; opacity: 0.9; display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" style="color: #667eea;"><use href="#icon-book"/></svg>
                        Resources:
                    </p>
                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; opacity: 0.8; line-height: 1.8;">
                        <li><a href="https://opendata.transport.vic.gov.au/dataset/gtfs-realtime" target="_blank" style="color: #4fb28e;">OpenData Portal - GTFS Realtime Dataset</a></li>
                        <li><a href="https://opendata.transport.vic.gov.au/dataset/2d9a7228-5b81-40d3-8075-ae7a3da42198/resource/0010d606-47bf-4abb-a04f-63add63a4d23/download/gtfsr_metro_train_trip_updates.openapi.json" target="_blank" style="color: #4fb28e;">OpenAPI Specification (JSON)</a></li>
                        <li>See <strong>VICTORIA-GTFS-REALTIME-PROTOCOL.md</strong> for complete implementation guide</li>
                    </ul>
                </div>
            </div>

            <!-- Algorithm Intelligence -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 12px; border-left: 4px solid #667eea;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #667eea;"><use href="#icon-cpu"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Algorithm Intelligence</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px;">
                    What makes this system smart? Here's how our algorithms work together to optimize your journey.
                </p>

                <!-- Coffee Decision Algorithm -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #40DCA5;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" style="color: #40DCA5;"><use href="#icon-coffee"/></svg>
                        Coffee Decision Algorithm
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Intelligence:</strong> Dynamically calculates if there's time for coffee based on real-time transit data</p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Inputs:</strong></div>
                            ‚Ä¢ Walking time from home to station (calculated via geocoding)<br>
                            ‚Ä¢ Next available train departure (live GTFS data)<br>
                            ‚Ä¢ Cafe busy-ness indicator (Google Places API)<br>
                            ‚Ä¢ Estimated coffee preparation time (2-5 min based on busy-ness)<br>
                            ‚Ä¢ Walking time from cafe to station<br>
                            ‚Ä¢ Safety buffer (2 min to avoid missing train)
                        </div>
                        <div style="padding: 12px; background: rgba(64, 220, 165, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Decision Logic:</strong></div>
                            If (home_to_station_walk + coffee_prep + cafe_to_station_walk + buffer) < time_until_next_train:<br>
                            <span style="margin-left: 20px; color: #40DCA5;">‚úì <strong>Go for coffee!</strong></span><br>
                            Else:<br>
                            <span style="margin-left: 20px; color: #fc8181;">‚úó <strong>Go direct</strong></span>
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Communication:</strong> Sends decision to Smart Journey Planner ‚Üí Updates display module
                        </p>
                    </div>
                </details>

                <!-- Multi-Tier Geocoding -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #4fb28e;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" style="color: #4fb28e;"><use href="#icon-map-pin"/></svg>
                        Multi-Tier Geocoding Intelligence
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Intelligence:</strong> 6-service fallback chain ensures address resolution always succeeds</p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Priority Chain:</strong></div>
                            1. <strong>Google Places</strong> - Highest accuracy, business data<br>
                            2. <strong>Mapbox</strong> - Global coverage, address-focused<br>
                            3. <strong>HERE</strong> - Optimized for Australian addresses<br>
                            4. <strong>Foursquare</strong> - Venue and business locations<br>
                            5. <strong>LocationIQ</strong> - Free tier geocoding<br>
                            6. <strong>Nominatim (OpenStreetMap)</strong> - Always available fallback
                        </div>
                        <div style="padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Smart Features:</strong></div>
                            ‚Ä¢ <strong>Bias coordinates</strong>: Searches near your configured city<br>
                            ‚Ä¢ <strong>Decision logging</strong>: Records which service was used<br>
                            ‚Ä¢ <strong>24-hour cache</strong>: Faster responses for repeated addresses<br>
                            ‚Ä¢ <strong>Automatic retry</strong>: If one service fails, tries next immediately
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Communication:</strong> Used by Route Planner ‚Üí Provides coordinates to Walking Time Calculator
                        </p>
                    </div>
                </details>

                <!-- Real-Time Delay Detection -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #f6ad55;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" style="color: #f6ad55;"><use href="#icon-zap"/></svg>
                        Real-Time Delay Detection & Adjustment
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Intelligence:</strong> Monitors live transit data and automatically recalculates journey when delays are detected</p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Detection Process:</strong></div>
                            ‚Ä¢ Fetches GTFS-Realtime data every 30 seconds<br>
                            ‚Ä¢ Compares scheduled departure vs actual departure<br>
                            ‚Ä¢ Calculates delay in minutes<br>
                            ‚Ä¢ Categorizes severity: on-time (0 min), delayed (1-10 min), disrupted (>10 min)
                        </div>
                        <div style="padding: 12px; background: rgba(246, 173, 85, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Automatic Actions:</strong></div>
                            1. <strong>Updates journey display</strong> with revised times<br>
                            2. <strong>Recalculates coffee decision</strong> based on new timing<br>
                            3. <strong>Adjusts connection buffers</strong> for multi-leg journeys<br>
                            4. <strong>Logs decision</strong> for transparency
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Communication:</strong> GTFS data ‚Üí Delay Detector ‚Üí Journey Status API ‚Üí Display Updates
                        </p>
                    </div>
                </details>

                <!-- Journey Optimization -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #4fb28e;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" style="color: #4fb28e;"><use href="#icon-target"/></svg>
                        Journey Optimization Engine
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Intelligence:</strong> Plans optimal route considering walking speed, connection buffers, and service patterns</p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Optimization Factors:</strong></div>
                            ‚Ä¢ <strong>Walking speed</strong>: 4.5 km/h average human walking pace<br>
                            ‚Ä¢ <strong>Connection buffer</strong>: 3-5 minutes between services<br>
                            ‚Ä¢ <strong>Station access time</strong>: Platform walking time included<br>
                            ‚Ä¢ <strong>Service frequency</strong>: Considers headways between trains
                        </div>
                        <div style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Route Selection:</strong></div>
                            1. Calculate all possible routes to destination<br>
                            2. Score each route: (earliest_arrival √ó 0.6) + (fewest_changes √ó 0.3) + (least_walking √ó 0.1)<br>
                            3. Select highest-scoring route<br>
                            4. Validate against live service data
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Communication:</strong> User Preferences ‚Üí Route Planner ‚Üí Multi-Modal Router ‚Üí Journey Display
                        </p>
                    </div>
                </details>

                <!-- Module Communication Map -->
                <details style="margin-bottom: 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid #ec4899;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" style="color: #ec4899;"><use href="#icon-git-branch"/></svg>
                        Inter-Module Communication Flow
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.8;">
                        <p><strong>How the algorithms talk to each other:</strong></p>
                        <div style="padding: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 11px; line-height: 1.6;">
                            User Preferences<br>
                            ‚Üì<br>
                            Setup Wizard ‚Üí Preferences Manager<br>
                            ‚Üì<br>
                            Geocoding Service (addresses ‚Üí coordinates)<br>
                            ‚Üì<br>
                            Route Planner + Walking Time Calculator<br>
                            ‚Üì<br>
                            Transit Authority API (GTFS Realtime)<br>
                            ‚Üì<br>
                            Multi-Modal Router<br>
                            ‚Üì<br>
                            Coffee Decision Engine + Busy Detector<br>
                            ‚Üì<br>
                            Smart Journey Planner (combines all data)<br>
                            ‚Üì<br>
                            Automatic Background Calculation (every 2 min)<br>
                            ‚Üì<br>
                            Journey Status API + Delay Detection<br>
                            ‚Üì<br>
                            Display Module ‚Üí Your e-ink Device
                        </div>
                        <div style="padding: 12px; background: rgba(236, 72, 153, 0.1); border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 8px;"><strong>Key Communication Methods:</strong></div>
                            ‚Ä¢ <strong>Shared Cache</strong>: Modules read/write to cachedJourney<br>
                            ‚Ä¢ <strong>Decision Logger</strong>: All modules log decisions to global logger<br>
                            ‚Ä¢ <strong>Preferences Object</strong>: Centralized configuration accessed by all<br>
                            ‚Ä¢ <strong>Event-Driven Updates</strong>: API endpoints trigger recalculations<br>
                            ‚Ä¢ <strong>Real-Time Sync</strong>: 30-second refresh cycle keeps data current
                        </div>
                    </div>
                </details>
            </div>

            <!-- Decision Log -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #4fb28e;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #4fb28e;"><use href="#icon-list"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Decision Log</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9; font-size: 14px;">
                    View all decisions made by the system for full transparency and troubleshooting
                </p>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="loadDecisionLog()" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="16" height="16"><use href="#icon-search"/></svg>
                        View Decision Log
                    </button>
                    <button class="btn" onclick="exportDecisionLog()" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; background: #22c55e;">
                        <svg width="16" height="16"><use href="#icon-save"/></svg>
                        Export Logs
                    </button>
                </div>
                <div id="decision-log-content" style="display: none; margin-top: 20px; max-height: 500px; overflow-y: auto;">
                    <div id="decision-log-stats" style="margin-bottom: 15px;"></div>
                    <div id="decision-log-entries"></div>
                </div>
            </div>

            <!-- Feedback Form -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #667eea;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #667eea;"><use href="#icon-mail"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Send Feedback & Ideas</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9; font-size: 14px;">
                    Have ideas for improvements or experiencing issues? Send feedback directly to the developer.
                </p>
                <div id="feedback-form">
                    <div class="form-group">
                        <label class="form-label">Your Name (Optional)</label>
                        <input type="text" id="feedback-name" class="form-input" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Email (Optional)</label>
                        <input type="email" id="feedback-email" class="form-input" placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Feedback Type</label>
                        <select id="feedback-type" class="form-input">
                            <option value="idea">Feature Idea</option>
                            <option value="bug">Bug Report</option>
                            <option value="question">Question</option>
                            <option value="praise">Praise</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea id="feedback-message" class="form-input" rows="5" placeholder="Describe your feedback, idea, or issue..." required></textarea>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="submitFeedback()" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="16" height="16"><use href="#icon-mail"/></svg>
                        Send Feedback
                    </button>
                    <div id="feedback-status" style="margin-top: 15px; text-align: center; display: none;"></div>
                </div>
            </div>

            <!-- Data Source Compliance -->
            <div class="card" style="margin-bottom: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #fbbf24;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #fbbf24;"><use href="#icon-shield"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Data Source Compliance & Licensing</h2>
                </div>
                <p style="margin-bottom: 15px; opacity: 0.9;">
                    This system uses multiple external data sources. <strong>You are responsible for complying with their terms of service and obtaining necessary API keys.</strong>
                </p>

                <!-- Transport APIs -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 4px solid #4fb28e;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #4fb28e;"><use href="#icon-train"/></svg>
                        Transport Victoria OpenData API
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Real-time train, tram, and bus data in Victoria</p>
                        <p><strong>Registration:</strong> <a href="https://opendata.transport.vic.gov.au/" target="_blank" style="color: #4fb28e;">https://opendata.transport.vic.gov.au/</a></p>
                        <p><strong>License:</strong> Creative Commons Attribution 4.0 International</p>
                        <p><strong>Compliance:</strong> Must attribute "Transport Victoria" in any public-facing implementation</p>
                    </div>
                </details>

                <!-- Weather API -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(72, 187, 120, 0.1); border-radius: 8px; border-left: 4px solid #22c55e;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #22c55e;"><use href="#icon-sun"/></svg>
                        Bureau of Meteorology (BOM) Data
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Weather data and forecasts</p>
                        <p><strong>Access:</strong> <a href="http://www.bom.gov.au/catalogue/data-feeds.shtml" target="_blank" style="color: #22c55e;">http://www.bom.gov.au/catalogue/data-feeds.shtml</a></p>
                        <p><strong>License:</strong> Creative Commons Attribution 3.0 Australia</p>
                        <p><strong>Compliance:</strong> Must attribute "Bureau of Meteorology" and include copyright notice</p>
                        <p style="font-size: 12px; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 4px;">
                            Example: "Weather data ¬© Commonwealth of Australia, Bureau of Meteorology"
                        </p>
                    </div>
                </details>

                <!-- Google Places API -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 4px solid #fbbf24;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #fbbf24;"><use href="#icon-map-pin"/></svg>
                        Google Places API (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Enhanced cafe/business geocoding and busy-ness detection</p>
                        <p><strong>Registration:</strong> <a href="https://developers.google.com/maps/documentation/places" target="_blank" style="color: #fbbf24;">Google Cloud Console</a></p>
                        <p><strong>License:</strong> Google Maps Platform Terms of Service</p>
                        <p><strong>Compliance:</strong> Must display "Powered by Google" logo and attribution</p>
                        <p><strong>Pricing:</strong> Check current pricing at <a href="https://cloud.google.com/maps-platform/pricing" target="_blank" style="color: #fbbf24;">Google Cloud Pricing</a></p>
                    </div>
                </details>

                <!-- Mapbox -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #4fb28e;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #4fb28e;"><use href="#icon-globe"/></svg>
                        Mapbox Geocoding API (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> High-accuracy address geocoding</p>
                        <p><strong>Registration:</strong> <a href="https://www.mapbox.com/pricing" target="_blank" style="color: #4fb28e;">Mapbox Pricing</a></p>
                        <p><strong>License:</strong> Mapbox Terms of Service</p>
                        <p><strong>Compliance:</strong> Must include Mapbox attribution in any maps displayed</p>
                    </div>
                </details>

                <!-- HERE -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 4px solid #4fb28e;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #4fb28e;"><use href="#icon-globe"/></svg>
                        HERE Geocoding API (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Australian address optimization</p>
                        <p><strong>Registration:</strong> <a href="https://developer.here.com/" target="_blank" style="color: #4fb28e;">HERE Developer Portal</a></p>
                        <p><strong>License:</strong> HERE Platform Terms and Conditions</p>
                        <p><strong>Compliance:</strong> Freemium tier available; check usage limits</p>
                    </div>
                </details>

                <!-- OpenStreetMap -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #22c55e;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #22c55e;"><use href="#icon-globe"/></svg>
                        OpenStreetMap Nominatim (Free, Always Available)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Fallback geocoding (no API key needed)</p>
                        <p><strong>Documentation:</strong> <a href="https://nominatim.org/release-docs/latest/" target="_blank" style="color: #22c55e;">Nominatim Documentation</a></p>
                        <p><strong>License:</strong> Open Database License (ODbL)</p>
                        <p><strong>Compliance:</strong> Must include "¬© OpenStreetMap contributors" attribution</p>
                        <p><strong>Usage Policy:</strong> Must include valid User-Agent header (already implemented)</p>
                    </div>
                </details>

                <!-- Foursquare -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(236, 72, 153, 0.1); border-radius: 8px; border-left: 4px solid #ec4899;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #ec4899;"><use href="#icon-map-pin"/></svg>
                        Foursquare Places API (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Venue and business location data</p>
                        <p><strong>Registration:</strong> <a href="https://foursquare.com/developers/" target="_blank" style="color: #ec4899;">Foursquare Developers</a></p>
                        <p><strong>License:</strong> Foursquare Developer Terms</p>
                        <p><strong>Compliance:</strong> Must attribute Foursquare in any displayed data</p>
                    </div>
                </details>

                <!-- LocationIQ -->
                <details style="margin-bottom: 15px; padding: 15px; background: rgba(156, 163, 175, 0.1); border-radius: 8px; border-left: 4px solid #9ca3af;">
                    <summary style="font-weight: 600; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #9ca3af;"><use href="#icon-search"/></svg>
                        LocationIQ (Optional)
                    </summary>
                    <div style="margin-top: 12px; font-size: 13px; line-height: 1.7;">
                        <p><strong>Required for:</strong> Free tier geocoding</p>
                        <p><strong>Registration:</strong> <a href="https://locationiq.com/" target="_blank" style="color: #9ca3af;">LocationIQ</a></p>
                        <p><strong>License:</strong> Free tier: 5,000 requests/day</p>
                        <p><strong>Compliance:</strong> Must include attribution per terms of service</p>
                    </div>
                </details>

                <!-- Important Notice -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(252, 129, 129, 0.15); border: 2px solid rgba(252, 129, 129, 0.5); border-radius: 8px;">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px; color: #fc8181; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" style="color: #fc8181;"><use href="#icon-alert"/></svg>
                        YOUR RESPONSIBILITY
                    </div>
                    <p style="font-size: 13px; line-height: 1.6; margin: 0;">
                        <strong>As a user of this software, you are responsible for:</strong><br>
                        ‚Ä¢ Registering for and maintaining your own API keys<br>
                        ‚Ä¢ Complying with all terms of service for external APIs<br>
                        ‚Ä¢ Properly attributing all data sources as required<br>
                        ‚Ä¢ Staying within usage limits and quotas<br>
                        ‚Ä¢ Paying for any commercial API usage<br>
                        <br>
                        <strong>The software creator (Angus Bergman) is not responsible for your use of external APIs.</strong>
                    </p>
                </div>
            </div>

            <!-- Support Development -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(244, 114, 182, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%); border-radius: 12px; border-left: 4px solid #f472b6;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #f472b6;"><use href="#icon-heart"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Support Development</h2>
                </div>
                <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px; line-height: 1.7;">
                    Commute Compute is developed and maintained by <strong>Angus Bergman</strong> in free time. If this system helps your daily commute and you'd like to support ongoing development, any contribution is deeply appreciated.
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <a href="https://www.buymeacoffee.com/angusbergman" target="_blank" style="text-decoration: none;">
                        <div style="background: rgba(255, 221, 87, 0.2); border: 2px solid #ffdd57; border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer;">
                            <svg width="32" height="32" style="color: #ffdd57; margin-bottom: 10px;"><use href="#icon-coffee"/></svg>
                            <div style="font-weight: 600; font-size: 16px; color: #ffdd57; margin-bottom: 5px;">Buy Me a Coffee</div>
                            <div style="font-size: 12px; opacity: 0.8;">One-time donation</div>
                        </div>
                    </a>
                    <a href="https://github.com/sponsors/angusbergman17-cpu" target="_blank" style="text-decoration: none;">
                        <div style="background: rgba(79, 178, 142, 0.2); border: 2px solid #4fb28e; border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer;">
                            <svg width="32" height="32" style="color: #4fb28e; margin-bottom: 10px;"><use href="#icon-heart"/></svg>
                            <div style="font-weight: 600; font-size: 16px; color: #4fb28e; margin-bottom: 5px;">GitHub Sponsors</div>
                            <div style="font-size: 12px; opacity: 0.8;">Monthly support</div>
                        </div>
                    </a>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" style="color: #f472b6;"><use href="#icon-heart"/></svg>
                        Your support helps with:
                    </div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; opacity: 0.9; line-height: 2;">
                        <li>Server costs for testing and development</li>
                        <li>e-ink devices for compatibility testing</li>
                        <li>Time spent on bug fixes and new features</li>
                        <li>Documentation and user support</li>
                        <li>GTFS data updates and maintenance</li>
                        <li>API credits for development environments</li>
                    </ul>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(244, 114, 182, 0.1); border-radius: 8px; text-align: center;">
                    <p style="margin: 0; font-size: 12px; opacity: 0.85; line-height: 1.6;">
                        <strong>Every contribution, no matter the size, is deeply appreciated and motivates continued development.</strong><br>
                        Thank you for using Commute Compute!
                    </p>
                </div>
            </div>

            <!-- System Reset & Cache Management (Collapsible) -->
            <details class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(252, 129, 129, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%); border-radius: 12px; border-left: 4px solid #fc8181;">
                <summary style="cursor: pointer; user-select: none; list-style: none; padding: 20px;">
                    <div class="card-header" style="margin: -20px; padding: 20px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <svg width="22" height="22" style="color: #fc8181;"><use href="#icon-alert"/></svg>
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600;">System Reset & Cache Management</h2>
                        </div>
                        <span style="font-size: 20px; transition: transform 0.3s;">‚ñº</span>
                    </div>
                </summary>
                <div style="padding: 0 20px 20px 20px;">
                    <p style="margin-bottom: 20px; opacity: 0.9; font-size: 14px; line-height: 1.6;">
                        Advanced system controls for managing data and restarting the server. Use these tools carefully.
                    </p>

                <!-- Cache Clear -->
                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <svg width="24" height="24" style="color: #94a3b8;"><use href="#icon-trash"/></svg>
                        <div>
                            <div style="font-weight: 600; font-size: 15px;">Clear All Caches</div>
                            <div style="font-size: 12px; opacity: 0.8;">Clears geocoding, weather, and journey calculation caches</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-block" onclick="clearAllCaches()" id="clear-cache-btn" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="16" height="16"><use href="#icon-trash"/></svg>
                        Clear Caches Only
                    </button>
                </div>

                <!-- Full System Reset -->
                <div style="background: linear-gradient(135deg, rgba(252, 129, 129, 0.15) 0%, rgba(239, 68, 68, 0.15) 100%); border-radius: 8px; padding: 20px; border: 2px solid #fc8181;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <svg width="28" height="28" style="color: #ef4444;"><use href="#icon-refresh"/></svg>
                        <div>
                            <div style="font-weight: 700; font-size: 16px; color: #ef4444;">Complete System Reset</div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                                <svg width="14" height="14" style="color: #fc8181;"><use href="#icon-alert"/></svg>
                                This will delete ALL user data and restart the server
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 12px; margin-bottom: 15px; font-size: 13px; line-height: 1.6;">
                        <strong>What gets deleted:</strong><br>
                        ‚Ä¢ All addresses (home, cafe, work)<br>
                        ‚Ä¢ Journey preferences and transit routes<br>
                        ‚Ä¢ API credentials<br>
                        ‚Ä¢ All cached data (geocoding, weather, journey)<br>
                        ‚Ä¢ Location and state configuration<br>
                        <br>
                        <strong>What happens after:</strong><br>
                        ‚Ä¢ Server restarts automatically (10 second delay)<br>
                        ‚Ä¢ You'll need to run Setup Wizard again<br>
                        ‚Ä¢ All data will be fresh and empty
                    </div>

                    <button class="btn btn-block" onclick="confirmFullSystemReset()" id="full-reset-btn"
                            style="background: linear-gradient(135deg, #fc8181 0%, #ef4444 100%);
                                   color: white;
                                   font-weight: 700;
                                   font-size: 16px;
                                   padding: 15px;
                                   border: none;
                                   box-shadow: 0 4px 12px rgba(252, 129, 129, 0.3);
                                   display: flex;
                                   align-items: center;
                                   justify-content: center;
                                   gap: 8px;">
                        <svg width="18" height="18"><use href="#icon-alert"/></svg>
                        WIPE ALL DATA & RESTART SERVER
                    </button>
                </div>
                </div>
            </details>

            <!-- Support Section -->
            <div class="card" style="background: linear-gradient(135deg, #40DCA5 0%, #2ecc71 100%); color: white; border: none; border-radius: 12px;">
                <div class="card-header" style="border: none; display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: white;"><use href="#icon-heart"/></svg>
                    <h2 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">Support This Project</h2>
                </div>
                <p style="margin-bottom: 20px; line-height: 1.6; opacity: 0.95; font-size: 14px;">
                    From conception to execution, many weeks, hours, and all-nighters went into creating this intelligent transit system.
                    Your support helps keep the project alive and improving.
                </p>
                <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 12px; font-size: 15px;">What your support enables:</div>
                    <div style="display: grid; gap: 10px; font-size: 14px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <svg width="20" height="20"><use href="#icon-zap"/></svg>
                            <span>Continued development and new features</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <svg width="20" height="20"><use href="#icon-wrench"/></svg>
                            <span>Bug fixes and performance improvements</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <svg width="20" height="20"><use href="#icon-book"/></svg>
                            <span>Better documentation and guides</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <svg width="20" height="20"><use href="#icon-cpu"/></svg>
                            <span>Server hosting and API costs</span>
                        </div>
                    </div>
                </div>
                <a href="https://buymeacoffee.com/angusbergman" target="_blank"
                   class="btn btn-block"
                   style="background: white; color: #40DCA5; font-weight: 600; font-size: 16px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 15px;">
                    <svg width="18" height="18" style="color: #40DCA5;"><use href="#icon-coffee"/></svg>
                    Buy Me a Coffee
                </a>
                <div style="text-align: center; margin-top: 15px; font-size: 13px; opacity: 0.85;">
                    Every contribution, big or small, is deeply appreciated
                </div>
            </div>

            <!-- About -->
            <div class="card" style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; border-left: 4px solid #667eea;">
                <div class="card-header" style="display: flex; align-items: center; gap: 12px;">
                    <svg width="22" height="22" style="color: #667eea;"><use href="#icon-info"/></svg>
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600;">About Commute Compute</h2>
                </div>
                <p style="line-height: 1.6; margin-bottom: 15px;">
                    An intelligent real-time Melbourne transit display system that learns your commute patterns
                    and helps you decide: <strong>Can I get coffee, or should I go direct?</strong>
                </p>
                <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; line-height: 1.6; font-size: 14px;">
                    <div><strong>Data Sources:</strong></div>
                    <div style="opacity: 0.9; margin-top: 5px;">
                        ‚Ä¢ Bureau of Meteorology (Official JSON Feeds)<br>
                        ‚Ä¢ Transport Victoria GTFS-Realtime API<br>
                        ‚Ä¢ OpenStreetMap Nominatim<br>
                        ‚Ä¢ Google Places API (Optional)
                    </div>
                </div>
            </div>
        </div>

        <!-- Version Control Footer -->
        <div class="version-footer">
            <span class="version-label">Version:</span>
            <span class="version-value" id="versionHash">Loading...</span>
            <span class="separator">‚Ä¢</span>
            <span class="version-label">Build:</span>
            <span class="version-value" id="buildDate">Loading...</span>
            <span class="separator">‚Ä¢</span>
            <span class="version-value">¬© 2026 Angus Bergman</span>
        </div>

        <!-- Footer -->
        <div class="footer">
            <!-- Quick Links Section -->
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px;">
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 12px; opacity: 0.9;">Quick Links</div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <a href="/api/livedash?device=trmnl-og&format=html" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(79, 178, 142, 0.2); border: 1px solid rgba(79, 178, 142, 0.3); border-radius: 6px; color: #4fb28e; text-decoration: none; font-size: 13px; transition: all 0.2s;">
                        <span>üìä</span> Live Display
                    </a>
                    <a href="/preview.html" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(79, 178, 142, 0.2); border: 1px solid rgba(79, 178, 142, 0.3); border-radius: 6px; color: #4fb28e; text-decoration: none; font-size: 13px; transition: all 0.2s;">
                        <span>üñ•Ô∏è</span> E-Ink Preview
                    </a>
                    <a href="/api/livedash?device=trmnl-og&format=html" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(79, 178, 142, 0.2); border: 1px solid rgba(79, 178, 142, 0.3); border-radius: 6px; color: #4fb28e; text-decoration: none; font-size: 13px; transition: all 0.2s;">
                        <span>üöâ</span> CC Dashboard
                    </a>
                    <a href="/journey-display.html" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(79, 178, 142, 0.2); border: 1px solid rgba(79, 178, 142, 0.3); border-radius: 6px; color: #4fb28e; text-decoration: none; font-size: 13px; transition: all 0.2s;">
                        <span>üó∫Ô∏è</span> Journey Visualizer
                    </a>
                    <a href="/api/status" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(6, 182, 212, 0.2); border: 1px solid rgba(6, 182, 212, 0.3); border-radius: 6px; color: #67e8f9; text-decoration: none; font-size: 13px; transition: all 0.2s;">
                        <span>üíö</span> API Status
                    </a>
                </div>
            </div>
            <p style="margin-top: 15px; font-size: 12px; opacity: 0.7;">
                ¬© 2026 Angus Bergman. Licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" style="color: #4fb28e;">CC BY-NC 4.0</a><br>
                Commute Compute - Intelligent Transit Display System
            </p>
            <p style="margin-top: 12px; font-size: 13px;">
                <a href="https://buymeacoffee.com/angusbergman" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: #FFDD00; color: #000; border-radius: 6px; font-weight: 500; text-decoration: none; transition: transform 0.2s;">
                    <span>‚òï</span> Buy Me a Coffee
                </a>
            </p>

            <!-- Data Source Attributions (Dynamic based on configuration) -->
            <div id="attributions-footer" style="margin-top: 15px; padding: 10px 12px; background: rgba(255, 255, 255, 0.03); border-left: 2px solid rgba(237, 137, 54, 0.3); font-size: 10px; opacity: 0.7; line-height: 1.6;">
                <div style="font-weight: 600; margin-bottom: 6px; font-size: 11px; opacity: 0.9;">Data Source Attributions</div>
                <div id="attributions-content" style="font-size: 10px;">Loading...</div>
            </div>

            <!-- License Information (Collapsible) -->
            <details style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 12px; line-height: 1.7; cursor: pointer;">
                <summary style="font-weight: 600; font-size: 13px; cursor: pointer; user-select: none;">
                    üìÑ License Information (Click to expand)
                </summary>
                <div style="margin-top: 15px;">
                    <p style="margin-bottom: 10px;">
                        This software, including all code, architecture, and documentation, is created by <strong>Angus Bergman</strong> and is licensed under:
                    </p>
                    <p style="margin-bottom: 10px;">
                        <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" style="color: #4fb28e; text-decoration: none; font-weight: 600;">
                            Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)
                        </a>
                    </p>
                    <div style="padding: 10px; background: rgba(0,0,0,0.1); border-radius: 6px; margin-top: 10px;">
                        <div style="font-weight: 600; margin-bottom: 6px;">‚úÖ You ARE free to:</div>
                        <ul style="margin-left: 20px; margin-bottom: 10px;">
                            <li>Use this software for personal, non-commercial purposes</li>
                            <li>Modify and adapt the code for your own use</li>
                            <li>Share the software with proper attribution to Angus Bergman</li>
                            <li>Study how it works and learn from it</li>
                        </ul>
                        <div style="font-weight: 600; margin-bottom: 6px;">‚ùå You are NOT allowed to:</div>
                        <ul style="margin-left: 20px;">
                            <li>Use this software for commercial purposes without written permission</li>
                            <li>Sell or profit from this software or derivatives</li>
                            <li><strong style="color: #fc8181;">Remove or obscure attribution to Angus Bergman</strong></li>
                            <li>Claim this work as your own</li>
                        </ul>
                    </div>
                    <p style="margin-top: 10px; font-size: 11px; opacity: 0.8;">
                        For commercial licensing inquiries, contact: angusbergman17@gmail.com
                    </p>
                </div>
            </details>
        </div>
    </div>

    <script>
        /**
         * ========================================================================
         * CRITICAL: DEVELOPMENT RULES COMPLIANCE REQUIRED
         * ========================================================================
         *
         * ALL CODE IN THIS FILE MUST COMPLY WITH:
         * docs/development/DEVELOPMENT-RULES.md (v1.0.12)
         *
         * TOP PRIORITY REQUIREMENTS:
         *
         * 1. LOCATION AGNOSTIC (Section K):
         *    - NO hardcoded locations (Melbourne, Victoria, etc.)
         *    - NO hardcoded timezones (Australia/Melbourne)
         *    - MUST detect state from user input
         *    - MUST use dynamic timezone based on detected state
         *    - MUST support all 8 Australian states/territories equally
         *
         * 2. USER-FIRST API KEY FLOW (Section R):
         *    - Setup MUST work WITHOUT API keys (fallback data)
         *    - API keys are OPTIONAL enhancements
         *    - Clear indicators: fallback vs live data
         *
         * 3. TERMINOLOGY (Section 3):
         *    - Use "Transport for Victoria" or "Transport Victoria"
         *    - NEVER use "PTV" or "Public Transport Victoria"
         *    - Use "ODATA_API_KEY" for environment variables
         *
         * 4. ROBUST ERROR HANDLING (Section N):
         *    - Timeout protection on all external calls
         *    - Circuit breakers for APIs
         *    - Graceful degradation
         *
         * 5. CC E-Ink COMPLIANCE (Section P):
         *    - 7.5" e-ink display (800x480 or 480x800)
         *    - BYOS webhook format required
         *    - Respect e-ink refresh limits
         *
         * 6. RENDER COMPATIBILITY (Section Q):
         *    - Use process.cwd() for file paths
         *    - Correct relative imports
         *    - Memory optimization for free tier
         *
         * BEFORE MAKING CHANGES:
         * - Read DEVELOPMENT-RULES.md sections 1-4
         * - Check for forbidden terms (Section 1)
         * - Verify location agnostic principles (Section K)
         * - Test with fallback data (no API keys)
         * - Run compliance self-check (Section 15)
         *
         * VIOLATIONS OF THESE RULES ARE NOT PERMITTED.
         * ========================================================================
         */

        // XSS Sanitization utility - escapes HTML special characters
        function sanitize(str) {
            if (str === null || str === undefined) return '';
            if (typeof str !== 'string') str = String(str);
            const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'};
            return str.replace(/[&<>"'`=/]/g, c => map[c]);
        }

        const BASE_URL = window.location.origin;
        let refreshInterval;

        // ==================== ONBOARDING SYSTEM ====================

        const ONBOARDING_STEPS = [
            {
                title: "Welcome to Commute Compute! üöä",
                content: `
                    <p>Your intelligent transit display system for smart commute decisions.</p>
                    <ul class="onboarding-features">
                        <li>Real-time transit data from Transport Victoria</li>
                        <li>Intelligent journey planning with live delays</li>
                        <li>Coffee stop optimization based on transit times</li>
                        <li>Weather-aware departure recommendations</li>
                    </ul>
                    <p style="margin-top: 15px; font-size: 14px; opacity: 0.8;">This quick tutorial will show you how to get started.</p>
                `
            },
            {
                title: "Step 1: Configure Your Journey üè†",
                content: `
                    <p>Start by setting up your daily journey locations:</p>
                    <ul class="onboarding-features">
                        <li><strong>Home Address:</strong> Your starting point</li>
                        <li><strong>Coffee Stop:</strong> Your favorite cafe (optional)</li>
                        <li><strong>Work Address:</strong> Your destination</li>
                    </ul>
                    <p style="margin-top: 15px;">The system will auto-detect your state and find nearby transit stops.</p>
                `,
                highlightElement: "tab-setup",
                scrollTo: "tab-setup"
            },
            {
                title: "Step 2: Select Transit Stops üöâ",
                content: `
                    <p>After entering addresses, you'll choose your preferred transit stops:</p>
                    <ul class="onboarding-features">
                        <li>System finds stops near your locations</li>
                        <li>Select departure and arrival stations</li>
                        <li>Data validation ensures accuracy</li>
                    </ul>
                    <p style="margin-top: 15px;">Commute Compute will then calculate smart departure times automatically.</p>
                `
            },
            {
                title: "Step 3: View Live Departures üî¥",
                content: `
                    <p>Once configured, enjoy real-time transit information:</p>
                    <ul class="onboarding-features">
                        <li>Auto-updates every 2 minutes</li>
                        <li>Live delay and cancellation alerts</li>
                        <li>Smart coffee stop recommendations</li>
                        <li>Weather-aware departure times</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Ready to get started?</strong> Let's configure your journey!</p>
                `
            }
        ];

        let currentOnboardingStep = 0;

        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('cc-onboarding-completed');
            if (!hasVisited) {
                setTimeout(() => {
                    startOnboarding();
                }, 500);
            } else {
                // Show "Show Tutorial Again" button for returning users
                document.getElementById('show-tutorial-btn').style.display = 'block';
            }
        }

        function startOnboarding() {
            currentOnboardingStep = 0;
            document.getElementById('onboarding-overlay').style.display = 'flex';
            updateOnboardingStep();
        }

        function updateOnboardingStep() {
            const step = ONBOARDING_STEPS[currentOnboardingStep];
            const content = document.getElementById('onboarding-content');
            const prevBtn = document.getElementById('onboarding-prev');
            const nextBtn = document.getElementById('onboarding-next');
            const skipBtn = document.getElementById('onboarding-skip');

            // Clear any previous highlights
            removeAllHighlights();

            // Update content
            content.innerHTML = `
                <h2>${step.title}</h2>
                ${step.content}
            `;

            // Update progress dots
            const dots = document.querySelectorAll('.onboarding-progress-dot');
            dots.forEach((dot, index) => {
                if (index === currentOnboardingStep) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });

            // Update buttons
            if (currentOnboardingStep === 0) {
                prevBtn.style.display = 'none';
                nextBtn.textContent = 'Next ‚Üí';
                skipBtn.style.display = 'block';
            } else if (currentOnboardingStep === ONBOARDING_STEPS.length - 1) {
                prevBtn.style.display = 'block';
                nextBtn.textContent = 'Get Started! üöÄ';
                skipBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'block';
                nextBtn.textContent = 'Next ‚Üí';
                skipBtn.style.display = 'block';
            }

            // Apply highlight if specified
            if (step.highlightElement) {
                setTimeout(() => {
                    highlightElement(step.highlightElement);
                }, 300);
            }

            // Scroll to element if specified
            if (step.scrollTo) {
                setTimeout(() => {
                    const element = document.getElementById(step.scrollTo);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
            }
        }

        function nextOnboardingStep() {
            if (currentOnboardingStep < ONBOARDING_STEPS.length - 1) {
                currentOnboardingStep++;
                updateOnboardingStep();
            } else {
                completeOnboarding();
            }
        }

        function prevOnboardingStep() {
            if (currentOnboardingStep > 0) {
                currentOnboardingStep--;
                updateOnboardingStep();
            }
        }

        function skipOnboarding() {
            if (confirm('Are you sure you want to skip the tutorial? You can always restart it later from the "Show Tutorial" button.')) {
                completeOnboarding();
            }
        }

        function completeOnboarding() {
            localStorage.setItem('cc-onboarding-completed', 'true');
            document.getElementById('onboarding-overlay').style.display = 'none';
            document.getElementById('show-tutorial-btn').style.display = 'block';
            removeAllHighlights();

            // Navigate to setup tab
            showTab('setup');
        }

        function restartTutorial() {
            localStorage.removeItem('cc-onboarding-completed');
            startOnboarding();
            document.getElementById('show-tutorial-btn').style.display = 'none';
        }

        function highlightElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('tutorial-highlight');
            }
        }

        function removeAllHighlights() {
            const highlighted = document.querySelectorAll('.tutorial-highlight');
            highlighted.forEach(el => el.classList.remove('tutorial-highlight'));
        }

        // ==================== END ONBOARDING SYSTEM ====================

        // Progressive UI disclosure removed - all tabs always visible

        // ==================== TOAST NOTIFICATION SYSTEM ====================

        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úó',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Convenience functions
        function showSuccess(title, message) {
            showToast('success', title, message);
        }

        function showError(title, message) {
            showToast('error', title, message);
        }

        function showWarning(title, message) {
            showToast('warning', title, message);
        }

        function showInfo(title, message) {
            showToast('info', title, message);
        }

        // ==================== END TOAST NOTIFICATION SYSTEM ====================

        // ==================== CONFIRMATION MODAL SYSTEM ====================

        function showConfirm(title, message, onConfirm, options = {}) {
            const overlay = document.createElement('div');
            overlay.className = 'confirm-modal-overlay';

            const isDangerous = options.danger || false;
            const confirmText = options.confirmText || 'Confirm';
            const cancelText = options.cancelText || 'Cancel';

            overlay.innerHTML = `
                <div class="confirm-modal">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div class="confirm-modal-buttons">
                        <button class="confirm-btn confirm-btn-cancel" id="confirm-cancel">
                            ${cancelText}
                        </button>
                        <button class="confirm-btn ${isDangerous ? 'confirm-btn-danger' : 'confirm-btn-confirm'}" id="confirm-ok">
                            ${confirmText}
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Handle button clicks
            document.getElementById('confirm-ok').addEventListener('click', () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            });

            document.getElementById('confirm-cancel').addEventListener('click', () => {
                overlay.remove();
            });

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });

            // Close on Escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // ==================== END CONFIRMATION MODAL SYSTEM ====================

        // ==================== INLINE VALIDATION HELPERS ====================

        function validateField(inputId, validator, errorMessage) {
            const input = document.getElementById(inputId);
            const field = input.closest('.form-field') || input.parentElement;

            if (!validator(input.value)) {
                field.classList.add('error');
                field.classList.remove('success');

                let errorEl = field.querySelector('.field-error');
                if (!errorEl) {
                    errorEl = document.createElement('div');
                    errorEl.className = 'field-error';
                    field.appendChild(errorEl);
                }
                errorEl.textContent = errorMessage;
                return false;
            } else {
                field.classList.remove('error');
                field.classList.add('success');

                const errorEl = field.querySelector('.field-error');
                if (errorEl) errorEl.remove();

                let successEl = field.querySelector('.field-success');
                if (!successEl) {
                    successEl = document.createElement('div');
                    successEl.className = 'field-success';
                    field.appendChild(successEl);
                }
                successEl.textContent = 'Looks good!';
                return true;
            }
        }

        function clearFieldValidation(inputId) {
            const input = document.getElementById(inputId);
            const field = input.closest('.form-field') || input.parentElement;

            field.classList.remove('error', 'success');
            const errorEl = field.querySelector('.field-error');
            const successEl = field.querySelector('.field-success');
            if (errorEl) errorEl.remove();
            if (successEl) successEl.remove();
        }

        // ==================== END INLINE VALIDATION HELPERS ====================

        // ==================== JOURNEY PROFILES MANAGEMENT (Task #6) ====================

        let profiles = [];

        // Load all profiles
        async function loadProfiles() {
            try {
                const response = await fetch(BASE_URL + '/api/profiles');
                const data = await response.json();

                if (data.success) {
                    profiles = data.profiles;
                    renderProfiles();
                    updateActiveProfileDisplay();
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        // Render profiles list
        function renderProfiles() {
            const container = document.getElementById('profiles-list');
            if (!container) return;

            if (profiles.length === 0) {
                container.innerHTML = `
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6;">
                        No profiles yet. Create your first journey profile!
                    </div>
                `;
                return;
            }

            container.innerHTML = profiles.map(profile => {
                const isActive = profile.isActive;
                const scheduleText = getScheduleText(profile.schedule);

                return `
                    <div class="profile-card" style="padding: 16px; background: ${isActive ? 'rgba(102, 126, 234, 0.15)' : 'rgba(255,255,255,0.05)'}; border-radius: 10px; border-left: 3px solid ${isActive ? '#4fb28e' : 'rgba(255,255,255,0.2)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-weight: 600; font-size: 15px;">${profile.name}</span>
                                    ${isActive ? '<span style="background: rgba(102, 126, 234, 0.3); color: #4fb28e; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">ACTIVE</span>' : ''}
                                </div>
                                <div style="font-size: 13px; opacity: 0.8;">
                                    üìÖ ${scheduleText}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${!isActive ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="activateProfile('${profile.id}')">Activate</button>` : ''}
                                ${profile.id !== 'default' ? `
                                    <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteProfileConfirm('${profile.id}')">Delete</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update active profile display
        function updateActiveProfileDisplay() {
            const activeProfile = profiles.find(p => p.isActive);
            if (!activeProfile) return;

            const nameEl = document.getElementById('active-profile-name');
            const scheduleEl = document.getElementById('active-profile-schedule');

            if (nameEl) nameEl.textContent = activeProfile.name;
            if (scheduleEl) scheduleEl.textContent = getScheduleText(activeProfile.schedule);
        }

        // Get schedule text description
        function getScheduleText(schedule) {
            if (schedule.type === 'all') return 'Active all days';
            if (schedule.type === 'weekdays') return 'Weekdays only';
            if (schedule.type === 'weekends') return 'Weekends only';
            if (schedule.type === 'custom') {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const days = schedule.days.map(d => dayNames[d]).join(', ');
                return `Custom: ${days}`;
            }
            return 'Custom schedule';
        }

        // Show create profile modal
        function showCreateProfileModal() {
            const modal = document.createElement('div');
            modal.className = 'confirm-modal-overlay';
            modal.innerHTML = `
                <div class="confirm-modal" style="max-width: 600px;">
                    <h3>Create Journey Profile</h3>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Profile Name</label>
                        <input type="text" id="profile-name" placeholder="e.g., Home to Gym" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Schedule</label>
                        <select id="profile-schedule-type" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                            <option value="all">All days</option>
                            <option value="weekdays">Weekdays only</option>
                            <option value="weekends">Weekends only</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Effective Until (Optional)</label>
                        <input type="date" id="profile-until" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 4px;">Leave empty for permanent profile</div>
                    </div>
                    <div class="confirm-modal-buttons">
                        <button class="confirm-btn confirm-btn-cancel" onclick="this.closest('.confirm-modal-overlay').remove()">
                            Cancel
                        </button>
                        <button class="confirm-btn confirm-btn-confirm" onclick="createProfile()">
                            Create Profile
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Create profile
        async function createProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const scheduleType = document.getElementById('profile-schedule-type').value;
            const effectiveUntil = document.getElementById('profile-until').value || null;

            if (!name) {
                showError('Validation Error', 'Please enter a profile name');
                return;
            }

            let days = [0, 1, 2, 3, 4, 5, 6];
            if (scheduleType === 'weekdays') {
                days = [1, 2, 3, 4, 5];
            } else if (scheduleType === 'weekends') {
                days = [0, 6];
            }

            try {
                const response = await fetch(BASE_URL + '/api/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        schedule: {
                            type: scheduleType,
                            days,
                            effectiveUntil
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Profile Created', data.message);
                    document.querySelector('.confirm-modal-overlay').remove();
                    loadProfiles();
                } else {
                    showError('Create Failed', data.error);
                }
            } catch (error) {
                showError('Network Error', error.message);
            }
        }

        // Activate profile
        async function activateProfile(profileId) {
            try {
                const response = await fetch(BASE_URL + `/api/profiles/${profileId}/activate`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Profile Activated', data.message);
                    loadProfiles();
                    loadAllData();
                } else {
                    showError('Activation Failed', data.error);
                }
            } catch (error) {
                showError('Network Error', error.message);
            }
        }

        // Delete profile with confirmation
        function deleteProfileConfirm(profileId) {
            const profile = profiles.find(p => p.id === profileId);
            if (!profile) return;

            showConfirm(
                'Delete Profile?',
                `Are you sure you want to delete "${profile.name}"? This action cannot be undone.`,
                () => deleteProfile(profileId),
                { danger: true, confirmText: 'Delete' }
            );
        }

        // Delete profile
        async function deleteProfile(profileId) {
            try {
                const response = await fetch(BASE_URL + `/api/profiles/${profileId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Profile Deleted', data.message);
                    loadProfiles();
                } else {
                    showError('Delete Failed', data.error);
                }
            } catch (error) {
                showError('Network Error', error.message);
            }
        }

        // ==================== END JOURNEY PROFILES MANAGEMENT ====================

        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);
            loadAllData();
            loadSavedPreferences();
            loadVersionInfo();
            loadAttributions();
            refreshInterval = setInterval(loadAllData, 30000);

            // Check if this is first visit and show onboarding
            checkFirstVisit();

            // Load profiles when on Config tab
            loadProfiles();

            // Load SmartCommute settings and e-ink preview
            loadSmartCommuteSettings();
            loadEinkPreview();
            
            // Auto-refresh e-ink preview every 60 seconds (matches firmware refresh)
            setInterval(() => {
                loadEinkPreview(false);
            }, 60000);
        });

        // Load version control info
        function loadVersionInfo() {
            fetch('/api/version')
                .then(r => r.json())
                .then(v => {
                    const version = v.components?.legacyAdmin?.version || v.version || 'v2.0.0';
                    const systemVersion = v.system?.version || '1.0.0';
                    document.getElementById('versionHash').textContent = `${version} (System ${systemVersion})`;
                    document.getElementById('buildDate').textContent = v.date || new Date().toISOString().split('T')[0];
                })
                .catch(() => {
                    document.getElementById('versionHash').textContent = 'v2.0.0';
                    document.getElementById('buildDate').textContent = new Date().toISOString().split('T')[0];
                });
        }

        // Load required attributions based on configuration
        function loadAttributions() {
            fetch('/api/attributions')
                .then(r => r.json())
                .then(data => {
                    const content = document.getElementById('attributions-content');
                    if (data.attributions && data.attributions.length > 0) {
                        content.innerHTML = data.attributions.map(attr => {
                            const required = attr.required ? ' (Required)' : ' (Optional)';
                            return `<div style="margin-bottom: 4px;">‚Ä¢ ${attr.text} ‚Ä¢ ${attr.license}${attr.required ? '' : required}</div>`;
                        }).join('');
                    } else {
                        content.innerHTML = '<div>No attributions loaded</div>';
                    }
                })
                .catch(() => {
                    document.getElementById('attributions-content').innerHTML = 'Created by <strong>Angus Bergman</strong> ‚Ä¢ Licensed under CC BY-NC 4.0';
                });
        }

        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            if (btn) btn.classList.add('active');

            // Update API keys status when API tab is shown
            if (tabId === 'api') {
                updateAPIKeysStatus();
            }
        }

        // Location-agnostic timezone detection
        let detectedTimezone = null;

        function getTimezoneForState(state) {
            const timezones = {
                'VIC': 'Australia/Melbourne',
                'NSW': 'Australia/Sydney',
                'ACT': 'Australia/Sydney',
                'QLD': 'Australia/Brisbane',
                'SA': 'Australia/Adelaide',
                'WA': 'Australia/Perth',
                'TAS': 'Australia/Hobart',
                'NT': 'Australia/Darwin'
            };
            return timezones[state] || Intl.DateTimeFormat().resolvedOptions().timeZone;
        }

        function updateClock() {
            const now = new Date();
            // Use detected timezone or fallback to browser timezone
            const timezone = detectedTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-AU', {
                timeZone: timezone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-AU', {
                timeZone: timezone, weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
        }

        async function loadAllData() {
            try {
                // Get config from localStorage
                const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
                const transitKey = localStorage.getItem('cc-transit-api-key') || '';
                const hasTransitKey = !!transitKey;
                const transitValidated = localStorage.getItem('cc-transit-api-validated') === 'true';
                
                // Check if configured
                if (!config.addresses?.home) {
                    document.getElementById('train-departures').innerHTML = '<div class="no-data">Complete setup first</div>';
                    document.getElementById('tram-departures').innerHTML = '<div class="no-data">Complete setup first</div>';
                    document.getElementById('weather-display').innerHTML = '<div class="no-data">Complete setup first</div>';
                    document.getElementById('coffee-decision').innerHTML = '<div class="no-data">Complete setup first</div>';
                    return;
                }
                
                // Fetch SmartCommute data - this is the single source of truth per dev rules
                const scResponse = await fetch(BASE_URL + '/api/smartcommute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        home: config.addresses?.home,
                        work: config.addresses?.work,
                        cafe: config.addresses?.cafe,
                        arrivalTime: config.journey?.arrivalTime || '09:00',
                        state: config.state || 'VIC',
                        coffeeEnabled: config.journey?.coffeeEnabled !== false
                    })
                });
                
                const scData = await scResponse.json();
                
                if (scData.success) {
                    // Update Live Data banner
                    const isLive = !scData.fallbackMode && (hasTransitKey && transitValidated);
                    const dataMode = document.getElementById('data-mode');
                    if (dataMode) dataMode.textContent = isLive ? 'Live Data' : 'Timetable';
                    updateLiveDataBanner(isLive, hasTransitKey, transitValidated);
                    
                    // Update departures from nextDeparture
                    updateSmartCommuteDepartures(scData);
                    
                    // Update weather
                    if (scData.weather) {
                        updateWeatherFromSmartCommute(scData.weather);
                    } else {
                        document.getElementById('weather-display').innerHTML = '<div class="no-data">Weather data unavailable</div>';
                    }
                    
                    // Update coffee decision
                    updateCoffeeFromSmartCommute(scData.coffee, scData.summary);
                    
                    // Update journey summary
                    updateJourneySummaryFromSmartCommute(scData);
                } else {
                    throw new Error(scData.error || 'SmartCommute calculation failed');
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                // Show error state in widgets
                document.getElementById('train-departures').innerHTML = `<div class="no-data">Error: ${error.message}</div>`;
                document.getElementById('tram-departures').innerHTML = '<div class="no-data">See train departures</div>';
                document.getElementById('weather-display').innerHTML = '<div class="no-data">Unable to load</div>';
                document.getElementById('coffee-decision').innerHTML = '<div class="no-data">Unable to calculate</div>';
            }
        }
        
        // Update departures from SmartCommute response
        function updateSmartCommuteDepartures(scData) {
            const trainEl = document.getElementById('train-departures');
            const tramEl = document.getElementById('tram-departures');
            
            // Extract departure info from journey legs
            const trainLeg = scData.journey_legs?.find(l => l.type === 'train');
            const tramLeg = scData.journey_legs?.find(l => l.type === 'tram');
            
            if (trainLeg) {
                trainEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; font-size: 14px; color: #f1f5f9;">${sanitize(trainLeg.title)}</div>
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 2px;">${sanitize(trainLeg.subtitle)}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 700; color: #4fb28e;">${trainLeg.minutes}<span style="font-size: 12px; font-weight: 400; color: #94a3b8;"> min</span></div>
                        </div>
                    </div>`;
            } else {
                trainEl.innerHTML = '<div class="no-data" style="color: #94a3b8; text-align: center; padding: 20px;">No train in route</div>';
            }
            
            if (tramLeg) {
                tramEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; font-size: 14px; color: #f1f5f9;">${sanitize(tramLeg.title)}</div>
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 2px;">${sanitize(tramLeg.subtitle)}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 700; color: #667eea;">${tramLeg.minutes}<span style="font-size: 12px; font-weight: 400; color: #94a3b8;"> min</span></div>
                        </div>
                    </div>`;
            } else {
                tramEl.innerHTML = '<div class="no-data" style="color: #94a3b8; text-align: center; padding: 20px;">No tram in route</div>';
            }
        }
        
        // Update weather from SmartCommute response
        function updateWeatherFromSmartCommute(weather) {
            const el = document.getElementById('weather-display');
            if (!weather) {
                el.innerHTML = '<div class="no-data">Weather unavailable</div>';
                return;
            }
            el.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="font-size: 48px; font-weight: 700; color: #f1f5f9;">${weather.temp || '--'}¬∞</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 500; color: #f1f5f9;">${sanitize(weather.condition) || 'N/A'}</div>
                        ${weather.umbrella ? '<div style="font-size: 12px; color: #fbbf24; margin-top: 4px;">‚òÇÔ∏è Bring umbrella</div>' : ''}
                    </div>
                </div>`;
        }
        
        // Update coffee decision from SmartCommute response
        function updateCoffeeFromSmartCommute(coffee, summary) {
            const el = document.getElementById('coffee-decision');
            if (!coffee) {
                el.innerHTML = '<div class="no-data">Unable to calculate</div>';
                return;
            }
            
            const canGet = coffee.canGet;
            const badge = document.getElementById('coffee-status-badge');
            if (badge) {
                badge.textContent = canGet ? 'YES' : 'SKIP';
                badge.style.background = canGet ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                badge.style.color = canGet ? '#22c55e' : '#ef4444';
            }
            
            el.innerHTML = `
                <div style="text-align: center; padding: 16px;">
                    <div style="font-size: 40px; margin-bottom: 8px;">${canGet ? '‚òï' : 'üèÉ'}</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${canGet ? '#22c55e' : '#ef4444'};">${canGet ? 'TIME FOR COFFEE!' : 'SKIP COFFEE'}</div>
                    <div style="font-size: 13px; color: #94a3b8; margin-top: 8px;">${sanitize(coffee.subtext) || (canGet ? 'You have time for a quick coffee' : 'Not enough time today')}</div>
                </div>`;
        }
        
        // Update journey summary from SmartCommute response  
        function updateJourneySummaryFromSmartCommute(scData) {
            const el = document.getElementById('journey-summary');
            if (!scData.journey_legs || scData.journey_legs.length === 0) {
                el.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">No journey data available</div>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            // Summary bar
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(79, 178, 142, 0.15); border-radius: 8px; margin-bottom: 8px;">
                    <div style="font-size: 14px; color: #94a3b8;">Leave <strong style="color: #f1f5f9;">${sanitize(scData.summary?.leaveNow || 'Now')}</strong></div>
                    <div style="font-size: 14px; color: #94a3b8;">Arrive <strong style="color: #4fb28e;">${sanitize(scData.summary?.arriveAt || '--:--')}</strong></div>
                    <div style="font-size: 14px; color: #94a3b8;">Total <strong style="color: #f1f5f9;">${scData.summary?.totalMinutes || '--'} min</strong></div>
                </div>`;
            
            // Journey legs
            scData.journey_legs.forEach((leg, idx) => {
                const icon = { walk: 'üö∂', coffee: '‚òï', train: 'üöÜ', tram: 'üöä', bus: 'üöå' }[leg.type] || 'üöá';
                const stateColor = leg.state === 'delayed' ? '#fbbf24' : leg.state === 'skip' ? '#94a3b8' : '#f1f5f9';
                html += `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; opacity: ${leg.state === 'skip' ? '0.5' : '1'};">
                        <span style="font-size: 20px;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: ${stateColor};">${sanitize(leg.title)}</div>
                            <div style="font-size: 11px; color: #94a3b8;">${sanitize(leg.subtitle)}</div>
                        </div>
                        <div style="font-size: 16px; font-weight: 600; color: #f1f5f9;">${leg.minutes} min</div>
                    </div>`;
            });
            
            html += '</div>';
            el.innerHTML = html;
        }

        function updateSystemStatus(status) {
            // Check both API status AND localStorage (setup wizard saves to localStorage)
            // Per Section 3.6: localStorage is the primary config store for serverless mode
            const localConfigured = localStorage.getItem('cc-configured') === 'true';
            const localConfig = localStorage.getItem('cc-config');
            const isConfigured = status.configured || (localConfigured && !!localConfig);

            // Set timezone based on detected state (location agnostic)
            if (status.location && status.location.state) {
                detectedTimezone = getTimezoneForState(status.location.state);
                console.log(`Timezone set to ${detectedTimezone} for state ${status.location.state}`);
            }

            // Control Live Data tab visibility based on configuration status
            const liveDataUnconfigured = document.getElementById('live-data-unconfigured');
            const liveDataConfigured = document.getElementById('live-data-configured');

            if (liveDataUnconfigured && liveDataConfigured) {
                if (isConfigured) {
                    liveDataUnconfigured.style.display = 'none';
                    liveDataConfigured.style.display = 'block';
                } else {
                    liveDataUnconfigured.style.display = 'block';
                    liveDataConfigured.style.display = 'none';
                }
            }

            // Update configuration banner
            const configSummary = document.getElementById('config-summary');
            if (configSummary) {
                configSummary.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 12px;">
                        <div><strong>Location:</strong> ${status.location.city}, ${status.location.state}</div>
                        <div><strong>Transit Authority:</strong> ${status.location.transitAuthority}</div>
                        <div><strong>Status:</strong> <span style="color: ${isConfigured ? '#22c55e' : '#fc8181'}; font-weight: 600;">${isConfigured ? '‚úì Configured' : '‚úó Not Configured'}</span></div>
                        <div><strong>Auto-Calc:</strong> ${status.journey.autoCalculation.active ? '‚úì Active' : '‚úó Inactive'}</div>
                    </div>
                `;
            }

            // Update data source indicator in Live Data tab
            updateDataSourceIndicator(status.apis);

            // Update data sources list in Configuration tab
            updateDataSourcesList(status.apis, status.location.state);

            // Update user configuration display
            updateUserConfigDisplay(status);

            // Show/hide Victorian GTFS viewer based on state
            updateVictorianGTFSViewer(status.location.state);

            // Update station names in live data widgets
            if (status.transitStations.mode1.origin !== 'Not configured') {
                const trainHeader = document.getElementById('train-station-name');
                if (trainHeader) {
                    trainHeader.textContent = `${status.transitStations.mode1.origin}`;
                }
            }

            if (status.transitStations.mode2 && status.transitStations.mode2.origin !== 'Not configured') {
                const tramHeader = document.getElementById('tram-station-name');
                if (tramHeader) {
                    tramHeader.textContent = `${status.transitStations.mode2.origin}`;
                }
            }

            // Update weather location
            const weatherHeader = document.getElementById('weather-location-name');
            if (weatherHeader && status.location.city !== 'Not configured') {
                weatherHeader.textContent = `Weather - ${status.location.city}`;
            }

            // Update API status grid
            updateApiStatusGrid(status.apis);

            // Update status badges
            updateStatusBadges(status);
        }

        function updateDataSourcesList(apis, state) {
            const dataSourcesList = document.getElementById('data-sources-list');
            if (!dataSourcesList) return;

            const sources = [];

            // Transit Authority API
            sources.push(`
                <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 3px solid ${apis.transitAuthority.configured ? '#22c55e' : '#fc8181'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 14px;">üöÜ ${apis.transitAuthority.name}</div>
                        <span style="padding: 4px 10px; background: ${apis.transitAuthority.configured ? 'rgba(72, 187, 120, 0.2)' : 'rgba(252, 129, 129, 0.2)'}; border-radius: 12px; font-size: 11px; font-weight: 600; color: ${apis.transitAuthority.configured ? '#22c55e' : '#fc8181'};">
                            ${apis.transitAuthority.configured ? '‚úì Active' : '‚úó Not Configured'}
                        </span>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                        <strong>Purpose:</strong> Real-time transit departures & route planning
                    </div>
                    <div style="font-size: 11px; opacity: 0.6;">${apis.transitAuthority.baseUrl || 'Configure in API Credentials section'}</div>
                </div>
            `);

            // Nominatim/OpenStreetMap (always active)
            sources.push(`
                <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #22c55e;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 14px;">üó∫Ô∏è OpenStreetMap / Nominatim</div>
                        <span style="padding: 4px 10px; background: rgba(72, 187, 120, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #22c55e;">
                            ‚úì Always Active
                        </span>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                        <strong>Purpose:</strong> Address geocoding & location search
                    </div>
                    <div style="font-size: 11px; opacity: 0.6;"><a href="https://nominatim.openstreetmap.org" target="_blank" style="color: inherit;">https://nominatim.openstreetmap.org</a></div>
                </div>
            `);

            // Google Places (if configured)
            if (apis.googlePlaces && apis.googlePlaces.configured) {
                sources.push(`
                    <div style="padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 3px solid #fbbf24;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px;">üìç Google Places API</div>
                            <span style="padding: 4px 10px; background: rgba(72, 187, 120, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #22c55e;">
                                ‚úì Active
                            </span>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                            <strong>Purpose:</strong> Enhanced geocoding, cafe busy-ness detection
                        </div>
                        <div style="font-size: 11px; opacity: 0.6;">Google Maps Platform</div>
                    </div>
                `);
            }

            // BOM Weather
            if (apis.bom) {
                sources.push(`
                    <div style="padding: 15px; background: rgba(72, 187, 120, 0.1); border-radius: 8px; border-left: 3px solid #22c55e;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px;">üå§Ô∏è Bureau of Meteorology</div>
                            <span style="padding: 4px 10px; background: rgba(72, 187, 120, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #22c55e;">
                                ‚úì Active
                            </span>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                            <strong>Purpose:</strong> Local weather forecasts & conditions
                        </div>
                        <div style="font-size: 11px; opacity: 0.6;"><a href="http://www.bom.gov.au" target="_blank" style="color: inherit;">http://www.bom.gov.au</a></div>
                    </div>
                `);
            }

            // Victorian GTFS Realtime API (Victoria only)
            if (state === 'VIC') {
                sources.push(`
                    <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 3px solid #4fb28e;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px;">üöÇ Transport for Victoria - GTFS Realtime</div>
                            <span style="padding: 4px 10px; background: rgba(251, 191, 36, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #fbbf24;">
                                Configure in API section
                            </span>
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                            <strong>Purpose:</strong> Real-time metro train trip updates (delays, cancellations)
                        </div>
                        <div style="font-size: 11px; opacity: 0.6;">
                            <a href="https://opendata.transport.vic.gov.au" target="_blank" style="color: inherit;">https://api.opendata.transport.vic.gov.au</a> ‚Ä¢ See <strong>VICTORIA-GTFS-REALTIME-PROTOCOL.md</strong>
                        </div>
                    </div>
                `);
            }

            // Fallback Timetables
            sources.push(`
                <div style="padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #4fb28e;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 14px;">üóÉÔ∏è Fallback Timetables</div>
                        <span style="padding: 4px 10px; background: rgba(72, 187, 120, 0.2); border-radius: 12px; font-size: 11px; font-weight: 600; color: #22c55e;">
                            ‚úì Ready
                        </span>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                        <strong>Purpose:</strong> Offline transit stop data for all Australian states
                    </div>
                    <div style="font-size: 11px; opacity: 0.6;">
                        Current state: <strong>${state || 'Not detected'}</strong> ‚Ä¢ 80+ stops across VIC, NSW, QLD, SA, WA, TAS, ACT, NT
                    </div>
                </div>
            `);

            dataSourcesList.innerHTML = sources.join('');
        }

        function updateDataSourceIndicator(apis) {
            const indicator = document.getElementById('data-source-indicator');
            const icon = document.getElementById('data-source-icon');
            const title = document.getElementById('data-source-title');
            const subtitle = document.getElementById('data-source-subtitle');
            const actionBtn = document.getElementById('data-source-action-btn');

            if (!indicator) return;

            // Check BOTH server status AND localStorage for live data
            const transitValidated = localStorage.getItem('cc-transit-api-validated') === 'true';
            const hasTransitKey = !!localStorage.getItem('cc-transit-api-key');
            const serverHasLive = apis && apis.transitAuthority && apis.transitAuthority.configured;
            const hasLiveData = serverHasLive || (hasTransitKey && transitValidated);

            if (hasLiveData) {
                // Live data mode
                indicator.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%)';
                indicator.style.borderLeft = '4px solid #22c55e';
                icon.textContent = 'üü¢';
                title.textContent = 'Live Data Active';
                subtitle.textContent = 'Real-time transit updates enabled ‚Ä¢ Refreshing automatically';
                actionBtn.textContent = 'üîÑ Refresh Now';
                actionBtn.onclick = () => loadAllData();
            } else {
                // Fallback data mode
                indicator.style.background = 'linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%)';
                indicator.style.borderLeft = '4px solid #fbbf24';
                icon.textContent = 'üî¥';
                title.textContent = 'Using Fallback Timetable Data';
                subtitle.textContent = 'Configure API keys in API Settings to enable real-time updates';
                actionBtn.textContent = '‚Üí API Settings';
                actionBtn.onclick = () => showTab('api');
            }
        }
        
        // Update Live Data tab banner based on localStorage validation status
        function updateLiveDataBanner(isLive, hasKey, isValidated) {
            const indicator = document.getElementById('data-source-indicator');
            const icon = document.getElementById('data-source-icon');
            const title = document.getElementById('data-source-title');
            const subtitle = document.getElementById('data-source-subtitle');
            const actionBtn = document.getElementById('data-source-action-btn');
            
            if (!indicator) return;
            
            if (isLive) {
                indicator.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%)';
                indicator.style.borderLeft = '4px solid #22c55e';
                icon.textContent = 'üü¢';
                title.textContent = 'Live Data Active';
                subtitle.textContent = 'Transit API validated ‚Ä¢ Real-time updates enabled';
                actionBtn.textContent = 'üîÑ Refresh Now';
                actionBtn.onclick = () => loadAllData();
            } else if (hasKey && !isValidated) {
                indicator.style.background = 'linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%)';
                indicator.style.borderLeft = '4px solid #fbbf24';
                icon.textContent = 'üü°';
                title.textContent = 'API Key Pending Validation';
                subtitle.textContent = 'Go to API Settings to test and validate your key';
                actionBtn.textContent = '‚Üí Validate Key';
                actionBtn.onclick = () => showTab('api');
            }
        }

        function updateUserConfigDisplay(status) {
            const userConfigDisplay = document.getElementById('user-config-display');
            if (!userConfigDisplay) return;

            // Check both API status AND localStorage (consistent with updateSystemStatus)
            const localConfigured = localStorage.getItem('cc-configured') === 'true';
            const localConfig = localStorage.getItem('cc-config');
            const isConfigured = status.configured || (localConfigured && !!localConfig);

            if (!isConfigured) {
                userConfigDisplay.innerHTML = `
                    <div style="padding: 30px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                        <div style="font-size: 40px; opacity: 0.3; margin-bottom: 15px;">‚öôÔ∏è</div>
                        <div style="opacity: 0.7; margin-bottom: 15px;">No configuration yet</div>
                        <button class="btn btn-primary" onclick="showTab('setup', this)">‚Üí Go to Setup</button>
                    </div>
                `;
                return;
            }

            const config = [];

            // Addresses
            config.push(`
                <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">üìç Addresses</div>
                    <div style="font-size: 13px; line-height: 1.8;">
                        <div><strong>Home:</strong> ${sanitize(status.addresses.home || 'Not set')}</div>
                        <div><strong>Work:</strong> ${sanitize(status.addresses.work || 'Not set')}</div>
                        ${status.addresses.cafe ? `<div><strong>Cafe:</strong> ${sanitize(status.addresses.cafe)}</div>` : ''}
                    </div>
                </div>
            `);

            // Transit Stops
            config.push(`
                <div style="padding: 15px; background: rgba(64, 220, 165, 0.1); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">üöâ Transit Stops</div>
                    <div style="font-size: 13px; line-height: 1.8;">
                        <div><strong>From:</strong> ${status.transitStations.mode1.origin || 'Not set'}</div>
                        <div><strong>To:</strong> ${status.transitStations.mode1.destination || 'Not set'}</div>
                        <div><strong>Mode:</strong> ${status.transitStations.mode1.type || 'Not set'}</div>
                        ${status.transitStations.mode2 && status.transitStations.mode2.origin !== 'Not configured' ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <strong>Transfer:</strong> ${status.transitStations.mode2.origin} ‚Üí ${status.transitStations.mode2.destination} (${status.transitStations.mode2.type})
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);

            // Journey Preferences
            config.push(`
                <div style="padding: 15px; background: rgba(246, 173, 85, 0.1); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">‚è∞ Journey Preferences</div>
                    <div style="font-size: 13px; line-height: 1.8;">
                        <div><strong>Arrival Time:</strong> ${formatTime12h(status.journey.arrivalTime) || 'Not set'}</div>
                        <div><strong>Coffee Stops:</strong> ${status.journey.coffeeEnabled ? '‚úì Enabled' : '‚úó Disabled'}</div>
                        ${status.journey.walkingTimes ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <strong>Walking Times:</strong><br>
                                Home ‚Üí Station: ${status.journey.walkingTimes.homeToStation || 'Calculating...'}<br>
                                ${status.addresses.cafe ? `Home ‚Üí Cafe: ${status.journey.walkingTimes.homeToCafe || 'Calculating...'}<br>` : ''}
                                ${status.addresses.cafe ? `Cafe ‚Üí Station: ${status.journey.walkingTimes.cafeToStation || 'Calculating...'}<br>` : ''}
                                Station ‚Üí Work: ${status.journey.walkingTimes.stationToWork || 'Calculating...'}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);

            userConfigDisplay.innerHTML = config.join('');
        }

        function updateVictorianGTFSViewer(state) {
            const viewer = document.getElementById('victoria-gtfs-viewer');
            const gtfsConfig = document.getElementById('victoria-gtfs-config');
            const transitApiTitle = document.getElementById('transit-api-title');
            const transitApiDesc = document.getElementById('transit-api-description');
            const transitApiDescGeneric = document.getElementById('transit-api-description-generic');

            // Show/hide Victorian-specific elements
            if (state === 'VIC') {
                if (viewer) viewer.style.display = 'block';
                if (gtfsConfig) gtfsConfig.style.display = 'block';
                if (transitApiDesc) transitApiDesc.style.display = 'block';
                if (transitApiDescGeneric) transitApiDescGeneric.style.display = 'none';

                // Update transit API title for Victorian users
                if (transitApiTitle) transitApiTitle.textContent = 'Transport for Victoria - OpenData API';

                console.log('‚úÖ Victorian features enabled');
            } else {
                if (viewer) viewer.style.display = 'none';
                if (gtfsConfig) gtfsConfig.style.display = 'none';
                if (transitApiDesc) transitApiDesc.style.display = 'none';
                if (transitApiDescGeneric) transitApiDescGeneric.style.display = 'block';

                // Generic title for non-Victorian users
                if (transitApiTitle) transitApiTitle.textContent = 'Transit Authority API';

                console.log(`‚ÑπÔ∏è  State-specific features hidden (state: ${state || 'unknown'})`);
            }
        }

        function updateApiStatusGrid(apis) {
            const grid = document.getElementById('api-status-grid');
            if (!grid) return;

            const apiCards = [];

            // Transit Authority API
            apiCards.push(createApiCard(
                'üöÜ',
                apis.transitAuthority.name,
                apis.transitAuthority.configured ? 'Configured' : 'Not Configured',
                apis.transitAuthority.status,
                apis.transitAuthority.baseUrl
            ));

            // Weather API
            apiCards.push(createApiCard(
                'üå§Ô∏è',
                apis.weather.name,
                apis.weather.service,
                apis.weather.status,
                'Always Active'
            ));

            // Geocoding
            apiCards.push(createApiCard(
                'üìç',
                apis.geocoding.name,
                `${apis.geocoding.services.length} Services Available`,
                apis.geocoding.status,
                apis.geocoding.services.join(', ')
            ));

            // Google Places (if configured)
            if (apis.googlePlaces.configured) {
                apiCards.push(createApiCard(
                    'üó∫Ô∏è',
                    apis.googlePlaces.name,
                    'Enhanced Geocoding',
                    apis.googlePlaces.status,
                    'Active'
                ));
            }

            // Mapbox (if configured)
            if (apis.mapbox.configured) {
                apiCards.push(createApiCard(
                    'üåê',
                    apis.mapbox.name,
                    'Address Geocoding',
                    apis.mapbox.status,
                    'Active'
                ));
            }

            // HERE (if configured)
            if (apis.here.configured) {
                apiCards.push(createApiCard(
                    'üåè',
                    apis.here.name,
                    'Australian Address Optimization',
                    apis.here.status,
                    'Active'
                ));
            }

            grid.innerHTML = apiCards.join('');
        }

        function createApiCard(icon, name, description, status, details) {
            const statusColor = status === 'active' ? '#22c55e' : status === 'optional' ? '#f6ad55' : '#fc8181';
            const statusText = status === 'active' ? 'Active' : status === 'optional' ? 'Optional' : 'Inactive';

            return `
                <div style="padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 4px solid ${statusColor};">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="font-size: 24px;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 13px;">${name}</div>
                            <div style="font-size: 11px; opacity: 0.7;">${description}</div>
                        </div>
                        <div style="padding: 4px 8px; background: ${statusColor}33; color: ${statusColor}; border-radius: 4px; font-size: 10px; font-weight: 600;">
                            ${statusText}
                        </div>
                    </div>
                    <div style="font-size: 10px; opacity: 0.6; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                        ${details}
                    </div>
                </div>
            `;
        }

        function updateStatusBadges(status) {
            // Update train status
            const trainStatus = document.getElementById('train-status');
            if (trainStatus) {
                trainStatus.style.color = status.apis.transitAuthority.configured ? '#22c55e' : '#fc8181';
                trainStatus.textContent = status.apis.transitAuthority.configured ? '‚óè Live' : '‚óè Offline';
            }

            // Update tram status
            const tramStatus = document.getElementById('tram-status');
            if (tramStatus) {
                tramStatus.style.color = status.apis.transitAuthority.configured ? '#22c55e' : '#fc8181';
                tramStatus.textContent = status.apis.transitAuthority.configured ? '‚óè Live' : '‚óè Offline';
            }

            // Update coffee status
            const coffeeStatus = document.getElementById('coffee-status');
            if (coffeeStatus) {
                coffeeStatus.style.color = status.journey.configured ? '#22c55e' : '#fc8181';
                coffeeStatus.textContent = status.journey.configured ? '‚óè Active' : '‚óè Inactive';
            }
        }

        async function loadAutoCalcStatus() {
            try {
                const response = await fetch(BASE_URL + '/api/journey-cache');
                const data = await response.json();
                const statusDiv = document.getElementById('auto-calc-status');

                if (data.cached) {
                    const calcTime = new Date(data.calculatedAt);
                    const timeAgo = getTimeAgo(calcTime);

                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 8px rgba(72, 187, 120, 0.6);"></div>
                            <span style="font-weight: 600; color: #22c55e;">Active</span>
                        </div>
                        <div style="font-size: 13px; opacity: 0.8; line-height: 1.6;">
                            <strong>Last Calculated:</strong> ${calcTime.toLocaleTimeString()}<br>
                            <strong>Time Ago:</strong> ${timeAgo}<br>
                            <strong>Arrival Time:</strong> ${data.journey?.arrivalTime || 'N/A'}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 8px; height: 8px; background: #f6ad55; border-radius: 50%;"></div>
                            <span style="font-weight: 600; color: #f6ad55;">Pending</span>
                        </div>
                        <div style="font-size: 13px; opacity: 0.8;">
                            No journey calculated yet. Configure your addresses and API credentials.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading auto-calc status:', error);
            }
        }

        async function forceRecalculation() {
            const btn = document.getElementById('recalc-btn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Calculating...';

            try {
                const response = await fetch(BASE_URL + '/api/journey-recalculate', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Journey recalculated successfully!');
                    loadAutoCalcStatus();
                    loadJourneySummary();
                } else {
                    alert('‚ùå ' + (data.message || 'Calculation failed. Check your configuration.'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Recalculate Now';
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds} seconds ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
        }

        function updateDepartures(data) {
            const trains = data.data?.trains || [];
            const trams = data.data?.trams || [];

            document.getElementById('train-departures').innerHTML = trains.length ?
                trains.slice(0, 4).map(d => `
                    <div class="departure-row">
                        <div><div class="departure-dest">${d.destination || d.direction || 'Unknown'}</div></div>
                        <div class="departure-time">${d.minutes || d.minutesToDeparture || '--'}<span> min</span></div>
                    </div>
                `).join('') : '<div class="no-data">No departures</div>';

            document.getElementById('tram-departures').innerHTML = trams.length ?
                trams.slice(0, 4).map(d => `
                    <div class="departure-row">
                        <div><div class="departure-dest">${d.destination || d.direction || 'Unknown'}</div></div>
                        <div class="departure-time">${d.minutes || d.minutesToDeparture || '--'}<span> min</span></div>
                    </div>
                `).join('') : '<div class="no-data">No departures</div>';
        }

        function updateWeather(data) {
            const temp = data.current?.temperature || data.temperature || '--';
            const condition = data.current?.condition?.full || data.condition || 'Unknown';
            const humidity = data.current?.humidity || data.humidity || '--';
            document.getElementById('weather-source').textContent = data.source || 'BOM';
            document.getElementById('weather-display').innerHTML = `
                <div class="weather-display">
                    <div class="weather-temp">${temp}¬∞</div>
                    <div><div class="weather-condition">${condition}</div><div class="weather-extra">Humidity ${humidity}%</div></div>
                </div>
            `;
        }

        async function loadCoffeeDecision() {
            try {
                const route = await fetch(BASE_URL + '/admin/route').then(r => r.json());
                if (route?.coffee_decision) {
                    document.getElementById('coffee-decision').innerHTML = `
                        <div class="coffee-icon">${route.coffee_decision.can_get_coffee ? '‚òï' : '‚è∞'}</div>
                        <div class="coffee-text">${route.coffee_decision.can_get_coffee ? 'Time for Coffee!' : 'Skip Coffee'}</div>
                        <div class="coffee-subtext">${route.coffee_decision.message || ''}</div>
                    `;
                } else {
                    document.getElementById('coffee-decision').innerHTML = `
                        <div class="coffee-icon">‚òï</div>
                        <div class="coffee-text">Plan a Journey</div>
                        <div class="coffee-subtext">Configure your route first</div>
                    `;
                }
            } catch (e) {
                document.getElementById('coffee-decision').innerHTML = `
                    <div class="coffee-icon">‚òï</div><div class="coffee-text">Plan a Journey</div>
                `;
            }
        }

        async function loadJourneySummary() {
            try {
                const journey = await fetch(BASE_URL + '/admin/route/auto').then(r => r.json());
                if (journey?.success && journey?.route) {
                    document.getElementById('journey-summary-card').style.display = 'block';

                    let legsHTML = '';
                    const route = journey.route;

                    // Display all journey legs
                    if (route.legs && route.legs.length > 0) {
                        legsHTML = route.legs.map((leg, idx) => {
                            const icon = {
                                'train': 'üöÜ',
                                'tram': 'üöä',
                                'bus': 'üöå',
                                'walk': 'üö∂',
                                'walking': 'üö∂',
                                'coffee': '‚òï'
                            }[leg.type?.toLowerCase()] || 'üö∂';

                            return `
                                <div style="display: flex; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                                    <div style="font-size: 28px; margin-right: 15px;">${icon}</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">${leg.route || leg.description || 'Walking'}</div>
                                        <div style="font-size: 13px; opacity: 0.8;">
                                            ${leg.from || ''} ${leg.to ? '‚Üí ' + leg.to : ''}
                                        </div>
                                        ${leg.departureTime ? `<div style="font-size: 12px; margin-top: 4px;">Depart: ${leg.departureTime}</div>` : ''}
                                    </div>
                                    <div style="text-align: right; font-size: 13px;">
                                        ${leg.duration ? `<div>${leg.duration} min</div>` : ''}
                                        ${leg.delay ? `<div style="color: #fc8181; font-weight: 600;">+${leg.delay} min delay</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }

                    document.getElementById('journey-summary').innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="padding: 15px; background: rgba(102, 126, 234, 0.15); border-radius: 8px;">
                                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">üè† Leave Home</div>
                                    <div style="font-size: 24px; font-weight: 700;">${journey.summary?.must_leave_home || route.startTime || '--:--'}</div>
                                </div>
                                <div style="padding: 15px; background: rgba(72, 187, 120, 0.15); border-radius: 8px;">
                                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">üè¢ Arrive Work</div>
                                    <div style="font-size: 24px; font-weight: 700;">${journey.arrivalTime || journey.summary?.arrival_at_work || '--:--'}</div>
                                </div>
                            </div>

                            ${route.includedCoffee ? `
                                <div style="padding: 12px; background: rgba(237, 137, 54, 0.15); border-radius: 8px; margin-bottom: 15px; text-align: center;">
                                    ‚òï Coffee stop included at ${route.cafeName || 'selected cafe'}
                                    ${route.coffeeWaitTime ? ` (${route.coffeeWaitTime} min wait)` : ''}
                                </div>
                            ` : ''}

                            <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">üìç Journey Breakdown:</div>
                            ${legsHTML || '<div style="opacity: 0.6;">No journey legs available</div>'}

                            ${journey.warnings && journey.warnings.length > 0 ? `
                                <div style="margin-top: 15px; padding: 12px; background: rgba(252, 129, 129, 0.15); border-radius: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Warnings:</div>
                                    ${journey.warnings.map(w => `<div style="font-size: 13px; margin-bottom: 4px;">‚Ä¢ ${w}</div>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else if (journey?.summary) {
                    // Fallback for old format
                    document.getElementById('journey-summary-card').style.display = 'block';
                    document.getElementById('journey-summary').innerHTML = `
                        <div class="route-summary">
                            <div class="route-time"><div class="route-time-label">Leave Home</div><div class="route-time-value">${journey.summary.must_leave_home || '--:--'}</div></div>
                            <div class="route-time"><div class="route-time-label">Arrive Work</div><div class="route-time-value">${journey.summary.arrival_at_work || '--:--'}</div></div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Journey summary error:', e);
                document.getElementById('journey-summary-card').style.display = 'none';
            }
        }

        function addTransitLeg() {
            document.getElementById('transit-mode-2').style.display = 'block';
            document.getElementById('add-mode-btn').style.display = 'none';
        }

        function removeTransitLeg() {
            document.getElementById('transit-mode-2').style.display = 'none';
            document.getElementById('add-mode-btn').style.display = 'flex';
            document.getElementById('mode2-origin').value = '';
            document.getElementById('mode2-destination').value = '';
        }

        async function planJourney() {
            document.getElementById('plan-btn-text').textContent = 'Planning...';
            const hasMode2 = document.getElementById('transit-mode-2').style.display !== 'none';

            const data = {
                homeAddress: document.getElementById('home-address').value,
                workAddress: document.getElementById('work-address').value,
                cafeAddress: document.getElementById('cafe-address').value,
                arrivalTime: document.getElementById('arrival-time').value,
                includeCoffee: document.getElementById('include-coffee').checked,
                coffeeTime: parseInt(document.getElementById('coffee-time').value) || 5,
                transitRoute: {
                    numberOfModes: hasMode2 ? 2 : 1,
                    mode1: { type: parseInt(document.getElementById('mode1-type').value), originStation: { name: document.getElementById('mode1-origin').value }, destinationStation: { name: document.getElementById('mode1-destination').value } },
                    mode2: hasMode2 ? { type: parseInt(document.getElementById('mode2-type').value), originStation: { name: document.getElementById('mode2-origin').value }, destinationStation: { name: document.getElementById('mode2-destination').value } } : null
                }
            };

            try {
                const result = await fetch(BASE_URL + '/admin/route/auto-plan', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
                }).then(r => r.json());

                if (result.success) {
                    showMessage('planner-message', 'Journey planned!', 'success');
                    document.getElementById('journey-result').style.display = 'block';
                    document.getElementById('journey-result-content').innerHTML = `
                        <div class="route-summary">
                            <div class="route-time"><div class="route-time-label">Leave Home</div><div class="route-time-value">${result.journey?.summary?.must_leave_home || '--:--'}</div></div>
                            <div class="route-time"><div class="route-time-label">Arrive Work</div><div class="route-time-value">${result.journey?.summary?.arrival_at_work || '--:--'}</div></div>
                        </div>
                    `;
                    localStorage.setItem('cc-journey-prefs', JSON.stringify(data));
                    loadJourneySummary();
                    loadCoffeeDecision();
                } else {
                    showMessage('planner-message', result.error || 'Failed', 'error');
                }
            } catch (e) {
                showMessage('planner-message', 'Error: ' + e.message, 'error');
            }
            document.getElementById('plan-btn-text').textContent = 'Plan My Journey';
        }

        async function loadSavedPreferences() {
            let prefs = null;
            let source = 'none';
            
            // First try localStorage (for Vercel serverless mode)
            const localConfig = localStorage.getItem('cc-config');
            if (localConfig) {
                try {
                    prefs = JSON.parse(localConfig);
                    source = 'localStorage';
                    console.log('‚úÖ Preferences loaded from localStorage (serverless mode)');
                } catch (e) {
                    console.warn('Failed to parse localStorage config:', e);
                }
            }
            
            // If no localStorage, try server (for self-hosted mode)
            if (!prefs) {
                try {
                    const response = await fetch(BASE_URL + '/api/admin/preferences');
                    if (response.ok) {
                        const data = await response.json();
                        prefs = data.preferences || data;
                        source = 'server';
                        console.log('‚úÖ Preferences loaded from server');
                    }
                } catch (error) {
                    console.warn('Server preferences not available (expected on Vercel):', error.message);
                }
            }
            
            // Apply preferences to form fields
            if (prefs) {
                // Load addresses
                if (prefs.addresses) {
                    if (document.getElementById('home-address')) {
                        document.getElementById('home-address').value = prefs.addresses.home || '';
                    }
                    if (document.getElementById('cafe-address')) {
                        document.getElementById('cafe-address').value = prefs.addresses.cafe || '';
                    }
                    if (document.getElementById('cafe-name')) {
                        document.getElementById('cafe-name').value = prefs.addresses.cafeName || '';
                    }
                    if (document.getElementById('work-address')) {
                        document.getElementById('work-address').value = prefs.addresses.work || '';
                    }
                }

                // Load journey preferences
                if (prefs.journey) {
                    if (document.getElementById('arrival-time')) {
                        document.getElementById('arrival-time').value = prefs.journey.arrivalTime || '09:00';
                    }

                    // Load transit route if configured
                    if (prefs.journey.transitRoute?.mode1) {
                        if (document.getElementById('mode1-type')) {
                            document.getElementById('mode1-type').value = prefs.journey.transitRoute.mode1.type || 0;
                        }
                        if (document.getElementById('mode1-origin')) {
                            document.getElementById('mode1-origin').value = prefs.journey.transitRoute.mode1.originStation?.name || '';
                        }
                        if (document.getElementById('mode1-destination')) {
                            document.getElementById('mode1-destination').value = prefs.journey.transitRoute.mode1.destinationStation?.name || '';
                        }
                    }
                }

                // Load API credentials
                if (prefs.api) {
                    if (document.getElementById('ptv-dev-id')) {
                        document.getElementById('ptv-dev-id').value = prefs.api.key || '';
                    }
                    if (document.getElementById('ptv-api-key')) {
                        document.getElementById('ptv-api-key').value = prefs.api.token || '';
                    }
                }
                
                // Update config summary display
                updateConfigSummary(prefs);
            } else {
                console.log('‚ÑπÔ∏è No preferences found - complete setup wizard first');
            }
        }
        
        // Convert 24-hour time to 12-hour format (DEVELOPMENT-RULES 12.2)
        function formatTime12h(time24) {
            if (!time24) return '';
            const [hours24, minutes] = time24.split(':').map(Number);
            const hours12 = hours24 % 12 || 12;
            const ampm = hours24 >= 12 ? 'pm' : 'am';
            return `${hours12}:${minutes.toString().padStart(2, '0')}${ampm}`;
        }
        
        function updateConfigSummary(prefs) {
            // Update the old config-summary element (if exists)
            const summaryEl = document.getElementById('config-summary');
            if (summaryEl && prefs) {
                const parts = [];
                if (prefs.addresses?.home) parts.push(`Home: ${prefs.addresses.home}`);
                if (prefs.addresses?.work) parts.push(`Work: ${prefs.addresses.work}`);
                if (prefs.addresses?.cafe) parts.push(`Cafe: ${prefs.addresses.cafe}`);
                if (prefs.journey?.arrivalTime) parts.push(`Arrive by ${formatTime12h(prefs.journey.arrivalTime)}`);
                if (prefs.state) parts.push(prefs.state);
                if (prefs.apiMode) parts.push(prefs.apiMode === 'cached' ? 'Free Mode' : 'Live Mode');
                
                if (parts.length > 0) {
                    summaryEl.innerHTML = parts.join(' ‚Ä¢ ');
                } else {
                    summaryEl.innerHTML = 'No configuration yet. <a href="/setup-wizard.html" style="color: #4fb28e;">Complete setup</a>';
                }
            }
            
            // Update the new Live Data tab journey config summary
            updateLiveDataJourneyConfig(prefs);
            
            // Also update the new Setup & Journey tab summary
            updateSetupTabSummary(prefs);
            
            // Also update the API Settings tab
            updateApiSettingsTab(prefs);
        }
        
        // Update Live Data tab journey configuration display
        function updateLiveDataJourneyConfig(prefs) {
            const summaryEl = document.getElementById('journey-config-summary');
            const unconfigured = document.getElementById('live-data-unconfigured');
            const configured = document.getElementById('live-data-configured');
            
            const hasConfig = prefs && (prefs.addresses?.home || prefs.addresses?.work);
            
            if (unconfigured && configured) {
                unconfigured.style.display = hasConfig ? 'none' : 'block';
                configured.style.display = hasConfig ? 'block' : 'none';
            }
            
            if (summaryEl && prefs && hasConfig) {
                const parts = [];
                if (prefs.addresses?.home) parts.push(`<strong>Home:</strong> ${prefs.addresses.home}`);
                if (prefs.addresses?.cafe) parts.push(`<strong>Coffee:</strong> ${prefs.addresses.cafe}`);
                if (prefs.addresses?.work) parts.push(`<strong>Work:</strong> ${prefs.addresses.work}`);
                if (prefs.journey?.arrivalTime) parts.push(`<strong>Arrive:</strong> ${formatTime12h(prefs.journey.arrivalTime)}`);
                if (prefs.state) parts.push(`<strong>State:</strong> ${prefs.state}`);
                
                summaryEl.innerHTML = parts.join(' &bull; ');
            }
            
            // Update SmartCommute status based on API validation
            updateSmartCommuteStatus(prefs);
        }
        
        // Update SmartCommute status banner
        function updateSmartCommuteStatus(prefs) {
            const banner = document.getElementById('smartcommute-status-banner');
            const iconContainer = document.getElementById('smartcommute-status-icon');
            const title = document.getElementById('smartcommute-status-title');
            const subtitle = document.getElementById('smartcommute-status-subtitle');
            
            if (!banner) return;
            
            const transitValidated = localStorage.getItem('cc-transit-api-validated') === 'true';
            const hasTransitKey = !!localStorage.getItem('cc-transit-api-key');
            
            if (hasTransitKey && transitValidated) {
                banner.style.background = 'linear-gradient(135deg, rgba(79, 178, 142, 0.15) 0%, rgba(34, 197, 94, 0.15) 100%)';
                banner.style.borderLeftColor = '#4fb28e';
                iconContainer.style.background = '#22c55e';
                iconContainer.innerHTML = '<svg width="18" height="18" style="color: white;"><use href="#icon-check"/></svg>';
                title.textContent = 'SmartCommute Active';
                subtitle.textContent = 'Real-time journey calculation enabled';
            } else if (hasTransitKey) {
                banner.style.background = 'linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%)';
                banner.style.borderLeftColor = '#fbbf24';
                iconContainer.style.background = '#fbbf24';
                iconContainer.innerHTML = '<svg width="18" height="18" style="color: white;"><use href="#icon-alert"/></svg>';
                title.textContent = 'API Key Pending';
                subtitle.textContent = 'Validate your API key in API Settings';
            } else {
                banner.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%)';
                banner.style.borderLeftColor = '#667eea';
                iconContainer.style.background = '#667eea';
                iconContainer.innerHTML = '<svg width="18" height="18" style="color: white;"><use href="#icon-clock"/></svg>';
                title.textContent = 'Using Timetable Data';
                subtitle.textContent = 'Add API key for real-time updates';
            }
        }
        
        // Refresh Live Data (called by refresh button)
        function refreshLiveData() {
            const btn = document.getElementById('refresh-data-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<svg width="16" height="16" class="spinning"><use href="#icon-refresh"/></svg> Refreshing...';
            }
            
            loadAllData().then(() => {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<svg width="16" height="16"><use href="#icon-refresh"/></svg> Refresh';
                }
                
                // Update last updated timestamp
                const lastUpdated = document.getElementById('data-last-updated');
                if (lastUpdated) {
                    const now = new Date();
                    lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}`;
                }
            });
        }
        
        // Recalculate journey (calls SmartCommute engine)
        async function recalculateJourney() {
            const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
            const journeySummary = document.getElementById('journey-summary');
            
            if (journeySummary) {
                journeySummary.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">Calculating optimal route...</div>';
            }
            
            try {
                // Call the SmartCommute calculation endpoint
                const response = await fetch(BASE_URL + '/api/calculate-journey', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        home: config.addresses?.home,
                        work: config.addresses?.work,
                        cafe: config.addresses?.cafe,
                        arrivalTime: config.journey?.arrivalTime || '09:00',
                        includesCoffee: config.journey?.coffeeEnabled !== false
                    })
                });
                
                const result = await response.json();
                
                if (result.success && journeySummary) {
                    journeySummary.innerHTML = formatJourneySummary(result.journey);
                } else {
                    throw new Error(result.error || 'Calculation failed');
                }
            } catch (error) {
                console.error('Journey calculation error:', error);
                if (journeySummary) {
                    journeySummary.innerHTML = `<div style="padding: 20px; text-align: center; color: #ef4444;">Unable to calculate journey: ${error.message}</div>`;
                }
            }
        }
        
        // Format journey summary for display
        function formatJourneySummary(journey) {
            if (!journey || !journey.legs) {
                return '<div style="padding: 20px; text-align: center; color: #94a3b8;">No journey data available</div>';
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            journey.legs.forEach((leg, index) => {
                html += `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(79, 178, 142, 0.2); display: flex; align-items: center; justify-content: center; color: #4fb28e; font-weight: 600; font-size: 14px;">${index + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #f1f5f9; font-size: 14px;">${leg.description || leg.mode}</div>
                            <div style="font-size: 12px; color: #94a3b8;">${leg.duration || ''}</div>
                        </div>
                        <div style="font-size: 14px; font-weight: 600; color: #4fb28e;">${leg.time || ''}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ============================================
        // E-Ink Display Preview Functions
        // ============================================

        // Device configurations (matches firmware)
        const DEVICE_CONFIGS = {
            'trmnl-og': { name: 'TRMNL Display (OG)', width: 800, height: 480, orientation: 'landscape' },
            'trmnl-mini': { name: 'TRMNL Display (Mini)', width: 400, height: 300, orientation: 'landscape' },
            'kindle-pw3': { name: 'Kindle Paperwhite 3', width: 758, height: 1024, orientation: 'portrait' },
            'kindle-pw4': { name: 'Kindle Paperwhite 4', width: 1072, height: 1448, orientation: 'portrait' },
            'kindle-pw5': { name: 'Kindle Paperwhite 5', width: 1236, height: 1648, orientation: 'portrait' }
        };

        // Sync localStorage config to Vercel KV storage
        // Ensures server has latest config for rendering
        async function syncConfigToKV() {
            const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
            const transitKey = localStorage.getItem('cc-transit-api-key') || config.api?.key || '';
            const googleKey = localStorage.getItem('cc-google-places-key') || '';
            
            // Only sync if we have some config
            if (!config.addresses?.home && !transitKey) {
                console.log('[Admin] No config to sync to KV');
                return false;
            }
            
            try {
                const response = await fetch(BASE_URL + '/api/sync-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transitKey: transitKey,
                        googleKey: googleKey,
                        state: config.state || 'VIC',
                        preferences: config
                    })
                });
                const result = await response.json();
                console.log('[Admin] KV sync result:', result);
                return result.success;
            } catch (error) {
                console.warn('[Admin] KV sync failed:', error);
                return false;
            }
        }

        // Load actual e-ink display image from CCDash renderer
        async function loadSmartCommuteOutput(forceRefresh = false) {
            loadEinkPreview(forceRefresh);
        }

        // Load E-Ink preview image from /api/screen
        async function loadEinkPreview(forceRefresh = false) {
            // Sync config to KV before loading (ensures server has latest data)
            await syncConfigToKV();
            
            const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
            const device = config.device || localStorage.getItem('cc-device') || 'trmnl-og';
            const deviceConfig = DEVICE_CONFIGS[device] || DEVICE_CONFIGS['trmnl-og'];
            
            // Update device info display
            updateDeviceInfo(device, deviceConfig);
            
            // Show loading state
            const loadingOverlay = document.getElementById('eink-loading-overlay');
            const previewImage = document.getElementById('eink-preview-image');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.innerHTML = `
                    <div class="spinner" style="margin-bottom: 12px;"></div>
                    <span style="font-size: 13px; color: #94a3b8;">Loading display...</span>
                `;
            }
            
            // Always use /api/screen endpoint (this is what generates the e-ink image)
            const baseUrl = window.location.origin;
            const timestamp = Date.now();
            const imageUrl = `${baseUrl}/api/screen?device=${device}&format=png&t=${timestamp}`;
            
            // Update API URL display
            const apiUrlEl = document.getElementById('eink-api-url');
            if (apiUrlEl) apiUrlEl.textContent = imageUrl;
            
            // Set image source - use a new Image to preload without triggering onerror on empty src
            if (previewImage) {
                // Create a new Image object to preload the image
                const newImage = new Image();
                newImage.onload = function() {
                    // Only set the src once loaded to avoid flicker
                    previewImage.src = imageUrl;
                    previewImage.style.width = Math.min(deviceConfig.width, 760) + 'px';
                    previewImage.style.height = 'auto';
                    handleEinkImageLoad();
                };
                newImage.onerror = function() {
                    handleEinkImageError();
                };
                // Start loading the image
                newImage.src = imageUrl;
            }
            
            // Also load raw SmartCommute data for the debug panel
            loadSmartCommuteRawData(forceRefresh);
        }

        // Load raw SmartCommute data for debug panel
        async function loadSmartCommuteRawData(forceRefresh = false) {
            const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
            const rawOutput = document.getElementById('sc-raw-output');
            
            try {
                const scSettings = JSON.parse(localStorage.getItem('cc-smartcommute-settings') || '{}');
                
                const requestBody = {
                    home: config.addresses?.home,
                    work: config.addresses?.work,
                    cafe: config.addresses?.cafe,
                    arrivalTime: config.journey?.arrivalTime || '09:00',
                    state: config.state || 'VIC',
                    coffeeEnabled: config.journey?.coffeeEnabled !== false,
                    forceRefresh: forceRefresh,
                    walkingTimes: {
                        homeToStop: scSettings.homeToStop || 5,
                        homeToCafe: scSettings.homeToCafe || 5,
                        cafeToStop: scSettings.cafeToStop || 2,
                        stopToWork: scSettings.stopToWork || 5
                    },
                    coffee: {
                        duration: scSettings.coffeeDuration || 5,
                        buffer: scSettings.bufferTime || 3,
                        position: scSettings.coffeePosition || 'auto'
                    },
                    modes: {
                        train: scSettings.preferTrain !== false,
                        tram: scSettings.preferTram !== false,
                        bus: scSettings.preferBus || false,
                        minimizeWalking: scSettings.minimizeWalking !== false
                    }
                };

                const response = await fetch(BASE_URL + '/api/smartcommute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                
                if (rawOutput) {
                    rawOutput.textContent = JSON.stringify(result, null, 2);
                }

            } catch (error) {
                console.error('SmartCommute raw data error:', error);
                if (rawOutput) {
                    rawOutput.textContent = `Error: ${error.message}`;
                }
            }
        }

        // Update device info in the panel
        function updateDeviceInfo(device, deviceConfig) {
            const deviceNameEl = document.getElementById('eink-device-name');
            const dimensionsEl = document.getElementById('eink-dimensions');
            const deviceInfoEl = document.getElementById('eink-device-info');
            const resolutionInfoEl = document.getElementById('eink-resolution-info');
            
            if (deviceNameEl) deviceNameEl.textContent = deviceConfig.name;
            if (dimensionsEl) dimensionsEl.textContent = `${deviceConfig.width}√ó${deviceConfig.height}`;
            if (deviceInfoEl) deviceInfoEl.textContent = deviceConfig.name;
            if (resolutionInfoEl) resolutionInfoEl.textContent = `${deviceConfig.width} √ó ${deviceConfig.height} px`;
        }

        // Handle image load success
        function handleEinkImageLoad() {
            const loadingOverlay = document.getElementById('eink-loading-overlay');
            const lastUpdateEl = document.getElementById('eink-last-update');
            
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            if (lastUpdateEl) {
                lastUpdateEl.textContent = 'Updated ' + new Date().toLocaleTimeString('en-AU', { 
                    hour: 'numeric', minute: '2-digit', hour12: true 
                }).toLowerCase();
            }
        }

        // Handle image load error
        function handleEinkImageError() {
            const loadingOverlay = document.getElementById('eink-loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div style="font-size: 14px; margin-bottom: 8px;">Failed to load display</div>
                        <div style="font-size: 12px; opacity: 0.7;">Check journey configuration</div>
                    </div>
                `;
            }
        }

        // Refresh e-ink preview
        function refreshEinkPreview() {
            loadEinkPreview(true);
        }

        // Legacy compatibility
        function updateSmartCommuteSummary(result) {}
        function updateSmartCommuteLegs(result) {}

        // Toggle SmartCommute details panel
        function toggleSmartCommuteDetails() {
            const details = document.getElementById('smartcommute-details');
            if (details) {
                details.open = !details.open;
            }
        }

        // Save SmartCommute settings
        function saveSmartCommuteSettings() {
            const settings = {
                homeToStop: parseInt(document.getElementById('sc-home-to-stop')?.value) || 5,
                homeToCafe: parseInt(document.getElementById('sc-home-to-cafe')?.value) || 5,
                cafeToStop: parseInt(document.getElementById('sc-cafe-to-stop')?.value) || 2,
                stopToWork: parseInt(document.getElementById('sc-stop-to-work')?.value) || 5,
                coffeeDuration: parseInt(document.getElementById('sc-coffee-duration')?.value) || 5,
                bufferTime: parseInt(document.getElementById('sc-buffer-time')?.value) || 3,
                coffeePosition: document.getElementById('sc-coffee-position')?.value || 'auto',
                preferTrain: document.getElementById('sc-prefer-train')?.checked !== false,
                preferTram: document.getElementById('sc-prefer-tram')?.checked !== false,
                preferBus: document.getElementById('sc-prefer-bus')?.checked || false,
                minimizeWalking: document.getElementById('sc-minimize-walking')?.checked !== false,
                walkingSpeed: parseInt(document.getElementById('sc-walking-speed')?.value) || 80,
                maxWalk: parseInt(document.getElementById('sc-max-walk')?.value) || 600,
                multiModal: document.getElementById('sc-multi-modal')?.value || 'allow'
            };

            localStorage.setItem('cc-smartcommute-settings', JSON.stringify(settings));

            // Also update the main config
            const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
            config.smartcommute = settings;
            localStorage.setItem('cc-config', JSON.stringify(config));

            // Show success message
            const msg = document.getElementById('sc-settings-message');
            if (msg) {
                msg.style.display = 'block';
                msg.style.background = 'rgba(34, 197, 94, 0.2)';
                msg.innerHTML = '‚úÖ SmartCommute settings saved! <a href="#" onclick="loadSmartCommuteOutput(true); return false;" style="color: #4fb28e; text-decoration: underline;">Recalculate now</a>';
                setTimeout(() => msg.style.display = 'none', 5000);
            }
        }

        // Load SmartCommute settings into form
        function loadSmartCommuteSettings() {
            const settings = JSON.parse(localStorage.getItem('cc-smartcommute-settings') || '{}');
            
            // Walking times
            if (document.getElementById('sc-home-to-stop')) document.getElementById('sc-home-to-stop').value = settings.homeToStop || 5;
            if (document.getElementById('sc-home-to-cafe')) document.getElementById('sc-home-to-cafe').value = settings.homeToCafe || 5;
            if (document.getElementById('sc-cafe-to-stop')) document.getElementById('sc-cafe-to-stop').value = settings.cafeToStop || 2;
            if (document.getElementById('sc-stop-to-work')) document.getElementById('sc-stop-to-work').value = settings.stopToWork || 5;
            
            // Coffee settings
            if (document.getElementById('sc-coffee-duration')) document.getElementById('sc-coffee-duration').value = settings.coffeeDuration || 5;
            if (document.getElementById('sc-buffer-time')) document.getElementById('sc-buffer-time').value = settings.bufferTime || 3;
            if (document.getElementById('sc-coffee-position')) document.getElementById('sc-coffee-position').value = settings.coffeePosition || 'auto';
            
            // Mode preferences
            if (document.getElementById('sc-prefer-train')) document.getElementById('sc-prefer-train').checked = settings.preferTrain !== false;
            if (document.getElementById('sc-prefer-tram')) document.getElementById('sc-prefer-tram').checked = settings.preferTram !== false;
            if (document.getElementById('sc-prefer-bus')) document.getElementById('sc-prefer-bus').checked = settings.preferBus || false;
            if (document.getElementById('sc-minimize-walking')) document.getElementById('sc-minimize-walking').checked = settings.minimizeWalking !== false;
            
            // Advanced
            if (document.getElementById('sc-walking-speed')) document.getElementById('sc-walking-speed').value = settings.walkingSpeed || 80;
            if (document.getElementById('sc-max-walk')) document.getElementById('sc-max-walk').value = settings.maxWalk || 600;
            if (document.getElementById('sc-multi-modal')) document.getElementById('sc-multi-modal').value = settings.multiModal || 'allow';
        }

        // ============================================
        // End SmartCommute Functions
        // ============================================
        
        // Populate the rebuilt Setup & Journey tab from localStorage config
        function updateSetupTabSummary(prefs) {
            const notConfigured = document.getElementById('setup-not-configured');
            const configured = document.getElementById('setup-configured');
            
            if (!notConfigured || !configured) return;
            
            const hasConfig = prefs && (prefs.addresses?.home || prefs.addresses?.work);
            
            if (hasConfig) {
                notConfigured.style.display = 'none';
                configured.style.display = 'block';
                
                // Populate route summary
                const homeEl = document.getElementById('summary-home');
                const workEl = document.getElementById('summary-work');
                const cafeEl = document.getElementById('summary-cafe');
                const cafeRow = document.getElementById('summary-cafe-row');
                const arrivalEl = document.getElementById('summary-arrival');
                const stateEl = document.getElementById('summary-state');
                const modeEl = document.getElementById('summary-mode');
                
                if (homeEl) homeEl.textContent = prefs.addresses?.home || 'Not set';
                if (workEl) workEl.textContent = prefs.addresses?.work || 'Not set';
                if (cafeEl && prefs.addresses?.cafe) {
                    cafeEl.textContent = prefs.addresses.cafe;
                    if (cafeRow) cafeRow.style.display = 'block';
                } else if (cafeRow) {
                    cafeRow.style.display = 'none';
                }
                if (arrivalEl) arrivalEl.textContent = formatTime12h(prefs.journey?.arrivalTime || '09:00');
                if (stateEl) stateEl.textContent = prefs.state || 'VIC';
                if (modeEl) modeEl.textContent = prefs.apiMode === 'live' ? 'Live' : 'Free';
                
                // Device info
                const deviceName = document.getElementById('device-name');
                const deviceSpecs = document.getElementById('device-specs');
                const webhookSection = document.getElementById('webhook-section');
                const noDeviceSection = document.getElementById('no-device-section');
                const webhookDisplay = document.getElementById('webhook-url-display');
                
                const device = prefs.device || localStorage.getItem('cc-device') || 'trmnl-og';
                const webhookUrl = prefs.webhookUrl || localStorage.getItem('cc-webhook-url');
                
                if (deviceName) {
                    const deviceNames = {
                        'trmnl-og': 'TRMNL Display (OG)',
                        'trmnl-byos': 'TRMNL Display',
                        'trmnl-mini': 'TRMNL Display (Mini)',
                        'kindle-pw3': 'Kindle Paperwhite 3',
                        'kindle-pw4': 'Kindle Paperwhite 4',
                        'kindle-pw5': 'Kindle Paperwhite 5'
                    };
                    deviceName.textContent = deviceNames[device] || 'TRMNL Display';
                }
                if (deviceSpecs) {
                    deviceSpecs.textContent = device?.startsWith('kindle') ? '1072√ó1448 ‚Ä¢ Portrait' : '800√ó480 ‚Ä¢ Landscape ‚Ä¢ ESP32';
                }
                
                if (webhookUrl && webhookSection && webhookDisplay) {
                    webhookSection.style.display = 'block';
                    webhookDisplay.value = webhookUrl;
                    if (noDeviceSection) noDeviceSection.style.display = 'none';
                } else {
                    if (webhookSection) webhookSection.style.display = 'none';
                    if (noDeviceSection) noDeviceSection.style.display = 'block';
                }
            } else {
                notConfigured.style.display = 'block';
                configured.style.display = 'none';
            }
        }
        
        // Copy webhook URL to clipboard
        function copyWebhookUrl() {
            const input = document.getElementById('webhook-url-display');
            if (input) {
                input.select();
                document.execCommand('copy');
                // Brief visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => btn.textContent = originalText, 1500);
            }
        }
        
        // Clear all config and restart
        function clearConfig() {
            if (confirm('Are you sure you want to reset all configuration? This cannot be undone.')) {
                localStorage.removeItem('cc-config');
                localStorage.removeItem('cc-configured');
                localStorage.removeItem('cc-webhook-url');
                localStorage.removeItem('cc-device');
                localStorage.removeItem('cc-transit-api-key');
                localStorage.removeItem('cc-transit-api-validated');
                localStorage.removeItem('cc-google-places-key');
                localStorage.removeItem('cc-google-places-validated');
                window.location.reload();
            }
        }
        
        // ============================================
        // API Settings Tab Functions (reads from localStorage)
        // ============================================
        
        // Mask API key for display (show first 8 chars + ****)
        function maskApiKey(key) {
            if (!key || key.length < 12) return '****';
            return key.substring(0, 8) + '-****-****-****-************';
        }
        
        function maskGoogleKey(key) {
            if (!key || key.length < 8) return '****';
            return key.substring(0, 4) + '****************************';
        }
        
        // Update API Settings tab from localStorage
        function updateApiSettingsTab(prefs) {
            const notConfigured = document.getElementById('api-not-configured');
            const configured = document.getElementById('api-configured');
            
            if (!notConfigured || !configured) return;
            
            // Get API keys from localStorage
            const transitKey = localStorage.getItem('cc-transit-api-key') || prefs?.api?.key || '';
            const transitValidated = localStorage.getItem('cc-transit-api-validated') === 'true';
            const googleKey = localStorage.getItem('cc-google-places-key') || '';
            const googleValidated = localStorage.getItem('cc-google-places-validated') === 'true';
            const apiMode = prefs?.apiMode || localStorage.getItem('cc-api-mode') || 'cached';
            
            const hasAnyConfig = transitKey || googleKey || localStorage.getItem('cc-configured') === 'true';
            
            if (hasAnyConfig) {
                notConfigured.style.display = 'none';
                configured.style.display = 'block';
                
                // Update Transit API card
                const transitStatusIcon = document.getElementById('transit-status-icon');
                const transitStatusText = document.getElementById('transit-status-text');
                const transitKeyPreview = document.getElementById('transit-key-preview');
                const transitStatusBadge = document.getElementById('transit-status-badge');
                
                if (transitKey) {
                    transitStatusIcon.textContent = transitValidated ? '‚úÖ' : '‚ö†Ô∏è';
                    transitStatusText.textContent = transitValidated ? 'Configured & Validated' : 'Configured (Not Validated)';
                    transitKeyPreview.textContent = maskApiKey(transitKey);
                    transitStatusBadge.textContent = transitValidated ? '‚úì Active' : '‚ö†Ô∏è Pending';
                    transitStatusBadge.style.background = transitValidated ? 'rgba(34, 197, 94, 0.9)' : 'rgba(251, 191, 36, 0.9)';
                } else {
                    transitStatusIcon.textContent = '‚ùå';
                    transitStatusText.textContent = 'Not Configured';
                    transitKeyPreview.textContent = 'No key set';
                    transitStatusBadge.textContent = 'Using Fallback';
                    transitStatusBadge.style.background = 'rgba(239, 68, 68, 0.7)';
                }
                
                // Update Google API card
                const googleStatusIcon = document.getElementById('google-status-icon');
                const googleStatusText = document.getElementById('google-status-text');
                const googleKeyPreview = document.getElementById('google-key-preview');
                const googleStatusBadge = document.getElementById('google-status-badge');
                
                if (googleKey) {
                    googleStatusIcon.textContent = googleValidated ? '‚úÖ' : '‚ö†Ô∏è';
                    googleStatusText.textContent = googleValidated ? 'Configured & Validated' : 'Configured (Not Validated)';
                    googleKeyPreview.textContent = maskGoogleKey(googleKey);
                    googleStatusBadge.textContent = googleValidated ? '‚úì Active' : '‚ö†Ô∏è Pending';
                    googleStatusBadge.style.background = googleValidated ? 'rgba(34, 197, 94, 0.9)' : 'rgba(251, 191, 36, 0.9)';
                } else {
                    googleStatusIcon.textContent = '‚ö™';
                    googleStatusText.textContent = 'Not Configured (Optional)';
                    googleKeyPreview.textContent = 'Using free geocoding';
                    googleStatusBadge.textContent = 'Optional';
                    googleStatusBadge.style.background = 'rgba(107, 114, 128, 0.7)';
                }
                
                // Update data mode banner
                const apiModeIcon = document.getElementById('api-mode-icon');
                const apiModeTitle = document.getElementById('api-mode-title');
                const apiModeSubtitle = document.getElementById('api-mode-subtitle');
                const apiModeBanner = document.getElementById('api-data-mode-banner');
                
                if (transitKey && transitValidated) {
                    apiModeIcon.textContent = 'üü¢';
                    apiModeTitle.textContent = 'Real-Time Data Enabled';
                    apiModeSubtitle.textContent = 'Transit API validated and active';
                    apiModeBanner.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.15) 100%)';
                    apiModeBanner.style.borderLeft = '4px solid #22c55e';
                } else if (transitKey) {
                    apiModeIcon.textContent = 'üü°';
                    apiModeTitle.textContent = 'API Key Pending Validation';
                    apiModeSubtitle.textContent = 'Test your API key to enable real-time data';
                    apiModeBanner.style.background = 'linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%)';
                    apiModeBanner.style.borderLeft = '4px solid #fbbf24';
                } else {
                    apiModeIcon.textContent = 'üî¥';
                    apiModeTitle.textContent = 'Using Fallback Timetable Data';
                    apiModeSubtitle.textContent = 'Add a Transit API key for real-time updates';
                    apiModeBanner.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%)';
                    apiModeBanner.style.borderLeft = '4px solid #ef4444';
                }
                
                // Update API mode selection
                const modeRadios = document.querySelectorAll('input[name="api-mode-select"]');
                modeRadios.forEach(radio => {
                    radio.checked = radio.value === apiMode;
                });
            } else {
                notConfigured.style.display = 'block';
                configured.style.display = 'none';
            }
        }
        
        // Update API mode in localStorage
        function updateApiMode(mode) {
            const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
            config.apiMode = mode;
            localStorage.setItem('cc-config', JSON.stringify(config));
            localStorage.setItem('cc-api-mode', mode);
            
            const msg = document.getElementById('mode-change-message');
            if (msg) {
                msg.style.display = 'block';
                msg.innerHTML = `‚úÖ Data mode changed to <strong>${mode === 'live' ? 'Live Mode' : 'Free Mode'}</strong>. Changes take effect immediately.`;
                setTimeout(() => msg.style.display = 'none', 3000);
            }
        }
        
        // Update Transit API key
        async function updateTransitKey() {
            const input = document.getElementById('edit-transit-key');
            const msg = document.getElementById('transit-edit-message');
            const key = input?.value?.trim();
            
            if (!key) {
                msg.style.display = 'block';
                msg.style.background = 'rgba(239, 68, 68, 0.2)';
                msg.textContent = '‚ö†Ô∏è Please enter an API key';
                return;
            }
            
            msg.style.display = 'block';
            msg.style.background = 'rgba(102, 126, 234, 0.2)';
            msg.textContent = 'üîÑ Validating API key...';
            
            try {
                // Validate the key
                const response = await fetch(BASE_URL + '/api/validate-transit-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey: key, state: 'VIC' })
                });
                const result = await response.json();
                
                if (result.valid) {
                    localStorage.setItem('cc-transit-api-key', key);
                    localStorage.setItem('cc-transit-api-validated', 'true');
                    
                    // Update config
                    const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
                    config.api = config.api || {};
                    config.api.key = key;
                    localStorage.setItem('cc-config', JSON.stringify(config));
                    
                    msg.style.background = 'rgba(34, 197, 94, 0.2)';
                    msg.textContent = '‚úÖ API key validated and saved!';
                    input.value = '';
                    
                    // Refresh the tab
                    updateApiSettingsTab(config);
                } else {
                    msg.style.background = 'rgba(239, 68, 68, 0.2)';
                    msg.textContent = '‚ùå API key validation failed: ' + (result.error || 'Invalid key');
                }
            } catch (error) {
                msg.style.background = 'rgba(239, 68, 68, 0.2)';
                msg.textContent = '‚ùå Error validating key: ' + error.message;
            }
        }
        
        // Update Google Places API key
        async function updateGoogleKey() {
            const input = document.getElementById('edit-google-key');
            const msg = document.getElementById('google-edit-message');
            const key = input?.value?.trim();
            
            if (!key) {
                msg.style.display = 'block';
                msg.style.background = 'rgba(239, 68, 68, 0.2)';
                msg.textContent = '‚ö†Ô∏è Please enter an API key';
                return;
            }
            
            msg.style.display = 'block';
            msg.style.background = 'rgba(102, 126, 234, 0.2)';
            msg.textContent = 'üîÑ Validating API key...';
            
            try {
                const response = await fetch(BASE_URL + '/api/validate-google-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey: key })
                });
                const result = await response.json();
                
                if (result.valid) {
                    localStorage.setItem('cc-google-places-key', key);
                    localStorage.setItem('cc-google-places-validated', 'true');
                    
                    msg.style.background = 'rgba(34, 197, 94, 0.2)';
                    msg.textContent = '‚úÖ Google API key validated and saved!';
                    input.value = '';
                    
                    // Refresh the tab
                    const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
                    updateApiSettingsTab(config);
                } else {
                    msg.style.background = 'rgba(239, 68, 68, 0.2)';
                    msg.textContent = '‚ùå Validation failed: ' + (result.error || 'Invalid key');
                }
            } catch (error) {
                msg.style.background = 'rgba(239, 68, 68, 0.2)';
                msg.textContent = '‚ùå Error validating key: ' + error.message;
            }
        }
        
        // Test all APIs
        async function testAllApis() {
            const transitKey = localStorage.getItem('cc-transit-api-key');
            const googleKey = localStorage.getItem('cc-google-places-key');
            
            let results = [];
            
            if (transitKey) {
                try {
                    const resp = await fetch(BASE_URL + '/api/validate-transit-key', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiKey: transitKey, state: 'VIC' })
                    });
                    const result = await resp.json();
                    results.push(`Transit API: ${result.valid ? '‚úÖ Valid' : '‚ùå Invalid'}`);
                    if (result.valid) localStorage.setItem('cc-transit-api-validated', 'true');
                } catch (e) {
                    results.push('Transit API: ‚ùå Error');
                }
            } else {
                results.push('Transit API: ‚ö™ Not configured');
            }
            
            if (googleKey) {
                try {
                    const resp = await fetch(BASE_URL + '/api/validate-google-key', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiKey: googleKey })
                    });
                    const result = await resp.json();
                    results.push(`Google API: ${result.valid ? '‚úÖ Valid' : '‚ùå Invalid'}`);
                    if (result.valid) localStorage.setItem('cc-google-places-validated', 'true');
                } catch (e) {
                    results.push('Google API: ‚ùå Error');
                }
            } else {
                results.push('Google API: ‚ö™ Not configured');
            }
            
            alert('API Test Results:\\n\\n' + results.join('\\n'));
            
            // Refresh display
            const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
            updateApiSettingsTab(config);
        }
        
        // Refresh API status display
        function refreshApiStatus() {
            const config = JSON.parse(localStorage.getItem('cc-config') || '{}');
            updateApiSettingsTab(config);
            
            const msg = document.getElementById('mode-change-message');
            if (msg) {
                msg.style.display = 'block';
                msg.innerHTML = '‚úÖ Status refreshed';
                setTimeout(() => msg.style.display = 'none', 2000);
            }
        }
        
        // Test current transit key
        async function testTransitKey() {
            const key = localStorage.getItem('cc-transit-api-key');
            const msg = document.getElementById('transit-edit-message');
            
            if (!key) {
                msg.style.display = 'block';
                msg.style.background = 'rgba(239, 68, 68, 0.2)';
                msg.textContent = '‚ö†Ô∏è No Transit API key configured';
                return;
            }
            
            msg.style.display = 'block';
            msg.style.background = 'rgba(102, 126, 234, 0.2)';
            msg.textContent = 'üîÑ Testing current key...';
            
            try {
                const resp = await fetch(BASE_URL + '/api/validate-transit-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey: key, state: 'VIC' })
                });
                const result = await resp.json();
                
                msg.style.background = result.valid ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                msg.textContent = result.valid ? '‚úÖ Current key is valid!' : '‚ùå Key validation failed';
                
                if (result.valid) localStorage.setItem('cc-transit-api-validated', 'true');
            } catch (e) {
                msg.style.background = 'rgba(239, 68, 68, 0.2)';
                msg.textContent = '‚ùå Test error: ' + e.message;
            }
        }
        
        // Test current Google key
        async function testGoogleKey() {
            const key = localStorage.getItem('cc-google-places-key');
            const msg = document.getElementById('google-edit-message');
            
            if (!key) {
                msg.style.display = 'block';
                msg.style.background = 'rgba(251, 191, 36, 0.2)';
                msg.textContent = '‚ÑπÔ∏è No Google API key configured (optional)';
                return;
            }
            
            msg.style.display = 'block';
            msg.style.background = 'rgba(102, 126, 234, 0.2)';
            msg.textContent = 'üîÑ Testing current key...';
            
            try {
                const resp = await fetch(BASE_URL + '/api/validate-google-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey: key })
                });
                const result = await resp.json();
                
                msg.style.background = result.valid ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                msg.textContent = result.valid ? '‚úÖ Current key is valid!' : '‚ùå Key validation failed';
                
                if (result.valid) localStorage.setItem('cc-google-places-validated', 'true');
            } catch (e) {
                msg.style.background = 'rgba(239, 68, 68, 0.2)';
                msg.textContent = '‚ùå Test error: ' + e.message;
            }
        }

        async function savePtvConfig() {
            const apiKey = document.getElementById('ptv-dev-id').value;
            const apiToken = document.getElementById('ptv-api-key').value;
            
            if (!apiKey || apiKey.trim() === '') {
                showMessage('api-message', '‚ö†Ô∏è Please enter an API key', 'error');
                return;
            }
            
            showMessage('api-message', 'üîÑ Validating API key...', 'info');
            
            try {
                // Get current state from preferences
                let state = 'VIC';
                try {
                    const prefsResp = await fetch(BASE_URL + '/admin/preferences');
                    const prefs = await prefsResp.json();
                    state = prefs.location?.state || prefs.api?.state || 'VIC';
                } catch (e) { /* Use default VIC */ }
                
                // Use the new validation endpoint
                const response = await fetch(BASE_URL + '/api/save-transit-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiKey: apiKey.trim(),
                        state: state
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.testResult && result.testResult.success) {
                        showMessage('api-message', '‚úÖ ' + result.message + ' (Key: ' + result.keyMasked + ')', 'success');
                    } else {
                        showMessage('api-message', '‚ö†Ô∏è Key saved but validation failed: ' + (result.testResult?.message || 'Unknown error'), 'warning');
                    }
                } else {
                    showMessage('api-message', '‚ùå ' + result.message, 'error');
                    return;
                }
                
                // Refresh API keys status display
                setTimeout(() => updateAPIKeysStatus(), 500);
            } catch (e) {
                console.error('Transit API save error:', e);
                showMessage('api-message', '‚ùå Error saving: ' + e.message, 'error');
            }
        }

        async function testPtvApi() {
            const data = await fetch(BASE_URL + '/api/status').then(r => r.json());
            showMessage('api-message', data.dataMode === 'Live' ? 'Connected!' : 'Not connected', data.dataMode === 'Live' ? 'success' : 'error');
        }

        async function saveGtfsRealtimeConfig() {
            try {
                const key = document.getElementById('gtfs-realtime-key').value;
                await fetch(BASE_URL + '/admin/apis/gtfs-realtime', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscription_key: key })
                });
                showMessage('api-message', '‚úÖ GTFS Realtime key saved!', 'success');
                // Refresh API keys status display
                setTimeout(() => updateAPIKeysStatus(), 500);
            } catch (e) {
                showMessage('api-message', '‚ùå Error saving key', 'error');
                console.error('GTFS Realtime save error:', e);
            }
        }

        async function testGtfsRealtimeApi() {
            try {
                const key = document.getElementById('gtfs-realtime-key').value;
                if (!key) {
                    showMessage('api-message', '‚ö†Ô∏è Please enter a subscription key first', 'error');
                    return;
                }

                showMessage('api-message', 'üîÑ Testing connection...', 'info');

                const response = await fetch(BASE_URL + '/admin/apis/gtfs-realtime/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscription_key: key })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('api-message', `‚úÖ Connected! Received ${result.tripCount || 0} trip updates`, 'success');
                } else {
                    showMessage('api-message', `‚ùå ${result.message || 'Connection failed'}`, 'error');
                }
            } catch (e) {
                showMessage('api-message', '‚ùå Test failed: ' + e.message, 'error');
                console.error('GTFS Realtime test error:', e);
            }
        }

        // Force save Google Places API (new) key - no restart required
        async function forceGooglePlacesKey() {
            const apiKey = document.getElementById('google-places-key').value.trim();
            const btn = document.getElementById('force-google-key-btn');
            const status = document.getElementById('google-key-status');

            if (!apiKey) {
                status.style.display = 'block';
                status.style.background = 'rgba(229, 62, 62, 0.2)';
                status.style.color = '#fc8181';
                status.innerHTML = '‚ö†Ô∏è Please enter an API key';
                return;
            }

            // Disable button during save
            btn.disabled = true;
            btn.textContent = 'üíæ Saving & Testing...';
            status.style.display = 'block';
            status.style.background = 'rgba(113, 128, 150, 0.2)';
            status.style.color = '#cbd5e1';
            status.innerHTML = '‚è≥ Saving and testing API key...';

            try {
                const response = await fetch(BASE_URL + '/admin/apis/force-save-google-places', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey: apiKey })
                });

                const result = await response.json();

                if (result.success) {
                    status.style.background = 'rgba(72, 187, 120, 0.2)';
                    status.style.color = '#68d391';
                    if (result.testResult && result.testResult.success) {
                        status.innerHTML = `‚úÖ API key saved and tested successfully!<br><small style="opacity: 0.8;">Service: ${result.testResult.service}<br>Test: "${result.testResult.testAddress}" ‚Üí "${result.testResult.foundAddress}"<br>Available services: ${result.availableServices.join(', ')}</small>`;
                    } else {
                        status.innerHTML = '‚úÖ API key saved (test inconclusive - will be used for address searches)<br><small style="opacity: 0.8;">The key will be tried for all address lookups</small>';
                    }
                    btn.textContent = '‚úì Saved & Activated';
                    btn.style.background = '#22c55e';

                    // Refresh data mode indicator
                    setTimeout(() => updateAPIKeysStatus(), 500);
                } else {
                    status.style.background = 'rgba(229, 62, 62, 0.2)';
                    status.style.color = '#fc8181';
                    status.innerHTML = `‚ùå Failed to save: ${result.message}`;
                    btn.disabled = false;
                    btn.textContent = 'üíæ Save & Test Immediately (No Restart)';
                }
            } catch (error) {
                status.style.background = 'rgba(229, 62, 62, 0.2)';
                status.style.color = '#fc8181';
                status.innerHTML = `‚ùå Error: ${error.message}`;
                btn.disabled = false;
                btn.textContent = 'üíæ Save & Test Immediately (No Restart)';
            }
        }

        async function saveAdditionalAPIs() {
            try {
                const googleKey = document.getElementById('google-places-key').value;
                const mapboxToken = document.getElementById('mapbox-token').value;

                await fetch(BASE_URL + '/admin/apis/additional', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        google_places: googleKey || null,
                        mapbox: mapboxToken || null,
                        rss_feeds: window.customRssFeeds || []
                    })
                });

                showMessage('api-message', '‚úÖ Additional APIs saved!', 'success');
                // Refresh API keys status display
                setTimeout(() => updateAPIKeysStatus(), 500);
            } catch (e) {
                showMessage('api-message', '‚ùå Error saving', 'error');
                console.error('Additional APIs save error:', e);
            }
        }

        // Initialize global RSS feeds array
        window.customRssFeeds = window.customRssFeeds || [];

        function addRssFeed() {
            const feedUrl = prompt('Enter RSS feed URL:');
            if (!feedUrl) return;

            const feedName = prompt('Enter a name for this feed (optional):');

            const feed = {
                url: feedUrl,
                name: feedName || feedUrl,
                enabled: true,
                id: Date.now().toString()
            };

            window.customRssFeeds.push(feed);
            renderRssFeeds();
        }

        function removeRssFeed(feedId) {
            window.customRssFeeds = window.customRssFeeds.filter(f => f.id !== feedId);
            renderRssFeeds();
        }

        function toggleRssFeed(feedId) {
            const feed = window.customRssFeeds.find(f => f.id === feedId);
            if (feed) {
                feed.enabled = !feed.enabled;
                renderRssFeeds();
            }
        }

        function renderRssFeeds() {
            const container = document.getElementById('rss-feeds-list');
            if (!container) return;

            if (window.customRssFeeds.length === 0) {
                container.innerHTML = `
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; opacity: 0.6; font-size: 13px;">
                        No custom RSS feeds added yet
                    </div>
                `;
                return;
            }

            container.innerHTML = window.customRssFeeds.map(feed => `
                <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" ${feed.enabled ? 'checked' : ''} onchange="toggleRssFeed('${feed.id}')" style="cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 13px;">${feed.name}</div>
                        <div style="font-size: 11px; opacity: 0.7; word-break: break-all;">${feed.url}</div>
                    </div>
                    <button onclick="removeRssFeed('${feed.id}')" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </div>
            `).join('');
        }

        // ==================== API KEYS STATUS DISPLAY ====================

        function maskAPIKey(key) {
            if (!key || key.length < 8) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            return key.substring(0, 4) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.substring(key.length - 4);
        }

        async function updateAPIKeysStatus() {
            try {
                const response = await fetch(BASE_URL + '/admin/preferences');
                const prefs = await response.json();

                const statusList = document.getElementById('api-keys-status-list');
                if (!statusList) return;

                const apis = [];

                // Google Places API
                const googleKey = prefs.additionalAPIs?.google_places || process.env?.GOOGLE_PLACES_API_KEY;
                apis.push({
                    name: 'üìç Google Places API',
                    value: googleKey,
                    status: googleKey ? 'active' : 'not-configured',
                    note: googleKey ? 'Enhanced geocoding enabled' : 'Optional - improves address search'
                });

                // Mapbox API
                const mapboxToken = prefs.additionalAPIs?.mapbox;
                apis.push({
                    name: 'üó∫Ô∏è Mapbox Geocoding',
                    value: mapboxToken,
                    status: mapboxToken ? 'active' : 'not-configured',
                    note: mapboxToken ? 'Additional geocoding coverage' : 'Optional - backup geocoding'
                });

                // Transit Authority API
                const transitKey = prefs.api?.key;
                const state = prefs.location?.state || 'VIC';
                const authorityNames = {
                    'VIC': 'Transport for Victoria',
                    'NSW': 'Transport for NSW',
                    'QLD': 'TransLink Queensland',
                    'SA': 'Adelaide Metro',
                    'WA': 'Transperth',
                    'TAS': 'Metro Tasmania',
                    'ACT': 'Transport Canberra',
                    'NT': 'Transport NT'
                };
                const authorityName = authorityNames[state] || 'Transit Authority';

                apis.push({
                    name: `üöÇ ${authorityName}`,
                    value: transitKey,
                    status: transitKey ? 'active' : 'not-configured',
                    note: transitKey ? `Real-time data for ${state}` : 'Optional - enables real-time departures'
                });

                // GTFS Realtime (Victoria only)
                if (state === 'VIC') {
                    const gtfsKey = prefs.additionalAPIs?.gtfs_realtime_key;
                    apis.push({
                        name: 'üöÜ GTFS Realtime (Victoria)',
                        value: gtfsKey,
                        status: gtfsKey ? 'active' : 'not-configured',
                        note: gtfsKey ? 'Live metro train updates' : 'Optional - Victoria only'
                    });
                }

                // Nominatim (always available)
                apis.push({
                    name: 'üåç OpenStreetMap Nominatim',
                    value: 'built-in',
                    status: 'active',
                    note: 'Free geocoding - always available'
                });

                // BOM Weather (always available)
                apis.push({
                    name: 'üå§Ô∏è Bureau of Meteorology',
                    value: 'built-in',
                    status: 'active',
                    note: 'Weather data - always available'
                });

                // Render API status items
                statusList.innerHTML = apis.map(api => {
                    const statusColors = {
                        'active': { bg: 'rgba(72, 187, 120, 0.15)', border: '#22c55e', icon: '‚úì', iconColor: '#22c55e' },
                        'not-configured': { bg: 'rgba(251, 191, 36, 0.15)', border: '#fbbf24', icon: '‚ö†Ô∏è', iconColor: '#fbbf24' },
                        'invalid': { bg: 'rgba(239, 68, 68, 0.15)', border: '#ef4444', icon: '‚ùå', iconColor: '#ef4444' }
                    };
                    const colors = statusColors[api.status];

                    return `
                        <div style="padding: 15px; background: ${colors.bg}; border-radius: 10px; border-left: 4px solid ${colors.border};">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-weight: 600; font-size: 14px;">${api.name}</div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 14px;">${colors.icon}</span>
                                    <span style="font-size: 12px; font-weight: 600; color: ${colors.iconColor};">
                                        ${api.status === 'active' ? 'Active' : api.status === 'not-configured' ? 'Not Configured' : 'Invalid'}
                                    </span>
                                </div>
                            </div>
                            <div style="font-size: 12px; opacity: 0.75; font-family: 'Courier New', monospace; margin-bottom: 6px;">
                                ${api.value === 'built-in' ? 'Built-in service' : maskAPIKey(api.value)}
                            </div>
                            <div style="font-size: 11px; opacity: 0.7;">
                                ${api.note}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error updating API keys status:', error);
            }
        }

        // ==================== END API KEYS STATUS DISPLAY ====================

        function saveDisplaySettings() {
            localStorage.setItem('cc-display-settings', JSON.stringify({
                use24Hour: document.getElementById('use-24-hour').checked,
                showWalkingTimes: document.getElementById('show-walking-times').checked
            }));
            showMessage('api-message', 'Saved!', 'success');
        }

        // ==================== REFRESH RATE SETTINGS ====================

        async function saveRefreshSettings() {
            try {
                const displayValue = parseInt(document.getElementById('display-refresh-value').value);
                const displayUnit = document.getElementById('display-refresh-unit').value;
                const journeyValue = parseInt(document.getElementById('journey-recalc-value').value);
                const journeyUnit = document.getElementById('journey-recalc-unit').value;
                const dataValue = parseInt(document.getElementById('data-fetch-value').value);
                const dataUnit = document.getElementById('data-fetch-unit').value;

                // Convert to milliseconds
                const displayInterval = displayUnit === 'minutes' ? displayValue * 60000 : displayValue * 1000;
                const journeyInterval = journeyUnit === 'minutes' ? journeyValue * 60000 : journeyValue * 1000;
                const dataInterval = dataUnit === 'seconds' ? dataValue * 1000 : dataValue * 60000;

                const response = await fetch(BASE_URL + '/admin/refresh-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        displayRefresh: { interval: displayInterval, unit: displayUnit },
                        journeyRecalc: { interval: journeyInterval, unit: journeyUnit },
                        dataFetch: { interval: dataInterval, unit: dataUnit }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const messageDiv = document.getElementById('refresh-settings-message');
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = 'rgba(72, 187, 120, 0.2)';
                    messageDiv.style.padding = '12px';
                    messageDiv.style.borderRadius = '8px';
                    messageDiv.style.color = '#22c55e';
                    messageDiv.innerHTML = `‚úÖ ${result.message}`;

                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 3000);

                    // Update e-ink lifespan estimate
                    updateEinkLifespanEstimate();
                } else {
                    throw new Error(result.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving refresh settings:', error);
                const messageDiv = document.getElementById('refresh-settings-message');
                messageDiv.style.display = 'block';
                messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                messageDiv.style.padding = '12px';
                messageDiv.style.borderRadius = '8px';
                messageDiv.style.color = '#fca5a5';
                messageDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        function updateEinkLifespanEstimate() {
            const displayValue = parseInt(document.getElementById('display-refresh-value').value);
            const deviceSelect = document.getElementById('setup-device-select');
            const selectedDevice = deviceSelect ? deviceSelect.value : 'trmnl-byos';

            // E-ink wear factors (Development Rules v1.0.15 Section Y)
            const wearFactors = {
                'trmnl-byos': 0.3,       // Partial refresh = lower wear
                'kindle-pw5': 0.5,       // Carta 1200 = moderate wear
                'kindle-pw3': 0.7,       // Carta = higher wear
                'kindle-pw4': 0.7,       // Carta 1100 = higher wear
                'kindle-basic-10': 1.0,  // Pearl = highest wear
                'kindle-11': 0.5         // Carta 1200 = moderate wear
            };

            const dailyRefreshes = (24 * 60) / displayValue;
            const yearlyRefreshes = dailyRefreshes * 365;
            const estimatedLifespan = 1000000 / (yearlyRefreshes * wearFactors[selectedDevice]);

            const lifespanSpan = document.getElementById('eink-lifespan');
            const estimateDiv = document.getElementById('display-refresh-estimate');

            if (lifespanSpan && estimateDiv) {
                lifespanSpan.textContent = Math.round(estimatedLifespan * 10) / 10;
                estimateDiv.style.display = 'block';
            }
        }

        // Update lifespan estimate when display refresh changes
        document.addEventListener('DOMContentLoaded', function() {
            const displayRefreshInput = document.getElementById('display-refresh-value');
            if (displayRefreshInput) {
                displayRefreshInput.addEventListener('input', updateEinkLifespanEstimate);
                updateEinkLifespanEstimate(); // Initial calculation
            }
        });

        // ==================== END REFRESH RATE SETTINGS ====================

        function refreshData() { loadAllData(); }
        async function clearCache() { await fetch(BASE_URL + '/admin/cache/clear', { method: 'POST' }); loadAllData(); }

        function showMessage(id, msg, type) {
            document.getElementById(id).innerHTML = `<div class="message message-${type}">${msg}</div>`;
            setTimeout(() => document.getElementById(id).innerHTML = '', 3000);
        }

        // ============= ADDRESS AUTOCOMPLETE =============
        let autocompleteDebounce = null;

        function setupAddressAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);

            input.addEventListener('input', function() {
                clearTimeout(autocompleteDebounce);
                const query = this.value.trim();

                if (query.length < 3) {
                    suggestions.style.display = 'none';
                    return;
                }

                autocompleteDebounce = setTimeout(async () => {
                    try {
                        // Use our API endpoint which checks for Google Places first, falls back to Nominatim
                        const url = `${BASE_URL}/api/address-search?q=${encodeURIComponent(query)}`;
                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.results && data.results.length > 0) {
                            const source = data.source === 'google' ? 'üîµ Google Places' : 'üü¢ OpenStreetMap';
                            suggestions.innerHTML = data.results.map(r => `
                                <div class="autocomplete-item" onclick="selectAddress('${inputId}', '${suggestionsId}', '${(r.display_name || '').replace(/'/g, "\\'")}', ${r.lat || 0}, ${r.lon || 0}, '${r.place_id || ''}')">
                                    ${r.display_name}
                                </div>
                            `).join('');
                            // Add source indicator at bottom
                            suggestions.innerHTML += `<div style="padding: 8px 15px; font-size: 11px; opacity: 0.6; border-top: 1px solid rgba(255,255,255,0.1);">${source}</div>`;
                            suggestions.style.display = 'block';
                        } else {
                            suggestions.style.display = 'none';
                        }
                    } catch (e) {
                        console.error('Autocomplete error:', e);
                    }
                }, 500);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }

        function selectAddress(inputId, suggestionsId, address, lat, lon, placeId) {
            document.getElementById(inputId).value = address;
            document.getElementById(inputId).dataset.lat = lat || '';
            document.getElementById(inputId).dataset.lon = lon || '';
            document.getElementById(inputId).dataset.placeId = placeId || '';
            document.getElementById(suggestionsId).style.display = 'none';
        }

        // Auto-save mechanism for fields
        let autoSaveTimeout = null;
        let saveIndicator = null;

        function createSaveIndicator() {
            if (!saveIndicator) {
                saveIndicator = document.createElement('div');
                saveIndicator.id = 'save-indicator';
                saveIndicator.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #22c55e; color: white; border-radius: 8px; font-size: 13px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s; z-index: 10000;';
                document.body.appendChild(saveIndicator);
            }
            return saveIndicator;
        }

        function showSaveIndicator(message, success = true) {
            const indicator = createSaveIndicator();
            indicator.textContent = message;
            indicator.style.background = success ? '#22c55e' : '#fc8181';
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 2000);
        }

        async function autoSaveField(fieldId, section, fieldName) {
            const value = document.getElementById(fieldId)?.value || '';

            try {
                // Get current preferences
                const prefsResponse = await fetch(BASE_URL + '/admin/preferences');
                const prefsData = await prefsResponse.json();
                const prefs = prefsData.preferences || prefsData;

                // Update the specific field
                if (!prefs[section]) prefs[section] = {};
                prefs[section][fieldName] = value;

                // Save back to server using PUT method
                const saveResponse = await fetch(BASE_URL + '/admin/preferences', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(prefs)
                });

                if (saveResponse.ok) {
                    showSaveIndicator('‚úì Saved', true);
                    console.log(`Auto-saved ${fieldName}:`, value);
                } else {
                    console.error('Failed to auto-save:', await saveResponse.text());
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        function setupAutoSave(fieldId, section, fieldName) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            field.addEventListener('input', () => {
                // Clear existing timeout
                if (autoSaveTimeout) {
                    clearTimeout(autoSaveTimeout);
                }

                // Set new timeout (debounce)
                autoSaveTimeout = setTimeout(() => {
                    autoSaveField(fieldId, section, fieldName);
                }, 1500); // Save 1.5 seconds after user stops typing
            });

            // Also save on blur (when field loses focus)
            field.addEventListener('blur', () => {
                if (autoSaveTimeout) {
                    clearTimeout(autoSaveTimeout);
                }
                autoSaveField(fieldId, section, fieldName);
            });
        }

        // Initialize autocomplete on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);
            loadAllData();
            loadSavedPreferences();
            refreshInterval = setInterval(loadAllData, 30000);

            // Setup address autocomplete
            setupAddressAutocomplete('home-address', 'home-suggestions');
            setupAddressAutocomplete('cafe-address', 'cafe-suggestions');
            setupAddressAutocomplete('work-address', 'work-suggestions');

            // Setup auto-save for address fields
            setupAutoSave('home-address', 'addresses', 'home');
            setupAutoSave('cafe-name', 'addresses', 'cafeName');
            setupAutoSave('cafe-address', 'addresses', 'cafe');
            setupAutoSave('work-address', 'addresses', 'work');
            setupAutoSave('arrival-time', 'journey', 'arrivalTime');
        });

        // ============= SIMPLIFIED JOURNEY PLANNER =============
        async function calculateSimpleRoute() {
            const btn = document.getElementById('calc-btn-text');
            btn.textContent = '‚è≥ Calculating...';

            const homeAddr = document.getElementById('home-address').value;
            const cafeAddr = document.getElementById('cafe-address').value;
            const workAddr = document.getElementById('work-address').value;
            const arrivalTime = document.getElementById('arrival-time').value;

            if (!homeAddr || !workAddr) {
                showMessage('planner-message', 'Please enter home and work addresses', 'error');
                btn.textContent = 'üó∫Ô∏è Calculate Route';
                return;
            }

            try {
                // Save preferences
                localStorage.setItem('cc-journey-addresses', JSON.stringify({
                    homeAddress: homeAddr,
                    cafeAddress: cafeAddr,
                    workAddress: workAddr,
                    arrivalTime: arrivalTime
                }));

                // Call simplified route planning endpoint
                const response = await fetch(BASE_URL + '/admin/route/quick-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        homeAddress: homeAddr,
                        cafeAddress: cafeAddr,
                        workAddress: workAddr,
                        arrivalTime: arrivalTime
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('planner-message', '‚úÖ Route calculated!', 'success');
                    displayRouteResult(result);
                } else {
                    showMessage('planner-message', result.error || 'Failed to calculate route', 'error');
                }
            } catch (e) {
                showMessage('planner-message', 'Error: ' + e.message, 'error');
            }

            btn.textContent = 'üó∫Ô∏è Calculate Route';
        }

        function displayRouteResult(result) {
            const journey = result.journey;

            if (!journey) {
                return;
            }

            // Show journey details
            document.getElementById('journey-result').style.display = 'block';
            document.getElementById('address-card').style.display = 'none';

            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(34, 197, 94, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">LEAVE HOME</div>
                        <div style="font-size: 32px; font-weight: 700;">${journey.summary?.must_leave_home || '--:--'}</div>
                    </div>
                    <div style="background: rgba(79, 178, 142, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">ARRIVE WORK</div>
                        <div style="font-size: 32px; font-weight: 700;">${journey.summary?.arrival_at_work || '--:--'}</div>
                    </div>
                </div>
            `;

            // Coffee decision
            if (journey.coffee_decision) {
                const canGetCoffee = journey.coffee_decision.can_get_coffee;
                html += `
                    <div style="background: ${canGetCoffee ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">
                            ${canGetCoffee ? '‚òï YES - YOU HAVE TIME FOR COFFEE!' : '‚ö° NO - GO DIRECT TO WORK'}
                        </div>
                        <div style="opacity: 0.9;">${journey.coffee_decision.message || ''}</div>
                    </div>
                `;
            }

            // Journey segments
            if (journey.segments && journey.segments.length > 0) {
                html += '<div style="margin-top: 20px;"><div style="font-weight: 600; margin-bottom: 15px; font-size: 16px;">Journey Timeline:</div>';
                journey.segments.forEach(seg => {
                    const icon = seg.type === 'walk' ? 'üö∂' : seg.type === 'coffee' ? '‚òï' : seg.type === 'train' ? 'üöÜ' : seg.type === 'tram' ? 'üöä' : seg.type === 'bus' ? 'üöå' : '‚è±Ô∏è';
                    html += `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 24px;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${seg.from || seg.location || ''} ${seg.to ? '‚Üí ' + seg.to : ''}</div>
                                <div style="font-size: 13px; opacity: 0.7;">${seg.type} ¬∑ ${seg.duration} min ${seg.departure ? '¬∑ ' + seg.departure : ''}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            document.getElementById('journey-result-content').innerHTML = html;
            window.scrollTo({ top: document.getElementById('journey-result').offsetTop - 20, behavior: 'smooth' });
        }

        function showAddressEditor() {
            document.getElementById('address-card').style.display = 'block';
            document.getElementById('journey-result').style.display = 'none';
            window.scrollTo({ top: document.getElementById('address-card').offsetTop - 20, behavior: 'smooth' });
        }

        // ============= SYSTEM ARCHITECTURE VISUALIZATION =============
        function showSystemArchitecture() {
            const viz = document.getElementById('architecture-viz');

            if (viz.style.display === 'block') {
                viz.style.display = 'none';
                return;
            }

            viz.style.display = 'block';
            viz.innerHTML = `
                <div style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                    <h3 style="text-align: center; margin-bottom: 25px; font-size: 20px;">üß† Intelligent Data Flow</h3>

                    <div class="arch-node">
                        <div class="arch-node-title">1Ô∏è‚É£ User Input</div>
                        <div class="arch-node-desc">You configure your home, cafe, and work addresses along with your desired arrival time</div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">2Ô∏è‚É£ Multi-Tier Address Geocoding</div>
                        <div class="arch-node-desc">
                            <strong>6-Tier Fallback System</strong> finds addresses with maximum accuracy:<br>
                            1Ô∏è‚É£ <strong>Google Places</strong> (best for cafes/businesses)<br>
                            2Ô∏è‚É£ <strong>Mapbox</strong> (excellent accuracy)<br>
                            3Ô∏è‚É£ <strong>HERE</strong> (optimized for Australia)<br>
                            4Ô∏è‚É£ <strong>Foursquare</strong> (venues/locations)<br>
                            5Ô∏è‚É£ <strong>LocationIQ</strong> (free tier)<br>
                            6Ô∏è‚É£ <strong>Nominatim</strong> (always available)<br>
                            <em>Cached in memory for 24 hours</em>
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">3Ô∏è‚É£ Walking Distance Calculation</div>
                        <div class="arch-node-desc">
                            <strong>Haversine Formula</strong> calculates walking distances and times<br>
                            Standard walking speed: 80m/min (4.8 km/h)
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">4Ô∏è‚É£ Cafe Busy-ness Detection</div>
                        <div class="arch-node-desc">
                            <strong>Google Places API</strong> (if configured) provides real-time busy-ness<br>
                            <strong>Fallback:</strong> Time-based inference (7-9am = 2√ó wait time, etc.)
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">5Ô∏è‚É£ Transit Data Fetching</div>
                        <div class="arch-node-desc">
                            <strong>Transport Victoria GTFS-Realtime API</strong> provides live departures<br>
                            OpenData Platform ¬∑ Metro Trains, Yarra Trams, Metro Bus, V/Line<br>
                            API Key authentication ¬∑ 30-second cache TTL
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">6Ô∏è‚É£ Backward Time Calculation</div>
                        <div class="arch-node-desc">
                            System works <strong>backwards</strong> from your arrival time:<br>
                            Arrival ‚Üí subtract work walk ‚Üí subtract transit ‚Üí subtract cafe time ‚Üí subtract walks ‚Üí <strong>LEAVE HOME TIME</strong>
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">7Ô∏è‚É£ Multi-Modal Route Optimization</div>
                        <div class="arch-node-desc">
                            <strong>Multi-Modal Router</strong> searches trains, trams, buses<br>
                            Filters by ¬±10 min window ¬∑ Returns best 2 options
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">8Ô∏è‚É£ Real-Time Delay Detection</div>
                        <div class="arch-node-desc">
                            <strong>Live GTFS-RT Monitoring</strong> detects service disruptions<br>
                            Automatically recalculates connections when delays occur<br>
                            Updates every 30 seconds ¬∑ Shows revised departure times
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">9Ô∏è‚É£ Coffee Decision</div>
                        <div class="arch-node-desc">
                            Compares available time vs required time (walk + coffee purchase + walk)<br>
                            <strong>Result:</strong> ‚òï YES or ‚ö° NO
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">üîü Weather Integration</div>
                        <div class="arch-node-desc">
                            <strong>Bureau of Meteorology</strong> official JSON feeds<br>
                            Updates every 30 min ¬∑ 10-minute cache
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node">
                        <div class="arch-node-title">1Ô∏è‚É£1Ô∏è‚É£ Decision Logging</div>
                        <div class="arch-node-desc">
                            <strong>Transparent Decision Trail</strong> records all system decisions:<br>
                            ‚Ä¢ Geocoding service used<br>
                            ‚Ä¢ Route calculations<br>
                            ‚Ä¢ Delay detections<br>
                            ‚Ä¢ Connection adjustments<br>
                            <em>Available for troubleshooting and transparency</em>
                        </div>
                    </div>

                    <div class="arch-arrow">‚Üì</div>

                    <div class="arch-node" style="border-color: #22c55e;">
                        <div class="arch-node-title">üéØ Live Display</div>
                        <div class="arch-node-desc">
                            E-ink display shows:<br>
                            ‚Ä¢ Current time & weather<br>
                            ‚Ä¢ Coffee decision<br>
                            ‚Ä¢ Next departures<br>
                            ‚Ä¢ Service alerts<br>
                            <br>
                            <strong>Updates every 30 seconds</strong>
                        </div>
                    </div>

                    <div style="margin-top: 25px; padding: 15px; background: rgba(79, 178, 142, 0.2); border-radius: 8px; text-align: center;">
                        <strong>All data points work together intelligently to answer:</strong><br>
                        <span style="font-size: 18px; display: block; margin-top: 10px;">
                            ‚òï "Can I get coffee, or should I go direct?"
                        </span>
                    </div>
                </div>
            `;
        }

        // Decision Log Functions
        async function loadDecisionLog() {
            const content = document.getElementById('decision-log-content');
            const stats = document.getElementById('decision-log-stats');
            const entries = document.getElementById('decision-log-entries');

            try {
                const response = await fetch(BASE_URL + '/api/decisions?limit=50');
                const data = await response.json();

                if (data.success) {
                    // Show content
                    content.style.display = 'block';

                    // Display stats
                    stats.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700;">${data.stats.totalDecisions}</div>
                                <div style="font-size: 12px; opacity: 0.8;">Total Decisions</div>
                            </div>
                            ${Object.entries(data.stats.categories).map(([cat, count]) => `
                                <div>
                                    <div style="font-size: 20px; font-weight: 600;">${count}</div>
                                    <div style="font-size: 11px; opacity: 0.8;">${cat}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    // Display log entries
                    if (data.logs.length > 0) {
                        entries.innerHTML = `
                            <div style="font-weight: 600; margin: 15px 0 10px 0; font-size: 14px;">Recent Decisions (Last 50):</div>
                            ${data.logs.reverse().map(log => {
                                const categoryColors = {
                                    'Geocoding': 'rgba(102, 126, 234, 0.15)',
                                    'Route Calculation': 'rgba(72, 187, 120, 0.15)',
                                    'Delay Detection': 'rgba(252, 129, 129, 0.15)',
                                    'Connection Adjustment': 'rgba(237, 137, 54, 0.15)',
                                    'Coffee Decision': 'rgba(139, 92, 246, 0.15)',
                                    'API Fallback': 'rgba(251, 191, 36, 0.15)',
                                    'Transit Mode Selection': 'rgba(59, 130, 246, 0.15)',
                                    'Cache': 'rgba(156, 163, 175, 0.15)'
                                };

                                const bgColor = categoryColors[log.category] || 'rgba(255,255,255,0.05)';

                                return `
                                    <div style="padding: 12px; background: ${bgColor}; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid rgba(255,255,255,0.3);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="font-weight: 600; font-size: 13px;">${log.category}</div>
                                            <div style="font-size: 11px; opacity: 0.7; font-family: 'Courier New', monospace;">
                                                ${new Date(log.timestamp).toLocaleTimeString()}
                                            </div>
                                        </div>
                                        <div style="font-size: 13px; margin-bottom: 4px;">${log.decision}</div>
                                        ${log.details ? `
                                            <details style="margin-top: 6px; font-size: 12px; opacity: 0.8;">
                                                <summary style="cursor: pointer; font-size: 11px;">Details</summary>
                                                <pre style="margin-top: 6px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; overflow-x: auto; font-size: 11px;">${JSON.stringify(log.details, null, 2)}</pre>
                                            </details>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        `;
                    } else {
                        entries.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">No decisions logged yet</div>';
                    }
                }
            } catch (error) {
                content.style.display = 'block';
                entries.innerHTML = `<div style="padding: 20px; text-align: center; color: #fc8181;">Error loading decision log: ${error.message}</div>`;
            }
        }

        async function exportDecisionLog() {
            try {
                const response = await fetch(BASE_URL + '/api/decisions/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `decisions-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                alert('‚úÖ Decision log exported successfully!');
            } catch (error) {
                alert('‚ùå Error exporting decision log: ' + error.message);
            }
        }

        // Feedback Form
        async function submitFeedback() {
            const name = document.getElementById('feedback-name').value;
            const email = document.getElementById('feedback-email').value;
            const type = document.getElementById('feedback-type').value;
            const message = document.getElementById('feedback-message').value;
            const status = document.getElementById('feedback-status');

            if (!message.trim()) {
                status.style.display = 'block';
                status.style.color = '#fc8181';
                status.textContent = '‚ùå Please enter a message';
                return;
            }

            status.style.display = 'block';
            status.style.color = '#334155';
            status.textContent = 'üì§ Sending...';

            try {
                const response = await fetch(BASE_URL + '/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name || 'Anonymous',
                        email: email || 'No email provided',
                        type,
                        message,
                        timestamp: new Date().toISOString()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    status.style.color = '#22c55e';
                    status.textContent = '‚úÖ Feedback sent successfully! Thank you for your input.';
                    // Clear form
                    document.getElementById('feedback-name').value = '';
                    document.getElementById('feedback-email').value = '';
                    document.getElementById('feedback-message').value = '';
                } else {
                    throw new Error(result.message || 'Failed to send feedback');
                }
            } catch (error) {
                status.style.color = '#fc8181';
                status.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // ============= SYSTEM RESET & CACHE MANAGEMENT =============

        /**
         * Clear all caches without resetting user data
         */
        async function clearAllCaches() {
            const btn = document.getElementById('clear-cache-btn');
            const originalText = btn.innerHTML;

            if (!confirm('Clear all caches? This will remove cached geocoding, weather, and journey data.\n\nYour preferences and configuration will NOT be deleted.\n\nClick OK to proceed.')) {
                return;
            }

            btn.innerHTML = '‚è≥ Clearing caches...';
            btn.disabled = true;

            try {
                const response = await fetch(BASE_URL + '/admin/cache/clear', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    btn.innerHTML = '‚úÖ Caches Cleared!';
                    btn.style.background = '#22c55e';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 3000);

                    showMessage('system-reset-message', 'All caches cleared successfully. Data will refresh on next request.', 'success');
                } else {
                    throw new Error(result.error || 'Failed to clear caches');
                }
            } catch (error) {
                btn.innerHTML = '‚ùå Error';
                btn.style.background = '#fc8181';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 3000);

                alert('Error clearing caches: ' + error.message);
            }
        }

        /**
         * Complete system reset - confirmation step
         */
        function confirmFullSystemReset() {
            const confirmed = confirm(
                '‚ö†Ô∏è COMPLETE SYSTEM RESET ‚ö†Ô∏è\n\n' +
                'This action will:\n' +
                '‚Ä¢ DELETE ALL user data (addresses, preferences, API keys)\n' +
                '‚Ä¢ CLEAR ALL caches\n' +
                '‚Ä¢ RESTART the server\n\n' +
                'You will need to run the Setup Wizard again.\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Are you ABSOLUTELY SURE you want to proceed?'
            );

            if (!confirmed) {
                return;
            }

            // Second confirmation for safety
            const finalConfirm = confirm(
                '‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è\n\n' +
                'This is your last chance to cancel.\n\n' +
                'All your data will be permanently deleted.\n\n' +
                'Type exactly "DELETE" in the next prompt to proceed, or click Cancel to abort.'
            );

            if (!finalConfirm) {
                return;
            }

            // Require typing DELETE
            const userInput = prompt('Type "DELETE" in capital letters to confirm system reset:');

            if (userInput !== 'DELETE') {
                alert('System reset cancelled. You must type "DELETE" exactly to proceed.');
                return;
            }

            // Proceed with reset
            performFullSystemReset();
        }

        /**
         * Execute the full system reset
         */
        async function performFullSystemReset() {
            const btn = document.getElementById('full-reset-btn');
            btn.innerHTML = '‚è≥ Wiping data and restarting server...';
            btn.disabled = true;
            btn.style.opacity = '0.6';

            try {
                const response = await fetch(BASE_URL + '/admin/system/reset-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    // Show success message
                    btn.innerHTML = '‚úÖ Reset Complete! Server Restarting...';
                    btn.style.background = '#22c55e';

                    // Show countdown and redirect
                    let countdown = 10;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            btn.innerHTML = `‚úÖ Server restarting... Redirecting to Setup in ${countdown}s`;
                        } else {
                            clearInterval(countdownInterval);
                            window.location.href = '/setup';
                        }
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Reset failed');
                }
            } catch (error) {
                btn.innerHTML = '‚ùå Error: ' + error.message;
                btn.style.background = '#fc8181';

                setTimeout(() => {
                    btn.innerHTML = '‚ö†Ô∏è WIPE ALL DATA & RESTART SERVER';
                    btn.style.background = '';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }, 5000);

                alert('System reset failed: ' + error.message + '\n\nPlease try again or contact support.');
            }
        }

        // System Architecture Visualization
        async function toggleSystemArchitecture() {
            const vizDiv = document.getElementById('architecture-viz');
            const toggleBtn = document.getElementById('arch-toggle-btn');

            if (vizDiv.style.display === 'block') {
                vizDiv.style.display = 'none';
                toggleBtn.innerHTML = '<span style="font-size: 20px;">üîç</span> Show Full Architecture Map';
                return;
            }

            // Fetch current configuration to show active services (or defaults if not configured)
            const attributions = await fetch(BASE_URL + '/api/attributions').then(r => r.json()).catch(() => ({
                attributions: [
                    { name: 'Commute Compute', license: 'CC BY-NC 4.0', required: true },
                    { name: 'Transport Authority', license: 'Varies by state', required: true },
                    { name: 'Bureau of Meteorology', license: 'CC BY 3.0 AU', required: true },
                    { name: 'OpenStreetMap', license: 'ODbL', required: true }
                ]
            }));
            const preferences = await fetch(BASE_URL + '/admin/preferences').then(r => r.json()).catch(() => null);

            // Use defaults if not configured to show full architecture BEFORE user configuration
            const transitAuthority = preferences?.location?.transitAuthority || 'Auto-detected based on your state';
            const location = preferences?.location?.city ? `${preferences.location.city}, ${preferences.location.state}` : 'To be configured';

            vizDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #4fb28e 0%, #4f46e5 100%); padding: 25px; border-radius: 12px; color: white;">
                    <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 20px;">System Architecture Map</h3>
                    <div style="font-size: 13px; opacity: 0.9; text-align: center; margin-bottom: 25px;">
                        <strong>Location:</strong> ${location} ‚Ä¢ <strong>Transit Authority:</strong> ${transitAuthority}
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <!-- Layer 1: User Input -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">üìù USER INPUT LAYER</div>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                <div style="padding: 8px 15px; background: rgba(255,255,255,0.15); border-radius: 6px;">Setup Wizard</div>
                                <div style="padding: 8px 15px; background: rgba(255,255,255,0.15); border-radius: 6px;">Preferences</div>
                                <div style="padding: 8px 15px; background: rgba(255,255,255,0.15); border-radius: 6px;">Addresses</div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 2: Data Processing -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">‚öôÔ∏è DATA PROCESSING LAYER</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                <div style="padding: 8px; background: rgba(64, 220, 165, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Geocoding</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">6-Tier Fallback</div>
                                </div>
                                <div style="padding: 8px; background: rgba(102, 126, 234, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Route Planning</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Multi-Modal</div>
                                </div>
                                <div style="padding: 8px; background: rgba(246, 173, 85, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Walking Times</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Calculated</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 3: External Data Sources (Active Only) -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">üåê ACTIVE DATA SOURCES</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                ${attributions.attributions?.filter(a => a.required || a.name !== 'Commute Compute').map(attr => `
                                    <div style="padding: 8px; background: rgba(255,255,255,0.15); border-radius: 6px; border-left: 3px solid ${attr.name.includes('Transport') ? '#4fb28e' : attr.name.includes('BOM') || attr.name.includes('Meteorology') ? '#22c55e' : attr.name.includes('OpenStreetMap') ? '#22c55e' : '#fbbf24'};">
                                        <div style="font-weight: 600; font-size: 11px;">${attr.name}</div>
                                        <div style="font-size: 9px; opacity: 0.8; margin-top: 2px;">${attr.license}</div>
                                    </div>
                                `).join('') || '<div style="text-align: center; opacity: 0.7;">No services configured</div>'}
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 4: Intelligence Engine -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">ü§ñ INTELLIGENCE ENGINE</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                <div style="padding: 8px; background: rgba(139, 92, 246, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Coffee Decision</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Time Calculator</div>
                                </div>
                                <div style="padding: 8px; background: rgba(236, 72, 153, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Delay Detection</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Real-Time</div>
                                </div>
                                <div style="padding: 8px; background: rgba(251, 191, 36, 0.3); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 600; font-size: 12px;">Journey Optimizer</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Multi-Factor</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 5: Auto Calculation -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">üîÑ AUTO-CALCULATION LAYER</div>
                            <div style="text-align: center;">
                                <div style="padding: 10px; background: rgba(102, 126, 234, 0.3); border-radius: 6px; display: inline-block;">
                                    <div style="font-weight: 600; font-size: 12px;">Background Process</div>
                                    <div style="font-size: 10px; opacity: 0.9; margin-top: 3px;">Runs every 2 minutes</div>
                                    <div style="font-size: 10px; opacity: 0.9;">Keeps data always current</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 20px;">‚Üì</div>
                        </div>

                        <!-- Layer 6: Output -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 10px; font-size: 14px; text-align: center;">üì± OUTPUT LAYER</div>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                <div style="padding: 10px 15px; background: rgba(64, 220, 165, 0.3); border-radius: 6px; font-weight: 600;">
                                    CC Display
                                </div>
                                <div style="padding: 10px 15px; background: rgba(72, 187, 120, 0.3); border-radius: 6px; font-weight: 600;">
                                    Journey Visualizer
                                </div>
                                <div style="padding: 10px 15px; background: rgba(102, 126, 234, 0.3); border-radius: 6px; font-weight: 600;">
                                    Admin Dashboard
                                </div>
                            </div>
                        </div>

                        <!-- Data Flow Indicators -->
                        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 10px; text-align: center; font-size: 13px;">üîÑ Live Data Flow</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 11px;">
                                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Transit Data:</strong> Refreshes every 30 seconds
                                </div>
                                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Weather Data:</strong> Cached for 10 minutes
                                </div>
                                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Journey Calc:</strong> Auto-updates every 2 minutes
                                </div>
                                <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong>Geocoding:</strong> Cached for 24 hours
                                </div>
                            </div>
                        </div>

                        <!-- Decision Logging -->
                        <div style="margin-top: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 11px; text-align: center;">
                            <strong>üîç Transparency:</strong> All decisions logged to Decision Log for full system transparency
                        </div>
                    </div>
                </div>
            `;

            vizDiv.style.display = 'block';
            toggleBtn.innerHTML = '<span style="font-size: 20px;">üîº</span> Hide Architecture Map';
        }

        // ===== SETUP WIZARD FUNCTIONS =====

        // Setup wizard step navigation
        function setupNextStep(step) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`setup-content-${i}`).style.display = 'none';
                document.getElementById(`setup-step-${i}`).style.background = '#e2e8f0';
                document.getElementById(`setup-step-${i}`).style.color = '#1e293b';
            }

            // Show current step
            document.getElementById(`setup-content-${step}`).style.display = 'block';
            document.getElementById(`setup-step-${step}`).style.background = '#4fb28e';
            document.getElementById(`setup-step-${step}`).style.color = 'white';

            // Mark previous steps as complete
            for (let i = 1; i < step; i++) {
                document.getElementById(`setup-step-${i}`).style.background = '#22c55e';
                document.getElementById(`setup-step-${i}`).style.color = 'white';
            }
        }

        function setupPrevStep(step) {
            setupNextStep(step);
        }

        function toggleSetupMode2() {
            const section = document.getElementById('setup-mode2-section');
            const checkbox = document.getElementById('setup-add-mode2');
            section.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleSetupCoffeeTime() {
            const section = document.getElementById('setup-coffee-time-section');
            const checkbox = document.getElementById('setup-include-coffee');
            section.style.display = checkbox.checked ? 'block' : 'none';
        }

        // Toggle Google API key input visibility
        function toggleGoogleApiInput() {
            const checkbox = document.getElementById('setup-has-google-api');
            const inputSection = document.getElementById('setup-google-api-input');
            inputSection.style.display = checkbox.checked ? 'block' : 'none';
        }

        // Save Google API key and restart system
        async function saveGoogleApiKey() {
            const apiKey = document.getElementById('setup-google-api-key').value.trim();
            const messageDiv = document.getElementById('google-api-save-message');

            if (!apiKey) {
                messageDiv.style.display = 'block';
                messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                messageDiv.style.color = '#fca5a5';
                messageDiv.innerHTML = '‚ùå Please enter your Google Places API key';
                return;
            }

            try {
                // Show saving message
                messageDiv.style.display = 'block';
                messageDiv.style.background = 'rgba(251, 191, 36, 0.2)';
                messageDiv.style.color = '#fbbf24';
                messageDiv.innerHTML = '‚è≥ Saving API key...';

                // Save to additional APIs endpoint
                const response = await fetch('/admin/apis/additional', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiId: 'googlePlaces',
                        apiKey: apiKey,
                        enabled: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                    messageDiv.style.color = '#6ee7b7';
                    messageDiv.innerHTML = `
                        ‚úÖ Google Places API key saved successfully!
                        <br><small>Reloading system in 3 seconds...</small>
                    `;

                    // Reload the page after 3 seconds to restart with new API key
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    messageDiv.style.color = '#fca5a5';
                    messageDiv.innerHTML = `‚ùå Failed to save: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                console.error('Error saving Google API key:', error);
                messageDiv.style.display = 'block';
                messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                messageDiv.style.color = '#fca5a5';
                messageDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // ==================== DEVICE SELECTION ====================

        function updateDeviceInfo() {
            const deviceSelect = document.getElementById('setup-device-select');
            const deviceInfo = document.getElementById('device-info');
            const trmnlModelSelection = document.getElementById('trmnl-model-selection');
            const selectedDevice = deviceSelect.value;

            // Show/hide display model selection based on device type
            if (selectedDevice === 'trmnl-byos') {
                trmnlModelSelection.style.display = 'block';
            } else {
                trmnlModelSelection.style.display = 'none';
            }

            const deviceSpecs = {
                'trmnl-byos': {
                    name: 'CC E-Ink (OG)',
                    resolution: '800√ó480 pixels',
                    orientation: 'Landscape',
                    display: '7.5" E-ink',
                    chip: 'ESP32',
                    ppi: 117,
                    icon: 'üì∫',
                    jailbreakRequired: false,
                    firmwarePath: '/firmware/src/main.cpp'
                },
                'kindle-pw3': {
                    name: 'Kindle Paperwhite 3',
                    resolution: '1072√ó1448 pixels',
                    orientation: 'Portrait',
                    display: '6" E-ink (Carta)',
                    ppi: 300,
                    icon: 'üìñ',
                    jailbreakRequired: true,
                    firmwarePath: '/firmware/kindle/kindle-pw3/'
                },
                'kindle-pw4': {
                    name: 'Kindle Paperwhite 4',
                    resolution: '1072√ó1448 pixels',
                    orientation: 'Portrait',
                    display: '6" E-ink (Carta 1100)',
                    ppi: 300,
                    icon: 'üìñ',
                    jailbreakRequired: true,
                    firmwarePath: '/firmware/kindle/kindle-pw4/'
                },
                'kindle-pw5': {
                    name: 'Kindle Paperwhite 5',
                    resolution: '1236√ó1648 pixels',
                    orientation: 'Portrait',
                    display: '6.8" E-ink (Carta 1200)',
                    ppi: 300,
                    icon: 'üìñ',
                    jailbreakRequired: true,
                    firmwarePath: '/firmware/kindle/kindle-pw5/'
                },
                'kindle-basic-10': {
                    name: 'Kindle Basic (10th gen)',
                    resolution: '600√ó800 pixels',
                    orientation: 'Portrait',
                    display: '6" E-ink (Pearl)',
                    ppi: 167,
                    icon: 'üìï',
                    jailbreakRequired: true,
                    firmwarePath: '/firmware/kindle/kindle-basic-10/'
                },
                'kindle-11': {
                    name: 'Kindle (11th gen)',
                    resolution: '1072√ó1448 pixels',
                    orientation: 'Portrait',
                    display: '6" E-ink (Carta 1200)',
                    ppi: 300,
                    icon: 'üìñ',
                    jailbreakRequired: true,
                    firmwarePath: '/firmware/kindle/kindle-11/'
                }
            };

            const spec = deviceSpecs[selectedDevice];
            let infoHTML = `
                <div style="font-size: 13px; line-height: 1.7;">
                    <div style="font-weight: 600; margin-bottom: 5px;">${spec.icon} ${spec.name}</div>
                    <div style="font-size: 12px; opacity: 0.85;">
                        Resolution: ${spec.resolution}<br>
                        Orientation: ${spec.orientation}<br>
                        Display: ${spec.display}<br>
                        PPI: ${spec.ppi}`;

            if (spec.chip) {
                infoHTML += `<br>Chip: ${spec.chip}`;
            }

            infoHTML += `</div>`;

            // Add jailbreak warning for Kindle devices
            if (spec.jailbreakRequired) {
                infoHTML += `
                    <div style="margin-top: 10px; padding: 10px; background: rgba(234, 88, 12, 0.15); border: 1px solid rgba(234, 88, 12, 0.4); border-radius: 6px;">
                        <div style="font-weight: 600; font-size: 12px; color: #f97316; margin-bottom: 5px;">
                            ‚ö†Ô∏è Jailbreak Required (WinterBreak)
                        </div>
                        <div style="font-size: 11px; opacity: 0.9; line-height: 1.5;">
                            Requires Kindle firmware 5.18.0 or earlier.<br>
                            Install KUAL + CC extension after jailbreak.<br>
                            <a href="https://github.com/angusbergman17-cpu/einkptdashboard/tree/main/firmware/kindle"
                               target="_blank" style="color: #818cf8; text-decoration: underline;">
                               View Installation Guide ‚Üí
                            </a>
                        </div>
                    </div>`;
            }

            infoHTML += `</div>`;

            deviceInfo.innerHTML = infoHTML;
        }

        function showDisplayXWarning() {
            const trmnlXWarning = document.getElementById('trmnl-x-warning');
            trmnlXWarning.style.display = 'block';
        }

        function hideDisplayXWarning() {
            const trmnlXWarning = document.getElementById('trmnl-x-warning');
            trmnlXWarning.style.display = 'none';
        }

        // ==================== END DEVICE SELECTION ====================

        async function startJourneyPlanning() {
            console.log('üöÄ startJourneyPlanning() called');

            // Get device selection
            const selectedDevice = document.getElementById('setup-device-select').value;
            console.log(`üì± Selected device: ${selectedDevice}`);

            // Get display model selection if CC E-Ink is selected
            let trmnlModel = null;
            if (selectedDevice === 'trmnl-byos') {
                const trmnlModelRadio = document.querySelector('input[name="trmnl-model"]:checked');
                trmnlModel = trmnlModelRadio ? trmnlModelRadio.value : 'trmnl-og';
                console.log(`üì± Display Model: ${trmnlModel}`);

                // Validate CC Display X is not selected (not yet compatible)
                if (trmnlModel === 'trmnl-x') {
                    showMessage('setup-message', '‚ùå CC Display X is not yet compatible. Please select CC Display OG or use a different device.', 'error');
                    return;
                }
            }

            // Validate required fields
            const homeAddress = document.getElementById('setup-home-address').value.trim();
            const workAddress = document.getElementById('setup-work-address').value.trim();
            const arrivalTime = document.getElementById('setup-arrival-time').value;
            const cafeAddress = document.getElementById('setup-cafe-address').value.trim();
            const coffeeEnabled = document.getElementById('setup-include-coffee').checked;
            const transportApiKey = document.getElementById('setup-transport-api-key')?.value.trim() || '';
            const googleApiKey = document.getElementById('setup-google-api-key')?.value.trim() || '';

            console.log('üìù Input values:', { homeAddress, workAddress, arrivalTime, cafeAddress, coffeeEnabled, trmnlModel, hasTransportKey: !!transportApiKey, hasGoogleKey: !!googleApiKey });

            // Save Transport API key if provided
            if (transportApiKey) {
                try {
                    const apiKeyResponse = await fetch(BASE_URL + '/admin/apis/transport', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiKey: transportApiKey })
                    });
                    if (apiKeyResponse.ok) {
                        console.log('‚úÖ Transport API key saved');
                        const statusDiv = document.getElementById('transport-api-status');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                            statusDiv.style.background = 'rgba(34, 197, 94, 0.2)';
                            statusDiv.innerHTML = '‚úÖ Transport API key saved';
                        }
                    }
                } catch (e) {
                    console.warn('Could not save transport API key:', e);
                }
            }

            // Save Google API key if provided
            if (googleApiKey) {
                try {
                    const googleResponse = await fetch(BASE_URL + '/admin/apis/additional', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiId: 'googlePlaces', apiKey: googleApiKey, enabled: true })
                    });
                    if (googleResponse.ok) {
                        console.log('‚úÖ Google API key saved');
                    }
                } catch (e) {
                    console.warn('Could not save Google API key:', e);
                }
            }

            if (!homeAddress) {
                showMessage('setup-message', '‚ùå Please enter your home address', 'error');
                return;
            }
            if (!workAddress) {
                showMessage('setup-message', '‚ùå Please enter your work address', 'error');
                return;
            }
            if (!arrivalTime) {
                showMessage('setup-message', '‚ùå Please enter your arrival time', 'error');
                return;
            }

            // Hide any previous messages
            document.getElementById('setup-message').style.display = 'none';

            // Show progress indicator
            const progressDiv = document.getElementById('setup-progress');
            const progressText = document.getElementById('setup-progress-text');
            progressDiv.style.display = 'block';
            progressText.textContent = 'Validating addresses...';

            try {
                // Get device specifications (correct resolutions per Development Rules)
                const deviceResolutions = {
                    'trmnl-byos': { width: 800, height: 480, orientation: 'landscape' },
                    'kindle-pw3': { width: 1072, height: 1448, orientation: 'portrait' },
                    'kindle-pw4': { width: 1072, height: 1448, orientation: 'portrait' },
                    'kindle-pw5': { width: 1236, height: 1648, orientation: 'portrait' },
                    'kindle-basic-10': { width: 600, height: 800, orientation: 'portrait' },
                    'kindle-11': { width: 1072, height: 1448, orientation: 'portrait' }
                };

                const deviceSpec = deviceResolutions[selectedDevice];

                // Prepare data for smart setup
                const setupData = {
                    addresses: {
                        home: homeAddress,
                        work: workAddress,
                        cafe: cafeAddress || null
                    },
                    arrivalTime: arrivalTime,
                    coffeeEnabled: coffeeEnabled,
                    deviceConfig: {
                        selectedDevice: selectedDevice,
                        trmnlModel: trmnlModel,
                        resolution: {
                            width: deviceSpec.width,
                            height: deviceSpec.height
                        },
                        orientation: deviceSpec.orientation
                    }
                };

                console.log('üì§ Sending request to /admin/smart-setup:', setupData);
                progressText.textContent = 'Detecting your state and nearby transit stops...';

                // Call smart setup endpoint that will:
                // 1. Geocode addresses
                // 2. Detect state
                // 3. Find nearby transit stops automatically
                // 4. Select best route mode
                // 5. Save configuration
                // 6. Start auto-calculation
                const response = await fetch(BASE_URL + '/admin/smart-setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(setupData)
                });

                console.log('üì• Response status:', response.status, response.statusText);

                const result = await response.json();
                console.log('üì• Response data:', result);

                if (result.success) {
                    progressText.textContent = '‚úÖ Journey configured! Loading Live Data...';

                    // Hide progress after brief display
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 300);

                    // Show comprehensive success message
                    const setupMessage = document.getElementById('setup-message');
                    setupMessage.className = 'message success';
                    setupMessage.style.display = 'block';
                    setupMessage.innerHTML = `
                        <div style="padding: 20px;">
                            <div style="font-size: 24px; margin-bottom: 15px;">‚úÖ Journey Configured for ${result.state || 'Your Location'}!</div>

                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; margin-bottom: 10px;">üìç Your Journey:</div>
                                <div style="font-size: 14px; line-height: 1.8;">
                                    <div>üè† <strong>Home:</strong> ${result.homeStop || 'Not available'}</div>
                                    <div>üíº <strong>Work:</strong> ${result.workStop || 'Not available'}</div>
                                    <div>üöÜ <strong>Transit Mode:</strong> ${result.routeMode || 'Auto-detected'}</div>
                                    <div>üìä <strong>Stops Found:</strong> ${result.stopsFound || 0} stops in your area</div>
                                </div>
                            </div>

                            <div style="background: rgba(251, 191, 36, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #fbbf24;">
                                <div style="font-weight: 600; margin-bottom: 8px;">üî¥ Using Fallback Timetable Data</div>
                                <div style="font-size: 13px; opacity: 0.9; line-height: 1.6;">
                                    Your journey is configured and working! Currently using static timetable data.
                                    For real-time updates, add your API keys in the next step.
                                </div>
                            </div>

                            <div style="font-weight: 600; margin-bottom: 10px;">What's Next?</div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="showTab('api', this)" style="flex: 1; min-width: 200px;">
                                    üîë Configure API Keys for Live Data
                                </button>
                                <button class="btn btn-secondary" onclick="showTab('live', this)" style="flex: 1; min-width: 200px;">
                                    üëÄ View Journey with Fallback Data
                                </button>
                            </div>

                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px; opacity: 0.7;">
                                <strong>üí° Tip:</strong> The system works great with fallback data! API keys are optional and just add real-time arrival updates.
                            </div>
                        </div>
                    `;

                    // Scroll to message
                    setupMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    console.error('‚ùå Setup failed:', result.message);
                    progressDiv.style.display = 'none';
                    showToast('error', 'Setup Failed', result.message || 'Setup failed. Please try again.');
                    showMessage('setup-message', '‚ùå ' + (result.message || 'Setup failed. Please try again.'), 'error');
                }
            } catch (error) {
                console.error('‚ùå Setup error:', error);
                progressDiv.style.display = 'none';
                showToast('error', 'Setup Error', error.message || 'An unexpected error occurred. Check console for details.');
                showMessage('setup-message', '‚ùå Error: ' + error.message + '<br>Check browser console for details.', 'error');
            }
        }

        // Legacy function for backward compatibility (no longer used in UI)
        async function completeSetup() {
            console.warn('completeSetup() is deprecated, use startJourneyPlanning() instead');
            await startJourneyPlanning();
        }

        // ===== ADDRESS AUTOCOMPLETE FUNCTIONS =====

        let addressSearchTimeout = null;

        function setupAddressAutocomplete(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) return;

            input.addEventListener('input', function() {
                const query = this.value.trim();

                clearTimeout(addressSearchTimeout);

                if (query.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }

                addressSearchTimeout = setTimeout(async () => {
                    try {
                        console.log(`üîç Searching for: "${query}"`);
                        const response = await fetch(`${BASE_URL}/admin/address/search?query=${encodeURIComponent(query)}`);
                        console.log(`üì° Search response status: ${response.status}`);

                        const data = await response.json();
                        console.log(`üì• Search results:`, data);

                        if (data.success && data.results && data.results.length > 0) {
                            console.log(`‚úÖ Found ${data.results.length} results from sources:`, data.sources);

                            // Log validation information if available
                            if (data.validation) {
                                console.log(`üéØ Geocoding confidence: ${data.validation.confidence.score}% (${data.validation.confidence.level})`);
                                console.log(`üîç Cross-validation: ${data.validation.crossValidation.agreement}`);
                            }

                            // Show confidence indicator at top if available
                            let confidenceHeader = '';
                            if (data.validation && data.validation.confidence) {
                                const conf = data.validation.confidence;
                                const emoji = conf.level === 'high' ? 'üü¢' : conf.level === 'medium' ? 'üü°' : 'üî¥';
                                confidenceHeader = `
                                    <div style="padding: 8px 12px; background: rgba(102, 126, 234, 0.1); border-bottom: 1px solid rgba(102, 126, 234, 0.2); font-size: 11px;">
                                        ${emoji} <strong>${conf.message}</strong> (${conf.score}% confidence)<br>
                                        <span style="opacity: 0.7;">Sources: ${conf.sources}</span>
                                    </div>
                                `;
                            }

                            dropdown.innerHTML = confidenceHeader + data.results.map(result => `
                                <div class="autocomplete-item" onclick='selectAddress("${inputId}", "${dropdownId}", ${JSON.stringify(result).replace(/'/g, "\\'")})'>
                                    <div style="font-weight: 600; margin-bottom: 3px;">${sanitize(result.display_name || result.address)}</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${sanitize(result.full_address || '')}</div>
                                    <div style="font-size: 10px; opacity: 0.5; margin-top: 2px;">Source: ${result.source || 'Unknown'}</div>
                                </div>
                            `).join('');
                            dropdown.style.display = 'block';
                        } else {
                            console.warn(`‚ö†Ô∏è No results found for: "${query}"`);
                            dropdown.innerHTML = `
                                <div class="autocomplete-item" style="opacity: 0.6;">
                                    No results found for "${query}"<br>
                                    <small style="font-size: 11px;">Try: full address with suburb and state</small>
                                </div>
                            `;
                            dropdown.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('‚ùå Address search error:', error);
                        dropdown.innerHTML = `
                            <div class="autocomplete-item" style="color: #fc8181;">
                                Search error: ${error.message}<br>
                                <small style="font-size: 11px;">Check browser console for details</small>
                            </div>
                        `;
                        dropdown.style.display = 'block';
                    }
                }, 300);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== input) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function selectAddress(inputId, dropdownId, result) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (input) {
                input.value = result.display_name || result.address;
                input.setAttribute('data-lat', result.lat);
                input.setAttribute('data-lon', result.lon);
            }

            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        // Initialize autocomplete on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Setup autocomplete for Setup tab
            setupAddressAutocomplete('setup-home-address', 'setup-home-suggestions');
            setupAddressAutocomplete('setup-work-address', 'setup-work-suggestions');
            setupAddressAutocomplete('setup-cafe-address', 'setup-cafe-suggestions');

            // Setup autocomplete for Journey Planner tab (if fields exist)
            setupAddressAutocomplete('home-address', 'home-suggestions');
            setupAddressAutocomplete('work-address', 'work-suggestions');
            setupAddressAutocomplete('cafe-address', 'cafe-suggestions');
        });
    </script>
</body>
</html>
