# System Audit Report - AUDIT-002-20260130

**Date:** 2026-01-30
**Auditor:** Claude Code
**Scope:** Full user-facing system audit
**Status:** ğŸ”´ CRITICAL ISSUES FOUND

---

## Executive Summary

The Commute Compute System has **critical architectural issues** that prevent proper functioning on Vercel deployment. The user is experiencing 404 errors because the system was designed primarily for Express server deployment (Render.com) and the Vercel serverless adaptation is incomplete.

### Critical Finding: Dual Deployment Architecture Mismatch

The codebase has TWO deployment models that were never fully reconciled:

| Model | Platform | Status |
|-------|----------|--------|
| Express Server | Render.com / Local | âœ… Fully functional (60+ routes) |
| Vercel Serverless | Vercel | âŒ Incomplete (~20 endpoints, missing key routes) |

---

## Issue Summary Table

| # | Severity | Category | Issue | Impact |
|---|----------|----------|-------|--------|
| 1 | ğŸ”´ CRITICAL | Architecture | admin.html calls Express routes not available on Vercel | Page loads but all API calls fail |
| 2 | ğŸ”´ CRITICAL | Deployment | api/index.js tries to wrap entire Express server | Server init fails, causes 404 |
| 3 | ğŸ”´ CRITICAL | Persistence | PreferencesManager uses filesystem (not available on Vercel) | Settings cannot be saved |
| 4 | ğŸŸ  HIGH | API | 40+ admin routes missing from Vercel serverless | Admin panel non-functional |
| 5 | ğŸŸ  HIGH | Syntax | 4 JavaScript syntax errors in admin.html | Page JavaScript broken (FIXED) |
| 6 | ğŸŸ¡ MEDIUM | Routing | vercel.json redirects may conflict with static file serving | Potential 404 on static files |
| 7 | ğŸŸ¡ MEDIUM | Dev Rules | Some endpoints still reference legacy PTV API terminology | Non-compliance with Section 1.1 |

---

## Detailed Findings

### 1. ğŸ”´ CRITICAL: admin.html Uses Express Routes

**Location:** `public/admin.html`

The admin.html page makes fetch calls to ~40+ endpoints that ONLY exist in the Express server (`src/server.js`), not as Vercel serverless functions:

**Missing Vercel Endpoints (called by admin.html):**

| Endpoint | Line | Purpose |
|----------|------|---------|
| `/admin/smart-setup` | 6359 | Main setup wizard endpoint |
| `/admin/weather` | 3774 | Weather data |
| `/admin/preferences` | 4645, 4883, 5195, 5850 | Load/save preferences |
| `/admin/apis/*` | Multiple | API key management |
| `/admin/address/search` | 6465 | Address autocomplete |
| `/admin/route/*` | Multiple | Route planning |
| `/admin/cache/clear` | 5101, 5702 | Cache management |
| `/admin/system/reset-all` | 5789 | System reset |
| `/api/profiles` | 3453, 3590 | Journey profiles |
| `/api/region-updates` | 3775 | Region updates |
| `/api/decisions` | 5547, 5619 | Decision log |
| `/api/journey-cache` | 4246 | Journey cache |

**Impact:** Admin page loads but ALL functionality fails silently. Users see frozen modules, unclickable buttons, and no data.

---

### 2. ğŸ”´ CRITICAL: api/index.js Architecture Failure

**Location:** `api/index.js`

```javascript
// Lines 9-16 - This imports the ENTIRE Express server
try {
  const module = await import('../src/server.js');
  app = module.default;
} catch (error) {
  console.error('âŒ Server initialization failed:', error);
  initError = error;
}
```

**Problem:** The Express server (`src/server.js`) is 6000+ lines with:
- 60+ route handlers
- Multiple class instantiations
- Filesystem operations
- Environment variable dependencies

This approach is fundamentally flawed for Vercel serverless where:
- Functions have cold start constraints
- File system is read-only
- Each function should be lightweight

**Impact:** Server initialization likely fails, causing 404 on all routes.

---

### 3. ğŸ”´ CRITICAL: PreferencesManager Filesystem Dependency

**Location:** `src/data/preferences-manager.js`

```javascript
// Line 342-360
async save() {
  await fs.writeFile(
    this.preferencesFile,          // user-preferences.json
    JSON.stringify(this.preferences, null, 2),
    'utf8'
  );
}
```

**Problem:** Vercel serverless functions:
- Have read-only filesystem (except `/tmp`)
- `/tmp` is ephemeral and not shared across invocations
- Any file writes are lost after function completes

**Impact:**
- `save-transit-key.js` calls `prefs.save()` - appears to work but changes are lost
- `save-google-key.js` has same issue
- All preference persistence is broken on Vercel

**Development Rules Violation:** Section 3.1 states "Users must NEVER need to manually configure server-side environment variables" - but without working persistence, the zero-config architecture breaks.

---

### 4. ğŸŸ  HIGH: Missing Serverless API Endpoints

**Current Vercel API structure (`/api/`):**
```
api/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ generate-webhook.js    âœ…
â”‚   â”œâ”€â”€ preferences.js         âœ… (but read-only)
â”‚   â””â”€â”€ setup-complete.js      âœ…
â”œâ”€â”€ device/
â”‚   â””â”€â”€ [token].js             âœ…
â”œâ”€â”€ pair/
â”‚   â””â”€â”€ [code].js              âœ…
â”œâ”€â”€ zone/
â”‚   â””â”€â”€ [id].js                âœ…
â”œâ”€â”€ address-search.js          âœ…
â”œâ”€â”€ attributions.js            âœ…
â”œâ”€â”€ cafe-details.js            âœ…
â”œâ”€â”€ fullscreen.js              âœ…
â”œâ”€â”€ health.js                  âœ…
â”œâ”€â”€ index.js                   âš ï¸ (wraps Express)
â”œâ”€â”€ landing.js                 âœ…
â”œâ”€â”€ livedash.js                âœ…
â”œâ”€â”€ save-google-key.js         âœ… (persistence broken)
â”œâ”€â”€ save-transit-key.js        âœ… (persistence broken)
â”œâ”€â”€ screen.js                  âœ…
â”œâ”€â”€ status.js                  âœ…
â”œâ”€â”€ system-status.js           âœ…
â”œâ”€â”€ version.js                 âœ…
â”œâ”€â”€ zonedata.js                âœ…
â”œâ”€â”€ zones-tiered.js            âœ…
â””â”€â”€ zones.js                   âœ…
```

**Required but MISSING for admin.html:**
- `/api/admin/smart-setup`
- `/api/admin/weather`
- `/api/admin/apis/*` (full API key management)
- `/api/admin/route/*` (route planning)
- `/api/admin/address/search`
- `/api/admin/cache/clear`
- `/api/profiles/*`
- `/api/region-updates`
- `/api/decisions/*`
- `/api/journey-*`
- 30+ more endpoints

---

### 5. ğŸŸ  HIGH: JavaScript Syntax Errors (FIXED)

**Location:** `public/admin.html`

**Status:** âœ… FIXED in commit 311ffe1

Four `sanitize()` calls were missing closing parentheses:
- Line 4051: `sanitize(status.addresses.home || 'Not set'` âŒ
- Line 4052: `sanitize(status.addresses.work || 'Not set'` âŒ
- Line 6495: `sanitize(result.display_name || result.address` âŒ
- Line 6496: `sanitize(result.full_address || ''` âŒ

These caused JavaScript parser errors, breaking all page functionality.

---

### 6. ğŸŸ¡ MEDIUM: vercel.json Configuration Issues

**Location:** `vercel.json`

```json
{
  "redirects": [
    { "source": "/", "destination": "/setup-wizard.html", "permanent": false },
    { "source": "/admin", "destination": "/admin.html", "permanent": false }
  ]
}
```

**Potential Issues:**
1. Redirects may not fire if static files take precedence
2. No explicit static file configuration (relies on Vercel defaults)
3. `api/index.js` with `includeFiles` may cause deployment issues

---

### 7. ğŸŸ¡ MEDIUM: Development Rules Compliance Issues

**Section 1.1 - Forbidden Terms:**
- `package.json` keywords still include `"ptv"` - should be neutral
- Some internal variable names reference legacy terminology

**Section 3 - Zero-Config Architecture:**
- The zero-config design (config token in URL) is correctly implemented in `generate-webhook.js`
- BUT persistence layer (PreferencesManager) breaks this on Vercel
- Users cannot save preferences without filesystem access

**Section 17.3 - Free-Tier Architecture:**
- Setup-time caching is correctly designed
- Token-based config is correctly implemented
- BUT admin panel relies on server-side routes that don't exist on Vercel

---

## API Keys Assessment

**User-provided keys (from screenshots):**
- Google Maps Platform API Key: Confirmed valid format (`AIza...`)
- Transport for Victoria API Key: Confirmed UUID format (`ce606b90-9ffb-43e8-bcd7-0c2b-d0498367`)

**Note:** API keys are correctly formatted but CANNOT be tested because:
1. The admin panel endpoints don't exist on Vercel
2. The save-transit-key.js endpoint can validate but cannot persist

---

## Root Cause Analysis

```
                    DEPLOYMENT ARCHITECTURE MISMATCH

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DESIGNED FOR                              â”‚
â”‚                                                              â”‚
â”‚   Express Server (src/server.js)                             â”‚
â”‚   â”œâ”€â”€ 60+ /admin/* routes                                    â”‚
â”‚   â”œâ”€â”€ PreferencesManager (filesystem)                        â”‚
â”‚   â”œâ”€â”€ Full journey calculation                               â”‚
â”‚   â””â”€â”€ Persistent state                                       â”‚
â”‚                                                              â”‚
â”‚   Deployment: Render.com, Docker, Local                      â”‚
â”‚   Status: âœ… WORKS                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEPLOYED TO                                â”‚
â”‚                                                              â”‚
â”‚   Vercel Serverless (api/*.js)                               â”‚
â”‚   â”œâ”€â”€ ~20 standalone functions                               â”‚
â”‚   â”œâ”€â”€ No persistent filesystem                               â”‚
â”‚   â”œâ”€â”€ Stateless execution                                    â”‚
â”‚   â””â”€â”€ api/index.js tries to wrap Express (FAILS)             â”‚
â”‚                                                              â”‚
â”‚   Deployment: Vercel                                         â”‚
â”‚   Status: âŒ BROKEN                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Recommendations

### Immediate Actions (To Fix 404 Error)

1. **Option A: Deploy to Render.com instead**
   - The system is fully functional on Express server
   - Use Render.com free tier for persistent server deployment
   - All 60+ routes will work
   - Filesystem persistence will work

2. **Option B: Use setup-wizard.html instead of admin.html**
   - `setup-wizard.html` is better adapted for Vercel
   - Uses `/api/*` endpoints that exist
   - Complete setup â†’ generate webhook URL â†’ use webhook

### Long-term Fixes (For Full Vercel Support)

1. **Create missing serverless endpoints**
   - Port essential `/admin/*` routes to `/api/admin/*` files
   - Minimum: `smart-setup`, `weather`, `preferences` (full CRUD)

2. **Replace PreferencesManager with Vercel KV**
   - Package `@vercel/kv` is already in dependencies
   - Implement KV-based persistence for serverless

3. **Refactor admin.html**
   - Update all fetch calls to use `/api/*` prefix
   - Add error handling for missing endpoints
   - Implement graceful degradation

4. **Remove api/index.js Express wrapper**
   - This approach is fundamentally broken for serverless
   - Use individual serverless functions instead

---

## Compliance Checklist

| Rule | Status | Notes |
|------|--------|-------|
| Section 0: Naming Conventions | âš ï¸ Partial | Some legacy references remain |
| Section 1: Forbidden Terms | âš ï¸ Partial | package.json keywords need update |
| Section 3: Zero-Config | âŒ Broken | Persistence fails on Vercel |
| Section 4: Architecture | âš ï¸ Partial | Dual architecture not reconciled |
| Section 17: Security | âœ… Pass | XSS sanitization present (with fixes) |
| Section 17.2: API Validation | âœ… Pass | Validation correctly implemented |
| Section 17.3: Free-Tier | âš ï¸ Partial | Design correct, implementation broken |

---

## Conclusion

The 404 error is a symptom of a **fundamental architecture mismatch**. The system was built for Express server deployment but is being deployed to Vercel serverless where it cannot function properly.

**Recommended immediate action:** Deploy to Render.com using the Express server, or use the setup-wizard.html which is better suited for Vercel.

---

**Document Version:** 1.0
**Audit Classification:** CRITICAL
**Next Review:** After implementing fixes

Copyright (c) 2026 Angus Bergman
Licensed under CC BY-NC 4.0
